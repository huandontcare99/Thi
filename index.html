<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Quiz Master</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 500:'#0ea5e9', 600:'#0284c7' } },
          boxShadow: { soft: '0 10px 24px rgba(0,0,0,.25)' }
        }
      }
    }
  </script>

  <style>
    /* Mobile-first tinh chỉnh nhỏ */
    .ctrl { display:grid; gap:.25rem }
    .ctrl .lbl { font-size:.75rem; color: rgb(148 163 184) }
    .ctrl .inp {
      height:2.75rem; border-radius:.75rem;
      border:1px solid rgb(30 41 59); background: rgb(15 23 42);
      padding:0 .75rem; color:#e2e8f0; font-size:.95rem; width:100%;
    }
    .ctrl .inp:focus { outline:2px solid rgba(14,165,233,.55) }

    .num { display:grid; place-items:center }
    .num.current{ border-color: rgb(14 165 233);
      background:linear-gradient(to bottom,rgb(14 165 233),rgb(2 132 199));
      color:#03121f; font-weight:700 }
    .num.answered{ outline:2px solid rgba(56,189,248,.35) }
    .num.marked{ box-shadow: inset 0 0 0 2px rgba(250,204,21,.95) }

    .b-ghost,.b-ok,.b-bad{
      display:inline-grid; place-items:center;
      width:1.5rem; height:1.5rem; border-radius:.5rem; margin-right:.35rem;
      border:1px solid rgb(30 41 59); font-weight:700; font-size:.875rem;
    }
    .b-ghost{ background: rgb(2 6 23); color: rgb(203 213 225) }
    .b-ok{ background:#22c55e1a; border-color:#22c55e; color:#22c55e }
    .b-bad{ background:#ef44441a; border-color:#ef4444; color:#ef4444 }

    @media (min-width: 640px){ .ctrl .inp{ height:2.9rem } }
  </style>
</head>
<body class="min-h-dvh bg-slate-950 text-slate-100 antialiased">
  <div class="mx-auto max-w-[1100px]">
    <!-- Header nhỏ gọn -->
    <header class="sticky top-0 z-30 border-b border-slate-800 bg-slate-900/80 backdrop-blur">
      <div class="flex items-center gap-3 px-4 py-3">
        <div class="grid h-9 w-9 place-items-center rounded-lg bg-gradient-to-br from-brand-500 to-sky-400 font-extrabold text-slate-900">Q</div>
        <h1 class="text-base font-semibold tracking-wide">Quiz Master</h1>
      </div>
    </header>

    <main class="grid grid-cols-1 gap-4 p-4 md:grid-cols-[280px_minmax(0,1fr)]">
      <!-- Sidebar (tablet/PC) -->
      <aside class="hidden md:block space-y-4">
        <div class="rounded-2xl border border-slate-800 bg-slate-900 shadow-soft">
          <div class="border-b border-slate-800 p-3 font-bold">Thiết lập</div>
          <div class="grid gap-2 p-3">
            <label class="ctrl">
              <span class="lbl">Môn</span>
              <select id="subject" class="inp"></select>
            </label>
            <label class="ctrl">
              <span class="lbl">Chế độ</span>
              <select id="mode" class="inp">
                <option value="practice">Luyện tập</option>
                <option value="exam">Thi</option>
              </select>
            </label>
            <label class="ctrl">
              <span class="lbl">Số câu</span>
              <input id="count" type="number" min="1" max="999" class="inp">
            </label>
            <label class="ctrl">
              <span class="lbl">Tùy chọn</span>
              <div class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-900 px-3 py-2">
                <input id="shuffle" type="checkbox" class="h-5 w-5 accent-sky-500">
                <span class="text-sm">Đảo đáp án</span>
              </div>
            </label>
            <button id="start" type="button" class="mt-1 h-11 w-full rounded-xl bg-gradient-to-b from-brand-500 to-brand-600 font-semibold text-slate-950 shadow-soft">Bắt đầu</button>
          </div>
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-900 shadow-soft">
          <div class="border-b border-slate-800 p-3 font-bold">Danh sách câu</div>
          <div id="numberGrid" class="grid grid-cols-6 gap-2 p-3"></div>
        </div>
      </aside>

      <!-- Nội dung chính -->
      <section class="space-y-4">
        <!-- Bộ lọc cho mobile (mặc định đóng để khỏi chiếm chỗ) -->
        <details class="rounded-2xl border border-slate-800 bg-slate-900 md:hidden">
          <summary class="cursor-pointer list-none p-3 font-semibold">Thiết lập</summary>
          <div class="grid gap-2 border-t border-slate-800 p-3">
            <label class="ctrl">
              <span class="lbl">Môn</span>
              <select id="subject_m" class="inp"></select>
            </label>
            <label class="ctrl">
              <span class="lbl">Chế độ</span>
              <select id="mode_m" class="inp">
                <option value="practice">Luyện tập</option>
                <option value="exam">Thi</option>
              </select>
            </label>
            <label class="ctrl">
              <span class="lbl">Số câu</span>
              <input id="count_m" type="number" min="1" max="999" class="inp">
            </label>
            <label class="ctrl">
              <span class="lbl">Tùy chọn</span>
              <div class="flex items-center gap-3 rounded-xl border border-slate-800 bg-slate-900 px-3 py-2">
                <input id="shuffle_m" type="checkbox" class="h-5 w-5 accent-sky-500">
                <span class="text-sm">Đảo đáp án</span>
              </div>
            </label>
            <button id="start_m" type="button" class="mt-1 h-11 w-full rounded-xl bg-gradient-to-b from-brand-500 to-brand-600 font-semibold text-slate-950 shadow-soft">Bắt đầu</button>
          </div>
        </details>

        <!-- Tiến trình -->
        <div class="grid grid-cols-[1fr_auto] items-center gap-3">
          <div class="relative h-2 rounded-full bg-slate-800">
            <div id="progressBar" class="absolute left-0 top-0 h-2 w-0 rounded-full bg-gradient-to-r from-brand-500 to-sky-400 transition-[width] duration-200 ease-linear"></div>
          </div>
          <div id="progressText" class="text-sm text-slate-400">0/0</div>
        </div>

        <!-- Danh sách số câu cho mobile -->
        <details class="rounded-2xl border border-slate-800 bg-slate-900 md:hidden">
          <summary class="cursor-pointer list-none p-3 font-semibold">Danh sách câu hỏi</summary>
          <div id="numberGridMobile" class="grid grid-cols-6 gap-2 border-t border-slate-800 p-3"></div>
        </details>

        <!-- Thẻ câu hỏi -->
        <article id="questionCard" class="rounded-2xl border border-slate-800 bg-slate-900 p-4 shadow-soft">
          <div class="mb-2 flex items-center justify-between">
            <div class="flex flex-wrap items-center gap-2">
              <span id="subjectBadge" class="rounded-full border border-slate-700 bg-slate-800 px-2 py-0.5 text-xs">—</span>
              <span id="modeBadge" class="rounded-full border border-slate-800 bg-slate-900 px-2 py-0.5 text-xs text-slate-300">—</span>
            </div>
            <div id="qIndex" class="text-sm text-slate-400">Câu —</div>
          </div>

          <div id="question" class="pb-3 text-lg leading-relaxed">Chọn “Bắt đầu” để làm bài.</div>

          <!-- Đáp án -->
          <ul id="answers" class="space-y-3" role="listbox" aria-label="Đáp án"></ul>

          <!-- Nút điều hướng (không cố định để không che màn hình) -->
          <div class="mt-4 grid grid-cols-2 gap-2 sm:grid-cols-4">
            <button id="prev" class="h-10 rounded-xl border border-slate-800 bg-slate-900 disabled:opacity-50" disabled>◀ Trước</button>
            <button id="clear" class="h-10 rounded-xl border border-slate-800 bg-slate-900 disabled:opacity-50" disabled>Xóa chọn</button>
            <button id="next" class="h-10 rounded-xl bg-gradient-to-b from-brand-500 to-brand-600 font-semibold text-slate-950 shadow-soft" disabled>Tiếp ▶</button>
            <button id="submit" class="h-10 rounded-xl bg-gradient-to-b from-brand-500 to-brand-600 font-semibold text-slate-950 shadow-soft" disabled>Nộp bài</button>
          </div>
        </article>

        <!-- Kết quả -->
        <section id="result" class="rounded-2xl border border-slate-800 bg-slate-900 p-4" hidden></section>

        <div class="flex flex-wrap justify-end gap-2">
          <button id="retry" class="h-10 rounded-xl border border-slate-800 bg-slate-900 px-4" hidden>Làm lại</button>
        </div>
      </section>
    </main>

    <footer class="px-4 py-6 text-center text-xs text-slate-500">© Quiz Master</footer>
  </div>

  <!-- Nạp data.js trước -->
  <script src="data.js"></script>
  <script>
  (function(){
    "use strict";
    const $ = (id) => document.getElementById(id);

    const state = {
      bank: [],             // [{subject, questions:[{q, opts:[{t,letter}], correct}]}]
      questions: [],
      count: 0,
      current: 0,
      chosen: {},           // idx -> optIndex
      marked: new Set(),
    };

    // ====== INIT ======
    document.addEventListener("DOMContentLoaded", () => {
      const all = (window.quizData && window.quizData.getAll && window.quizData.getAll()) || [];
      state.bank = all.map(it => parseBank(it.text, it.subject));

      // Bind desktop controls
      buildSubjectSelect("subject");
      $("subject").value = "0";
      $("count").value = String(state.bank[0]?.questions.length || 1);
      $("mode").value = "practice";

      // Bind mobile controls (mirror desktop)
      buildSubjectSelect("subject_m");
      $("subject_m").value = "0";
      $("count_m").value = $("count").value;
      $("mode_m").value = "practice";

      updateBadges();

      // Khi đổi ở một bên -> sync sang bên kia
      linkMirrors("subject","subject_m");
      linkMirrors("mode","mode_m");
      linkMirrors("count","count_m");
      linkMirrors("shuffle","shuffle_m");

      $("start").addEventListener("click", start);
      $("start_m").addEventListener("click", start);

      $("next").addEventListener("click", ()=>go(state.current+1));
      $("prev").addEventListener("click", ()=>go(state.current-1));
      $("clear").addEventListener("click", ()=>{
        delete state.chosen[state.current];
        renderQuestion(); updateProgress();
      });
      $("submit").addEventListener("click", submit);
      $("retry").addEventListener("click", ()=>{ $("result").hidden=true; start(); });

      // Auto set count theo môn
      const syncCountBySubject = (selId, countId) => {
        $(selId).addEventListener("change", ()=>{
          const idx=+$(selId).value||0;
          const n=state.bank[idx]?.questions.length || 1;
          $(countId).value = String(n);
          // mirror qua bên kia
          if (countId==="count") $("count_m").value = String(n);
          else $("count").value = String(n);
          updateBadges();
        });
      };
      syncCountBySubject("subject","count");
      syncCountBySubject("subject_m","count_m");

      $("mode").addEventListener("change", updateBadges);
      $("mode_m").addEventListener("change", updateBadges);
    });

    function linkMirrors(a,b){
      const A=$(a), B=$(b);
      const sync=(src,dst)=>{
        if (src.type==="checkbox") dst.checked=src.checked;
        else dst.value=src.value;
        updateBadges();
      };
      A.addEventListener("input", ()=>sync(A,B));
      B.addEventListener("input", ()=>sync(B,A));
    }

    // ====== PARSER CỨNG CỠI ======
    function parseBank(raw, subjectName){
      const text = String(raw||"");

      // 1) Cắt khối câu hỏi. Ưu tiên ngăn cách bằng dòng gạch; fallback bằng "Câu \d+:"
      let blocks = [];
      const reSep = /(^|\n)Câu\s+\d+\s*:[\s\S]*?(?=\n[-=]{3,}\s*\n|$)/gim;
      let m; while((m=reSep.exec(text))!==null) blocks.push(m[0]);

      if (blocks.length===0){
        // fallback: quét mốc "Câu n:" tới trước "Câu n+1:" hoặc hết
        const marks = [...text.matchAll(/(^|\n)Câu\s+\d+\s*:/gim)];
        for (let i=0;i<marks.length;i++){
          const start = marks[i].index + (marks[i][1]?.length||0);
          const end = (i<marks.length-1) ? marks[i+1].index : text.length;
          blocks.push(text.slice(start, end));
        }
      }

      const questions = blocks.map(blkRaw=>{
        const blk = blkRaw.trim();

        // Câu hỏi: lấy phần từ sau "Câu n:" tới trước "Đáp án đúng:"
        let q = blk;
        const qm = blk.match(/Câu\s+\d+\s*:\s*([\s\S]*?)\s*Đáp án đúng\s*:/i);
        if (qm) q = qm[1].trim();

        // Lấy “Tất cả đáp án” (nếu có), nếu không thì lấy toàn khối sau dòng “Đáp án đúng”
        let zone = blk;
        const z1 = blk.match(/Tất cả đáp án\s*:\s*([\s\S]*)$/i);
        if (z1) {
          zone = z1[1];
        } else {
          const z2 = blk.match(/Đáp án đúng\s*:\s*.*?\n([\s\S]*)$/i);
          if (z2) zone = z2[1];
        }

        // 2) Tách đáp án: hỗ trợ đa dòng, ký hiệu ✓ nằm cùng dòng hoặc không
        const opts=[]; let correct=-1;

        // a) Ưu tiên bắt đa dòng cho đến trước dòng A./B./C./D. kế tiếp
        const optReMulti = /(^|\n)\s*([ABCD])\.\s*([^\n]*)(?:\n(?!\s*[ABCD]\.).+)*/gim;
        let mm; while((mm=optReMulti.exec(zone))!==null){
          const letter = mm[2].toUpperCase();
          const rawLine = mm[0].replace(/^\s*[\r\n]*/,'').trim();
          // Lấy nội dung (bỏ tiền tố "A. ", ký hiệu ✓ và khoảng trắng thừa)
          let line = rawLine.replace(/^[ABCD]\.\s*/i,'').trim();
          const hasTick = /✓/.test(line);
          line = line.replace(/✓/g,'').trim();
          opts.push({ t: line, letter });
          if (hasTick) correct = opts.length-1;
        }

        // b) Nếu vẫn chưa thấy đáp án, thử chế độ một dòng
        if (opts.length===0){
          const optRe = /^\s*([ABCD])\.\s*(.*)$/gim;
          let om; while((om=optRe.exec(zone))!==null){
            const letter = om[1].toUpperCase();
            let line = om[2].trim();
            const hasTick = /✓/.test(line);
            line = line.replace(/✓/g,'').trim();
            opts.push({ t: line, letter });
            if (hasTick) correct = opts.length-1;
          }
        }

        // c) Nếu vẫn chưa xác định đúng, so khớp với “Đáp án đúng: …”
        if (correct<0){
          const ans = blk.match(/Đáp án đúng\s*:\s*([\s\S]*?)(?:\n|$)/i);
          if (ans){
            const needle = norm(ans[1]);
            const idx = opts.findIndex(o => norm(o.t)===needle);
            if (idx>=0) correct=idx;
          }
        }

        // d) Trường hợp hiếm: thiếu tick + thiếu so khớp -> mặc định A
        if (opts.length===0){
          // Fallback tối hậu: tạo khung 4 đáp án để không vỡ UI
          ["A","B","C","D"].forEach(L=>opts.push({t:"(Không đọc được dòng đáp án trong dữ liệu gốc)", letter:L}));
          correct=0;
        }
        if (correct<0) correct=0;

        return { q, opts, correct };
      });

      return { subject: subjectName, questions };
    }

    // ====== UI ======
    function buildSubjectSelect(id){
      const sel=$(id); sel.innerHTML="";
      state.bank.forEach((b,i)=>{
        const o=document.createElement("option");
        o.value=String(i);
        o.textContent=`${b.subject} (${b.questions.length} câu)`;
        sel.appendChild(o);
      });
    }

    function buildNumberPads(){
      const make = (i) => {
        const b=document.createElement("button");
        b.type="button"; b.className="num w-10 h-10 rounded-xl border border-slate-800 bg-slate-900 text-sm";
        b.textContent=i+1; b.dataset.idx=String(i);
        b.onclick=()=>go(i);
        return b;
      };
      [ $("numberGrid"), $("numberGridMobile") ].forEach(el=>{
        if(!el) return; el.innerHTML="";
        for(let i=0;i<state.count;i++) el.appendChild(make(i));
      });
    }
    function paintPads(){
      document.querySelectorAll("#numberGrid .num, #numberGridMobile .num").forEach(btn=>{
        const i=+btn.dataset.idx;
        btn.classList.toggle("current", i===state.current);
        btn.classList.toggle("answered", state.chosen[i]!=null);
        btn.classList.toggle("marked", state.marked.has(i));
      });
    }

    function renderQuestion(){
      const i=state.current, q=state.questions[i]; if(!q) return;
      $("qIndex").textContent = `Câu ${i+1}/${state.count}`;
      $("question").textContent = q.q;

      const ul=$("answers"); ul.innerHTML="";
      q.opts.forEach((op,idx)=>{
        const id=`q${i}_o${idx}`;
        const li=document.createElement("li");
        li.className="rounded-xl border border-slate-800 bg-slate-900 p-3";
        li.innerHTML = `
          <label class="flex items-start gap-3">
            <input type="radio" name="q${i}" id="${id}" class="mt-1.5 h-5 w-5 shrink-0 accent-sky-500">
            <span class="flex min-w-0 items-start gap-2">
              <span class="inline-grid h-6 w-6 shrink-0 place-items-center rounded-lg border border-slate-700 bg-slate-800 font-bold">${op.letter}</span>
              <span class="text-sm leading-6 break-words" id="${id}_t"></span>
            </span>
          </label>`;
        li.querySelector(`#${id}_t`).textContent = op.t;
        ul.appendChild(li);
        li.querySelector("input").addEventListener("change", ()=>{
          state.chosen[i]=idx; updateProgress(); paintPads(); $("clear").disabled=false;
        });
      });

      const chosen=state.chosen[i];
      if(chosen!=null){ const el=document.getElementById(`q${i}_o${chosen}`); if(el) el.checked=true; $("clear").disabled=false; }
      else { $("clear").disabled=true; }

      $("prev").disabled = i===0;
      $("next").disabled = i>=state.count-1;
      paintPads();

      // cuộn lên đầu thẻ câu hỏi trên mobile cho đỡ rối
      $("questionCard").scrollIntoView({behavior:'smooth', block:'start'});
    }

    function updateBadges(){
      const idx = +($("subject")?.value ?? 0) || +($("subject_m")?.value ?? 0) || 0;
      const modeVal = ($("mode")?.value) || ($("mode_m")?.value) || "practice";
      $("subjectBadge").textContent = state.bank[idx]?.subject || "—";
      $("modeBadge").textContent = modeVal==="exam" ? "Thi" : "Luyện tập";
    }

    function updateProgress(){
      const answered = Object.keys(state.chosen).length;
      $("progressText").textContent = `${answered}/${state.count}`;
      const pct = state.count? Math.round(answered/state.count*100):0;
      $("progressBar").style.width = pct + "%";
      $("submit").disabled = answered===0;
    }

    function go(i){ if(i>=0 && i<state.count){ state.current=i; renderQuestion(); } }

    // ====== FLOW ======
    function getControls(){
      // Ưu tiên desktop nếu đang hiển thị, ngược lại mobile
      const isDesktop = window.matchMedia("(min-width: 768px)").matches;
      const read = (id, id_m, isBool=false) => {
        const el = $(isDesktop? id : id_m) || $(id) || $(id_m);
        return isBool ? !!el?.checked : (el?.value ?? "");
      };
      return {
        sidx: +(read("subject","subject_m") || 0),
        mode: read("mode","mode_m"),
        count: +(read("count","count_m") || 0),
        shuffle: read("shuffle","shuffle_m", true),
      };
    }

    function start(){
      const {sidx, mode, count, shuffle} = getControls();
      const bank = state.bank[sidx];
      if(!bank || !bank.questions.length){
        $("question").textContent="Không tìm thấy câu hỏi trong dữ liệu."; $("answers").innerHTML=""; return;
      }

      const req = +(count || bank.questions.length);
      const n = Math.max(1, Math.min(req, bank.questions.length));

      state.questions = bank.questions.slice();
      if (shuffle) state.questions = shuffleArr(state.questions).map(shuffleOptions);
      state.questions = state.questions.slice(0, n);

      state.count = state.questions.length;
      state.current = 0;
      state.chosen = {};
      state.marked.clear();

      // cập nhật badge & lưới số câu
      updateBadges();
      buildNumberPads();
      updateProgress();
      renderQuestion();

      // bật nút
      ["next","prev","clear","submit"].forEach(id => $(id).disabled=false);
      $("result").hidden = true; $("retry").hidden = true;
    }

    function submit(){
      let correct=0; const parts=[];
      state.questions.forEach((q,i)=>{
        const pick=state.chosen[i];
        const ok = (pick===q.correct);
        if(ok) correct++;
        parts.push(`
          <div class="mb-3 rounded-xl border border-slate-800 bg-slate-900 p-3">
            <div class="mb-2 text-sm text-slate-400">Câu ${i+1}</div>
            <div class="mb-2">${escapeHtml(q.q)}</div>
            <ul class="space-y-1 text-sm">
              ${q.opts.map((op,idx)=>{
                const isC = idx===q.correct;
                const isU = idx===pick;
                const cls = isC ? "b-ok" : isU ? "b-bad" : "b-ghost";
                return `<li><span class="${cls}">${op.letter}</span> ${escapeHtml(op.t)}</li>`;
              }).join("")}
            </ul>
          </div>`);
      });
      const score = Math.round((correct/state.count)*100);
      $("result").innerHTML = `
        <div class="mb-3 flex flex-wrap items-center gap-2">
          <div class="rounded-xl bg-gradient-to-b from-brand-500 to-brand-600 px-3 py-1.5 font-semibold text-slate-950 shadow-soft">
            Điểm: ${correct}/${state.count} (${score}%)
          </div>
          <div class="rounded-xl border border-slate-800 bg-slate-900 px-3 py-1.5 text-slate-300">
            Chế độ: ${($("mode")?.value||$("mode_m")?.value)==="exam"?"Thi":"Luyện tập"}
          </div>
        </div>
        ${parts.join("")}`;
      $("result").hidden=false; $("retry").hidden=false;
      ["next","prev","clear","submit"].forEach(id => $(id).disabled=true);
    }

    // ====== Utils ======
    function norm(s){
      return String(s||"")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/<[^>]+>/g,"")
        .replace(/[\s·•\u00A0]+/g," ")
        .toLowerCase().trim();
    }
    function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
    function shuffleArr(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function shuffleOptions(q){
      const order=[...q.opts.keys()]; shuffleArr(order);
      const opts = order.map(i=>q.opts[i]);
      const correct = order.indexOf(q.correct);
      return { q:q.q, opts, correct };
    }
  })();
  </script>
</body>
</html>
