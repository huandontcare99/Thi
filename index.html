<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Quiz Pro+  ‚Äî √în luy·ªán & Thi th·ª≠</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme:{
        extend:{
          colors:{ brand:'#2563eb', ok:'#22c55e', bad:'#ef4444', ink:'#0f172a'},
          boxShadow:{ soft:'0 10px 25px -10px rgba(0,0,0,.15)'},
          borderRadius:{ xl2:'1rem' },
          animation:{
            'slide-in':'slideIn .25s ease-out',
            'fade-in':'fadeIn .25s ease-out',
            'shake':'shake .35s ease-in-out',
            'pop':'pop .22s ease-out',
          },
          keyframes:{
            slideIn:{ '0%':{transform:'translateY(6px)',opacity:0}, '100%':{transform:'translateY(0)',opacity:1}},
            fadeIn:{ '0%':{opacity:0}, '100%':{opacity:1}},
            shake:{ '0%,100%':{transform:'translateX(0)'}, '25%':{transform:'translateX(-6px)'}, '75%':{transform:'translateX(6px)'} },
            pop:{ '0%':{transform:'scale(.96)',opacity:.8}, '100%':{transform:'scale(1)',opacity:1} }
          }
        }
      }
    }
  </script>

  <style>
    :root{ color-scheme: light; }
    /* Radio ƒë·∫πp & v√πng ch·∫°m l·ªõn */
    .opt input[type="radio"]{ display:none; }
    .opt input[type="radio"]+label{
      display:block; border:1px solid rgb(226 232 240); border-radius:14px;
      padding:12px 14px; background:#fff;
    }
    .opt input[type="radio"]:checked+label{
      border-color: rgb(59 130 246);
      outline: 3px solid rgba(59,130,246,.14);
    }
    .is-correct{ border-color: rgb(34 197 94)!important; background:#f0fdf4!important; }
    .is-wrong{ border-color: rgb(239 68 68)!important; background:#fef2f2!important; }
    /* Donut chart */
    .donut { --p: 0; width:120px; height:120px; border-radius:999px;
      background: conic-gradient(#22c55e var(--p), #e2e8f0 0); }
    /* iOS font-size ƒë·ªÉ kh√¥ng auto-zoom */
    @media (max-width:380px){ select,input,button{ font-size:16px; } }
  </style>

  <!-- (T√πy ch·ªçn) T·ª± load data.js n·∫øu c√≥ c√πng th∆∞ m·ª•c -->
  <script src="data.js" defer></script>
  <!-- Confetti nh·∫π nh√†ng -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer></script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
  <!-- Header g·ªçn, kh√¥ng che n·ªôi dung -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/85 border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-3 py-2">
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-xl2 bg-brand text-white flex items-center justify-center font-bold shadow-soft">Q+</div>
        <div class="min-w-0">
          <h1 class="text-base font-semibold leading-tight">Quiz Pro+</h1>
          <p class="text-xs text-slate-500 leading-tight">L√†m b√†i ‚Ä¢ Ch·∫•m ƒëi·ªÉm ‚Ä¢ √în c√¢u sai</p>
        </div>
        <button id="btnToolbar" class="ml-auto px-3 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">
          B·∫£ng ƒëi·ªÅu khi·ªÉn
        </button>
      </div>

      <!-- Toolbar: x·∫øp d·ªçc tr√™n mobile -->
      <div id="toolbar" class="mt-2 grid grid-cols-1 gap-2 md:grid-cols-2 lg:grid-cols-3">
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">M√¥n</label>
          <select id="subjectSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option>ƒêang n·∫°p d·ªØ li·ªáu‚Ä¶</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">Ch·∫ø ƒë·ªô</label>
          <select id="modeSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option value="study">H·ªçc (hi·ªán ƒë√°p √°n)</option>
            <option value="practice" selected>Luy·ªán t·∫≠p (ch·∫•m ngay)</option>
            <option value="exam">Thi th·ª≠ (ch·∫•m cu·ªëi, c√≥ gi·ªù)</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">S·ªë c√¢u</label>
          <select id="countSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="30">30</option>
            <option value="all">T·∫•t c·∫£</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">S·∫Øp x·∫øp</label>
          <select id="orderSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option value="sequence">Theo th·ª© t·ª±</option>
            <option value="shuffle" selected>Ng·∫´u nhi√™n</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">B·ªô l·ªçc</label>
          <select id="filterSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option value="all" selected>T·∫•t c·∫£</option>
            <option value="bookmarked">ƒê√£ ƒë√°nh d·∫•u</option>
            <option value="wrong">Sai g·∫ßn ƒë√¢y</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">T√¨m</label>
          <input id="searchInput" placeholder="T·ª´ kh√≥a c√¢u h·ªèi‚Ä¶" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2" />
        </div>

        <div class="md:col-span-2 lg:col-span-3 flex gap-2 mt-1">
          <button id="btnStart" class="flex-1 bg-brand hover:bg-blue-700 text-white rounded-xl2 px-4 py-3 font-semibold shadow-soft">
            B·∫Øt ƒë·∫ßu
          </button>
          <button id="btnReset" class="px-4 py-3 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">
            X√≥a l·ªãch s·ª≠
          </button>
          <button id="btnLoadFile" class="px-4 py-3 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">
            üìÅ N·∫°p d·ªØ li·ªáu
          </button>
          <input id="fileInput" type="file" accept=".js,.txt,.json" class="hidden" />
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-3 pb-28">
    <!-- Top status: ƒë√∫ng/sai/ƒë√£ l√†m + progress + timer -->
    <section class="mt-3 rounded-2xl bg-white border border-slate-200 p-3 shadow-soft">
      <div class="flex items-center gap-3">
        <div class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600" id="badgeSubject">M√¥n</div>
        <div class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600" id="badgeMode">Ch·∫ø ƒë·ªô</div>
        <div class="ml-auto text-xs text-slate-500" id="timerBox" hidden>‚è± <span id="timer">00:00</span></div>
      </div>

      <div class="mt-3 grid grid-cols-3 gap-2 text-center">
        <div class="rounded-xl bg-green-50 py-2"><div class="text-xs text-green-700">ƒê√∫ng</div><div id="statCorrect" class="text-lg font-bold text-green-700">0</div></div>
        <div class="rounded-xl bg-rose-50 py-2"><div class="text-xs text-rose-700">Sai</div><div id="statWrong" class="text-lg font-bold text-rose-700">0</div></div>
        <div class="rounded-xl bg-slate-50 py-2"><div class="text-xs text-slate-600">ƒê√£ l√†m</div><div id="statDone" class="text-lg font-bold text-slate-700">0</div></div>
      </div>

      <div class="mt-3 h-2 w-full bg-slate-200 rounded-full overflow-hidden">
        <div id="progressBar" class="h-2 bg-brand transition-[width] duration-300" style="width:0%"></div>
      </div>
      <div class="mt-1 text-xs text-slate-500" id="progressText">0 / 0</div>
    </section>

    <!-- Empty hint -->
    <div id="emptyMsg" class="mt-3 bg-amber-50 border border-amber-200 text-amber-800 rounded-xl2 p-3 text-sm">
      Ch∆∞a c√≥ b√†i. ƒê·∫∑t <b>index.html</b> c·∫°nh file <b>data.js</b> ho·∫∑c <b>data.txt</b>, r·ªìi nh·∫•n <b>B·∫Øt ƒë·∫ßu</b>.
      N·∫øu v·∫´n ch∆∞a ƒë·ªçc ƒë∆∞·ª£c, b·∫•m <b>üìÅ N·∫°p d·ªØ li·ªáu</b> ƒë·ªÉ ch·ªçn file th·ªß c√¥ng.
    </div>

    <!-- Play view -->
    <article id="card" class="hidden mt-3 rounded-2xl bg-white border border-slate-200 shadow-soft p-4 animate-fade-in">
      <h2 id="qTitle" class="text-base font-semibold"></h2>
      <div id="optList" class="mt-3 space-y-2"></div>

      <div id="explainBox" class="mt-4 hidden animate-slide-in">
        <div class="text-sm font-semibold mb-1">Gi·∫£i th√≠ch</div>
        <div id="explain" class="text-sm text-slate-700"></div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnPrev" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">‚Üê Tr∆∞·ªõc</button>
        <button id="btnNext" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Ti·∫øp ‚Üí</button>
        <button id="btnCheck" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Ch·∫•m c√¢u n√†y</button>
        <button id="btnReveal" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Hi·ªán ƒë√°p √°n</button>
        <button id="btnBookmark" class="ml-auto px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">üîñ ƒê√°nh d·∫•u</button>
        <button id="btnSubmit" class="px-4 py-2 rounded-xl2 bg-brand text-white hover:bg-blue-700">N·ªôp b√†i</button>
      </div>
    </article>

    <!-- Result view -->
    <article id="resultCard" class="hidden mt-3 rounded-2xl bg-white border border-slate-200 shadow-soft p-4 animate-pop">
      <div class="flex items-center gap-4">
        <div id="donut" class="donut" style="--p:0deg"></div>
        <div>
          <h3 class="text-lg font-bold mb-1">K·∫øt qu·∫£</h3>
          <p id="scoreText" class="text-sm text-slate-700"></p>
          <div class="text-xs text-slate-500" id="timeText"></div>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnReviewWrong" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Luy·ªán l·∫°i c√¢u sai</button>
        <button id="btnRestart" class="px-4 py-2 rounded-xl2 bg-brand text-white hover:bg-blue-700">L√†m l·∫°i</button>
      </div>
    </article>

    <!-- Review Wrong view -->
    <article id="reviewCard" class="hidden mt-3 rounded-2xl bg-white border border-slate-200 shadow-soft p-4 animate-fade-in">
      <div class="flex items-center gap-2">
        <div class="text-sm font-semibold">√în l·∫°i c√¢u sai</div>
        <div class="ml-auto text-xs text-slate-500" id="reviewMeta"></div>
      </div>
      <h2 id="rTitle" class="mt-2 text-base font-semibold"></h2>
      <div id="rOptList" class="mt-2 space-y-2"></div>
      <div id="rExplainBox" class="mt-3 hidden">
        <div class="text-sm font-semibold mb-1">Gi·∫£i th√≠ch</div>
        <div id="rExplain" class="text-sm text-slate-700"></div>
      </div>
      <div class="mt-4 flex flex-wrap gap-2">
        <button id="rPrev" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">‚Üê Tr∆∞·ªõc</button>
        <button id="rNext" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Ti·∫øp ‚Üí</button>
        <button id="rReveal" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Hi·ªán ƒë√°p √°n</button>
        <button id="rMastered" class="ml-auto px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">ƒê√£ hi·ªÉu ‚úì</button>
        <button id="rExit" class="px-4 py-2 rounded-xl2 bg-brand text-white hover:bg-blue-700">Tho√°t √¥n sai</button>
      </div>
    </article>

    <!-- Danh s√°ch c√¢u (bottom sheet) -->
    <div id="sheet" class="fixed inset-x-0 bottom-0 z-30 hidden">
      <div class="mx-auto max-w-4xl rounded-t-2xl bg-white shadow-2xl border border-slate-200 animate-slide-in">
        <div class="p-3 flex items-center gap-2 border-b border-slate-200">
          <div class="font-semibold">Danh s√°ch c√¢u</div>
          <button id="sheetClose" class="ml-auto px-3 py-1 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">ƒê√≥ng</button>
        </div>
        <div id="qGrid" class="p-3 grid grid-cols-10 gap-1 max-h-[40vh] overflow-auto"></div>
      </div>
    </div>
  </main>

  <!-- FAB -->
  <button id="fab" class="fixed bottom-4 right-4 z-20 rounded-full bg-brand text-white w-12 h-12 shadow-soft hover:bg-blue-700" title="Danh s√°ch c√¢u">#</button>

  <!-- Bottom action bar (mobile) -->
  <footer class="fixed inset-x-0 bottom-0 z-30">
    <div class="max-w-4xl mx-auto px-3 pb-[env(safe-area-inset-bottom)]">
      <div class="rounded-2xl bg-white border border-slate-200 shadow-soft p-2 flex gap-2">
        <button id="bPrev" class="flex-1 px-3 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">‚Üê</button>
        <button id="bReveal" class="px-3 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">ƒê√°p √°n</button>
        <button id="bCheck" class="px-3 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Ch·∫•m</button>
        <button id="bSubmit" class="px-3 py-2 rounded-xl2 bg-brand text-white hover:bg-blue-700">N·ªôp</button>
        <button id="bNext" class="flex-1 px-3 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">‚Üí</button>
      </div>
    </div>
  </footer>

  <!-- App -->
  <script>
  (function(){
    "use strict";

    // ===== Shortcuts =====
    const $  = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const byId = id => document.getElementById(id);

    // Safe get
    const safe = (id)=>{ const el=byId(id); if(!el) console.warn('Missing',id); return el; };

    // ===== Normalize helpers =====
    const normalize = (s) => (s ?? "")
      .toString()
      .replace(/\s+/g,' ')
      .trim()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[‚Äú‚Äù"']/g,'')
      .toLowerCase();

    const debounce = (fn,ms=200)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

    const choiceLetters = ['A','B','C','D','E','F'];
    const LS_BOOK = 'quizpro_bookmarks';
    const LS_WRONG = 'quizpro_wrong';
    const LS_STATS = 'quizpro_stats';

    const loadLS = (k, def) => { try{return JSON.parse(localStorage.getItem(k)) ?? def;}catch{return def;} };
    const saveLS = (k,v) => localStorage.setItem(k, JSON.stringify(v));

    // ===== Robust legacy RAW parser =====
    function parseLegacyText(raw){
      if(!raw) return [];
      const blocks=[]; const re=/(^|\n)C√¢u\s*\d+\s*:[\s\S]*?(?=(?:\n[-=]{3,}\s*\n)|(?:\n\s*C√¢u\s*\d+\s*:)|\s*$)/gi;
      let m; while((m=re.exec(raw))){ blocks.push(m[0]); }

      const qs=[];
      for(const b of blocks){
        const qm=/C√¢u\s*\d+\s*:\s*([\s\S]*?)\n\s*ƒê√°p √°n ƒë√∫ng:\s*([^\n]+)\s*\n/i.exec(b);
        if(!qm) continue;
        const qText=qm[1].trim();
        const correctText=qm[2].trim();

        let optPart=/T·∫•t c·∫£ ƒë√°p √°n:\s*([\s\S]*)/i.exec(b)?.[1] ?? '';
        const lines=optPart.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

        const opts=[];
        for(const ln of lines){
          const m2=/^([A-Zƒê])\.\s*(.*)$/.exec(ln);
          if(!m2) continue;
          const letter=m2[1].toUpperCase();
          let text=m2[2].trim();
          const hasCheck=/‚úì/.test(text);
          text=text.replace(/^‚úì\s*/,'').replace(/\s*‚úì\s*$/,'').trim();
          opts.push({letter,text,hasCheck});
        }
        if(!opts.length) continue;

        let answerIndex=opts.findIndex(o=>o.hasCheck);
        if(answerIndex<0){
          const normCorrect=normalize(correctText);
          answerIndex=opts.findIndex(o=>normalize(o.text)===normCorrect);
          if(answerIndex<0){
            answerIndex=opts.findIndex(o=>normalize(o.text).includes(normCorrect)||normCorrect.includes(normalize(o.text)));
          }
        }
        if(answerIndex<0) answerIndex=0;

        qs.push({ text:qText, options:opts.map(o=>o.text), answer:answerIndex, explain:'' });
      }
      return qs;
    }

    function inferSubjectName(raw, fallback){
      const m=/M√îN\s*[:Ôºö]\s*([^\n]+)\n/i.exec(raw||'');
      return (m?m[1].trim():fallback||'M√¥n');
    }

    function parseDataJsText(jsText){
      const subjects=[];
      if(!jsText) return subjects;

      const subjMap={};
      const subjRe=/const\s+SUBJECT_([A-Za-z0-9_]+)\s*=\s*"([^"]*)"/g;
      let sm; while((sm=subjRe.exec(jsText))){
        subjMap[sm[1]] = sm[2];
      }

      const rawRe=/const\s+(RAW_([A-Za-z0-9_]+))\s*=\s*String\.raw`([\s\S]*?)`;/g;
      let rm; while((rm=rawRe.exec(jsText))){
        const key = rm[2];
        const raw = rm[3];
        const name = subjMap[key] || inferSubjectName(raw, key);
        subjects.push({ name, questions: parseLegacyText(raw) });
      }

      if(subjects.length===0){
        const allRaw=[...jsText.matchAll(/String\.raw`([\s\S]*?)`/g)].map(x=>x[1]);
        for(const raw of allRaw){
          const name=inferSubjectName(raw, 'M√¥n');
          const qs=parseLegacyText(raw);
          if(qs.length) subjects.push({ name, questions: qs });
        }
      }
      return subjects;
    }

    function parseJsonText(txt){
      try{
        const data=JSON.parse(txt);
        if(Array.isArray(data?.subjects)){
          return data.subjects.map(s=>({
            name: s.name || 'M√¥n',
            questions: s.questions?.map(q=>({ text:q.text, options:q.options, answer:q.answer, explain:q.explain||'' }))||[]
          }));
        }
      }catch{}
      return [];
    }

    async function loadSubjectsAuto(){
      if(window.quizDataJSON?.subjects?.length){
        return window.quizDataJSON.subjects.map(s=>({
          name:s.name, questions:s.questions.map(q=>({text:q.text,options:q.options,answer:q.answer,explain:q.explain||''}))
        }));
      }
      if(window.quizData?.getAll){
        try{
          const arr=window.quizData.getAll();
          return arr.map(it=>({ name: it.subject, questions: parseLegacyText(String(it.text||'')) }));
        }catch(e){ console.warn('L·ªói quizData.getAll()', e); }
      }
      const rawKeys = Object.keys(window).filter(k=>/^RAW_/.test(k));
      if(rawKeys.length){
        const subjects=[];
        for(const k of rawKeys){
          const raw=String(window[k]||'');
          const suffix=k.replace(/^RAW_/,'');
          const subjName=(window['SUBJECT_'+suffix]||inferSubjectName(raw,suffix));
          subjects.push({ name:subjName, questions:parseLegacyText(raw) });
        }
        if(subjects.length) return subjects;
      }
      try{
        const res = await fetch('data.txt', {cache:'no-store'});
        if(res.ok){
          const txt = await res.text();
          const rawQs = parseLegacyText(txt);
          if(rawQs.length) return [{ name: inferSubjectName(txt,'M√¥n'), questions: rawQs }];
          const jsonSubs = parseJsonText(txt);
          if(jsonSubs.length) return jsonSubs;
        }
      }catch{}
      return [];
    }

    // ====== State ======
    const state={
      subjects:[],
      subjectIdx:0,
      mode:'practice',
      order:'shuffle',
      filter:'all',
      search:'',
      pool:[],
      cur:0,
      answers:{},
      checked:{},
      correct:0,
      wrong:0,
      bookmarks: loadLS(LS_BOOK,{}),
      wrongBank: loadLS(LS_WRONG,[]),
      stats: loadLS(LS_STATS,{ total:0, correct:0 }),
      timer:null,
      seconds:0,
      review:{ list:[], idx:0 }
    };

    // ====== Refs ======
    const subjectSelect = safe('subjectSelect');
    const modeSelect = safe('modeSelect');
    const countSelect = safe('countSelect');
    const orderSelect = safe('orderSelect');
    const filterSelect = safe('filterSelect');
    const searchInput = safe('searchInput');
    const btnStart = safe('btnStart');
    const btnReset = safe('btnReset');
    const btnToolbar = safe('btnToolbar');
    const btnLoadFile = safe('btnLoadFile');
    const fileInput = safe('fileInput');
    const toolbar = safe('toolbar');

    const emptyMsg = safe('emptyMsg');
    const card = safe('card');
    const badgeSubject = safe('badgeSubject');
    const badgeMode = safe('badgeMode');
    const timerBox = safe('timerBox'); const timerLbl = safe('timer');

    const statCorrect = safe('statCorrect');
    const statWrong = safe('statWrong');
    const statDone = safe('statDone');

    const qTitle = safe('qTitle');
    const optList = safe('optList');
    const explainBox = safe('explainBox'); const explain = safe('explain');

    const btnPrev = safe('btnPrev');
    const btnNext = safe('btnNext');
    const btnCheck = safe('btnCheck');
    const btnReveal = safe('btnReveal');
    const btnBookmark = safe('btnBookmark');
    const btnSubmit = safe('btnSubmit');

    const progressBar = safe('progressBar');
    const progressText = safe('progressText');

    const resultCard = safe('resultCard');
    const scoreText = safe('scoreText');
    const timeText = safe('timeText');
    const donut = safe('donut');
    const btnReviewWrong = safe('btnReviewWrong');
    const btnRestart = safe('btnRestart');

    const reviewCard = safe('reviewCard');
    const rTitle = safe('rTitle');
    const rOptList = safe('rOptList');
    const rExplainBox = safe('rExplainBox'); const rExplain = safe('rExplain');
    const rPrev = safe('rPrev'); const rNext=safe('rNext'); const rReveal=safe('rReveal'); const rMastered=safe('rMastered'); const rExit=safe('rExit');
    const reviewMeta = safe('reviewMeta');

    const sheet = safe('sheet'); const sheetClose = safe('sheetClose'); const qGrid = safe('qGrid');
    const fab = safe('fab');

    const bPrev=safe('bPrev'), bNext=safe('bNext'), bCheck=safe('bCheck'), bReveal=safe('bReveal'), bSubmit=safe('bSubmit');

    // ====== Init ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      // S·ª± ki·ªán UI (toolbar)
      btnStart.onclick = start;
      btnReset.onclick = resetAll;
      btnToolbar.onclick = ()=> toolbar.classList.toggle('hidden');
      btnLoadFile.onclick = ()=> fileInput.click();
      fileInput.onchange = handleFileInput;

      subjectSelect.onchange = ()=> state.subjectIdx = subjectSelect.selectedIndex;
      modeSelect.onchange = ()=> state.mode = modeSelect.value;
      orderSelect.onchange = ()=> state.order = orderSelect.value;
      filterSelect.onchange = ()=> state.filter = filterSelect.value;
      searchInput.oninput = debounce(()=> state.search = searchInput.value, 200);

      // S·ª± ki·ªán l√†m b√†i
      btnPrev.onclick = prevQ; btnNext.onclick = nextQ;
      btnCheck.onclick = checkThis; btnReveal.onclick = revealThis;
      btnBookmark.onclick = toggleBookmark; btnSubmit.onclick = submitAll;

      // Bottom bar (mobile quick)
      bPrev.onclick=prevQ; bNext.onclick=nextQ; bCheck.onclick=checkThis; bReveal.onclick=revealThis; bSubmit.onclick=submitAll;

      // Danh s√°ch c√¢u
      fab.onclick = ()=> sheet.classList.toggle('hidden');
      sheetClose.onclick = ()=> sheet.classList.add('hidden');

      // Vu·ªët chuy·ªÉn c√¢u
      attachSwipe();

      // N·∫°p subjects t·ª± ƒë·ªông
      state.subjects = await loadSubjectsAuto();
      renderSubjectOptions();
    });

    function renderSubjectOptions(){
      subjectSelect.innerHTML='';
      if(!state.subjects.length){
        subjectSelect.innerHTML='<option>Ch∆∞a ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu</option>';
        emptyMsg.classList.remove('hidden');
        card.classList.add('hidden');
        return;
      }
      state.subjects.forEach((s,i)=>{
        const opt=document.createElement('option');
        opt.value=i; opt.textContent=s.name || ('M√¥n '+(i+1));
        subjectSelect.appendChild(opt);
      });
      state.subjectIdx=0;
      emptyMsg.classList.remove('hidden');
    }

    async function handleFileInput(e){
      const file = e.target.files?.[0];
      if(!file) return;
      const txt = await file.text();

      let subs = parseJsonText(txt);
      if(!subs.length) subs = parseDataJsText(txt);
      if(!subs.length){
        const rawQs = parseLegacyText(txt);
        if(rawQs.length) subs=[{ name: inferSubjectName(txt,'M√¥n'), questions: rawQs }];
      }

      if(!subs.length){
        alert('Kh√¥ng tr√≠ch xu·∫•t ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ file n√†y. Vui l√≤ng ch·ªçn ƒë√∫ng file data.');
        return;
      }
      state.subjects = subs;
      renderSubjectOptions();
      alert('N·∫°p d·ªØ li·ªáu th√†nh c√¥ng!');
    }

    // ====== Pooling ======
    function makePool(){
      const subj = state.subjects[state.subjectIdx];
      if(!subj) return [];
      let arr = subj.questions.map((q,idx)=>({...q,_id:idx}));

      if(state.search.trim()){
        const key=normalize(state.search);
        arr=arr.filter(q => normalize(q.text).includes(key) || q.options.some(o=>normalize(o).includes(key)));
      }
      if(state.filter==='bookmarked'){
        arr=arr.filter(q => !!state.bookmarks[`${state.subjectIdx}:${q._id}`]);
      }else if(state.filter==='wrong'){
        const set=new Set(state.wrongBank.map(x=>`${x.s}:${x.q}`));
        arr=arr.filter(q=>set.has(`${state.subjectIdx}:${q._id}`));
      }
      const need = (countSelect.value==='all') ? arr.length : Math.min(+countSelect.value||20, arr.length);
      if(state.order==='shuffle') arr.sort(()=>Math.random()-.5);
      return arr.slice(0, need);
    }

    // ====== Start ======
    function start(){
      clearTimer();
      state.answers={}; state.checked={}; state.correct=0; state.wrong=0;
      resultCard.classList.add('hidden'); reviewCard.classList.add('hidden'); card.classList.add('hidden');

      state.pool = makePool();
      state.cur = 0;

      if(!state.pool.length){
        emptyMsg.classList.remove('hidden');
        updateProgress(); updateStatsUI(); return;
      }
      emptyMsg.classList.add('hidden');

      if(state.mode==='exam'){ startTimer(); }
      badgeSubject.textContent = state.subjects[state.subjectIdx]?.name || 'M√¥n';
      badgeMode.textContent = (state.mode==='study'?'H·ªçc':state.mode==='practice'?'Luy·ªán t·∫≠p':'Thi th·ª≠');

      renderQuestion(true);
      updateProgress(); buildGrid(); updateStatsUI();

      // Scroll l√™n th·∫ª card
      card.scrollIntoView({behavior:'smooth',block:'start'});
    }

    // ====== Render ======
    function renderQuestion(first=false){
      const q = state.pool[state.cur];
      if(!q){ card.classList.add('hidden'); return; }
      card.classList.remove('hidden');
      if(!first){ card.classList.remove('animate-fade-in'); void card.offsetWidth; card.classList.add('animate-fade-in'); }

      qTitle.textContent = `C√¢u ${state.cur+1}: ${q.text}`;
      optList.innerHTML=''; explainBox.classList.add('hidden'); explain.textContent=q.explain||'';

      q.options.forEach((o,i)=>{
        const id=`opt-${state.cur}-${i}`;
        const wrap=document.createElement('div'); wrap.className='opt';
        const input=document.createElement('input'); input.type='radio'; input.name=`q-${state.cur}`; input.id=id; input.value=i;
        input.checked = (state.answers[state.cur]===i);
        input.onchange = ()=>{
          state.answers[state.cur]=i;
          // Practice: ch·∫•m ngay
          if(state.mode==='practice'){ markOptions(true); }
        };
        const lab=document.createElement('label'); lab.setAttribute('for',id);
        lab.innerHTML=`<div class="flex gap-2"><div class="text-slate-500">${choiceLetters[i]||''}.</div><div class="flex-1 whitespace-normal break-words">${o}</div></div>`;
        wrap.appendChild(input); wrap.appendChild(lab); optList.appendChild(wrap);
      });

      // Toggle n√∫t theo mode
      btnCheck.classList.toggle('hidden', state.mode!=='practice');
      btnReveal.classList.toggle('hidden', state.mode!=='study');
      btnSubmit.classList.toggle('hidden', state.mode!=='exam');

      const key=`${state.subjectIdx}:${q._id}`;
      btnBookmark.textContent = state.bookmarks[key] ? 'üîñ ƒê√£ ƒë√°nh d·∫•u' : 'üîñ ƒê√°nh d·∫•u';
      timerBox.hidden = (state.mode!=='exam');

      clearMarks();
    }

    function clearMarks(){ $$('#optList label').forEach(el=>el.classList.remove('is-correct','is-wrong','animate-shake','animate-pop')); }
    function markOptions(fromChange=false){
      const q=state.pool[state.cur]; const pick=state.answers[state.cur];
      clearMarks();
      const labels=$$('#optList label');
      if(labels[q.answer]) { labels[q.answer].classList.add('is-correct','animate-pop'); }
      if(pick!=null && pick!==q.answer && labels[pick]) { labels[pick].classList.add('is-wrong','animate-shake'); }
      state.checked[state.cur]=true;

      // c·∫≠p nh·∫≠t th·ªëng k√™
      const prevRight = state.answers.__lastRight;
      const isRight = pick===q.answer;
      // ch·ªâ tƒÉng n·∫øu ch·∫•m l·∫ßn ƒë·∫ßu c·ªßa c√¢u n√†y
      if(fromChange && state.answers.__markedIndex!==state.cur){
        state.answers.__markedIndex = state.cur;
        if(isRight){ state.correct++; fireConfetti(); } else { state.wrong++; vibrate(20); }
        updateStatsUI();
      }
      if(state.mode==='practice' && q.explain) explainBox.classList.remove('hidden');
    }
    function revealThis(){
      const q=state.pool[state.cur]; const labels=$$('#optList label');
      clearMarks(); if(labels[q.answer]) labels[q.answer].classList.add('is-correct','animate-pop');
      if(q.explain) explainBox.classList.remove('hidden');
    }

    function toggleBookmark(){
      const q=state.pool[state.cur]; const key=`${state.subjectIdx}:${q._id}`;
      state.bookmarks[key]=!state.bookmarks[key]; saveLS(LS_BOOK,state.bookmarks);
      btnBookmark.textContent = state.bookmarks[key] ? 'üîñ ƒê√£ ƒë√°nh d·∫•u' : 'üîñ ƒê√°nh d·∫•u';
    }

    function prevQ(){ if(state.cur>0){ state.cur--; renderQuestion(); updateProgress(); } }
    function nextQ(){ if(state.cur<state.pool.length-1){ state.cur++; renderQuestion(); updateProgress(); } }

    function updateProgress(){
      const cur=state.cur+1, total=state.pool.length||0;
      progressText.textContent = `${cur>total?total:cur} / ${total}`;
      progressBar.style.width = total? `${(Math.min(cur,total)/total)*100}%` : '0%';
    }
    function updateStatsUI(){
      const done = Object.keys(state.checked).filter(k=>state.checked[k]).length;
      statCorrect.textContent = state.correct;
      statWrong.textContent = state.wrong;
      statDone.textContent = done;
    }

    // ====== Submit (Exam) ======
    function submitAll(){
      if(state.mode!=='exam'){ return; }
      const total=state.pool.length; let correct=0, wrongList=[];
      for(let i=0;i<total;i++){
        const q=state.pool[i];
        if(state.answers[i]===q.answer) correct++; else wrongList.push({s:state.subjectIdx,q:q._id});
      }
      const wrong=total-correct;

      // L∆∞u wrong bank
      state.wrongBank=(wrongList.concat(state.wrongBank)).slice(0,400);
      saveLS(LS_WRONG,state.wrongBank);

      // Th·ªëng k√™ t·ªïng
      state.stats.total += total; state.stats.correct += correct; saveLS(LS_STATS,state.stats);

      clearTimer();

      // UI k·∫øt qu·∫£
      const pct = Math.round(correct*100/Math.max(1,total));
      scoreText.textContent=`ƒê√∫ng ${correct}/${total} c√¢u (${pct}%).`;
      if(state.seconds>0){
        const m=Math.floor(state.seconds/60), s=state.seconds%60;
        timeText.textContent = `Th·ªùi gian: ${m}m ${s}s`;
      } else timeText.textContent='';

      donut.style.setProperty('--p', `${pct*3.6}deg`);
      resultCard.classList.remove('hidden'); card.classList.add('hidden');
      window.scrollTo({top:0,behavior:'smooth'});

      btnReviewWrong.onclick=enterReviewWrong;
      btnRestart.onclick=start;
    }

    function enterReviewWrong(){
      // L·∫•y danh s√°ch sai c·ªßa l·∫ßn v·ª´a r·ªìi (∆∞u ti√™n theo m√¥n hi·ªán t·∫°i)
      const set=new Set(state.wrongBank.map(x=>`${x.s}:${x.q}`));
      const subj = state.subjects[state.subjectIdx];
      const list = subj.questions
        .map((q,idx)=>({q, _id:idx}))
        .filter(item=>set.has(`${state.subjectIdx}:${item._id}`));
      if(!list.length){ alert('Kh√¥ng c√≥ c√¢u sai ƒë·ªÉ √¥n.'); return; }
      state.review.list = list; state.review.idx = 0;
      resultCard.classList.add('hidden'); card.classList.add('hidden'); reviewCard.classList.remove('hidden');
      renderReview();
    }

    function renderReview(){
      const item = state.review.list[state.review.idx];
      if(!item){ reviewCard.classList.add('hidden'); return; }
      reviewMeta.textContent = `C√¢u ${state.review.idx+1}/${state.review.list.length}`;
      rTitle.textContent = item.q.text;
      rOptList.innerHTML=''; rExplainBox.classList.add('hidden'); rExplain.textContent=item.q.explain||'';

      item.q.options.forEach((o,i)=>{
        const id=`r-${state.review.idx}-${i}`;
        const wrap=document.createElement('div'); wrap.className='opt';
        const input=document.createElement('input'); input.type='radio'; input.name=`rq-${state.review.idx}`; input.id=id; input.value=i;
        input.onchange=()=>{ // ch·∫•m ngay
          clearReviewMarks();
          const labs=$$('#rOptList label');
          if(labs[item.q.answer]) labs[item.q.answer].classList.add('is-correct','animate-pop');
          if(i!==item.q.answer && labs[i]) labs[i].classList.add('is-wrong','animate-shake');
          if(i===item.q.answer) fireConfetti(); else vibrate(20);
          if(item.q.explain) rExplainBox.classList.remove('hidden');
        };
        const lab=document.createElement('label'); lab.setAttribute('for',id);
        lab.innerHTML=`<div class="flex gap-2"><div class="text-slate-500">${choiceLetters[i]||''}.</div><div class="flex-1 whitespace-normal break-words">${o}</div></div>`;
        wrap.appendChild(input); wrap.appendChild(lab); rOptList.appendChild(wrap);
      });

      rPrev.onclick=()=>{ if(state.review.idx>0){ state.review.idx--; renderReview(); } };
      rNext.onclick=()=>{ if(state.review.idx<state.review.list.length-1){ state.review.idx++; renderReview(); } };
      rReveal.onclick=()=>{ clearReviewMarks(); const labs=$$('#rOptList label'); if(labs[item.q.answer]) labs[item.q.answer].classList.add('is-correct','animate-pop'); if(item.q.explain) rExplainBox.classList.remove('hidden'); };
      rMastered.onclick=()=>{
        // b·ªè kh·ªèi wrongBank
        const key=`${state.subjectIdx}:${item._id}`;
        state.wrongBank=state.wrongBank.filter(x=>`${x.s}:${x.q}`!==key);
        saveLS(LS_WRONG,state.wrongBank);
        // b·ªè kh·ªèi list hi·ªán t·∫°i
        state.review.list.splice(state.review.idx,1);
        if(state.review.idx>=state.review.list.length) state.review.idx=Math.max(0,state.review.list.length-1);
        if(state.review.list.length) renderReview(); else { alert('ƒê√£ ho√†n th√†nh √¥n sai.'); reviewCard.classList.add('hidden'); }
      };
      rExit.onclick=()=>{ reviewCard.classList.add('hidden'); };
    }
    function clearReviewMarks(){ $$('#rOptList label').forEach(el=>el.classList.remove('is-correct','is-wrong','animate-shake','animate-pop')); }

    // ====== Grid & FAB ======
    function buildGrid(){
      qGrid.innerHTML='';
      for(let i=0;i<state.pool.length;i++){
        const b=document.createElement('button');
        b.className='text-sm rounded-lg border border-slate-200 px-2 py-1 '+(i===state.cur?'bg-brand text-white border-brand':'bg-white hover:bg-slate-50');
        b.textContent=(i+1);
        b.onclick=()=>{ state.cur=i; renderQuestion(); updateProgress(); };
        qGrid.appendChild(b);
      }
    }

    // ====== Timer ======
    function startTimer(){
      state.seconds=0; timerLbl.textContent='00:00';
      state.timer=setInterval(()=>{
        state.seconds++;
        const m=String(Math.floor(state.seconds/60)).padStart(2,'0');
        const s=String(state.seconds%60).padStart(2,'0');
        timerLbl.textContent=`${m}:${s}`;
      },1000);
    }
    function clearTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

    // ====== Misc ======
    function resetAll(){
      localStorage.removeItem(LS_BOOK);
      localStorage.removeItem(LS_WRONG);
      localStorage.removeItem(LS_STATS);
      state.bookmarks={}; state.wrongBank=[]; state.stats={total:0,correct:0};
      alert('ƒê√£ x√≥a ƒë√°nh d·∫•u, sai g·∫ßn ƒë√¢y & th·ªëng k√™ t·ªïng.');
    }

    function attachSwipe(){
      let startX=0, startY=0, dx=0, dy=0;
      const area=$('main');
      area.addEventListener('touchstart', e=>{ const t=e.touches[0]; startX=t.clientX; startY=t.clientY; }, {passive:true});
      area.addEventListener('touchmove', e=>{ const t=e.touches[0]; dx=t.clientX-startX; dy=t.clientY-startY; }, {passive:true});
      area.addEventListener('touchend', ()=>{
        if(Math.abs(dx)>60 && Math.abs(dy)<40){
          if(dx<0) nextQ(); else prevQ();
        }
        dx=dy=0;
      }, {passive:true});
    }

    function fireConfetti(){
      if(typeof confetti!=='function') return;
      confetti({ particleCount: 40, spread: 55, origin: { y: .8 } });
    }
    function vibrate(ms){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch{} }

  })();
  </script>
</body>
</html>
