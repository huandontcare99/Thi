<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Quiz Ultra ‚Äî Setup & Thi</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors:{ brand:'#2563eb', ok:'#16a34a', bad:'#ef4444' },
        boxShadow:{ soft:'0 12px 28px -12px rgba(0,0,0,.18)' },
        animation:{
          fade:'fade .25s ease',
          slide:'slide .25s ease',
          pop:'pop .2s ease'
        },
        keyframes:{
          fade:{from:{opacity:0},to:{opacity:1}},
          slide:{from:{transform:'translateY(8px)',opacity:.0},to:{transform:'translateY(0)',opacity:1}},
          pop:{from:{transform:'scale(.98)'},to:{transform:'scale(1)'}}
        }
      }
    }
  }
</script>
<style>
  /* radio/checkbox ƒë·∫πp ‚Äì click c·∫£ block */
  .opt input{ display:none; }
  .opt input + label{
    display:block; border:1px solid rgb(226,232,240); background:#fff; border-radius:14px;
    padding:12px 14px; transition:all .15s ease; cursor:pointer;
  }
  .dark .opt input + label{ background:#0b1220; border-color:#1f2937; }
  .opt input:checked + label{ border-color:#2563eb; outline:3px solid rgba(37,99,235,.15); }
  .is-correct{ border-color:#16a34a !important; background:#f0fdf4 !important; }
  .dark .is-correct{ background:#0a1a0f !important; }
  .is-wrong{ border-color:#ef4444 !important; background:#fef2f2 !important; }
  .dark .is-wrong{ background:#2a0e10 !important; }
  /* donut k·∫øt qu·∫£ */
  .donut{ --p:0; width:120px; height:120px; border-radius:999px; background: conic-gradient(#16a34a var(--p), #e2e8f0 0); }
  .dark .donut{ background: conic-gradient(#16a34a var(--p), #334155 0); }
  /* ch·ªëng iOS ph√≥ng to khi focus */
  @media (max-width:380px){ select,input,button{ font-size:16px; } }
</style>

<!-- n·∫°p d·ªØ li·ªáu g·ªëc -->
<script src="data.js" defer></script>
<!-- confetti nh·∫π -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer></script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen">

<!-- ===== Header d√πng chung (nh·∫π, kh√¥ng che n·ªôi dung) ===== -->
<header class="sticky top-0 z-30 backdrop-blur bg-white/90 dark:bg-slate-900/80 border-b border-slate-200 dark:border-slate-800">
  <div class="max-w-4xl mx-auto px-3 py-2 flex items-center gap-3">
    <div class="w-9 h-9 rounded-xl bg-brand text-white flex items-center justify-center font-bold shadow-soft">U</div>
    <div class="min-w-0">
      <div class="text-sm font-semibold leading-5">Quiz Ultra</div>
      <div class="text-[11px] text-slate-500 dark:text-slate-400 -mt-1">Setup & L√†m b√†i (mobile-first)</div>
    </div>
    <div class="ml-auto flex items-center gap-2">
      <button id="btnTheme" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">üåô</button>
    </div>
  </div>
</header>

<main class="max-w-4xl mx-auto px-3 pb-24">
  <!-- ===== VIEW 1: SETUP ===== -->
  <section id="viewSetup" class="animate-fade">
    <!-- c·∫£nh b√°o -->
    <div id="warn" class="hidden mt-3 p-3 text-sm rounded-xl bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 text-amber-900 dark:text-amber-200">
      Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu g·ªëc. H√£y ch·∫Øc ch·∫Øn <b>index.html</b> ƒë·∫∑t <b>c√πng th∆∞ m·ª•c</b> v·ªõi <b>data.js</b>.
    </div>

    <!-- ch·ªçn m√¥n -->
    <div class="mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4 animate-slide">
      <div class="text-sm font-semibold mb-2">Ch·ªçn m√¥n</div>
      <select id="selSubject" class="w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
        <option>ƒêang n·∫°p‚Ä¶</option>
      </select>
    </div>

    <!-- ch·∫ø ƒë·ªô -->
    <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2">
      <button data-mode="study" class="modeBtn rounded-2xl p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft text-left">
        <div class="text-base font-bold">H·ªçc</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">Hi·ªán ƒë√°p √°n</div>
      </button>
      <button data-mode="practice" class="modeBtn rounded-2xl p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft text-left ring-2 ring-brand/60">
        <div class="text-base font-bold">Luy·ªán t·∫≠p</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">Ch·∫•m ngay</div>
      </button>
      <button data-mode="exam" class="modeBtn rounded-2xl p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft text-left">
        <div class="text-base font-bold">Thi th·ª≠</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">Ch·∫•m cu·ªëi + th·ªùi gian</div>
      </button>
      <button data-mode="flash" class="modeBtn rounded-2xl p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft text-left">
        <div class="text-base font-bold">Flashcard</div>
        <div class="text-xs text-slate-500 dark:text-slate-400">ƒê·∫£o m·∫∑t, SRS nh·∫π</div>
      </button>
    </div>

    <!-- th√¥ng s·ªë -->
    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
        <label class="text-sm font-semibold">S·ªë c√¢u</label>
        <select id="selCount" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="30">30</option>
          <option value="all">T·∫•t c·∫£</option>
        </select>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm font-semibold">Th·ª© t·ª±</label>
            <select id="selOrder" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
              <option value="sequence">Theo th·ª© t·ª±</option>
              <option value="shuffle" selected>Ng·∫´u nhi√™n</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-semibold">B·ªô l·ªçc</label>
            <select id="selFilter" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
              <option value="all" selected>T·∫•t c·∫£</option>
              <option value="bookmarked">ƒê√£ ƒë√°nh d·∫•u</option>
              <option value="wrong">Sai g·∫ßn ƒë√¢y</option>
            </select>
          </div>
        </div>
      </div>

      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
        <label class="text-sm font-semibold">T√¨m ki·∫øm</label>
        <input id="txtSearch" placeholder="T·ª´ kh√≥a trong c√¢u/ƒë√°p √°n‚Ä¶" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2"/>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btnWrong" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">√în c√¢u sai</button>
          <button id="btnExport" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚¨áÔ∏è Xu·∫•t ti·∫øn tr√¨nh</button>
          <button id="btnImport" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚¨ÜÔ∏è Nh·∫≠p ti·∫øn tr√¨nh</button>
          <input id="fileImport" type="file" accept=".json" class="hidden"/>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <button id="btnStart" class="w-full bg-brand hover:bg-blue-700 text-white rounded-2xl px-5 py-4 font-semibold shadow-soft">B·∫ÆT ƒê·∫¶U</button>
    </div>
  </section>

  <!-- ===== VIEW 2: L√ÄM B√ÄI ===== -->
  <section id="viewPlay" class="hidden animate-fade">
    <!-- Top info -->
    <div class="mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-3">
      <div class="flex items-center gap-2">
        <button id="btnBackSetup" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üê Setup</button>
        <div id="badgeSubj" class="text-xs px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">M√¥n</div>
        <div id="badgeMode" class="text-xs px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">Ch·∫ø ƒë·ªô</div>
        <div class="ml-auto text-xs text-slate-500 dark:text-slate-400" id="timerBox" hidden>‚è± <span id="timer">00:00</span></div>
      </div>
      <div class="mt-2 h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
        <div id="progress" class="h-2 bg-brand" style="width:0%"></div>
      </div>
      <div id="progText" class="mt-1 text-xs text-slate-500 dark:text-slate-400">0 / 0</div>
    </div>

    <!-- Question Card -->
    <article id="qCard" class="hidden mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
      <h2 id="qTitle" class="text-base font-semibold"></h2>
      <div id="optList" class="mt-3 space-y-2"></div>

      <div id="expWrap" class="mt-4 hidden animate-slide">
        <div class="text-sm font-semibold mb-1">Gi·∫£i th√≠ch</div>
        <div id="expText" class="text-sm text-slate-700 dark:text-slate-300"></div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnPrev" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üê Tr∆∞·ªõc</button>
        <button id="btnNext" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Ti·∫øp ‚Üí</button>
        <button id="btnCheck" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Ch·∫•m</button>
        <button id="btnReveal" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Hi·ªán ƒë√°p √°n</button>
        <button id="btnBookmark" class="ml-auto px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">üîñ ƒê√°nh d·∫•u</button>
        <button id="btnSubmit" class="px-4 py-2 rounded-xl bg-brand text-white">N·ªôp b√†i</button>
      </div>
    </article>

    <!-- Flashcards -->
    <article id="flashWrap" class="hidden mt-3 animate-pop">
      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
        <div id="fcFront" class="text-base font-semibold"></div>
        <div id="fcBack" class="mt-2 text-sm hidden"></div>
        <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">Ch·∫°m ‚ÄúL·∫≠t‚Äù ƒë·ªÉ xem ƒë√°p √°n</div>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="fcPrev" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üê</button>
          <button id="fcFlip" class="px-4 py-2 rounded-xl bg-brand text-white">L·∫≠t</button>
          <button id="fcAgain" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">üïë Ch∆∞a nh·ªõ</button>
          <button id="fcGood" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚úì Nh·ªõ r·ªìi</button>
          <button id="fcNext" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üí</button>
        </div>
        <div id="fcMeta" class="mt-1 text-xs text-slate-500 dark:text-slate-400"></div>
      </div>
    </article>

    <!-- Result -->
    <article id="resultCard" class="hidden mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4 animate-pop">
      <div class="flex items-center gap-4">
        <div id="donut" class="donut" style="--p:0deg"></div>
        <div>
          <h3 class="text-lg font-bold mb-1">K·∫øt qu·∫£</h3>
          <p id="scoreText" class="text-sm text-slate-700 dark:text-slate-300"></p>
          <div id="timeText" class="text-xs text-slate-500 dark:text-slate-400"></div>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnReviewWrong" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Luy·ªán l·∫°i c√¢u sai</button>
        <button id="btnRestart" class="px-4 py-2 rounded-xl bg-brand text-white">L√†m l·∫°i</button>
      </div>
    </article>

    <!-- Grid c√¢u h·ªèi (bottom sheet ƒë∆°n gi·∫£n) -->
    <div id="sheet" class="hidden fixed inset-x-0 bottom-0 z-40">
      <div class="mx-auto max-w-4xl rounded-t-2xl bg-white dark:bg-slate-900 shadow-2xl border border-slate-200 dark:border-slate-800 animate-slide">
        <div class="p-3 flex items-center gap-2 border-b border-slate-200 dark:border-slate-800">
          <div class="font-semibold">Danh s√°ch c√¢u</div>
          <button id="btnSheetClose" class="ml-auto px-3 py-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">ƒê√≥ng</button>
        </div>
        <div id="qGrid" class="p-3 grid grid-cols-10 gap-1 max-h-[40vh] overflow-auto"></div>
      </div>
    </div>
  </section>
</main>

<!-- Thanh h√†nh ƒë·ªông ƒë√°y (ch·ªâ khi l√†m b√†i) -->
<footer id="footerBar" class="fixed inset-x-0 bottom-0 z-30 hidden">
  <div class="max-w-4xl mx-auto px-3 pb-[env(safe-area-inset-bottom)]">
    <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-2 flex gap-2">
      <button id="bPrev" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üê</button>
      <button id="bReveal" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">ƒê√°p √°n</button>
      <button id="bCheck" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Ch·∫•m</button>
      <button id="bSheet" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Danh s√°ch</button>
      <button id="bSubmit" class="px-3 py-2 rounded-xl bg-brand text-white">N·ªôp</button>
      <button id="bNext" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üí</button>
    </div>
  </div>
</footer>

<script>
(function(){
  "use strict";

  // ---------- utils ----------
  const $ = s => document.querySelector(s);
  const byId = id => document.getElementById(id);
  const on = (el, ev, fn) => el && el.addEventListener(ev, fn, {passive: ev.startsWith('touch')});

  const norm = s => (s??'').toString().replace(/\s+/g,' ').trim()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[‚Äú‚Äù"']/g,'').toLowerCase();
  const letters=['A','B','C','D','E','F','G'];
  const LS_BOOK='qu_book', LS_WRONG='qu_wrong', LS_STATS='qu_stats';
  const loadLS=(k,def)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? def;}catch{return def;} };
  const saveLS=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
  const vibrate = ms => { if(navigator.vibrate) try{ navigator.vibrate(ms); }catch{} };
  const fire = () => { if(typeof confetti==='function') confetti({particleCount:36,spread:55,origin:{y:.8}}); };

  // ---------- elements ----------
  const viewSetup = byId('viewSetup');
  const viewPlay  = byId('viewPlay');
  const footerBar = byId('footerBar');
  const warn = byId('warn');

  // setup elems
  const selSubject = byId('selSubject');
  const selCount = byId('selCount');
  const selOrder = byId('selOrder');
  const selFilter = byId('selFilter');
  const txtSearch = byId('txtSearch');
  const btnStart = byId('btnStart');
  const btnWrong = byId('btnWrong');
  const btnExport = byId('btnExport');
  const btnImport = byId('btnImport');
  const fileImport = byId('fileImport');
  const btnTheme = byId('btnTheme');
  const modeBtns = Array.from(document.querySelectorAll('.modeBtn'));
  let setupMode = 'practice';

  // play elems
  const btnBackSetup = byId('btnBackSetup');
  const badgeSubj = byId('badgeSubj');
  const badgeMode = byId('badgeMode');
  const progress = byId('progress');
  const progText = byId('progText');
  const timerBox = byId('timerBox'), timerLbl = byId('timer');

  const qCard = byId('qCard'), qTitle = byId('qTitle'), optList = byId('optList');
  const expWrap = byId('expWrap'), expText = byId('expText');

  const btnPrev = byId('btnPrev'), btnNext = byId('btnNext'), btnCheck = byId('btnCheck'), btnReveal = byId('btnReveal'), btnBookmark = byId('btnBookmark'), btnSubmit = byId('btnSubmit');

  // bottom bar
  const bPrev=byId('bPrev'), bNext=byId('bNext'), bCheck=byId('bCheck'), bReveal=byId('bReveal'), bSubmit=byId('bSubmit'), bSheet=byId('bSheet');

  // sheet
  const sheet = byId('sheet'), qGrid = byId('qGrid'), btnSheetClose = byId('btnSheetClose');

  // result
  const resultCard=byId('resultCard'), donut=byId('donut'), scoreText=byId('scoreText'), timeText=byId('timeText'), btnReviewWrong=byId('btnReviewWrong'), btnRestart=byId('btnRestart');

  // flash
  const flashWrap = byId('flashWrap'), fcFront=byId('fcFront'), fcBack=byId('fcBack'), fcPrev=byId('fcPrev'), fcNext=byId('fcNext'), fcFlip=byId('fcFlip'), fcAgain=byId('fcAgain'), fcGood=byId('fcGood'), fcMeta=byId('fcMeta');

  // ---------- state ----------
  const state = {
    subjects: [],
    subjIdx: 0,
    mode: 'practice',
    order:'shuffle',
    filter:'all',
    search:'',
    pool:[],
    cur:0,
    answers:{},    // i -> pick
    checked:{},    // i -> true
    correct:0, wrong:0,
    bookmarks: loadLS(LS_BOOK,{}),
    wrongBank: loadLS(LS_WRONG,[]),
    stats: loadLS(LS_STATS,{total:0,correct:0}),
    timer:null, seconds:0,
    flash:{ list:[], i:0 }
  };

  // ---------- data loading ----------
  function parseLegacyText(raw){
    if(!raw) return [];
    const blocks=[]; const re=/(^|\n)C√¢u\s*\d+\s*:[\s\S]*?(?=(?:\n[-=]{3,}\s*\n)|(?:\n\s*C√¢u\s*\d+\s*:)|\s*$)/gi;
    let m; while((m=re.exec(raw))) blocks.push(m[0]);

    const qs=[];
    for(const b of blocks){
      const head=/C√¢u\s*\d+\s*:\s*([\s\S]*?)\n\s*ƒê√°p √°n ƒë√∫ng:\s*([^\n]+)\s*/i.exec(b);
      if(!head) continue;
      const qText=head[1].trim();
      const correctText=head[2].trim();

      let optPart=/T·∫•t c·∫£ ƒë√°p √°n:\s*([\s\S]*)/i.exec(b)?.[1] ?? '';
      const lines=optPart.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

      const opts=[];
      for(const ln of lines){
        const mm=/^[A-Zƒê]\.\s*(.+)$/.exec(ln);
        if(!mm) continue;
        let text=mm[1].trim();
        const hasTick=/‚úì/.test(text);
        text=text.replace(/^‚úì\s*/,'').replace(/\s*‚úì\s*$/,'').trim();
        opts.push({text, hasTick});
      }
      if(!opts.length) continue;

      let idx=opts.findIndex(o=>o.hasTick);
      if(idx<0){
        const nc=norm(correctText);
        idx=opts.findIndex(o=>norm(o.text)===nc);
        if(idx<0) idx=opts.findIndex(o=>norm(o.text).includes(nc) || nc.includes(norm(o.text)));
        if(idx<0) idx=0;
      }
      qs.push({ text:qText, options:opts.map(o=>o.text), answer:idx, explain:'' });
    }
    return qs;
  }
  function inferSubject(raw,fallback){ const m=/M√îN\s*[:Ôºö]\s*([^\n]+)/i.exec(raw||''); return m?m[1].trim():fallback||'M√¥n'; }

  async function loadSubjects(){
    // 1) API c≈©
    if(window.quizData?.getAll){
      try{
        const arr=window.quizData.getAll();
        const subs = arr.map(it=>({ name: it.subject, questions: parseLegacyText(String(it.text||'')) }))
                       .filter(s=>s.questions.length);
        if(subs.length) return subs;
      }catch(e){}
    }
    // 2) bi·∫øn RAW_ + SUBJECT_
    const rawKeys = Object.keys(window).filter(k=>/^RAW_/.test(k));
    if(rawKeys.length){
      const list=[];
      for(const k of rawKeys){
        const raw=String(window[k]||'');
        const suf=k.replace(/^RAW_/,'');
        const name=window['SUBJECT_'+suf] || inferSubject(raw,suf);
        list.push({name, questions:parseLegacyText(raw)});
      }
      const subs=list.filter(s=>s.questions.length);
      if(subs.length) return subs;
    }
    // 3) data.txt (tu·ª≥ ch·ªçn)
    try{
      const r=await fetch('data.txt',{cache:'no-store'});
      if(r.ok){
        const txt=await r.text();
        const q1=parseLegacyText(txt);
        if(q1.length) return [{name: inferSubject(txt,'M√¥n'), questions:q1}];
        const j=JSON.parse(txt);
        if(Array.isArray(j?.subjects)) return j.subjects;
      }
    }catch{}

    return [];
  }

  // ---------- setup UI ----------
  function renderSubjects(){
    selSubject.innerHTML='';
    state.subjects.forEach((s,i)=>{
      const o=document.createElement('option');
      o.value=i; o.textContent=s.name||('M√¥n '+(i+1));
      selSubject.appendChild(o);
    });
    state.subjIdx=0;
  }
  modeBtns.forEach(btn=>{
    on(btn,'click',()=>{
      modeBtns.forEach(b=>b.classList.remove('ring-2','ring-brand/60'));
      btn.classList.add('ring-2','ring-brand/60');
      setupMode = btn.dataset.mode;
    });
  });

  // ---------- play helpers ----------
  function makePool(){
    const subj=state.subjects[state.subjIdx]; if(!subj) return [];
    let arr=subj.questions.map((q,idx)=>({...q,_id:idx}));
    if(state.search.trim()){
      const key=norm(state.search);
      arr=arr.filter(q=> norm(q.text).includes(key) || q.options.some(o=>norm(o).includes(key)));
    }
    if(state.filter==='bookmarked'){
      arr=arr.filter(q => !!state.bookmarks[`${state.subjIdx}:${q._id}`]);
    }else if(state.filter==='wrong'){
      const set=new Set(state.wrongBank.map(x=>`${x.s}:${x.q}`));
      arr=arr.filter(q=>set.has(`${state.subjIdx}:${q._id}`));
    }
    if(state.order==='shuffle') arr.sort(()=>Math.random()-.5);
    const need = (selCount.value==='all') ? arr.length : Math.min(+selCount.value||20, arr.length);
    return arr.slice(0,need);
  }
  function showSetup(){ viewSetup.classList.remove('hidden'); viewPlay.classList.add('hidden'); footerBar.classList.add('hidden'); window.scrollTo({top:0}); }
  function showPlay(){ viewSetup.classList.add('hidden'); viewPlay.classList.remove('hidden'); footerBar.classList.remove('hidden'); window.scrollTo({top:0}); }

  // ---------- render c√¢u ----------
  function renderQuestion(){
    const q=state.pool[state.cur];
    if(!q){ qCard.classList.add('hidden'); return; }
    qCard.classList.remove('hidden');
    qTitle.textContent = `C√¢u ${state.cur+1}: ${q.text}`;
    optList.innerHTML=''; expWrap.classList.add('hidden'); expText.textContent=q.explain||'';

    q.options.forEach((o,i)=>{
      const id=`q${state.cur}-o${i}`;
      const wrap=document.createElement('div'); wrap.className='opt';
      const inp=document.createElement('input'); inp.type='radio'; inp.name=`q${state.cur}`; inp.id=id; inp.value=i;
      inp.checked = (state.answers[state.cur]===i);
      inp.onchange=()=>{ state.answers[state.cur]=i; if(state.mode==='practice'){ markCurrent(true); } };
      const lab=document.createElement('label'); lab.setAttribute('for',id);
      lab.innerHTML=`<div class="flex gap-2"><div class="text-slate-500 dark:text-slate-400">${letters[i]}.</div><div class="flex-1 break-words">${o}</div></div>`;
      wrap.appendChild(inp); wrap.appendChild(lab); optList.appendChild(wrap);
    });

    const key=`${state.subjIdx}:${q._id}`;
    btnBookmark.textContent = state.bookmarks[key] ? 'üîñ ƒê√£ ƒë√°nh d·∫•u' : 'üîñ ƒê√°nh d·∫•u';

    // progress
    const total=state.pool.length||0;
    const cur=state.cur+1; progText.textContent=`${Math.min(cur,total)} / ${total}`;
    progress.style.width = total? `${(Math.min(cur,total)/total)*100}%`:'0%';
  }
  function clearMarks(){ optList.querySelectorAll('label').forEach(el=>el.classList.remove('is-correct','is-wrong','animate-pop')); }
  function markCurrent(fromPick=false){
    const q=state.pool[state.cur]; const pick=state.answers[state.cur];
    clearMarks();
    const labs=optList.querySelectorAll('label');
    if(labs[q.answer]) labs[q.answer].classList.add('is-correct','animate-pop');
    if(pick!=null && pick!==q.answer && labs[pick]) labs[pick].classList.add('is-wrong');
    if(fromPick && !state.checked[state.cur]){
      state.checked[state.cur]=true;
      if(pick===q.answer){ state.correct++; fire(); } else { state.wrong++; addWrong(q._id); vibrate(20); }
    }
    if(state.mode!=='exam' && q.explain) expWrap.classList.remove('hidden');
  }
  function addWrong(qid){
    const key=`${state.subjIdx}:${qid}`;
    const exists=state.wrongBank.some(x=>`${x.s}:${x.q}`===key);
    if(!exists){ state.wrongBank.unshift({s:state.subjIdx,q:qid}); state.wrongBank=state.wrongBank.slice(0,500); saveLS(LS_WRONG,state.wrongBank); }
  }

  function prevQ(){ if(state.cur>0){ state.cur--; renderQuestion(); } }
  function nextQ(){ if(state.cur<state.pool.length-1){ state.cur++; renderQuestion(); } }

  // ---------- submit/exam ----------
  function submitAll(){
    if(state.mode!=='exam') return;
    const total=state.pool.length; let correct=0; const wrongList=[];
    for(let i=0;i<total;i++){
      const q=state.pool[i];
      if(state.answers[i]===q.answer) correct++; else wrongList.push({s:state.subjIdx,q:q._id});
    }
    state.wrongBank=[...wrongList, ...state.wrongBank].slice(0,500); saveLS(LS_WRONG,state.wrongBank);
    state.stats.total += total; state.stats.correct += correct; saveLS(LS_STATS,state.stats);
    stopTimer();

    const pct=Math.round(correct*100/Math.max(1,total));
    donut.style.setProperty('--p', `${pct*3.6}deg`);
    scoreText.textContent=`ƒê√∫ng ${correct}/${total} c√¢u (${pct}%).`;
    timeText.textContent = state.seconds? `Th·ªùi gian: ${Math.floor(state.seconds/60)}m ${state.seconds%60}s` : '';
    resultCard.classList.remove('hidden'); qCard.classList.add('hidden'); flashWrap.classList.add('hidden'); window.scrollTo({top:0,behavior:'smooth'});

    btnReviewWrong.onclick = ()=>{ showSetup(); selFilter.value='wrong'; startFromSetup('practice'); };
    btnRestart.onclick = ()=> startFromSetup(state.mode);
  }

  // ---------- sheet ----------
  function buildGrid(){
    qGrid.innerHTML='';
    for(let i=0;i<state.pool.length;i++){
      const b=document.createElement('button');
      b.className='text-sm rounded-lg border px-2 py-1 '+(i===state.cur?'bg-brand text-white border-brand':'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700');
      b.textContent=(i+1);
      b.onclick=()=>{ state.cur=i; renderQuestion(); };
      qGrid.appendChild(b);
    }
  }

  // ---------- timer ----------
  function startTimer(){ state.seconds=0; timerLbl.textContent='00:00'; timerBox.hidden=false; state.timer=setInterval(()=>{ state.seconds++; const m=String(Math.floor(state.seconds/60)).padStart(2,'0'), s=String(state.seconds%60).padStart(2,'0'); timerLbl.textContent=`${m}:${s}`; },1000); }
  function stopTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

  // ---------- flashcards ----------
  function enterFlash(){
    const pool = makePool();
    state.flash.list = pool.map(q=>({front:q.text, back: renderFlashBack(q)}));
    state.flash.i=0;
    qCard.classList.add('hidden'); resultCard.classList.add('hidden'); flashWrap.classList.remove('hidden');
    renderFlash();
  }
  function renderFlashBack(q){
    const opts=q.options.map((o,i)=>`<div class="mt-1"><b>${letters[i]}.</b> ${o}${i===q.answer?' <span class="text-green-600 dark:text-green-400">‚úì</span>':''}</div>`).join('');
    return `<div class="text-sm"><div class="font-semibold mb-1">ƒê√°p √°n ƒë√∫ng: <span class="text-green-600 dark:text-green-400">${letters[q.answer]}</span></div>${opts}</div>`;
  }
  function renderFlash(){
    if(!state.flash.list.length){ fcFront.textContent='üî• B·∫°n ƒë√£ thu·ªôc h·∫øt b·ªô th·∫ª!'; fcBack.classList.add('hidden'); fcMeta.textContent=''; return; }
    const it=state.flash.list[state.flash.i];
    fcFront.textContent = it.front;
    fcBack.innerHTML = it.back;
    fcBack.classList.add('hidden');
    fcMeta.textContent = `Th·∫ª ${state.flash.i+1}/${state.flash.list.length}`;
  }

  // ---------- start from setup ----------
  function startFromSetup(forceMode){
    // sync selections
    state.subjIdx = selSubject.selectedIndex;
    state.mode = forceMode || setupMode;
    state.order = selOrder.value;
    state.filter = selFilter.value;
    state.search = txtSearch.value.trim();

    state.pool = makePool();
    state.cur=0; state.answers={}; state.checked={}; state.correct=0; state.wrong=0;
    resultCard.classList.add('hidden');

    badgeSubj.textContent = state.subjects[state.subjIdx]?.name || 'M√¥n';
    badgeMode.textContent = state.mode==='study'?'H·ªçc': state.mode==='practice'?'Luy·ªán t·∫≠p': state.mode==='exam'?'Thi th·ª≠':'Flashcard';

    if(!state.pool.length){ warn.classList.remove('hidden'); showSetup(); return; }
    warn.classList.add('hidden');
    showPlay();
    buildGrid();

    // hi·ªÉn th·ªã theo mode
    const isExam = state.mode==='exam';
    const isStudy = state.mode==='study';
    const isPractice = state.mode==='practice';
    const isFlash = state.mode==='flash';

    qCard.classList.toggle('hidden', isFlash);
    flashWrap.classList.toggle('hidden', !isFlash);
    btnCheck.classList.toggle('hidden', !isPractice);
    bCheck.classList.toggle('hidden', !isPractice);
    btnReveal.classList.toggle('hidden', !isStudy);
    bReveal.classList.toggle('hidden', !isStudy);
    btnSubmit.classList.toggle('hidden', !isExam);
    bSubmit.classList.toggle('hidden', !isExam);

    if(isExam){ startTimer(); } else { stopTimer(); timerBox.hidden=true; }

    if(isFlash){
      enterFlash();
    }else{
      renderQuestion();
    }
  }

  // ---------- events ----------
  document.addEventListener('DOMContentLoaded', async ()=>{
    // theme
    on(btnTheme,'click',()=> document.documentElement.classList.toggle('dark'));

    // import/export
    on(btnExport,'click',()=>{
      const data={ bookmarks: state.bookmarks, wrongBank: state.wrongBank, stats: state.stats };
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quiz-progress.json'; a.click(); URL.revokeObjectURL(a.href);
    });
    on(btnImport,'click',()=> fileImport.click());
    on(fileImport,'change', async e=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{ const t=await f.text(); const d=JSON.parse(t);
        if(d.bookmarks) state.bookmarks=d.bookmarks;
        if(d.wrongBank) state.wrongBank=d.wrongBank;
        if(d.stats) state.stats=d.stats;
        saveLS(LS_BOOK,state.bookmarks); saveLS(LS_WRONG,state.wrongBank); saveLS(LS_STATS,state.stats);
        alert('Nh·∫≠p ti·∫øn tr√¨nh th√†nh c√¥ng!');
      }catch{ alert('File kh√¥ng h·ª£p l·ªá.'); }
      e.target.value='';
    });

    // quick wrong
    on(btnWrong,'click',()=>{ selFilter.value='wrong'; });

    // start
    on(btnStart,'click', ()=> startFromSetup());

    // back to setup
    on(btnBackSetup,'click', ()=>{ stopTimer(); showSetup(); });

    // bottom actions
    on(bPrev,'click', ()=> prevQ());
    on(bNext,'click', ()=> nextQ());
    on(bCheck,'click', ()=> markCurrent(true));
    on(bReveal,'click', ()=>{
      if(state.mode!=='study') return;
      clearMarks(); const q=state.pool[state.cur]; const labs=optList.querySelectorAll('label');
      if(labs[q.answer]) labs[q.answer].classList.add('is-correct','animate-pop');
      if(q.explain) expWrap.classList.remove('hidden');
    });
    on(bSubmit,'click', ()=> submitAll());
    on(bSheet,'click', ()=> sheet.classList.toggle('hidden'));
    on(btnSheetClose,'click', ()=> sheet.classList.add('hidden'));

    // card buttons
    on(btnPrev,'click', ()=> prevQ());
    on(btnNext,'click', ()=> nextQ());
    on(btnCheck,'click', ()=> markCurrent(true));
    on(btnReveal,'click', ()=>{
      if(state.mode!=='study') return;
      clearMarks(); const q=state.pool[state.cur]; const labs=optList.querySelectorAll('label');
      if(labs[q.answer]) labs[q.answer].classList.add('is-correct','animate-pop');
      if(q.explain) expWrap.classList.remove('hidden');
    });
    on(btnSubmit,'click', ()=> submitAll());
    on(btnBookmark,'click', ()=>{
      const q=state.pool[state.cur]; const key=`${state.subjIdx}:${q._id}`;
      state.bookmarks[key]=!state.bookmarks[key]; saveLS(LS_BOOK,state.bookmarks);
      btnBookmark.textContent = state.bookmarks[key] ? 'üîñ ƒê√£ ƒë√°nh d·∫•u' : 'üîñ ƒê√°nh d·∫•u';
    });

    // flash buttons
    on(fcFlip,'click', ()=> fcBack.classList.toggle('hidden'));
    on(fcPrev,'click', ()=>{ if(state.flash.i>0){ state.flash.i--; renderFlash(); } });
    on(fcNext,'click', ()=>{ if(state.flash.i<state.flash.list.length-1){ state.flash.i++; renderFlash(); } });
    on(fcAgain,'click', ()=>{
      const it=state.flash.list[state.flash.i];
      state.flash.list.push(it);
      state.flash.i++;
      if(state.flash.i>=state.flash.list.length) state.flash.i=state.flash.list.length-1;
      renderFlash(); vibrate(20);
    });
    on(fcGood,'click', ()=>{
      state.flash.list.splice(state.flash.i,1);
      if(state.flash.i>=state.flash.list.length) state.flash.i=Math.max(0,state.flash.list.length-1);
      if(state.flash.list.length){ renderFlash(); } else { fcFront.textContent='üî• B·∫°n ƒë√£ thu·ªôc h·∫øt b·ªô th·∫ª!'; fcBack.classList.add('hidden'); fcMeta.textContent=''; fire(); }
    });

    // vu·ªët chuy·ªÉn c√¢u
    (function attachSwipe(){
      let sx=0,sy=0,dx=0,dy=0; const area=$('main');
      on(area,'touchstart',e=>{const t=e.touches[0]; sx=t.clientX; sy=t.clientY;});
      on(area,'touchmove',e=>{const t=e.touches[0]; dx=t.clientX-sx; dy=t.clientY-sy;});
      on(area,'touchend',()=>{ if(Math.abs(dx)>60 && Math.abs(dy)<40){ if(dx<0) nextQ(); else prevQ(); } dx=dy=0;});
    })();

    // load data
    state.subjects = await loadSubjects();
    if(!state.subjects.length){ warn.classList.remove('hidden'); selSubject.innerHTML='<option>Ch∆∞a c√≥ d·ªØ li·ªáu</option>'; }
    else { warn.classList.add('hidden'); renderSubjects(); }
  });

})();
</script>
</body>
</html>
