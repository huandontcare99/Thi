<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Quiz Ultra+ — Mobile First</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors:{brand:'#2563eb', ok:'#16a34a', bad:'#ef4444', ink:'#0f172a'},
        boxShadow:{soft:'0 18px 40px -18px rgba(0,0,0,.2)'},
        animation:{fade:'fade .22s ease', pop:'pop .18s ease', slide:'slide .25s ease'},
        keyframes:{
          fade:{from:{opacity:0},to:{opacity:1}},
          pop:{from:{transform:'scale(.98)'},to:{transform:'scale(1)'}},
          slide:{from:{transform:'translateY(8px)',opacity:0},to:{transform:'translateY(0)',opacity:1}},
        }
      }
    }
  }
</script>

<style>
  /* ====== Card đáp án nổi bật, chạm cả block ====== */
  .opt input{ display:none; }
  .opt .card{
    position:relative; border:1px solid #e6edf5; background:#fff;
    border-radius:16px; padding:12px 14px; transition:transform .06s ease,border-color .12s, background .12s;
  }
  .dark .opt .card{ background:#0b1220; border-color:#1f2937; }
  .opt .card:active{ transform:scale(.995); }
  .opt .lead{
    width:28px; height:28px; border-radius:999px; flex:none;
    display:flex; align-items:center; justify-content:center; font-weight:700;
    background:#f1f5f9; color:#334155;
  }
  .dark .opt .lead{ background:#0f172a; color:#cbd5e1; }
  .opt input:checked + .card{
    border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15) inset;
    background:linear-gradient(180deg, rgba(37,99,235,.06), transparent 38%);
  }
  .is-correct{ border-color:#16a34a!important; box-shadow:0 0 0 3px rgba(22,163,74,.18) inset; }
  .is-wrong  { border-color:#ef4444!important; box-shadow:0 0 0 3px rgba(239,68,68,.18) inset; }
  .correct-badge, .wrong-badge{
    position:absolute; right:10px; top:10px; font-size:12px; font-weight:700; padding:2px 8px; border-radius:999px;
  }
  .correct-badge{ background:#16a34a; color:#fff; }
  .wrong-badge{ background:#ef4444; color:#fff; }

  /* Donut kết quả */
  .donut{ --p:0; width:120px; height:120px; border-radius:999px; background: conic-gradient(#16a34a var(--p), #e2e8f0 0); }
  .dark .donut{ background: conic-gradient(#16a34a var(--p), #334155 0); }

  /* Progress minimap */
  .dot{ width:10px; height:10px; border-radius:999px; background:#cbd5e1; }
  .dark .dot{ background:#475569; }
  .dot.active{ background:#2563eb; }
  .dot.done.correct{ background:#16a34a; }
  .dot.done.wrong{ background:#ef4444; }

  /* Bar đơn giản */
  .bar{height:10px; border-radius:999px; background:#e2e8f0;}
  .bar > i{display:block; height:10px; border-radius:999px; background:#2563eb;}

  /* Ripple nhẹ cho nút */
  .ripple{ position:relative; overflow:hidden; }
  .ripple:after{
    content:""; position:absolute; inset:0; background:radial-gradient(circle at var(--x,50%) var(--y,50%), rgba(0,0,0,.12), transparent 45%);
    opacity:0; transition:opacity .25s; pointer-events:none;
  }
  .ripple:active:after{ opacity:1; transition:opacity .25s; }

  /* Chống iOS auto-zoom */
  @media (max-width:380px){ select,input,button{ font-size:16px; } }
</style>

<!-- DATA -->
<script src="data.js" defer></script>
<!-- confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer></script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen">

<header class="sticky top-0 z-30 backdrop-blur bg-white/90 dark:bg-slate-900/85 border-b border-slate-200 dark:border-slate-800">
  <div class="max-w-5xl mx-auto px-3 py-2 flex items-center gap-3">
    <button id="btnHome" class="w-9 h-9 rounded-xl bg-brand text-white flex items-center justify-center font-bold shadow-soft ripple">U</button>
    <div class="min-w-0">
      <div class="text-sm font-semibold leading-5" id="appTitle">Quiz Ultra+</div>
      <div class="text-[11px] text-slate-500 dark:text-slate-400 -mt-1" id="subtitle">Mobile-first • Siêu mượt</div>
    </div>
    <div class="ml-auto flex items-center gap-2">
      <button id="btnTheme" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">🌙</button>
      <button id="btnNav" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">☰</button>
    </div>
  </div>
</header>

<!-- Drawer -->
<aside id="drawer" class="fixed inset-y-0 left-0 w-[84%] max-w-xs bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 p-3 shadow-xl translate-x-[-110%] transition-transform z-40">
  <div class="flex items-center gap-2 mb-2">
    <div class="w-9 h-9 rounded-xl bg-brand text-white flex items-center justify-center font-bold">U</div>
    <div class="font-semibold">Quiz Ultra+</div>
    <button id="btnCloseDrawer" class="ml-auto px-3 py-1 rounded-xl border border-slate-200 dark:border-slate-700 ripple">✕</button>
  </div>
  <nav class="space-y-1 text-sm">
    <button data-goto="#setup" class="navbtn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 ripple">🏁 Setup</button>
    <button data-goto="#play" class="navbtn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 ripple">📝 Làm bài</button>
    <button data-goto="#flash" class="navbtn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 ripple">🃏 Flashcards</button>
    <button data-goto="#review" class="navbtn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 ripple">🔁 Ôn câu sai</button>
    <button data-goto="#browser" class="navbtn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 ripple">📚 Ngân hàng</button>
    <button data-goto="#stats" class="navbtn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 ripple">📈 Thống kê</button>
    <button data-goto="#history" class="navbtn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 ripple">🗂 Lịch sử</button>
    <button data-goto="#settings" class="navbtn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 ripple">⚙️ Cài đặt</button>
    <button data-goto="#help" class="navbtn w-full text-left px-3 py-2 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 ripple">❓ Hướng dẫn</button>
  </nav>
</aside>

<main class="max-w-5xl mx-auto px-3 pb-24">
  <!-- ===== SETUP ===== -->
  <section id="setup" class="animate-fade">
    <div id="warn" class="hidden mt-3 p-3 text-sm rounded-xl bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 text-amber-900 dark:text-amber-200">
      Không đọc được dữ liệu gốc. Hãy đảm bảo <b>index.html</b> đặt cùng thư mục với <b>data.js</b>.
    </div>

    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4 animate-slide">
        <div class="grid grid-cols-2 gap-2">
          <div class="col-span-2">
            <label class="text-sm font-semibold">Chọn môn</label>
            <select id="selSubject" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
              <option>Đang nạp…</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-semibold">Số câu</label>
            <select id="selCount" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
              <option value="10">10</option><option value="20" selected>20</option><option value="30">30</option><option value="all">Tất cả</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-semibold">Thứ tự</label>
            <select id="selOrder" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
              <option value="sequence">Theo thứ tự</option><option value="shuffle" selected>Ngẫu nhiên</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-semibold">Bộ lọc</label>
            <select id="selFilter" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
              <option value="all" selected>Tất cả</option><option value="bookmarked">Đã đánh dấu</option><option value="wrong">Sai gần đây</option><option value="flagged">Đánh dấu xem lại</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-semibold">Chế độ</label>
            <select id="selMode" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
              <option value="study">Học (hiện đáp án)</option>
              <option value="practice" selected>Luyện tập (chấm ngay)</option>
              <option value="exam">Thi thử (chấm cuối)</option>
            </select>
          </div>
        </div>

        <div class="mt-3">
          <label class="text-sm font-semibold">Tìm kiếm</label>
          <input id="txtSearch" placeholder="Từ khóa trong câu / đáp án…" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2"/>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="btnStart" class="w-full bg-brand hover:bg-blue-700 text-white rounded-2xl px-5 py-3 font-semibold shadow-soft ripple">BẮT ĐẦU</button>
          <button data-goto="#flash" class="w-full rounded-2xl px-5 py-3 border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">Flashcards</button>
        </div>
      </div>

      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4 animate-slide">
        <div class="text-sm font-semibold">Tiện ích nhanh</div>
        <div class="mt-2 flex flex-wrap gap-2">
          <button id="btnWrongQuick" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">🔁 Ôn câu sai</button>
          <button id="btnExport" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">⬇️ Xuất tiến trình</button>
          <button id="btnImport" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">⬆️ Nhập tiến trình</button>
          <input id="fileImport" type="file" accept=".json" class="hidden">
        </div>

        <div class="mt-3 text-xs text-slate-500 dark:text-slate-400">
          Tổng câu đã luyện: <b id="statTotal">0</b> — Độ chính xác: <b id="statAcc">0%</b>
        </div>
        <div class="mt-2 bar"><i id="accBar" style="width:0%"></i></div>

        <div class="mt-4 text-xs text-slate-500 dark:text-slate-400">
          * Gợi ý: có thể bật <b>Tự chuyển câu khi chọn</b> và chỉnh <b>Cỡ chữ</b> trong mục Cài đặt.
        </div>
      </div>
    </div>
  </section>

  <!-- ===== PLAY ===== -->
  <section id="play" class="hidden animate-fade">
    <div class="mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-3">
      <div class="flex items-center gap-2">
        <button class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple" data-goto="#setup">← Setup</button>
        <div id="badgeSubj" class="text-xs px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">Môn</div>
        <div id="badgeMode" class="text-xs px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">Chế độ</div>
        <div class="ml-auto text-xs text-slate-500 dark:text-slate-400" id="timerBox" hidden>⏱ <span id="timer">00:00</span></div>
      </div>
      <div class="mt-2 h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
        <div id="progress" class="h-2 bg-brand" style="width:0%"></div>
      </div>
      <div id="progText" class="mt-1 text-xs text-slate-500 dark:text-slate-400">0 / 0</div>

      <!-- Minimap -->
      <div id="minimap" class="mt-2 flex flex-wrap gap-1"></div>
    </div>

    <article id="qCard" class="hidden mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
      <div class="flex items-start gap-2">
        <h2 id="qTitle" class="text-base font-semibold flex-1"></h2>
        <button id="btnFlag" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple" title="Đánh dấu xem lại">⏳</button>
      </div>

      <div id="optList" class="mt-3 space-y-2"></div>

      <details id="expWrap" class="mt-4 group">
        <summary class="cursor-pointer select-none text-sm font-semibold">
          Giải thích <span class="text-slate-400">(chạm để mở/đóng)</span>
        </summary>
        <div id="expText" class="text-sm text-slate-700 dark:text-slate-300 mt-1"></div>
      </details>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnPrev" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">← Trước</button>
        <button id="btnNext" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">Tiếp →</button>
        <button id="btnUndo" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">↩︎ Hoàn tác</button>
        <button id="btnCheck" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">Chấm</button>
        <button id="btnReveal" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">Hiện đáp án</button>
        <button id="btnBookmark" class="ml-auto px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">🔖 Đánh dấu</button>
        <button id="btnSubmit" class="px-4 py-2 rounded-xl bg-brand text-white ripple">Nộp bài</button>
      </div>
    </article>

    <!-- Kết quả -->
    <article id="resultCard" class="hidden mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4 animate-pop">
      <div class="flex items-center gap-4">
        <div id="donut" class="donut" style="--p:0deg"></div>
        <div>
          <h3 class="text-lg font-bold mb-1">Kết quả</h3>
          <p id="scoreText" class="text-sm text-slate-700 dark:text-slate-300"></p>
          <div id="timeText" class="text-xs text-slate-500 dark:text-slate-400"></div>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnReviewWrong" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple" data-goto="#review">Ôn các câu sai</button>
        <button id="btnRestart" class="px-4 py-2 rounded-xl bg-brand text-white ripple">Làm lại</button>
      </div>
    </article>
  </section>

  <!-- ===== FLASH ===== -->
  <section id="flash" class="hidden animate-fade">
    <div class="mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
      <div class="flex items-center gap-2">
        <button class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple" data-goto="#setup">← Setup</button>
        <div class="font-semibold">Flashcards</div>
        <div class="ml-auto text-xs text-slate-500 dark:text-slate-400" id="fcMeta"></div>
      </div>
      <div id="fcFront" class="mt-3 text-base font-semibold"></div>
      <div id="fcBack" class="mt-2 text-sm hidden"></div>
      <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">Chạm “Lật” để xem đáp án</div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="fcPrev" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">←</button>
        <button id="fcFlip" class="px-4 py-2 rounded-2xl bg-brand text-white ripple">Lật</button>
        <button id="fcAgain" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">🕑 Chưa nhớ</button>
        <button id="fcGood" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">✓ Nhớ rồi</button>
        <button id="fcNext" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">→</button>
      </div>
    </div>
  </section>

  <!-- ===== REVIEW WRONG ===== -->
  <section id="review" class="hidden animate-fade">
    <div class="mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
      <div class="flex items-center gap-2">
        <button class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple" data-goto="#setup">← Setup</button>
        <div class="font-semibold">Ôn câu sai gần đây</div>
        <button id="btnClearWrong" class="ml-auto px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">Xóa danh sách</button>
      </div>
      <div id="wrongList" class="mt-3 space-y-2"></div>
    </div>
  </section>

  <!-- ===== BROWSER ===== -->
  <section id="browser" class="hidden animate-fade">
    <div class="mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
      <div class="flex items-center gap-2">
        <div class="font-semibold">Ngân hàng câu hỏi</div>
        <div class="ml-auto flex gap-2">
          <select id="brSubj" class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-2 py-1 text-sm"></select>
          <input id="brSearch" placeholder="Tìm trong câu/đáp án…" class="rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-1 text-sm">
        </div>
      </div>
      <div id="brList" class="mt-3 space-y-2"></div>
    </div>
  </section>

  <!-- ===== STATS ===== -->
  <section id="stats" class="hidden animate-fade">
    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
        <div class="flex items-center gap-4">
          <div id="sumDonut" class="donut" style="--p:0deg"></div>
          <div>
            <div class="text-lg font-bold">Tổng quan</div>
            <div class="text-sm text-slate-600 dark:text-slate-300" id="sumText">—</div>
          </div>
        </div>
        <div class="mt-3 text-xs text-slate-500 dark:text-slate-400">Độ chính xác</div>
        <div class="bar"><i id="sumBar" style="width:0%"></i></div>
      </div>

      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
        <div class="text-lg font-bold">Theo môn</div>
        <div id="bySubj" class="mt-2 space-y-2"></div>
      </div>
    </div>
  </section>

  <!-- ===== HISTORY ===== -->
  <section id="history" class="hidden animate-fade">
    <div class="mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
      <div class="flex items-center gap-2">
        <div class="font-semibold">Lịch sử bài làm</div>
        <button id="btnClearHist" class="ml-auto px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">Xóa lịch sử</button>
      </div>
      <div id="histList" class="mt-3 space-y-2"></div>
    </div>
  </section>

  <!-- ===== SETTINGS ===== -->
  <section id="settings" class="hidden animate-fade">
    <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
        <div class="text-lg font-bold">Giao diện</div>
        <div class="mt-2 flex flex-wrap gap-2">
          <button id="setLight" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 ripple">☀️ Sáng</button>
          <button id="setDark" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 ripple">🌙 Tối</button>
          <button id="setAuto" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 ripple">🖥 Auto</button>
        </div>
        <div class="mt-3">
          <label class="text-sm font-semibold">Cỡ chữ (câu hỏi/đáp án)</label>
          <select id="selFont" class="mt-1 w-full rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
            <option value="base">Mặc định</option>
            <option value="lg">Lớn</option>
            <option value="xl">Rất lớn</option>
          </select>
        </div>
        <div class="mt-3 flex items-center gap-2">
          <input id="chkAutoNext" type="checkbox" class="w-5 h-5">
          <label for="chkAutoNext" class="text-sm">Tự chuyển câu khi chọn</label>
        </div>
        <div class="mt-2 flex items-center gap-2">
          <input id="chkMinimap" type="checkbox" class="w-5 h-5" checked>
          <label for="chkMinimap" class="text-sm">Hiện minimap câu hỏi</label>
        </div>
        <div class="mt-2 flex items-center gap-2">
          <input id="chkExplain" type="checkbox" class="w-5 h-5" checked>
          <label for="chkExplain" class="text-sm">Tự mở “Giải thích” khi chấm</label>
        </div>
      </div>

      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
        <div class="text-lg font-bold">Dữ liệu</div>
        <div class="mt-2 flex flex-wrap gap-2">
          <button id="btnExport2" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 ripple">⬇️ Xuất tiến trình</button>
          <button id="btnImport2" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 ripple">⬆️ Nhập tiến trình</button>
          <input id="fileImport2" type="file" accept=".json" class="hidden">
          <button id="btnReset" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 ripple">🗑 Xóa toàn bộ (LS)</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== HELP ===== -->
  <section id="help" class="hidden animate-fade">
    <div class="mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4">
      <div class="text-lg font-bold">Hướng dẫn nhanh</div>
      <ul class="mt-2 text-sm list-disc pl-5 space-y-1 text-slate-700 dark:text-slate-300">
        <li>Vào <b>Setup</b> chọn môn, chế độ, số câu → <b>Bắt đầu</b>.</li>
        <li>Minimap chấm tròn giúp nhảy nhanh giữa các câu. Chấm xanh: đúng, đỏ: sai.</li>
        <li>Trong <b>Cài đặt</b> có: Tự chuyển câu, cỡ chữ, ẩn/hiện minimap & giải thích.</li>
      </ul>
    </div>
  </section>
</main>

<!-- Play footer -->
<footer id="playBar" class="fixed inset-x-0 bottom-0 z-30 hidden">
  <div class="max-w-5xl mx-auto px-3 pb-[env(safe-area-inset-bottom)]">
    <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-2 flex gap-2">
      <button id="bPrev" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">←</button>
      <button id="bReveal" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">Đáp án</button>
      <button id="bCheck" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">Chấm</button>
      <button id="bSubmit" class="px-3 py-2 rounded-xl bg-brand text-white ripple">Nộp</button>
      <button id="bNext" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 ripple">→</button>
    </div>
  </div>
</footer>

<script>
(function(){
  "use strict";

  /* ===== Helpers ===== */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const byId = id => document.getElementById(id);
  const on = (el, ev, fn) => el && el.addEventListener(ev, fn, {passive: ev.startsWith('touch')});
  const letters=['A','B','C','D','E','F','G'];
  const vibrate = ms => { if(navigator.vibrate) try{ navigator.vibrate(ms); }catch{} };
  const fire = () => { if(typeof confetti==='function') confetti({particleCount:36,spread:55,origin:{y:.82}}); };

  // Ripple pos
  document.addEventListener('click', e=>{
    const btn = e.target.closest('.ripple'); if(!btn) return;
    const r=btn.getBoundingClientRect();
    btn.style.setProperty('--x', (e.clientX-r.left)+'px');
    btn.style.setProperty('--y', (e.clientY-r.top)+'px');
  }, {capture:true});

  const norm = s => (s??'').toString().replace(/\s+/g,' ').trim()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[“”"']/g,'').toLowerCase();

  const LS_BOOK='qu_book', LS_WRONG='qu_wrong', LS_STATS='qu_stats', LS_HIST='qu_hist', LS_PREF='qu_prefs', LS_FLAG='qu_flag';
  const loadLS=(k,def)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? def;}catch{return def;} };
  const saveLS=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

  /* ===== State ===== */
  const S = {
    subjects: [],
    subjIdx: 0,
    mode: 'practice',
    order: 'shuffle',
    filter: 'all',
    search: '',
    pool: [],
    cur: 0,
    answers: {},
    checked: {},
    trail: [], // lịch sử hành động để Undo
    correct: 0, wrong: 0,
    bookmarks: loadLS(LS_BOOK,{}),
    flagged:   loadLS(LS_FLAG,{}), // đánh dấu xem lại trong bài
    wrongBank: loadLS(LS_WRONG,[]),
    stats: loadLS(LS_STATS,{total:0,correct:0,bySubj:{}}),
    history: loadLS(LS_HIST,[]),
    prefs: loadLS(LS_PREF,{ font:'base', autoNext:false, minimap:true, showExplain:true }),
    timer:null, seconds:0,
    flash:{ list:[], i:0 }
  };

  /* ===== Parser ===== */
  function parseLegacyText(raw){
    if(!raw) return [];
    const blocks=[]; const re=/(^|\n)Câu\s*\d+\s*:[\s\S]*?(?=(?:\n[-=]{3,}\s*\n)|(?:\n\s*Câu\s*\d+\s*:)|\s*$)/gi;
    let m; while((m=re.exec(raw))) blocks.push(m[0]);

    const qs=[];
    for(const b of blocks){
      const head=/Câu\s*\d+\s*:\s*([\s\S]*?)\n\s*Đáp\s*án\s*đúng\s*[:：]\s*([^\n]+)\s*/i.exec(b);
      if(!head) continue;
      const qText=head[1].trim();
      const correctText=head[2].trim();

      let optPart=/Tất\s*cả\s*đáp\s*án\s*[:：]\s*([\s\S]*)/i.exec(b)?.[1] ?? '';
      const lines=optPart.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

      const opts=[];
      for(const ln of lines){
        const mm=/^[A-ZĐ]\.\s*(.+)$/.exec(ln);
        if(!mm) continue;
        let text=mm[1].trim();
        const hasTick=/✓/.test(text);
        text=text.replace(/^✓\s*/,'').replace(/\s*✓\s*$/,'').trim();
        opts.push({text, hasTick});
      }
      if(!opts.length) continue;

      let idx=opts.findIndex(o=>o.hasTick);
      if(idx<0){
        const nc=norm(correctText);
        idx=opts.findIndex(o=>norm(o.text)===nc);
        if(idx<0) idx=opts.findIndex(o=>norm(o.text).includes(nc) || nc.includes(norm(o.text)));
        if(idx<0) idx=0;
      }
      qs.push({ text:qText, options:opts.map(o=>o.text), answer:idx, explain:'' });
    }
    return qs;
  }
  function inferSubject(raw,fallback){ const m=/MÔN\s*[:：]\s*([^\n]+)/i.exec(raw||''); return m?m[1].trim():fallback||'Môn'; }

  async function loadSubjects(){
    if(window.quizData?.getAll){
      try{
        const arr=window.quizData.getAll();
        const subs = arr.map(it=>({ name: it.subject, questions: parseLegacyText(String(it.text||'')) }))
                       .filter(s=>s.questions.length);
        if(subs.length) return subs;
      }catch(e){}
    }
    const rawKeys = Object.keys(window).filter(k=>/^RAW_/.test(k));
    if(rawKeys.length){
      const list=[];
      for(const k of rawKeys){
        const raw=String(window[k]||''); const suf=k.replace(/^RAW_/,'');
        const name=window['SUBJECT_'+suf] || inferSubject(raw,suf);
        list.push({name, questions:parseLegacyText(raw)});
      }
      const subs=list.filter(s=>s.questions.length);
      if(subs.length) return subs;
    }
    try{
      const r=await fetch('data.txt',{cache:'no-store'});
      if(r.ok){
        const txt=await r.text();
        const q1=parseLegacyText(txt);
        if(q1.length) return [{name: inferSubject(txt,'Môn'), questions:q1}];
        const j=JSON.parse(txt);
        if(Array.isArray(j?.subjects)) return j.subjects;
      }
    }catch{}
    return [];
  }

  /* ===== UI Hooks ===== */
  const selSubject=byId('selSubject'), selCount=byId('selCount'), selOrder=byId('selOrder'), selFilter=byId('selFilter'), selMode=byId('selMode'), txtSearch=byId('txtSearch');
  const statTotal=byId('statTotal'), statAcc=byId('statAcc'), accBar=byId('accBar');

  // play
  const badgeSubj=byId('badgeSubj'), badgeMode=byId('badgeMode'), progress=byId('progress'), progText=byId('progText'), timerBox=byId('timerBox'), timerLbl=byId('timer');
  const qCard=byId('qCard'), qTitle=byId('qTitle'), optList=byId('optList'), expWrap=byId('expWrap'), expText=byId('expText'), minimap=byId('minimap');
  const btnPrev=byId('btnPrev'), btnNext=byId('btnNext'), btnCheck=byId('btnCheck'), btnReveal=byId('btnReveal'), btnBookmark=byId('btnBookmark'), btnSubmit=byId('btnSubmit'), btnUndo=byId('btnUndo'), btnFlag=byId('btnFlag');
  const resultCard=byId('resultCard'), donut=byId('donut'), scoreText=byId('scoreText'), timeText=byId('timeText'), btnReviewWrong=byId('btnReviewWrong'), btnRestart=byId('btnRestart');

  // footer
  const bPrev=byId('bPrev'), bNext=byId('bNext'), bCheck=byId('bCheck'), bReveal=byId('bReveal'), bSubmit=byId('bSubmit');

  // flash
  const fcFront=byId('fcFront'), fcBack=byId('fcBack'), fcPrev=byId('fcPrev'), fcNext=byId('fcNext'), fcFlip=byId('fcFlip'), fcAgain=byId('fcAgain'), fcGood=byId('fcGood'), fcMeta=byId('fcMeta');

  // settings
  const chkAutoNext=byId('chkAutoNext'), chkMinimap=byId('chkMinimap'), chkExplain=byId('chkExplain'), selFont=byId('selFont');

  /* ===== Router ===== */
  function go(hash){
    const id = (hash||'#setup').replace(/^#/,'');
    $$('main > section').forEach(s=>s.classList.add('hidden'));
    const el = byId(id); if(el){ el.classList.remove('hidden'); location.hash='#'+id; }
    const map = {setup:'Setup', play:'Làm bài', flash:'Flashcards', review:'Ôn câu sai', browser:'Ngân hàng câu hỏi', stats:'Thống kê', history:'Lịch sử', settings:'Cài đặt', help:'Hướng dẫn'};
    byId('appTitle').textContent = 'Quiz Ultra+ — '+(map[id]||'');
    byId('playBar').classList.toggle('hidden', id!=='play');
    drawer(false);
    if(id==='review') renderWrongView();
    if(id==='browser') renderBrowser();
    if(id==='stats') renderStats();
    if(id==='history') renderHistory();
  }
  function drawer(show){ const el=$('#drawer'); if(!el) return; el.style.transform = show? 'translateX(0)' : 'translateX(-110%)'; }

  /* ===== Home Stats ===== */
  function renderSubjectsSelects(){
    selSubject.innerHTML=''; const br=byId('brSubj'); br.innerHTML='';
    S.subjects.forEach((s,i)=>{
      const o=document.createElement('option'); o.value=i; o.textContent=s.name||('Môn '+(i+1));
      const o2=o.cloneNode(true); selSubject.appendChild(o); br.appendChild(o2);
    });
    updateHomeStats();
  }
  function updateHomeStats(){
    const total=S.stats.total||0; const acc= total? Math.round((S.stats.correct*100)/total) : 0;
    statTotal.textContent=total; statAcc.textContent=acc+'%'; accBar.style.width=acc+'%';
  }

  /* ===== Build Pool ===== */
  function makePool(){
    const subj=S.subjects[S.subjIdx]; if(!subj) return [];
    let arr=subj.questions.map((q,idx)=>({...q,_id:idx}));
    const key=norm(S.search);
    if(key){ arr=arr.filter(q=> norm(q.text).includes(key) || q.options.some(o=>norm(o).includes(key))); }
    if(S.filter==='bookmarked'){
      arr=arr.filter(q=> !!S.bookmarks[`${S.subjIdx}:${q._id}`]);
    }else if(S.filter==='wrong'){
      const set=new Set(S.wrongBank.map(x=>`${x.s}:${x.q}`));
      arr=arr.filter(q=> set.has(`${S.subjIdx}:${q._id}`));
    }else if(S.filter==='flagged'){
      arr=arr.filter(q=> !!S.flagged[`${S.subjIdx}:${q._id}`]);
    }
    if(S.order==='shuffle') arr.sort(()=>Math.random()-.5);
    const need = (selCount.value==='all') ? arr.length : Math.min(+selCount.value||20, arr.length);
    return arr.slice(0,need);
  }

  /* ===== Render Question ===== */
  function applyFontSize(){
    const size = S.prefs.font; // base|lg|xl
    const qCls = size==='xl'?'text-[18px] md:text-lg':'text-base';
    const oCls = size==='xl'?'text-[15.5px] md:text-base': size==='lg'?'text-[15px]':'text-[14.5px]';
    qTitle.className = `flex-1 font-semibold ${qCls}`;
    optList.querySelectorAll('.opt .text').forEach(el=> el.className=`text ${oCls}`);
  }
  function renderMinimap(){
    minimap.innerHTML='';
    if(!S.prefs.minimap){ minimap.classList.add('hidden'); return; }
    minimap.classList.remove('hidden');
    S.pool.forEach((q,idx)=>{
      const d=document.createElement('button');
      d.className='dot'; d.title='Câu '+(idx+1);
      if(S.checked[idx]) d.classList.add('done', S.answers[idx]===q.answer?'correct':'wrong');
      if(idx===S.cur) d.classList.add('active');
      d.onclick=()=>{ S.cur=idx; renderQuestion(); };
      minimap.appendChild(d);
    });
  }
  function clearMarks(){ optList.querySelectorAll('.card').forEach(el=>el.classList.remove('is-correct','is-wrong')); optList.querySelectorAll('.correct-badge,.wrong-badge').forEach(el=>el.remove()); }
  function markCurrent(fromPick=false){
    const q=S.pool[S.cur]; const pick=S.answers[S.cur];
    clearMarks();
    const cards=optList.querySelectorAll('.card');
    if(cards[q.answer]) {
      cards[q.answer].classList.add('is-correct','animate-pop');
      const b=document.createElement('div'); b.className='correct-badge'; b.textContent='✓ Đúng'; cards[q.answer].appendChild(b);
    }
    if(pick!=null && pick!==q.answer && cards[pick]) {
      cards[pick].classList.add('is-wrong');
      const b=document.createElement('div'); b.className='wrong-badge'; b.textContent='Sai'; cards[pick].appendChild(b);
    }
    if(fromPick && !S.checked[S.cur]){
      S.checked[S.cur]=true;
      S.trail.push({i:S.cur, prevCorrect:S.correct, prevWrong:S.wrong, prevChecked:true, prevAns:pick});
      if(pick===q.answer){ S.correct++; fire(); } else { S.wrong++; addWrong(q._id); vibrate(20); }
      if(S.prefs.showExplain && q.explain) expWrap.open = true;
    }
    if(S.mode!=='exam' && q.explain && S.prefs.showExplain) expWrap.open = true;
    renderMinimap();
  }
  function renderQuestion(){
    const q=S.pool[S.cur];
    if(!q){ qCard.classList.add('hidden'); return; }
    qCard.classList.remove('hidden');
    qTitle.textContent = `Câu ${S.cur+1}: ${q.text}`;
    expText.textContent = q.explain||'';
    expWrap.open = false;

    // options
    optList.innerHTML='';
    q.options.forEach((o,i)=>{
      const id=`q${S.cur}-o${i}`;
      const wrap=document.createElement('div'); wrap.className='opt';
      const inp=document.createElement('input'); inp.type='radio'; inp.name=`q${S.cur}`; inp.id=id; inp.value=i; inp.checked=(S.answers[S.cur]===i);
      const card=document.createElement('label'); card.setAttribute('for',id); card.className='card cursor-pointer';
      const row=document.createElement('div'); row.className='flex gap-3 items-start';
      const lead=document.createElement('div'); lead.className='lead'; lead.textContent=letters[i];
      const text=document.createElement('div'); text.className='text flex-1 break-words'; text.textContent=o;
      row.appendChild(lead); row.appendChild(text); card.appendChild(row);
      wrap.appendChild(inp); wrap.appendChild(card); optList.appendChild(wrap);

      inp.onchange=()=>{
        S.answers[S.cur]=i;
        if(S.mode==='practice') markCurrent(true);
        if(S.prefs.autoNext && S.cur < S.pool.length-1){
          setTimeout(()=>{ S.cur++; renderQuestion(); }, 120);
        }
      };
    });

    // badges & buttons
    const key=`${S.subjIdx}:${q._id}`;
    btnBookmark.textContent = S.bookmarks[key] ? '🔖 Đã đánh dấu' : '🔖 Đánh dấu';
    btnFlag.textContent = S.flagged[key] ? '⏳ Đã đánh dấu' : '⏳';

    // progress
    const total=S.pool.length||0; const cur=S.cur+1; progText.textContent=`${Math.min(cur,total)} / ${total}`;
    progress.style.width = total? `${(Math.min(cur,total)/total)*100}%`:'0%';

    // font size
    applyFontSize();

    // if already checked in practice, keep marks
    if(S.mode!=='exam' && S.checked[S.cur]) markCurrent(false);

    // scroll to top of question for mobile
    window.scrollTo({top:0,behavior:'smooth'});
    renderMinimap();
  }

  function addWrong(qid){
    const key=`${S.subjIdx}:${qid}`;
    const exists=S.wrongBank.some(x=>`${x.s}:${x.q}`===key);
    if(!exists){ S.wrongBank.unshift({s:S.subjIdx,q:qid}); S.wrongBank=S.wrongBank.slice(0,800); saveLS(LS_WRONG,S.wrongBank); }
  }

  function prevQ(){ if(S.cur>0){ S.cur--; renderQuestion(); } }
  function nextQ(){ if(S.cur<S.pool.length-1){ S.cur++; renderQuestion(); } }

  /* ===== Submit / History ===== */
  function submitAll(){
    if(S.mode!=='exam') return;
    const total=S.pool.length; let correct=0; const wrongList=[];
    for(let i=0;i<total;i++){
      const q=S.pool[i];
      if(S.answers[i]===q.answer) correct++; else wrongList.push({s:S.subjIdx,q:q._id});
    }
    S.wrongBank=[...wrongList, ...S.wrongBank].slice(0,800); saveLS(LS_WRONG,S.wrongBank);
    S.stats.total += total; S.stats.correct += correct;
    const subjName=S.subjects[S.subjIdx]?.name||'Môn'; S.stats.bySubj[subjName]=S.stats.bySubj[subjName]||{total:0,correct:0};
    S.stats.bySubj[subjName].total += total; S.stats.bySubj[subjName].correct += correct;
    saveLS(LS_STATS,S.stats);

    stopTimer();
    const pct=Math.round(correct*100/Math.max(1,total));
    donut.style.setProperty('--p', `${pct*3.6}deg`);
    scoreText.textContent=`Đúng ${correct}/${total} câu (${pct}%).`;
    timeText.textContent = S.seconds? `Thời gian: ${Math.floor(S.seconds/60)}m ${S.seconds%60}s` : '';
    resultCard.classList.remove('hidden'); qCard.classList.add('hidden'); window.scrollTo({top:0,behavior:'smooth'});

    S.history.unshift({id:Date.now(), t:new Date().toLocaleString(), subjName, mode:'Thi thử', total, correct, secs:S.seconds});
    S.history = S.history.slice(0,200);
    saveLS(LS_HIST,S.history);
    updateHomeStats();
  }

  /* ===== Timer ===== */
  function startTimer(){ S.seconds=0; timerLbl.textContent='00:00'; timerBox.hidden=false; S.timer=setInterval(()=>{ S.seconds++; const m=String(Math.floor(S.seconds/60)).padStart(2,'0'), s=String(S.seconds%60).padStart(2,'0'); timerLbl.textContent=`${m}:${s}`; },1000); }
  function stopTimer(){ if(S.timer){ clearInterval(S.timer); S.timer=null; } }

  /* ===== Start Session ===== */
  function startSession(){
    S.subjIdx = selSubject.selectedIndex;
    S.mode = selMode.value;
    S.order = selOrder.value;
    S.filter = selFilter.value;
    S.search = txtSearch.value.trim();

    S.pool = makePool();
    S.cur=0; S.answers={}; S.checked={}; S.correct=0; S.wrong=0; S.trail=[]; S.flagged={};
    if(!S.pool.length){ byId('warn').classList.remove('hidden'); go('#setup'); return; }
    byId('warn').classList.add('hidden');

    badgeSubj.textContent = S.subjects[S.subjIdx]?.name || 'Môn';
    badgeMode.textContent = S.mode==='study'?'Học': S.mode==='practice'?'Luyện tập':'Thi thử';
    const isExam=S.mode==='exam', isStudy=S.mode==='study', isPractice=S.mode==='practice';

    btnCheck.classList.toggle('hidden', !isPractice); bCheck.classList.toggle('hidden', !isPractice);
    btnReveal.classList.toggle('hidden', !isStudy);   bReveal.classList.toggle('hidden', !isStudy);
    btnSubmit.classList.toggle('hidden', !isExam);    bSubmit.classList.toggle('hidden', !isExam);

    resultCard.classList.add('hidden'); qCard.classList.remove('hidden');
    if(isExam){ startTimer(); } else { stopTimer(); timerBox.hidden=true; }
    renderQuestion(); go('#play');
  }

  /* ===== Flashcards ===== */
  function renderFlashBack(q){
    const opts=q.options.map((o,i)=>`<div class="mt-1"><b>${letters[i]}.</b> ${escapeHtml(o)}${i===q.answer?' <span class="text-green-600 dark:text-green-400">✓</span>':''}</div>`).join('');
    return `<div class="text-sm"><div class="font-semibold mb-1">Đáp án đúng: <span class="text-green-600 dark:text-green-400">${letters[q.answer]}</span></div>${opts}</div>`;
  }
  function enterFlash(){
    S.subjIdx = selSubject.selectedIndex;
    const base = S.subjects[S.subjIdx]?.questions||[];
    let arr=base.map((q,idx)=>({...q,_id:idx}));
    const key=norm(txtSearch.value||'');
    if(key){ arr=arr.filter(q=> norm(q.text).includes(key) || q.options.some(o=>norm(o).includes(key))); }
    if(selOrder.value==='shuffle') arr.sort(()=>Math.random()-.5);

    S.flash.list = arr.map(q=>({front:q.text, back: renderFlashBack(q)}));
    S.flash.i=0;
    if(!S.flash.list.length){ fcFront.textContent='Chưa có thẻ. Chọn môn ở Setup rồi quay lại đây nhé.'; fcBack.classList.add('hidden'); fcMeta.textContent=''; return; }
    renderFlash();
  }
  function renderFlash(){
    const it=S.flash.list[S.flash.i];
    fcFront.textContent = it.front;
    fcBack.innerHTML = it.back;
    fcBack.classList.add('hidden');
    fcMeta.textContent = `Thẻ ${S.flash.i+1}/${S.flash.list.length}`;
  }

  /* ===== Review Wrong ===== */
  function renderWrongView(){
    const box=byId('wrongList'); box.innerHTML='';
    if(!S.wrongBank.length){ box.innerHTML='<div class="text-sm text-slate-500">Không có câu sai nào gần đây.</div>'; return; }
    const by={};
    for(const w of S.wrongBank){
      const subj=S.subjects[w.s]; if(!subj) continue;
      by[w.s]=by[w.s]||[]; const q=subj.questions[w.q]; if(!q) continue;
      by[w.s].push({qid:w.q, q});
    }
    for(const sIdx of Object.keys(by)){
      const group=document.createElement('div');
      group.className='rounded-xl border border-slate-200 dark:border-slate-800 p-3';
      const h=document.createElement('div'); h.className='font-semibold mb-2'; h.textContent=S.subjects[sIdx]?.name||'Môn';
      group.appendChild(h);
      by[sIdx].slice(0,60).forEach((it,i)=>{
        const row=document.createElement('details'); row.className='rounded-lg border border-slate-200 dark:border-slate-700 p-2';
        const sum=document.createElement('summary'); sum.className='cursor-pointer text-sm font-medium'; sum.textContent=`${i+1}. ${it.q.text}`;
        const ans=document.createElement('div'); ans.className='mt-2 text-sm';
        ans.innerHTML = renderFlashBack(it.q);
        row.appendChild(sum); row.appendChild(ans); group.appendChild(row);
      });
      box.appendChild(group);
    }
  }

  /* ===== Browser ===== */
  function renderBrowser(){
    const sIdx=byId('brSubj').selectedIndex ?? 0;
    const subj=S.subjects[sIdx]; if(!subj) return;
    const key=norm(byId('brSearch').value||'');
    const list=byId('brList'); list.innerHTML='';
    subj.questions.forEach((q,idx)=>{
      if(key && !(norm(q.text).includes(key) || q.options.some(o=>norm(o).includes(key)))) return;
      const row=document.createElement('details'); row.className='rounded-xl border border-slate-200 dark:border-slate-800 p-3';
      const sum=document.createElement('summary'); sum.className='cursor-pointer font-medium'; sum.textContent=`${idx+1}. ${q.text}`;
      const box=document.createElement('div'); box.className='mt-2 space-y-2';
      q.options.forEach((o,i)=>{
        const div=document.createElement('div'); div.className='px-3 py-2 rounded-lg border text-sm '+(i===q.answer?' border-green-600 text-green-700 dark:text-green-300':' border-slate-200 dark:border-slate-700');
        div.textContent = `${letters[i]}. ${o}`;
        box.appendChild(div);
      });
      row.appendChild(sum); row.appendChild(box); list.appendChild(row);
    });
  }

  /* ===== Stats ===== */
  function renderStats(){
    const total=S.stats.total||0; const correct=S.stats.correct||0; const acc= total? Math.round(correct*100/total) : 0;
    byId('sumText').textContent = `Đúng ${correct}/${total} (${acc}%)`;
    byId('sumDonut').style.setProperty('--p', `${acc*3.6}deg`);
    byId('sumBar').style.width = acc+'%';

    const box=byId('bySubj'); box.innerHTML='';
    const entries=Object.entries(S.stats.bySubj||{});
    if(!entries.length){ box.innerHTML='<div class="text-sm text-slate-500">Chưa có dữ liệu.</div>'; return; }
    entries.forEach(([name,st])=>{
      const a = st.total? Math.round(st.correct*100/st.total) : 0;
      const row=document.createElement('div'); row.className='p-2 rounded-xl border border-slate-200 dark:border-slate-800';
      row.innerHTML=`<div class="text-sm font-medium">${escapeHtml(name)}</div>
                     <div class="text-xs text-slate-500 dark:text-slate-400 mb-1">Đúng ${st.correct}/${st.total} (${a}%)</div>
                     <div class="bar"><i style="width:${a}%"></i></div>`;
      box.appendChild(row);
    });
  }

  /* ===== History ===== */
  function renderHistory(){
    const box=byId('histList'); box.innerHTML='';
    if(!S.history.length){ box.innerHTML='<div class="text-sm text-slate-500">Chưa có bài làm nào.</div>'; return; }
    S.history.forEach((h,i)=>{
      const card=document.createElement('div'); card.className='rounded-xl border border-slate-200 dark:border-slate-800 p-3 flex items-center gap-3';
      const pct = h.total? Math.round(h.correct*100/h.total):0;
      card.innerHTML = `<div class="w-14">
        <div class="donut" style="--p:${pct*3.6}deg"></div>
      </div>
      <div class="flex-1">
        <div class="text-sm font-semibold">${escapeHtml(h.subjName)} — ${escapeHtml(h.mode)}</div>
        <div class="text-xs text-slate-500">${h.t} • ${h.correct}/${h.total} (${pct}%) • ${Math.floor((h.secs||0)/60)}m ${ (h.secs||0)%60 }s</div>
      </div>
      <button class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 ripple">Luyện lại</button>`;
      card.querySelector('button').onclick = debounce(()=>{
        selSubject.selectedIndex = S.subjects.findIndex(s=>s.name===h.subjName);
        selMode.value = 'practice'; selCount.value = 'all'; selOrder.value = 'shuffle'; selFilter.value = 'all'; txtSearch.value = '';
        startSession();
      }, 200);
      box.appendChild(card);
    });
  }

  /* ===== Prefs / Theme ===== */
  function setTheme(mode){
    const root=document.documentElement;
    if(mode==='dark') root.classList.add('dark');
    else if(mode==='light') root.classList.remove('dark');
    else window.matchMedia('(prefers-color-scheme: dark)').matches ? root.classList.add('dark') : root.classList.remove('dark');
  }

  /* ===== Utils ===== */
  function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  const debounce=(fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),ms); } };
  const guardClick = (btn,fn)=> ()=>{ if(btn.disabled) return; btn.disabled=true; setTimeout(()=>btn.disabled=false,260); fn(); };

  /* ===== Events ===== */
  document.addEventListener('DOMContentLoaded', async ()=>{
    // theme buttons
    on(byId('btnTheme'),'click',()=> document.documentElement.classList.toggle('dark'));
    on(byId('btnNav'),'click',()=> drawer(true));
    on(byId('btnCloseDrawer'),'click',()=> drawer(false));
    $$('#drawer .navbtn').forEach(b=> on(b,'click',()=> go(b.dataset.goto)));
    on(byId('btnHome'),'click',()=> go('#setup'));

    // import/export (setup)
    const doExport=()=>{
      const data={ bookmarks:S.bookmarks, wrongBank:S.wrongBank, stats:S.stats, history:S.history, prefs:S.prefs };
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quiz-progress.json'; a.click(); URL.revokeObjectURL(a.href);
    };
    const doImport=async (file)=>{
      if(!file) return;
      try{
        const t=await file.text(); const d=JSON.parse(t);
        if(d.bookmarks) S.bookmarks=d.bookmarks;
        if(d.wrongBank) S.wrongBank=d.wrongBank;
        if(d.stats) S.stats=d.stats;
        if(d.history) S.history=d.history;
        if(d.prefs) S.prefs=Object.assign(S.prefs,d.prefs);
        saveLS(LS_BOOK,S.bookmarks); saveLS(LS_WRONG,S.wrongBank); saveLS(LS_STATS,S.stats); saveLS(LS_HIST,S.history); saveLS(LS_PREF,S.prefs);
        updateHomeStats(); alert('Nhập tiến trình thành công!');
      }catch{ alert('File không hợp lệ.'); }
    };
    on(byId('btnExport'),'click',doExport);
    on(byId('btnImport'),'click',()=> byId('fileImport').click());
    on(byId('fileImport'),'change',e=>{ doImport(e.target.files?.[0]); e.target.value=''; });

    on(byId('btnExport2'),'click',doExport);
    on(byId('btnImport2'),'click',()=> byId('fileImport2').click());
    on(byId('fileImport2'),'change',e=>{ doImport(e.target.files?.[0]); e.target.value=''; });

    on(byId('btnReset'),'click',()=>{ if(confirm('Xóa toàn bộ tiến trình đã lưu?')){ localStorage.clear(); location.reload(); } });

    // quick wrong
    on(byId('btnWrongQuick'),'click',()=> go('#review'));

    // browser
    on(byId('brSubj'),'change',renderBrowser);
    on(byId('brSearch'),'input',debounce(renderBrowser,150));

    // start session
    on(byId('btnStart'),'click', guardClick(byId('btnStart'), startSession));

    // play buttons (chống click đúp)
    on(btnPrev,'click',guardClick(btnPrev, prevQ));
    on(btnNext,'click',guardClick(btnNext, nextQ));
    on(bPrev,'click',guardClick(bPrev, prevQ));
    on(bNext,'click',guardClick(bNext, nextQ));

    on(btnCheck,'click',guardClick(btnCheck, ()=>markCurrent(true)));
    on(bCheck,'click',guardClick(bCheck, ()=>markCurrent(true)));
    on(btnReveal,'click',guardClick(btnReveal, ()=>{
      if(S.mode!=='study') return;
      clearMarks(); const q=S.pool[S.cur]; const cards=optList.querySelectorAll('.card');
      if(cards[q.answer]){ cards[q.answer].classList.add('is-correct','animate-pop'); const b=document.createElement('div'); b.className='correct-badge'; b.textContent='✓ Đúng'; cards[q.answer].appendChild(b); }
      expWrap.open = true;
    }));
    on(bReveal,'click',()=>btnReveal.click());

    on(btnBookmark,'click',guardClick(btnBookmark, ()=>{
      const q=S.pool[S.cur]; const key=`${S.subjIdx}:${q._id}`;
      S.bookmarks[key]=!S.bookmarks[key]; saveLS(LS_BOOK,S.bookmarks);
      btnBookmark.textContent = S.bookmarks[key] ? '🔖 Đã đánh dấu' : '🔖 Đánh dấu';
    }));

    on(btnFlag,'click',guardClick(btnFlag, ()=>{
      const q=S.pool[S.cur]; const key=`${S.subjIdx}:${q._id}`;
      S.flagged[key]=!S.flagged[key]; saveLS(LS_FLAG,S.flagged);
      btnFlag.textContent = S.flagged[key] ? '⏳ Đã đánh dấu' : '⏳';
    }));

    on(btnSubmit,'click',guardClick(btnSubmit, submitAll));
    on(bSubmit,'click',guardClick(bSubmit, submitAll));
    on(btnRestart,'click',guardClick(btnRestart, startSession));
    on(btnReviewWrong,'click',()=> go('#review'));

    // Undo
    on(btnUndo,'click',guardClick(btnUndo, ()=>{
      const last=S.trail.pop(); if(!last) return;
      S.correct=last.prevCorrect; S.wrong=last.prevWrong; S.checked[last.i]=false; S.answers[last.i]=last.prevAns;
      if(S.cur!==last.i){ S.cur=last.i; }
      renderQuestion();
    }));

    // flash
    on(fcFlip,'click',()=> fcBack.classList.toggle('hidden'));
    on(fcPrev,'click',()=>{ if(S.flash.i>0){ S.flash.i--; renderFlash(); } });
    on(fcNext,'click',()=>{ if(S.flash.i<S.flash.list.length-1){ S.flash.i++; renderFlash(); } });
    on(fcAgain,'click',()=>{ const it=S.flash.list[S.flash.i]; S.flash.list.push(it); S.flash.i=Math.min(S.flash.i+1, S.flash.list.length-1); renderFlash(); vibrate(20); });
    on(fcGood,'click',()=>{ S.flash.list.splice(S.flash.i,1); if(S.flash.i>=S.flash.list.length) S.flash.i=Math.max(0,S.flash.list.length-1);
      if(S.flash.list.length){ renderFlash(); } else { fcFront.textContent='🔥 Bạn đã thuộc hết bộ thẻ!'; fcBack.classList.add('hidden'); fcMeta.textContent=''; fire(); }});
    // vào Flash từ Setup
    $$('button[data-goto="#flash"]').forEach(b=> on(b,'click',()=>{ enterFlash(); go('#flash'); }));

    // review
    on(byId('btnClearWrong'),'click',()=>{ if(confirm('Xóa danh sách câu sai gần đây?')){ S.wrongBank=[]; saveLS(LS_WRONG,S.wrongBank); renderWrongView(); } });

    // swipe trái/phải
    (function attachSwipe(){
      let sx=0,sy=0,dx=0,dy=0; const area=$('main');
      on(area,'touchstart',e=>{const t=e.touches[0]; sx=t.clientX; sy=t.clientY;});
      on(area,'touchmove',e=>{const t=e.touches[0]; dx=t.clientX-sx; dy=t.clientY-sy;});
      on(area,'touchend',()=>{ if(Math.abs(dx)>60 && Math.abs(dy)<40){ dx<0? nextQ(): prevQ(); } dx=dy=0;});
    })();

    // settings
    chkAutoNext.checked = !!S.prefs.autoNext;
    chkMinimap.checked  = !!S.prefs.minimap;
    chkExplain.checked  = !!S.prefs.showExplain;
    selFont.value = S.prefs.font || 'base';

    on(chkAutoNext,'change',()=>{ S.prefs.autoNext=chkAutoNext.checked; saveLS(LS_PREF,S.prefs); });
    on(chkMinimap,'change',()=>{ S.prefs.minimap=chkMinimap.checked; saveLS(LS_PREF,S.prefs); renderMinimap(); });
    on(chkExplain,'change',()=>{ S.prefs.showExplain=chkExplain.checked; saveLS(LS_PREF,S.prefs); });
    on(selFont,'change',()=>{ S.prefs.font=selFont.value; saveLS(LS_PREF,S.prefs); applyFontSize(); });

    // theme
    on(byId('setDark'),'click',()=> setTheme('dark'));
    on(byId('setLight'),'click',()=> setTheme('light'));
    on(byId('setAuto'),'click',()=> setTheme('auto'));

    // hash
    window.addEventListener('hashchange',()=> go(location.hash||'#setup'));

    // Load data
    S.subjects = await loadSubjects();
    if(!S.subjects.length){ byId('warn').classList.remove('hidden'); selSubject.innerHTML='<option>Chưa có dữ liệu</option>'; }
    else { byId('warn').classList.add('hidden'); renderSubjectsSelects(); }

    // init
    go(location.hash||'#setup');
    setTheme('auto');
  });
})();
</script>
</body>
</html>
