<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Quiz Pro • Mobile</title>
<style>
  :root{
    --bg:#0b0e13; --layer:#0f1522; --card:#10161f; --muted:#1a2230; --ink:#e7ecf3; --sub:#a8b2c1;
    --brand:#5b8cff; --ok:#19c37d; --warn:#ffb020; --bad:#ff5c7c; --ring:rgba(91,140,255,.25);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;color:var(--ink);background:linear-gradient(180deg,#0b0e13 0,#0b0e13 200px,#0f1522 201px)}
  button,input,select,textarea{font:inherit;color:inherit}
  .container{max-width:960px;margin:0 auto;padding:12px}
  .header{position:sticky;top:0;z-index:50;background:rgba(11,14,19,.7);backdrop-filter:blur(10px);border-bottom:1px solid #1f2838}
  .bar{display:flex;align-items:center;gap:10px;padding:10px 12px}
  .brand{font-weight:800}
  .chip{font-size:12px;background:var(--muted);padding:3px 8px;border-radius:999px;color:var(--sub)}
  .btn{border:1px solid #2a3750;background:#152033;color:#e7ecf3;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .btn.primary{background:var(--brand);border-color:#2a54ff;color:#fff}
  .btn.ghost{background:transparent;border-color:#2a3750}
  .btn.warn{background:#2b1c00;border-color:#5c3d00;color:#ffc56b}
  .btn.success{background:#06251a;border-color:#0c4d33;color:#7ff0bd}
  .btn.danger{background:#2a1217;border-color:#6b1f2b;color:#ff9cae}
  .btn.block{width:100%}
  .card{background:var(--card);border:1px solid #202a3b;border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr}
  @media(max-width:680px){.two{grid-template-columns:1fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .field label{display:block;font-size:12px;color:var(--sub);margin-bottom:6px}
  .field input,.field select{width:100%;background:#121826;border:1px solid #25314a;border-radius:12px;padding:10px 12px;color:var(--ink);outline:none}
  .sub{font-size:12px;color:var(--sub)}
  .stickyNav{position:sticky;top:62px;z-index:40;background:rgba(16,21,31,.75);backdrop-filter:blur(10px);border:1px solid #202a3b;border-radius:14px}
  .collapse{overflow:hidden;max-height:0;transition:max-height .25s ease}
  .collapse.open{max-height:270px}
  .navGrid{display:grid;gap:6px;grid-template-columns:repeat(10,1fr)}
  @media(max-width:600px){.navGrid{grid-template-columns:repeat(8,1fr)}}
  @media(max-width:420px){.navGrid{grid-template-columns:repeat(6,1fr)}}
  #navGrid,#drawerGrid{max-height:160px;overflow:auto;padding-bottom:2px}
  .navBtn{border:1px solid #2a3750;background:#141c2b;border-radius:10px;padding:6px 0;text-align:center;font-size:12px;color:#cfd7e7}
  .navBtn.answered{background:#0f2a21;border-color:#1f6b50;color:#a3f2cf}
  .navBtn.hard{background:#2a240f;border-color:#5d4d1a;color:#ffd56b}
  .navBtn.correct{background:#0f2418;border-color:#1e6b45;color:#9cf0c3}
  .navBtn.wrong{background:#2a1217;border-color:#6b1f2b;color:#ff9cae}
  .qCard{border:1px solid #223147;border-radius:16px;padding:12px;background:#0f1522}
  .qHead{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
  .qTitle{font-weight:700}
  .star{font-size:18px;color:#3a4357} .star.active{color:#ffd56b;filter:drop-shadow(0 0 6px rgba(255,213,107,.4))}
  .opts{margin-top:8px;display:grid;gap:8px}
  .opt{border:1px solid #2a3750;border-radius:12px}
  .opt.locked{opacity:.7}
  .opt input{display:none}
  .opt label{display:block;padding:10px 12px;cursor:pointer}
  .opt input:checked + label{background:#151f33;border-radius:12px;border:1px solid #36507a;box-shadow:0 0 0 4px var(--ring)}
  .result{margin-top:6px;font-size:13px}
  .ok{color:#7ff0bd} .bad{color:#ff9cae}
  .pulse{position:relative}
  .pulse::after{content:"";position:absolute;inset:-6px;border:2px dashed rgba(91,140,255,.5);border-radius:12px;animation:pulse 1.1s ease-out 2}
  @keyframes pulse{0%{opacity:.8;transform:scale(.98)}70%{opacity:.15;transform:scale(1.06)}100%{opacity:0;transform:scale(1.12)}}
  .fab{position:fixed;right:14px;bottom:16px;z-index:60}
  .drawer{position:fixed;inset:0;z-index:70;display:none}
  .drawer.open{display:block}
  .drawer .mask{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .drawer .panel{position:absolute;right:0;top:0;height:100%;width:360px;max-width:92vw;background:#0f1522;border-left:1px solid #1f2838;padding:12px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:#121826;border:1px solid #24324a;padding:10px 14px;border-radius:12px;color:#dbe6f8;font-size:13px;z-index:100;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .hidden{display:none !important}
</style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <div class="bar container">
      <div class="brand">Quiz Pro</div>
      <span id="chipPhase" class="chip">Thiết lập</span>
      <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
        <div class="sub">⏱</div>
        <div id="timer" style="font-variant-numeric:tabular-nums;font-weight:800">00:00</div>
        <button id="btnSubmit" class="btn primary hidden">Nộp bài</button>
        <button id="btnRestart" class="btn ghost hidden">Làm lại</button>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- SETUP -->
    <section id="setup" class="card">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <div style="font-weight:800;font-size:18px">Thiết lập bài</div>
        <span class="chip" id="chipBank">0 câu</span>
        <span class="chip" id="chipSRS">SRS hôm nay: 0</span>
        <span style="margin-left:auto"></span>
        <button id="btnSRSStart" class="btn success">Ôn SRS hôm nay</button>
      </div>
      <div class="sub">Chọn môn, số câu, thời lượng, trộn, seed… rồi bắt đầu.</div>

      <div class="grid two" style="margin-top:12px">
        <div class="field">
          <label>Môn</label>
          <select id="selSubject"></select>
          <div class="sub">Ngân hàng: <b id="bankCount">0</b> câu</div>
        </div>
        <div class="field"><label>Số câu</label><input id="inpLimit" type="number" min="1" value="20" /></div>
        <div class="field"><label>Thời lượng (phút)</label><input id="inpMinutes" type="number" min="1" value="15" /></div>
        <div class="field">
          <label>Chế độ</label>
          <select id="selMode">
            <option value="exam">Kiểm tra (ẩn đáp án)</option>
            <option value="practice">Luyện tập (phản hồi ngay)</option>
          </select>
        </div>
        <div class="field"><label>Seed (mã đề, tuỳ chọn)</label><input id="inpSeed" placeholder="vd: lopT2" /></div>
      </div>

      <div class="row" style="margin-top:10px">
        <label><input type="checkbox" id="chkShuffleQ" checked /> Trộn câu</label>
        <label><input type="checkbox" id="chkShuffleA" checked /> Trộn đáp án</label>
        <label><input type="checkbox" id="chkPreferHard" /> Ưu tiên câu ★</label>
        <label><input type="checkbox" id="chkSRS" /> Áp dụng SRS khi chọn câu</label>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnStart" class="btn success">Bắt đầu làm bài</button>
        <button id="btnOpenEditor" class="btn warn">Soát/Đổi đáp</button>
        <button id="btnExport" class="btn ghost">Xuất CSV</button>
        <button id="btnBackup" class="btn ghost">Sao lưu JSON</button>
        <button id="btnRestore" class="btn ghost">Phục hồi JSON</button>
        <input id="fileRestore" type="file" accept="application/json" class="hidden" />
        <div class="sub" style="margin-left:auto">Cài đặt & tiến trình tự lưu.</div>
      </div>
      <div id="snapNotice" class="sub hidden" style="margin-top:6px"></div>
    </section>

    <!-- STICKY TOOLS -->
    <section id="stickyTools" class="stickyNav card hidden" style="margin-top:12px">
      <div class="row">
        <span class="chip" id="progress">0/0</span>
        <span id="titleRun" class="sub"></span>
        <button id="btnToggleNav" class="btn ghost" style="margin-left:auto">☰ Danh sách</button>
      </div>
      <div id="navBody" class="collapse">
        <div class="row" style="margin-top:8px">
          <select id="selFilter" class="btn ghost">
            <option value="all">Tất cả</option>
            <option value="unanswered">Chưa làm</option>
            <option value="answered">Đã làm</option>
            <option value="hard">Câu ★</option>
          </select>
          <input id="inpSearch" placeholder="Tìm câu hỏi…" class="btn ghost" style="flex:1" />
          <label class="btn ghost" style="padding:6px 10px"><input type="checkbox" id="chkPreferHardLive" /> Ưu tiên ★</label>
          <button id="btnPrev" class="btn ghost">← Trước</button>
          <button id="btnNext" class="btn ghost">Sau →</button>
        </div>
        <div id="navGrid" class="navGrid" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- EXAM -->
    <section id="exam" class="hidden" style="margin-top:12px">
      <div id="qList" class="grid"></div>
    </section>

    <!-- EDITOR -->
    <section id="editor" class="card hidden" style="margin-top:12px">
      <div class="row" style="width:100%">
        <div style="font-weight:800">Soát / Đổi đáp & giải thích</div>
        <div class="sub" id="edCount"></div>
        <div style="margin-left:auto"></div>
        <select id="edSubject" class="btn ghost"></select>
        <input id="edSearch" class="btn ghost" placeholder="Tìm câu…" style="flex:1" />
        <button id="btnCloseEditor" class="btn">Đóng</button>
      </div>
      <div id="edList" class="grid" style="margin-top:8px"></div>
    </section>

  </div>

  <!-- Drawer -->
  <div id="drawer" class="drawer">
    <div class="mask" id="drawerMask"></div>
    <div class="panel">
      <div class="row">
        <div style="font-weight:800">Danh sách câu</div>
        <button id="btnCloseDrawer" class="btn ghost" style="margin-left:auto">Đóng</button>
      </div>
      <div id="drawerGrid" class="navGrid" style="margin-top:8px"></div>
    </div>
  </div>
  <button id="btnOpenDrawer" class="fab btn primary hidden">☰ Danh sách</button>

  <div id="toast" class="toast hidden"></div>

  <!-- DATA SCRIPT -->
  <script src="./data.js"></script>

  <!-- APP SCRIPT -->
  <script>
  /************ Utils ************/
  const KEYS = {
    SETUP:'qp_setup', HARD:'qp_hard', OVERRIDE:'qp_override',
    SNAP:'qp_snapshot', NAVOPEN:'qp_nav_open', SRS:'qp_srs', STATS:'qp_stats'
  };
  const $ = s => document.querySelector(s);
  const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
  const load=(k,def)=>{ try{const v=JSON.parse(localStorage.getItem(k)||''); return (v??def);}catch{return def;} };
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const shuffle=a=>{ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } };
  const normVN=s=>s.normalize('NFD').replace(/\p{M}+/gu,'').toLowerCase().replace(/[“”"'`’]/g,'').replace(/\s+/g,' ').trim();
  const toast=msg=>{ const t=$("#toast"); t.textContent=msg; t.classList.remove('hidden'); clearTimeout(toast._t); toast._t=setTimeout(()=>t.classList.add('hidden'),1800); };
  const fmt=sec=>{ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return m+':'+s; };
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
  function seededShuffle(arr, seedStr='seed'){
    let h=1779033703^seedStr.length; for(let i=0;i<seedStr.length;i++){ h=Math.imul(h^seedStr.charCodeAt(i),3432918353); h=h<<13|h>>>19; }
    const rand=mulberry32(h>>>0); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(rand()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  }

  /************ Elements ************/
  const el = {
    chipPhase: $("#chipPhase"), timer: $("#timer"),
    setup: $("#setup"), selSubject: $("#selSubject"), bankCount: $("#bankCount"), chipBank: $("#chipBank"), chipSRS: $("#chipSRS"),
    inpLimit: $("#inpLimit"), inpMinutes: $("#inpMinutes"), selMode: $("#selMode"), inpSeed: $("#inpSeed"),
    chkShuffleQ: $("#chkShuffleQ"), chkShuffleA: $("#chkShuffleA"), chkPreferHard: $("#chkPreferHard"), chkSRS: $("#chkSRS"),
    btnStart: $("#btnStart"), btnSRSStart: $("#btnSRSStart"), btnOpenEditor: $("#btnOpenEditor"),
    btnExport: $("#btnExport"), btnBackup: $("#btnBackup"), btnRestore: $("#btnRestore"), fileRestore: $("#fileRestore"),
    sticky: $("#stickyTools"), progress: $("#progress"), titleRun: $("#titleRun"),
    selFilter: $("#selFilter"), inpSearch: $("#inpSearch"), chkPreferHardLive: $("#chkPreferHardLive"),
    btnPrev: $("#btnPrev"), btnNext: $("#btnNext"), navGrid: $("#navGrid"), btnToggleNav: $("#btnToggleNav"), navBody: $("#navBody"),
    exam: $("#exam"), qList: $("#qList"), btnSubmit: $("#btnSubmit"), btnRestart: $("#btnRestart"),
    editor: $("#editor"), edSubject: $("#edSubject"), edSearch: $("#edSearch"), edList: $("#edList"), edCount: $("#edCount"), btnCloseEditor: $("#btnCloseEditor"),
    drawer: $("#drawer"), drawerMask: $("#drawerMask"), drawerGrid: $("#drawerGrid"), btnOpenDrawer: $("#btnOpenDrawer"), btnCloseDrawer: $("#btnCloseDrawer"),
    snapNotice: $("#snapNotice"),
  };

  /************ Data model ************/
  const BANK = [];        // [{id, subjectId, subjectName, qnum, question, options[4], correctIndex, explain?}]
  const STATS = load(KEYS.STATS, {});  // id -> {A:0,B:0,C:0,D:0,seen:0,correct:0}
  const SRS = load(KEYS.SRS, {});      // id -> {dueAt:number(utc ms), stage:number}
  const state = {
    phase:'setup', items:[], answers:new Map(), hard:new Set(), currentIndex:0,
    submitted:false, timeLeft:0, timerId:null,
    setup:{subject:'all', limit:20, minutes:15, shuffleQ:true, shuffleA:true, mode:'exam', preferHard:false, seed:'', useSRS:false},
    overrides:{}, filter:'all', search:'', preferHardLive:false, wrongQueue:null, navOpen:false
  };

  /************ Legacy TXT parser (fallback) ************/
  function parseTxt(inputText, subjectId, subjectName){
    let text=(inputText||'').replace(/\r\n|\r/g,'\n');
    const parts=text.split(/(?=^\s*Câu\s+\d+\s*:)/m).filter(b=>/^\s*Câu\s+\d+\s*:/m.test(b));
    const items=[];
    for(const raw of parts){
      const mQ=raw.match(/^\s*Câu\s+(\d+)\s*:\s*([\s\S]*)$/i); if(!mQ) continue;
      const qnum=parseInt(mQ[1],10), afterQ=mQ[2];
      const dividerRe=/^\s*Tất\s*cả\s*(?:các\s*)?đáp\s*án\s*:?.*$/mi;
      const mDiv=dividerRe.exec(afterQ);
      const before=mDiv?afterQ.slice(0,mDiv.index):afterQ;
      const optionsPart=mDiv?afterQ.slice(mDiv.index):"";
      const mAns=before.match(/Đáp\s*án\s*đúng\s*:\s*(.+)/i);
      const explicitCorrect=mAns?mAns[1].trim():null;
      const questionText=mAns?before.slice(0,mAns.index).trim():before.trim();

      let options=[]; let correctIndex=null;
      const rxOpt=/^\s*([A-Z])\.\s*(.+?)\s*$/gmi; let m;
      while((m=rxOpt.exec(optionsPart))){
        let txt=m[2].trim();
        const tick=/[✓✔]/.test(txt);
        txt=txt.replace(/[✓✔]/g,'').replace(/\s*\.\s*$/,'').trim();
        if(txt) options.push(txt);
        if(tick) correctIndex=options.length-1;
      }
      // Fallback khi thiếu A/B/C/D
      if(!options.length){
        if(explicitCorrect){ options=[explicitCorrect,'—','—','—']; correctIndex=0; }
        else continue;
      }
      // Tìm correct nếu chưa đánh dấu ✓
      if(correctIndex==null && explicitCorrect){
        const target=normVN(explicitCorrect);
        for(let i=0;i<options.length;i++){
          const o=normVN(options[i]);
          if(o===target||o.startsWith(target)||target.startsWith(o)){ correctIndex=i; break; }
        }
        if(correctIndex==null){
          const set=s=>new Set(normVN(s).split(' ').filter(Boolean));
          const inter=(a,b)=>{ const sa=set(a), sb=set(b); const n=[...sa].filter(x=>sb.has(x)).length; const u=new Set([...sa,...sb]).size||1; return n/u; };
          let best=-1,bestI=null; for(let i=0;i<options.length;i++){ const r=inter(options[i], explicitCorrect); if(r>best){best=r;bestI=i;} }
          if(bestI!=null && best>=0.35) correctIndex=bestI;
        }
      }
      if(correctIndex==null) continue;

      items.push({
        id:`${subjectId}-${qnum}`, subjectId, subjectName, qnum,
        question:questionText, options, correctIndex
      });
    }
    return items.sort((a,b)=>a.qnum-b.qnum);
  }

  /************ Load data from data.js ************/
  function loadBank(){
    // 1) JSON dễ sửa
    if(window.quizDataJSON && Array.isArray(window.quizDataJSON.subjects)){
      window.quizDataJSON.subjects.forEach(sub=>{
        (sub.questions||[]).forEach((q,i)=>{
          BANK.push({
            id:q.id || `${sub.id}-${q.qnum||i+1}`,
            subjectId:sub.id, subjectName:sub.name,
            qnum:q.qnum||i+1, question:q.text, options:q.options, correctIndex:q.answer, explain:q.explain||''
          });
        });
      });
    }
    // 2) Legacy TXT (tương thích file cũ của bạn)
    else if(window.quizData && typeof window.quizData.getAll==='function'){
      window.quizData.getAll().forEach(({subject,text, id})=>{
        const subId = id || normVN(subject).replace(/\s+/g,'-').slice(0,24);
        BANK.push(...parseTxt(text, subId, subject));
      });
    }
    // Hard & override
    state.hard=new Set(Object.keys(load(KEYS.HARD, {})));
    state.overrides=load(KEYS.OVERRIDE, {});
  }

  /************ Setup screen ************/
  function buildSetup(){
    loadBank();
    // Subject list
    const subs=[...new Map(BANK.map(x=>[x.subjectId,x.subjectName])).entries()]
      .map(([id,name])=>({id,name}));
    el.selSubject.innerHTML = `<option value="all">Tất cả</option>` + subs.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    // restore setup
    Object.assign(state.setup, load(KEYS.SETUP, state.setup));
    el.selSubject.value = state.setup.subject;
    el.inpLimit.value = state.setup.limit;
    el.inpMinutes.value = state.setup.minutes;
    el.selMode.value = state.setup.mode;
    el.chkShuffleQ.checked = state.setup.shuffleQ;
    el.chkShuffleA.checked = state.setup.shuffleA;
    el.chkPreferHard.checked = state.setup.preferHard;
    el.chkSRS.checked = state.setup.useSRS;
    el.inpSeed.value = state.setup.seed || '';

    const updateBankCount=()=> {
      const subj=el.selSubject.value||'all';
      const list = subj==='all'? BANK : BANK.filter(x=>x.subjectId===subj);
      el.bankCount.textContent = String(list.length);
      el.chipBank.textContent = `${list.length} câu`;
      el.inpLimit.value = clamp(+el.inpLimit.value||1, 1, Math.max(1,list.length));
    };
    el.selSubject.onchange=()=>{ state.setup.subject=el.selSubject.value; save(KEYS.SETUP,state.setup); updateBankCount(); };
    ["inpLimit","inpMinutes","inpSeed"].forEach(id=> el[id].oninput=()=>{ state.setup.limit=+el.inpLimit.value||1; state.setup.minutes=+el.inpMinutes.value||1; state.setup.seed=el.inpSeed.value.trim(); save(KEYS.SETUP,state.setup); });
    el.selMode.onchange=()=>{ state.setup.mode=el.selMode.value; save(KEYS.SETUP,state.setup); };
    el.chkShuffleQ.onchange=()=>{ state.setup.shuffleQ=el.chkShuffleQ.checked; save(KEYS.SETUP,state.setup); };
    el.chkShuffleA.onchange=()=>{ state.setup.shuffleA=el.chkShuffleA.checked; save(KEYS.SETUP,state.setup); };
    el.chkPreferHard.onchange=()=>{ state.setup.preferHard=el.chkPreferHard.checked; save(KEYS.SETUP,state.setup); };
    el.chkSRS.onchange=()=>{ state.setup.useSRS=el.chkSRS.checked; save(KEYS.SETUP,state.setup); };

    el.btnStart.onclick=startFromSetup;
    el.btnSRSStart.onclick=startSRS;
    el.btnOpenEditor.onclick=openEditor;
    el.btnToggleNav.onclick=()=>setNavOpen(!state.navOpen);
    el.btnExport.onclick=exportCSV;
    el.btnBackup.onclick=backupJSON;
    el.btnRestore.onclick=()=>el.fileRestore.click();
    el.fileRestore.onchange=restoreJSON;

    updateBankCount();
    updateSRSChip();

    // Snapshot notice
    const snap=load(KEYS.SNAP,null);
    if(snap && snap.items && snap.items.length){
      el.snapNotice.classList.remove('hidden');
      el.snapNotice.textContent = '⚡ Có phiên làm dở trước đó. Bạn có muốn khôi phục?';
      const restoreBtn = document.createElement('button'); restoreBtn.className='btn success'; restoreBtn.textContent='Khôi phục';
      restoreBtn.onclick=()=>restoreSnapshot(snap);
      el.snapNotice.appendChild(restoreBtn);
      const discardBtn=document.createElement('button'); discardBtn.className='btn danger'; discardBtn.textContent='Bỏ';
      discardBtn.style.marginLeft='8px'; discardBtn.onclick=()=>{ localStorage.removeItem(KEYS.SNAP); el.snapNotice.classList.add('hidden'); };
      el.snapNotice.appendChild(discardBtn);
    }
  }

  function setNavOpen(open){
    state.navOpen=open;
    el.navBody.classList.toggle('open', open);
    el.btnToggleNav.textContent = open ? 'Ẩn danh sách' : '☰ Danh sách';
    save(KEYS.NAVOPEN, open);
  }
  function updateSRSChip(){
    const now=Date.now();
    const subj=el.selSubject.value||'all';
    const list=subj==='all'?BANK:BANK.filter(x=>x.subjectId===subj);
    const due = list.filter(x=> !SRS[x.id] || (SRS[x.id] && SRS[x.id].dueAt<=now) );
    el.chipSRS.textContent = `SRS hôm nay: ${due.length}`;
  }

  /************ Round selection ************/
  function applyOverrides(pool){ return pool.map(it => (state.overrides[it.id]!==undefined ? {...it, correctIndex: state.overrides[it.id]} : it)); }
  function pickPool(baseList){
    let pool = applyOverrides(baseList);
    // Ưu tiên ★
    if(state.setup.preferHard){
      const hard = pool.filter(x=>state.hard.has(x.id));
      const rest = pool.filter(x=>!state.hard.has(x.id));
      pool = hard.concat(rest);
    }
    // SRS
    if(state.setup.useSRS){
      const now=Date.now();
      pool.sort((a,b)=>{
        const da=(SRS[a.id]?.dueAt??0), db=(SRS[b.id]?.dueAt??0);
        return (da<=now?0:1) - (db<=now?0:1) || (da - db);
      });
    }
    // Trộn theo seed hay random
    if(state.setup.seed){
      seededShuffle(pool, state.setup.seed + 'Q');
    } else if(state.setup.shuffleQ){ shuffle(pool); }
    const limit = clamp(+el.inpLimit.value||1, 1, pool.length);
    pool = pool.slice(0,limit);
    // Trộn đáp án
    pool = pool.map(it=>{
      const order = it.options.map((_,i)=>i);
      if(state.setup.seed){ seededShuffle(order, state.setup.seed + it.id); }
      else if(state.setup.shuffleA){ shuffle(order); }
      return {...it, options: order.map(i=>it.options[i]), correctIndex: order.indexOf(it.correctIndex)};
    });
    return pool;
  }
  function startFromSetup(){
    const subj=el.selSubject.value;
    const base=subj==='all'?BANK:BANK.filter(x=>x.subjectId===subj);
    if(!base.length){ toast('Chưa có dữ liệu'); return; }
    startRound( pickPool(base) );
  }
  function startSRS(){
    const subj=el.selSubject.value;
    const now=Date.now();
    let base=subj==='all'?BANK:BANK.filter(x=>x.subjectId===subj);
    base=base.filter(x=> !SRS[x.id] || SRS[x.id].dueAt<=now );
    if(!base.length){ toast('Không có câu đến hạn SRS'); return; }
    startRound( pickPool(base) );
  }

  /************ Start/Render round ************/
  function startWrongRound(ids){
    state.wrongQueue=ids.slice();
    const pool = BANK.filter(x=> ids.includes(x.id));
    startRound( pickPool(pool) );
  }
  function startRound(selected){
    state.items=selected;
    state.answers=new Map(); state.currentIndex=0; state.submitted=false;
    state.timeLeft = (+el.inpMinutes.value||1) * 60;
    if(state.timerId) clearInterval(state.timerId);
    tick(); state.timerId=setInterval(tick,1000);
    // switch UI
    el.setup.classList.add('hidden');
    el.sticky.classList.remove('hidden');
    el.exam.classList.remove('hidden');
    el.btnSubmit.classList.remove('hidden');
    el.btnRestart.classList.remove('hidden');
    el.btnOpenDrawer.classList.remove('hidden');
    el.chipPhase.textContent='Đang làm bài';

    el.chkPreferHardLive.onchange=()=>{ state.preferHardLive=el.chkPreferHardLive.checked; renderNav(); renderDrawer(); };
    el.selFilter.onchange=()=>{ state.filter=el.selFilter.value; renderNav(); renderDrawer(); };
    el.inpSearch.oninput=()=>{ state.search=el.inpSearch.value; renderNav(); renderDrawer(); };
    el.btnPrev.onclick=()=>jumpTo(state.currentIndex-1);
    el.btnNext.onclick=()=>jumpTo(state.currentIndex+1);
    el.btnSubmit.onclick=manualSubmit;
    el.btnRestart.onclick=()=>{ if(confirm('Thoát về thiết lập?')) backToSetup(); };
    $("#btnOpenDrawer").onclick=()=>{ el.drawer.classList.add('open'); renderDrawer(); };
    $("#btnCloseDrawer").onclick=()=> el.drawer.classList.remove('open');
    el.drawerMask.onclick=()=> el.drawer.classList.remove('open');

    renderRunHeader(); renderQuestions(); renderNav(); renderDrawer(); jumpTo(0,false);

    // Collapsible nav open/close
    const saved=load(KEYS.NAVOPEN,null);
    if(saved===null){ setNavOpen(window.innerWidth>=768); } else setNavOpen(!!saved);
    window.addEventListener('resize',()=>{ if(window.innerWidth>=768 && !state.navOpen) setNavOpen(true); });

    // Autosave snapshot
    if(state.timerId) clearInterval(state._snapI);
    state._snapI=setInterval(saveSnapshot, 1500);
  }
  function renderRunHeader(){
    const subj=el.selSubject.value;
    el.titleRun.textContent = (subj==='all'?'Tất cả môn': (BANK.find(x=>x.subjectId===subj)?.subjectName||''))
      + ' • ' + state.items.length + ' câu • ' + (state.setup.mode==='exam'?'Kiểm tra':'Luyện tập')
      + (state.wrongQueue?' • Ôn câu sai':'') + (state.setup.seed?` • Seed ${state.setup.seed}`:'');
  }
  function renderQuestions(){
    el.qList.innerHTML='';
    state.items.forEach((it,idx)=>{
      const card=document.createElement('div'); card.className='qCard'; card.id='q-'+idx;
      const head=document.createElement('div'); head.className='qHead';
      const left=document.createElement('div'); left.innerHTML=`<div class="qTitle">Câu ${idx+1}</div><div class="sub">#${it.qnum} • ${it.subjectName}</div>`;
      const right=document.createElement('div');
      const star=document.createElement('button'); star.className='star'+(state.hard.has(it.id)?' active':''); star.textContent='★'; star.title='Đánh dấu câu khó';
      star.onclick=()=>{ if(state.hard.has(it.id)) state.hard.delete(it.id); else state.hard.add(it.id);
        const obj={}; state.hard.forEach(id=>obj[id]=true); save(KEYS.HARD,obj);
        star.classList.toggle('active'); renderNav(); renderDrawer(); };
      right.appendChild(star); head.appendChild(left); head.appendChild(right); card.appendChild(head);

      const qt=document.createElement('div'); qt.style.marginTop='6px'; qt.textContent=it.question; card.appendChild(qt);

      const opts=document.createElement('div'); opts.className='opts';
      it.options.forEach((txt,optI)=>{
        const id=`${it.id}-${idx}-${optI}`;
        const wrap=document.createElement('div'); wrap.className='opt';
        const input=document.createElement('input'); input.type='radio'; input.id=id; input.name='q-'+idx; input.value=String(optI);
        if(state.answers.get(it.id)===optI) input.checked=true;
        if(state.submitted) input.disabled=true;
        const label=document.createElement('label'); label.setAttribute('for',id); label.textContent=txt;

        input.onchange=()=>{
          state.answers.set(it.id,optI);
          // Stats
          (STATS[it.id] ||= {A:0,B:0,C:0,D:0,seen:0,correct:0});
          const key = ['A','B','C','D'][optI]||'A'; STATS[it.id][key]++; STATS[it.id].seen++; save(KEYS.STATS, STATS);

          updateProgress(); renderNav(); renderDrawer();
          if(state.setup.mode==='practice'){
            const r=$("#res-"+idx);
            const ok=optI===it.correctIndex;
            r.classList.remove('hidden'); r.textContent = ok? 'Chính xác ✓' : 'Sai. Đáp án đúng: '+it.options[it.correctIndex];
            r.classList.toggle('ok', ok); r.classList.toggle('bad', !ok);
          }
        };
        if(state.submitted) wrap.classList.add('locked');
        wrap.appendChild(input); wrap.appendChild(label); opts.appendChild(wrap);
      });
      card.appendChild(opts);

      const res=document.createElement('div'); res.id='res-'+idx; res.className='result hidden';
      if(it.explain) res.title='Giải thích'; card.appendChild(res);

      el.qList.appendChild(card);
    });
    updateProgress();
  }

  /************ Nav + Drawer ************/
  function filteredIdx(){
    const ids=state.items.map((_,i)=>i);
    const q=normVN(state.search||'');
    let arr=ids.filter(i=>{
      const it=state.items[i];
      if(state.filter==='answered' && !state.answers.has(it.id)) return false;
      if(state.filter==='unanswered' && state.answers.has(it.id)) return false;
      if(state.filter==='hard' && !state.hard.has(it.id)) return false;
      if(q){
        const hay=normVN(it.question+' '+it.options.join(' '));
        if(!hay.includes(q)) return false;
      }
      return true;
    });
    if(state.preferHardLive){
      const a=arr.filter(i=>state.hard.has(state.items[i].id));
      const b=arr.filter(i=>!state.hard.has(state.items[i].id));
      arr=a.concat(b);
    }
    return arr;
  }
  function renderNav(){
    el.navGrid.innerHTML='';
    filteredIdx().forEach(i=>{
      const it=state.items[i];
      const btn=document.createElement('button'); btn.className='navBtn';
      if(state.hard.has(it.id)) btn.classList.add('hard');
      if(state.answers.has(it.id)) btn.classList.add('answered');
      if(state.submitted){ const ok=state.answers.get(it.id)===it.correctIndex; btn.classList.remove('answered'); btn.classList.add(ok?'correct':'wrong'); }
      btn.textContent=String(i+1);
      btn.onclick=()=>jumpTo(i);
      el.navGrid.appendChild(btn);
    });
  }
  function renderDrawer(){
    el.drawerGrid.innerHTML='';
    filteredIdx().forEach(i=>{
      const it=state.items[i];
      const b=document.createElement('button'); b.className='navBtn';
      if(state.hard.has(it.id)) b.classList.add('hard');
      if(state.answers.has(it.id)) b.classList.add('answered');
      if(state.submitted){ const ok=state.answers.get(it.id)===it.correctIndex; b.classList.remove('answered'); b.classList.add(ok?'correct':'wrong'); }
      b.textContent=String(i+1);
      b.onclick=()=>{ el.drawer.classList.remove('open'); jumpTo(i); };
      el.drawerGrid.appendChild(b);
    });
  }
  function updateProgress(){
    const total=state.items.length;
    const ans=state.items.reduce((n,it)=>n+(state.answers.has(it.id)?1:0),0);
    el.progress.textContent = ans+'/'+total;
  }
  function jumpTo(idx,smooth=true){
    idx = clamp(idx,0,state.items.length-1);
    state.currentIndex=idx;
    const target=$("#q-"+idx);
    if(!target) return;
    target.classList.add('pulse');
    target.scrollIntoView({behavior:smooth?'smooth':'auto', block:'start'});
    setTimeout(()=>target.classList.remove('pulse'),800);
  }

  /************ Timer + Submit ************/
  function tick(){
    el.timer.textContent=fmt(state.timeLeft);
    if(state.timeLeft<=0){ if(state.timerId) clearInterval(state.timerId); autoSubmit(); return; }
    state.timeLeft--;
  }
  function unansweredIdx(){ const miss=[]; state.items.forEach((it,i)=>{ if(!state.answers.has(it.id)) miss.push(i); }); return miss; }
  function manualSubmit(){
    const miss=unansweredIdx();
    if(miss.length){ toast(`Còn ${miss.length} câu chưa làm — chuyển tới câu ${miss[0]+1}`); jumpTo(miss[0]); return; }
    grade(false);
  }
  function autoSubmit(){ grade(true); }
  function _srsSchedule(id, correct){
    const base=[4*3600, 24*3600, 3*24*3600, 7*24*3600]; // 4h, 1d, 3d, 7d
    const cur=SRS[id]||{stage:0,dueAt:0};
    if(correct){ cur.stage = Math.min(cur.stage+1, base.length-1); }
    else { cur.stage = 0; }
    const add = base[cur.stage]*1000;
    cur.dueAt = Date.now() + add;
    SRS[id]=cur; save(KEYS.SRS,SRS);
  }
  function grade(fromTimeout){
    state.submitted=true; if(state.timerId){ clearInterval(state.timerId); state.timerId=null; }
    let correct=0; const wrongIds=[];
    state.items.forEach((it,i)=>{
      const chosen=state.answers.get(it.id);
      const ok = chosen===it.correctIndex;
      if(ok) correct++; else wrongIds.push(it.id);
      // update SRS + stats
      _srsSchedule(it.id, ok);
      (STATS[it.id] ||= {A:0,B:0,C:0,D:0,seen:0,correct:0}); if(ok) STATS[it.id].correct++; save(KEYS.STATS, STATS);

      const card=$("#q-"+i); const res=$("#res-"+i);
      if(card){
        card.style.boxShadow = ok? "0 0 0 1px #165b3f inset" : "0 0 0 1px #6b1f2b inset";
        card.querySelectorAll('input[type=radio]').forEach(x=>x.disabled=true);
        card.querySelectorAll('.opt').forEach(d=>d.classList.add('locked'));
      }
      if(res){
        res.classList.remove('hidden');
        const explain = state.items[i].explain ? ` — ${state.items[i].explain}` : '';
        res.textContent = ok? "Chính xác ✓" : "Sai. Đáp án đúng: "+it.options[it.correctIndex] + explain;
        res.classList.toggle('ok', ok); res.classList.toggle('bad', !ok);
      }
    });
    renderNav(); renderDrawer(); updateSRSChip();
    const total=state.items.length; const score=Math.round(correct/total*100);
    // clear snapshot
    localStorage.removeItem(KEYS.SNAP);

    if(wrongIds.length){
      if(confirm((fromTimeout?'Hết giờ — ':'')+`Điểm ${score}/100 — Ôn lại ${wrongIds.length} câu sai?`)) startWrongRound(wrongIds);
      else backToSetup();
    }else{
      alert((fromTimeout?'Hết giờ — ':'')+'Tuyệt vời! Đúng hết.');
      backToSetup();
    }
  }

  /************ Snapshot ************/
  function saveSnapshot(){
    const snap = {
      items: state.items.map(it=>({id:it.id, options:it.options, correctIndex:it.correctIndex, qnum:it.qnum, subjectId:it.subjectId, subjectName:it.subjectName, question:it.question, explain:it.explain||''})),
      answers: [...state.answers.entries()],
      currentIndex: state.currentIndex,
      timeLeft: state.timeLeft,
      setup: state.setup,
      submitted: state.submitted
    };
    save(KEYS.SNAP, snap);
  }
  function restoreSnapshot(snap){
    // rebuild items from BANK to ensure references valid; fallback to snap items
    const byId = Object.fromEntries(BANK.map(x=>[x.id,x]));
    state.items = (snap.items||[]).map(s => {
      const base = byId[s.id] || s;
      return {...base, options:s.options, correctIndex:s.correctIndex};
    });
    state.answers = new Map(snap.answers||[]);
    Object.assign(state.setup, snap.setup||{});
    el.selSubject.value = state.setup.subject;
    el.inpLimit.value = state.setup.limit;
    el.inpMinutes.value = state.setup.minutes;
    el.selMode.value = state.setup.mode;
    el.chkShuffleQ.checked = state.setup.shuffleQ;
    el.chkShuffleA.checked = state.setup.shuffleA;
    el.chkPreferHard.checked = state.setup.preferHard;
    el.chkSRS.checked = state.setup.useSRS;
    el.inpSeed.value = state.setup.seed||'';

    state.currentIndex = snap.currentIndex||0;
    state.submitted = !!snap.submitted;
    state.timeLeft = snap.timeLeft||600;
    if(state.timerId) clearInterval(state.timerId);
    if(!state.submitted){ tick(); state.timerId=setInterval(tick,1000); }

    // switch UI
    el.setup.classList.add('hidden');
    el.sticky.classList.remove('hidden');
    el.exam.classList.remove('hidden');
    el.btnSubmit.classList.toggle('hidden', state.submitted);
    el.btnRestart.classList.remove('hidden');
    el.btnOpenDrawer.classList.remove('hidden');
    el.chipPhase.textContent = state.submitted?'Đã nộp bài':'Đang làm bài';

    renderRunHeader(); renderQuestions(); renderNav(); renderDrawer(); jumpTo(state.currentIndex,false);

    // Collapsible state
    const saved=load(KEYS.NAVOPEN,null);
    if(saved===null){ setNavOpen(window.innerWidth>=768); } else setNavOpen(!!saved);
  }

  /************ Editor ************/
  function openEditor(){
    const subs=[...new Map(BANK.map(x=>[x.subjectId,x.subjectName])).entries()].map(([id,name])=>({id,name}));
    $("#setup").classList.add('hidden'); el.editor.classList.remove('hidden');
    el.edSubject.innerHTML = `<option value="all">Tất cả</option>` + subs.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    el.edSubject.onchange=renderEdList; el.edSearch.oninput=renderEdList; el.btnCloseEditor.onclick=()=>{ el.editor.classList.add('hidden'); $("#setup").classList.remove('hidden'); };
    renderEdList();
  }
  function renderEdList(){
    const subj=el.edSubject.value||'all'; const q=normVN(el.edSearch.value||'');
    let arr=BANK.slice();
    if(subj && subj!=='all') arr=arr.filter(x=>x.subjectId===subj);
    if(q) arr=arr.filter(x=> normVN(x.question+' '+x.options.join(' ')).includes(q));
    el.edCount.textContent='• '+arr.length+' câu';
    el.edList.innerHTML='';
    arr.forEach(it=>{
      const row=document.createElement('div'); row.className='card'; row.style.background="#0b111d"; row.style.borderColor="#1e2840";
      const h=document.createElement('div'); h.className='row';
      const diff = STATS[it.id]?.seen ? (1 - (STATS[it.id].correct/(STATS[it.id].seen||1))).toFixed(2) : '';
      h.innerHTML=`<div style="font-weight:700">#${it.qnum}</div><div class="sub" style="margin-left:6px">${it.subjectName}</div><div class="sub" style="margin-left:6px">Sai%:${diff||'—'}</div>`;
      row.appendChild(h);

      const qx=document.createElement('div'); qx.className='sub'; qx.textContent=it.question; qx.style.marginTop='6px'; row.appendChild(qx);

      const opts=document.createElement('div'); opts.className='grid'; opts.style.marginTop='6px';
      const current = (state.overrides[it.id]!==undefined) ? state.overrides[it.id] : it.correctIndex;
      it.options.forEach((txt,idx)=>{
        const lab=document.createElement('label'); lab.className='btn ghost'; lab.style.textAlign='left';
        const rd=document.createElement('input'); rd.type='radio'; rd.name='ed-'+it.id; rd.value=idx; rd.checked=(idx===current);
        rd.onchange=()=>{ state.overrides[it.id]=idx; save(KEYS.OVERRIDE, state.overrides); toast('Đã đổi đáp #'+it.qnum); };
        lab.appendChild(rd); const span=document.createElement('span'); span.textContent='  '+txt; lab.appendChild(span);
        opts.appendChild(lab);
      });
      // Giải thích:
      const ex=document.createElement('div'); ex.className='field'; ex.style.marginTop='6px';
      const ta=document.createElement('textarea'); ta.placeholder='Giải thích (tuỳ chọn)'; ta.value=it.explain||''; ta.style.width='100%'; ta.style.minHeight='60px';
      ta.onchange=()=>{ it.explain = ta.value; toast('Đã lưu giải thích'); };
      ex.appendChild(ta); row.appendChild(opts); row.appendChild(ex);

      el.edList.appendChild(row);
    });
  }

  /************ Export/Backup ************/
  function exportCSV(){
    if(!state.items.length){ toast('Chưa có bài để xuất'); return; }
    const lines=['qnum,subject,question,chosen,correct,ok'];
    state.items.forEach(it=>{
      const chosen = state.answers.has(it.id) ? it.options[state.answers.get(it.id)] : '';
      const corr = it.options[it.correctIndex];
      const ok = state.answers.get(it.id)===it.correctIndex ? '1':'0';
      const esc = s => '"' + String(s).replace(/"/g,'""') + '"';
      lines.push([it.qnum, it.subjectName, esc(it.question), esc(chosen), esc(corr), ok].join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ket_qua.csv'; a.click();
  }
  function backupJSON(){
    const data={
      setup:state.setup, hard:[...state.hard], overrides:state.overrides, srs:SRS, stats:STATS
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quiz_backup.json'; a.click();
  }
  function restoreJSON(ev){
    const f=ev.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      try{
        const obj=JSON.parse(r.result);
        if(obj.setup) { Object.assign(state.setup,obj.setup); save(KEYS.SETUP,state.setup); }
        if(obj.hard) { state.hard=new Set(obj.hard); const o={}; state.hard.forEach(x=>o[x]=true); save(KEYS.HARD,o); }
        if(obj.overrides){ state.overrides=obj.overrides; save(KEYS.OVERRIDE, state.overrides); }
        if(obj.srs){ Object.assign(SRS,obj.srs); save(KEYS.SRS, SRS); }
        if(obj.stats){ Object.assign(STATS,obj.stats); save(KEYS.STATS, STATS); }
        toast('Đã phục hồi.'); location.reload();
      }catch(e){ alert('File không hợp lệ'); }
    };
    r.readAsText(f);
  }

  /************ Back to setup ************/
  function backToSetup(){
    if(state.timerId) clearInterval(state.timerId);
    if(state._snapI) clearInterval(state._snapI);
    state.timerId=null; state._snapI=null; state.phase='setup';
    el.exam.classList.add('hidden'); el.sticky.classList.add('hidden');
    el.btnSubmit.classList.add('hidden'); el.btnRestart.classList.add('hidden'); el.btnOpenDrawer.classList.add('hidden');
    el.setup.classList.remove('hidden'); el.chipPhase.textContent='Thiết lập';
    updateSRSChip();
    window.scrollTo({top:0,behavior:'smooth'});
  }

  /************ Boot ************/
  (function boot(){
    if(!Array.isArray(BANK) || !BANK.length){
      // Không có dữ liệu
      // eslint-disable-next-line no-console
      console.warn('Không thấy dữ liệu trong data.js');
    }
    // Build setup
    buildSetup();
  })();
  </script>
</body>
</html>
