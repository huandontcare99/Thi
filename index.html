<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Quiz Ultra ‚Äî √în luy·ªán & Thi th·ª≠</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: { brand:'#2563eb', ok:'#16a34a', bad:'#ef4444', ink:'#0f172a' },
        boxShadow: { soft:'0 10px 25px -10px rgba(0,0,0,.15)' },
        animation:{
          'fade':'fade .25s ease-out',
          'pop':'pop .2s ease-out',
          'flip':'flip .35s ease-in-out',
          'shake':'shake .35s ease-in-out',
          'slide-up':'slideUp .25s ease-out'
        },
        keyframes:{
          fade:{ from:{opacity:0}, to:{opacity:1} },
          pop:{ from:{transform:'scale(.96)',opacity:.8}, to:{transform:'scale(1)',opacity:1} },
          flip:{ from:{transform:'rotateY(180deg)'}, to:{transform:'rotateY(0)'} },
          shake:{ '0%,100%':{transform:'translateX(0)'}, '25%':{transform:'translateX(-6px)'}, '75%':{transform:'translateX(6px)'} },
          slideUp:{ from:{transform:'translateY(6px)',opacity:0}, to:{transform:'translateY(0)',opacity:1} }
        }
      }
    }
  }
</script>

<style>
  :root{ color-scheme: light; }
  .dark :root{ color-scheme: dark; }
  /* l·ª±a ch·ªçn ƒë√°p √°n: radio t√†ng h√¨nh, label l·ªõn, ch·∫°m d·ªÖ */
  .opt input[type="radio"]{ display:none; }
  .opt input[type="radio"]+label{
    display:block; border:1px solid rgb(226 232 240); border-radius:14px;
    padding:12px 14px; background:#fff; transition:all .15s ease;
  }
  .dark .opt input[type="radio"]+label{ background:#0b1220; border-color:#1f2a37; }
  .opt input[type="radio"]:checked+label{ border-color:#2563eb; outline:3px solid rgba(37,99,235,.18); }
  .is-correct{ border-color:#16a34a!important; background:#f0fdf4!important; }
  .dark .is-correct{ background:#0a1a0f!important; }
  .is-wrong{ border-color:#ef4444!important; background:#fef2f2!important; }
  .dark .is-wrong{ background:#2a0e10!important; }
  /* donut k·∫øt qu·∫£ */
  .donut{ --p:0; width:120px; height:120px; border-radius:999px;
    background: conic-gradient(#16a34a var(--p), #e2e8f0 0);
  }
  .dark .donut{ background: conic-gradient(#16a34a var(--p), #334155 0); }
  /* flashcard flip */
  .fc-scene{ perspective:1000px; }
  .fc-card{ position:relative; transform-style:preserve-3d; transition:transform .4s ease; border-radius:16px; }
  .fc-card.is-flipped{ transform: rotateY(180deg); }
  .fc-face{ position:absolute; inset:0; backface-visibility:hidden; -webkit-backface-visibility:hidden; }
  .fc-back{ transform: rotateY(180deg); }
  /* ch·ªëng iOS zoom khi focus */
  @media (max-width:380px){ select,input,button{ font-size:16px; } }
</style>

<!-- T·ª± n·∫°p data.js (n·∫øu c√≥) -->
<script src="data.js" defer></script>
<!-- Confetti nh·∫π -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer></script>
</head>

<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/90 dark:bg-slate-900/85 border-b border-slate-200 dark:border-slate-800">
    <div class="max-w-4xl mx-auto px-3 py-2">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-brand text-white flex items-center justify-center font-bold shadow-soft">U</div>
        <div class="min-w-0">
          <h1 class="text-base font-semibold leading-tight">Quiz Ultra</h1>
          <p class="text-xs text-slate-500 dark:text-slate-400 leading-tight">H·ªçc ‚Ä¢ Luy·ªán t·∫≠p ‚Ä¢ Thi th·ª≠ ‚Ä¢ Flashcard</p>
        </div>
        <button id="btnToggleToolbar" class="ml-auto px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700">B·∫£ng ƒëi·ªÅu khi·ªÉn</button>
        <button id="btnDark" class="ml-2 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800" title="Dark/Light">üåô</button>
      </div>

      <!-- Toolbar (mobile-first: x·∫øp d·ªçc) -->
      <div id="toolbar" class="mt-2 grid grid-cols-1 gap-2 md:grid-cols-2 lg:grid-cols-3">
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 dark:text-slate-300 pt-2 min-w-[70px]">M√¥n</label>
          <select id="subjectSelect" class="flex-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
            <option>ƒêang n·∫°p‚Ä¶</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 dark:text-slate-300 pt-2 min-w-[70px]">Ch·∫ø ƒë·ªô</label>
          <select id="modeSelect" class="flex-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
            <option value="study">H·ªçc (hi·ªán ƒë√°p √°n)</option>
            <option value="practice" selected>Luy·ªán t·∫≠p (ch·∫•m ngay)</option>
            <option value="exam">Thi th·ª≠ (ch·∫•m cu·ªëi)</option>
            <option value="flash">Flashcard (ƒë·∫£o m·∫∑t)</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 dark:text-slate-300 pt-2 min-w-[70px]">S·ªë c√¢u</label>
          <select id="countSelect" class="flex-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="30">30</option>
            <option value="all">T·∫•t c·∫£</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 dark:text-slate-300 pt-2 min-w-[70px]">S·∫Øp x·∫øp</label>
          <select id="orderSelect" class="flex-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
            <option value="sequence">Theo th·ª© t·ª±</option>
            <option value="shuffle" selected>Ng·∫´u nhi√™n</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 dark:text-slate-300 pt-2 min-w-[70px]">B·ªô l·ªçc</label>
          <select id="filterSelect" class="flex-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2">
            <option value="all" selected>T·∫•t c·∫£</option>
            <option value="bookmarked">ƒê√£ ƒë√°nh d·∫•u</option>
            <option value="wrong">Sai g·∫ßn ƒë√¢y</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 dark:text-slate-300 pt-2 min-w-[70px]">T√¨m</label>
          <input id="searchInput" placeholder="T·ª´ kh√≥a‚Ä¶" class="flex-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-3 py-2" />
        </div>
        <div class="md:col-span-2 lg:col-span-3 flex flex-wrap gap-2 mt-1">
          <button id="btnStart" class="flex-1 bg-brand hover:bg-blue-700 text-white rounded-xl px-4 py-3 font-semibold shadow-soft">B·∫Øt ƒë·∫ßu</button>
          <button id="btnWrongOnly" class="px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">√în c√¢u sai</button>
          <button id="btnExport" class="px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚¨áÔ∏è Xu·∫•t ti·∫øn tr√¨nh</button>
          <button id="btnImport" class="px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚¨ÜÔ∏è Nh·∫≠p ti·∫øn tr√¨nh</button>
          <input id="fileImport" type="file" accept=".json" class="hidden" />
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-3 pb-28">
    <!-- Th√¥ng b√°o khi ch∆∞a c√≥ d·ªØ li·ªáu -->
    <div id="emptyMsg" class="mt-3 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 text-amber-900 dark:text-amber-200 rounded-xl p-3 text-sm hidden">
      Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu. H√£y ch·∫Øc ch·∫Øn <b>index.html</b> ƒë·∫∑t c·∫°nh <b>data.js</b> (gi·ªØ nguy√™n n·ªôi dung).<br/>
      M·∫πo: b·∫°n c≈©ng c√≥ th·ªÉ ƒë·∫∑t <b>data.txt</b> (ƒë·ªãnh d·∫°ng y nh∆∞ data g·ªëc) ‚Äî h·ªá th·ªëng s·∫Ω t·ª± nh·∫≠n.
    </div>

    <!-- Tr·∫°ng th√°i -->
    <section class="mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-3 shadow-soft">
      <div class="flex items-center gap-3">
        <div id="badgeSubject" class="text-xs px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">M√¥n</div>
        <div id="badgeMode" class="text-xs px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300">Ch·∫ø ƒë·ªô</div>
        <div class="ml-auto text-xs text-slate-500 dark:text-slate-400" id="timerBox" hidden>‚è± <span id="timer">00:00</span></div>
      </div>
      <div class="mt-3 grid grid-cols-3 gap-2 text-center">
        <div class="rounded-xl bg-green-50 dark:bg-green-900/20 py-2">
          <div class="text-xs text-green-700 dark:text-green-300">ƒê√∫ng</div><div id="statCorrect" class="text-lg font-bold text-green-700 dark:text-green-300">0</div>
        </div>
        <div class="rounded-xl bg-rose-50 dark:bg-rose-900/20 py-2">
          <div class="text-xs text-rose-700 dark:text-rose-300">Sai</div><div id="statWrong" class="text-lg font-bold text-rose-700 dark:text-rose-300">0</div>
        </div>
        <div class="rounded-xl bg-slate-50 dark:bg-slate-800 py-2">
          <div class="text-xs text-slate-600 dark:text-slate-300">ƒê√£ l√†m</div><div id="statDone" class="text-lg font-bold text-slate-700 dark:text-slate-200">0</div>
        </div>
      </div>
      <div class="mt-3 h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
        <div id="progressBar" class="h-2 bg-brand transition-[width] duration-300" style="width:0%"></div>
      </div>
      <div class="mt-1 text-xs text-slate-500 dark:text-slate-400" id="progressText">0 / 0</div>
    </section>

    <!-- Th·∫ª c√¢u h·ªèi -->
    <article id="card" class="hidden mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4 animate-fade">
      <h2 id="qTitle" class="text-base font-semibold"></h2>
      <div id="optList" class="mt-3 space-y-2"></div>

      <div id="explainBox" class="mt-4 hidden animate-slide-up">
        <div class="text-sm font-semibold mb-1">Gi·∫£i th√≠ch</div>
        <div id="explain" class="text-sm text-slate-700 dark:text-slate-300"></div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnPrev" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üê Tr∆∞·ªõc</button>
        <button id="btnNext" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Ti·∫øp ‚Üí</button>
        <button id="btnCheck" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Ch·∫•m c√¢u n√†y</button>
        <button id="btnReveal" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Hi·ªán ƒë√°p √°n</button>
        <button id="btnBookmark" class="ml-auto px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">üîñ ƒê√°nh d·∫•u</button>
        <button id="btnSubmit" class="px-4 py-2 rounded-xl bg-brand text-white">N·ªôp b√†i</button>
      </div>
    </article>

    <!-- Flashcard -->
    <article id="flashWrap" class="hidden mt-3 animate-fade">
      <div class="fc-scene">
        <div id="flashCard" class="fc-card border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-soft">
          <div class="fc-face fc-front p-4 rounded-2xl">
            <div id="fcFront" class="text-base font-semibold"></div>
            <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">Ch·∫°m/nh·∫•n ƒë·ªÉ l·∫≠t th·∫ª</div>
          </div>
          <div class="fc-face fc-back p-4 rounded-2xl bg-slate-50 dark:bg-slate-800">
            <div id="fcBack" class="text-sm"></div>
          </div>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="fcPrev" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üê</button>
        <button id="fcFlip" class="px-4 py-2 rounded-xl bg-brand text-white">L·∫≠t th·∫ª</button>
        <button id="fcAgain" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">üïë Ch∆∞a nh·ªõ</button>
        <button id="fcGood" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚úì Nh·ªõ r·ªìi</button>
        <button id="fcNext" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üí</button>
      </div>
      <div id="fcMeta" class="mt-1 text-xs text-slate-500 dark:text-slate-400"></div>
    </article>

    <!-- K·∫øt qu·∫£ -->
    <article id="resultCard" class="hidden mt-3 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-4 animate-pop">
      <div class="flex items-center gap-4">
        <div id="donut" class="donut" style="--p:0deg"></div>
        <div>
          <h3 class="text-lg font-bold mb-1">K·∫øt qu·∫£</h3>
          <p id="scoreText" class="text-sm text-slate-700 dark:text-slate-300"></p>
          <div class="text-xs text-slate-500 dark:text-slate-400" id="timeText"></div>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="btnReviewWrong" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Luy·ªán l·∫°i c√¢u sai</button>
        <button id="btnRestart" class="px-4 py-2 rounded-xl bg-brand text-white">L√†m l·∫°i</button>
      </div>
    </article>

    <!-- Danh s√°ch c√¢u ‚Üí bottom sheet -->
    <div id="sheet" class="fixed inset-x-0 bottom-0 z-30 hidden">
      <div class="mx-auto max-w-4xl rounded-t-2xl bg-white dark:bg-slate-900 shadow-2xl border border-slate-200 dark:border-slate-800 animate-slide-up">
        <div class="p-3 flex items-center gap-2 border-b border-slate-200 dark:border-slate-800">
          <div class="font-semibold">Danh s√°ch c√¢u</div>
          <button id="sheetClose" class="ml-auto px-3 py-1 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">ƒê√≥ng</button>
        </div>
        <div id="qGrid" class="p-3 grid grid-cols-10 gap-1 max-h-[40vh] overflow-auto"></div>
      </div>
    </div>
  </main>

  <!-- FAB -->
  <button id="fab" class="fixed bottom-4 right-4 z-20 rounded-full bg-brand text-white w-12 h-12 shadow-soft" title="Danh s√°ch c√¢u">#</button>

  <!-- Thanh h√†nh ƒë·ªông ƒë√°y (mobile) -->
  <footer class="fixed inset-x-0 bottom-0 z-30">
    <div class="max-w-4xl mx-auto px-3 pb-[env(safe-area-inset-bottom)]">
      <div class="rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 shadow-soft p-2 flex gap-2">
        <button id="bPrev" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üê</button>
        <button id="bReveal" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">ƒê√°p √°n</button>
        <button id="bCheck" class="px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">Ch·∫•m</button>
        <button id="bSubmit" class="px-3 py-2 rounded-xl bg-brand text-white">N·ªôp</button>
        <button id="bNext" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">‚Üí</button>
      </div>
    </div>
  </footer>

  <!-- ·ª®ng d·ª•ng -->
  <script>
  (function(){
    "use strict";

    // ====== Helpers ======
    const $ = s => document.querySelector(s);
    const byId = id => document.getElementById(id);
    const on = (el, ev, fn) => el && el.addEventListener(ev, fn);

    const choiceLetters = ['A','B','C','D','E','F','G'];
    const LS_BOOK='qu_book', LS_WRONG='qu_wrong', LS_STATS='qu_stats', LS_STATE='qu_state';
    const loadLS=(k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } };
    const saveLS=(k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const norm = s => (s??'').toString().replace(/\s+/g,' ').trim()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[‚Äú‚Äù"']/g,'').toLowerCase();

    // ====== UI refs (t·ªìn t·∫°i ch·∫Øc ch·∫Øn) ======
    const subjectSelect = byId('subjectSelect');
    const modeSelect    = byId('modeSelect');
    const countSelect   = byId('countSelect');
    const orderSelect   = byId('orderSelect');
    const filterSelect  = byId('filterSelect');
    const searchInput   = byId('searchInput');

    const btnStart   = byId('btnStart');
    const btnWrongOnly = byId('btnWrongOnly');
    const btnExport  = byId('btnExport');
    const btnImport  = byId('btnImport');
    const fileImport = byId('fileImport');

    const btnToggleToolbar = byId('btnToggleToolbar');
    const toolbar = byId('toolbar');
    const btnDark = byId('btnDark');

    const emptyMsg = byId('emptyMsg');
    const badgeSubject = byId('badgeSubject');
    const badgeMode = byId('badgeMode');
    const timerBox = byId('timerBox'), timerLbl = byId('timer');

    const statCorrect = byId('statCorrect'), statWrong = byId('statWrong'), statDone = byId('statDone');
    const progressBar = byId('progressBar'), progressText = byId('progressText');

    const card = byId('card'), qTitle = byId('qTitle'), optList = byId('optList');
    const explainBox = byId('explainBox'), explain = byId('explain');

    const btnPrev = byId('btnPrev'), btnNext = byId('btnNext'), btnCheck = byId('btnCheck'), btnReveal = byId('btnReveal'), btnBookmark = byId('btnBookmark'), btnSubmit = byId('btnSubmit');

    const resultCard = byId('resultCard'), donut = byId('donut'), scoreText = byId('scoreText'), timeText = byId('timeText');
    const btnReviewWrong = byId('btnReviewWrong'), btnRestart = byId('btnRestart');

    const flashWrap = byId('flashWrap'), flashCard = byId('flashCard'), fcFront = byId('fcFront'), fcBack = byId('fcBack');
    const fcPrev=byId('fcPrev'), fcNext=byId('fcNext'), fcFlip=byId('fcFlip'), fcAgain=byId('fcAgain'), fcGood=byId('fcGood'), fcMeta=byId('fcMeta');

    const sheet = byId('sheet'), qGrid = byId('qGrid'), sheetClose = byId('sheetClose'), fab = byId('fab');

    const bPrev=byId('bPrev'), bNext=byId('bNext'), bCheck=byId('bCheck'), bReveal=byId('bReveal'), bSubmit=byId('bSubmit');

    // ====== State ======
    const state={
      subjects:[],
      subjectIdx:0,
      mode:'practice',
      order:'shuffle',
      filter:'all',
      search:'',
      pool:[],
      cur:0,
      answers:{},        // index->picked
      checked:{},        // index->true
      correct:0, wrong:0,
      bookmarks: loadLS(LS_BOOK,{}),
      wrongBank: loadLS(LS_WRONG,[]), // [{s,q}]
      stats: loadLS(LS_STATS,{total:0,correct:0}),
      timer:null, seconds:0,
      // flashcard queue
      fc:{ list:[], i:0 }
    };

    // ====== Parser (ch·ªãu ƒë∆∞·ª£c format data g·ªëc) ======
    function parseLegacyText(raw){
      if(!raw) return [];
      const blocks=[]; const re=/(^|\n)C√¢u\s*\d+\s*:[\s\S]*?(?=(?:\n[-=]{3,}\s*\n)|(?:\n\s*C√¢u\s*\d+\s*:)|\s*$)/gi;
      let m; while((m=re.exec(raw))) blocks.push(m[0]);

      const qs=[];
      for(const b of blocks){
        const qm=/C√¢u\s*\d+\s*:\s*([\s\S]*?)\n\s*ƒê√°p √°n ƒë√∫ng:\s*([^\n]+)\s*\n/i.exec(b);
        if(!qm) continue;
        const qText=qm[1].trim();
        const correctText=qm[2].trim();

        let optPart=/T·∫•t c·∫£ ƒë√°p √°n:\s*([\s\S]*)/i.exec(b)?.[1] ?? '';
        const lines=optPart.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

        const opts=[];
        for(const ln of lines){
          const m2=/^([A-Zƒê])\.\s*(.*)$/.exec(ln);
          if(!m2) continue;
          let text=m2[2].trim();
          const hasCheck=/‚úì/.test(text);
          text=text.replace(/^‚úì\s*/,'').replace(/\s*‚úì\s*$/,'').trim();
          opts.push({text, hasCheck});
        }
        if(!opts.length) continue;

        let idx=opts.findIndex(o=>o.hasCheck);
        if(idx<0){
          const nc=norm(correctText);
          idx=opts.findIndex(o=>norm(o.text)===nc);
          if(idx<0) idx=opts.findIndex(o=>norm(o.text).includes(nc) || nc.includes(norm(o.text)));
          if(idx<0) idx=0;
        }
        qs.push({ text:qText, options:opts.map(o=>o.text), answer:idx, explain:'' });
      }
      return qs;
    }
    function inferSubjectName(raw, fallback){
      const m=/M√îN\s*[:Ôºö]\s*([^\n]+)\n/i.exec(raw||''); return (m?m[1].trim():fallback||'M√¥n');
    }
    function parseDataJsText(jsText){
      const out=[];
      if(!jsText) return out;

      const subjMap={}; // SUBJECT_* √°nh x·∫° suffix -> t√™n
      const subjRe=/const\s+SUBJECT_([A-Za-z0-9_]+)\s*=\s*"([^"]*)"/g;
      let sm; while((sm=subjRe.exec(jsText))) subjMap[sm[1]]=sm[2];

      const rawRe=/const\s+(RAW_([A-Za-z0-9_]+))\s*=\s*String\.raw`([\s\S]*?)`;/g;
      let rm; while((rm=rawRe.exec(jsText))){
        const suffix=rm[2], raw=rm[3];
        const name=subjMap[suffix] || inferSubjectName(raw, suffix);
        out.push({ name, questions: parseLegacyText(raw) });
      }

      if(out.length===0){
        // v√©t
        const raws=[...jsText.matchAll(/String\.raw`([\s\S]*?)`/g)].map(x=>x[1]);
        for(const raw of raws){
          const qs=parseLegacyText(raw);
          if(qs.length) out.push({ name: inferSubjectName(raw,'M√¥n'), questions: qs });
        }
      }
      return out;
    }
    function parseJsonText(txt){
      try{
        const data=JSON.parse(txt);
        if(Array.isArray(data?.subjects)){
          return data.subjects.map(s=>({
            name: s.name || 'M√¥n',
            questions: s.questions?.map(q=>({text:q.text, options:q.options, answer:q.answer, explain:q.explain||''}))||[]
          }));
        }
      }catch{}
      return [];
    }

    async function loadSubjectsAuto(){
      // 1) window.quizDataJSON (n·∫øu c√≥)
      if(window.quizDataJSON?.subjects?.length){
        return window.quizDataJSON.subjects.map(s=>({
          name:s.name, questions:s.questions.map(q=>({text:q.text, options:q.options, answer:q.answer, explain:q.explain||''}))
        }));
      }
      // 2) API getAll() c≈©
      if(window.quizData?.getAll){
        try{
          const arr=window.quizData.getAll();
          return arr.map(it=>({ name: it.subject, questions: parseLegacyText(String(it.text||'')) }));
        }catch(e){ console.warn('quizData.getAll() l·ªói', e); }
      }
      // 3) bi·∫øn RAW_* + SUBJECT_*
      const rawKeys = Object.keys(window).filter(k=>/^RAW_/.test(k));
      if(rawKeys.length){
        const subjects=[];
        for(const k of rawKeys){
          const raw=String(window[k]||'');
          const suffix=k.replace(/^RAW_/,'');
          const subjName=(window['SUBJECT_'+suffix]||inferSubjectName(raw,suffix));
          subjects.push({ name:subjName, questions:parseLegacyText(raw) });
        }
        if(subjects.length) return subjects;
      }
      // 4) data.txt (n·∫øu c√≥)
      try{
        const res = await fetch('data.txt', {cache:'no-store'});
        if(res.ok){
          const txt=await res.text();
          const rawQs=parseLegacyText(txt);
          if(rawQs.length) return [{ name: inferSubjectName(txt,'M√¥n'), questions: rawQs }];
          const jsonSubs=parseJsonText(txt);
          if(jsonSubs.length) return jsonSubs;
        }
      }catch{}
      return [];
    }

    // ====== App init ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      // Ch·ªß ƒë·ªÅ
      on(btnDark, 'click', ()=>{ document.documentElement.classList.toggle('dark'); });

      // Toggle toolbar
      on(btnToggleToolbar, 'click', ()=> toolbar.classList.toggle('hidden'));

      // Event tool
      on(btnStart,'click', start);
      on(btnWrongOnly,'click', ()=>{ filterSelect.value='wrong'; start(); });
      on(btnExport,'click', exportState);
      on(btnImport,'click', ()=> fileImport.click());
      on(fileImport,'change', importState);

      // Bottom sheet & FAB
      on(fab,'click', ()=> sheet.classList.toggle('hidden'));
      on(sheetClose,'click', ()=> sheet.classList.add('hidden'));

      // Bottom bar
      on(bPrev,'click', prevQ);
      on(bNext,'click', nextQ);
      on(bCheck,'click', checkThis);
      on(bReveal,'click', revealThis);
      on(bSubmit,'click', submitAll);

      // ƒêi·ªÅu khi·ªÉn
      on(subjectSelect,'change', ()=> state.subjectIdx=subjectSelect.selectedIndex);
      on(modeSelect,'change', ()=> state.mode=modeSelect.value);
      on(orderSelect,'change', ()=> state.order=orderSelect.value);
      on(filterSelect,'change', ()=> state.filter=filterSelect.value);
      on(searchInput,'input', ()=> state.search=searchInput.value);

      // Vu·ªët chuy·ªÉn c√¢u
      attachSwipe();

      // N·∫°p d·ªØ li·ªáu t·ª± ƒë·ªông
      state.subjects = await loadSubjectsAuto();
      if(!state.subjects.length){
        emptyMsg.classList.remove('hidden');
        subjectSelect.innerHTML='<option>Ch∆∞a ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu</option>';
      }else{
        emptyMsg.classList.add('hidden');
        renderSubjectOptions();
      }
    });

    function renderSubjectOptions(){
      subjectSelect.innerHTML='';
      state.subjects.forEach((s,i)=>{
        const o=document.createElement('option');
        o.value=i; o.textContent=s.name || ('M√¥n '+(i+1));
        subjectSelect.appendChild(o);
      });
      state.subjectIdx=0;
    }

    // ====== Pooling & Start ======
    function makePool(){
      const subj = state.subjects[state.subjectIdx];
      if(!subj) return [];
      let arr = subj.questions.map((q,idx)=>({...q,_id:idx}));

      if(state.search.trim()){
        const key=norm(state.search);
        arr=arr.filter(q => norm(q.text).includes(key) || q.options.some(o=>norm(o).includes(key)));
      }
      if(state.filter==='bookmarked'){
        arr=arr.filter(q => !!state.bookmarks[`${state.subjectIdx}:${q._id}`]);
      }else if(state.filter==='wrong'){
        const set=new Set(state.wrongBank.map(x=>`${x.s}:${x.q}`));
        arr=arr.filter(q=>set.has(`${state.subjectIdx}:${q._id}`));
      }

      if(state.order==='shuffle') arr.sort(()=>Math.random()-.5);
      const need = (countSelect.value==='all') ? arr.length : Math.min(+countSelect.value||20, arr.length);
      return arr.slice(0, need);
    }

    function start(){
      clearTimer();
      state.mode = modeSelect.value;
      state.answers={}; state.checked={}; state.correct=0; state.wrong=0;
      state.pool = makePool(); state.cur=0;
      buildGrid();
      updateStatsUI(); updateProgress();

      // badges
      badgeSubject.textContent = state.subjects[state.subjectIdx]?.name || 'M√¥n';
      const modeName = state.mode==='study'?'H·ªçc': state.mode==='practice'?'Luy·ªán t·∫≠p': state.mode==='exam'?'Thi th·ª≠':'Flashcard';
      badgeMode.textContent = modeName;

      if(!state.pool.length){ card.classList.add('hidden'); flashWrap.classList.add('hidden'); resultCard.classList.add('hidden'); emptyMsg.classList.remove('hidden'); return; }
      emptyMsg.classList.add('hidden');

      // Mode
      if(state.mode==='flash'){ enterFlash(); return; }
      resultCard.classList.add('hidden'); flashWrap.classList.add('hidden'); card.classList.remove('hidden');

      // N√∫t theo ch·∫ø ƒë·ªô
      btnCheck.classList.toggle('hidden', state.mode!=='practice');
      btnReveal.classList.toggle('hidden', state.mode!=='study');
      btnSubmit.classList.toggle('hidden', state.mode!=='exam');
      timerBox.hidden = (state.mode!=='exam');
      if(state.mode==='exam') startTimer();

      renderQuestion(true);
      card.scrollIntoView({behavior:'smooth',block:'start'});

      // L∆∞u tr·∫°ng th√°i kh·ªüi ƒë·ªông ƒë·ªÉ ti·∫øp t·ª•c l·∫ßn sau
      saveSessionSnapshot();
    }

    // ====== Render c√¢u h·ªèi ======
    function renderQuestion(first=false){
      const q = state.pool[state.cur];
      if(!q){ card.classList.add('hidden'); return; }
      if(!first){ card.classList.remove('animate-fade'); void card.offsetWidth; card.classList.add('animate-fade'); }

      qTitle.textContent = `C√¢u ${state.cur+1}: ${q.text}`;
      optList.innerHTML=''; explainBox.classList.add('hidden'); explain.textContent=q.explain||'';

      q.options.forEach((o,i)=>{
        const id=`opt-${state.cur}-${i}`;
        const wrap=document.createElement('div'); wrap.className='opt';
        const input=document.createElement('input'); input.type='radio'; input.name=`q-${state.cur}`; input.id=id; input.value=i;
        input.checked = (state.answers[state.cur]===i);
        input.onchange = ()=>{
          state.answers[state.cur]=i;
          if(state.mode==='practice'){ markThis(true); }
        };
        const lab=document.createElement('label'); lab.setAttribute('for',id);
        lab.innerHTML=`<div class="flex gap-2"><div class="text-slate-500 dark:text-slate-400">${choiceLetters[i]||''}.</div><div class="flex-1 whitespace-normal break-words">${o}</div></div>`;
        wrap.appendChild(input); wrap.appendChild(lab); optList.appendChild(wrap);
      });

      const key=`${state.subjectIdx}:${q._id}`;
      btnBookmark.textContent = state.bookmarks[key] ? 'üîñ ƒê√£ ƒë√°nh d·∫•u' : 'üîñ ƒê√°nh d·∫•u';

      // B·∫Øt s·ª± ki·ªán
      btnPrev.onclick=prevQ; btnNext.onclick=nextQ; btnReveal.onclick=revealThis; btnCheck.onclick=checkThis; btnSubmit.onclick=submitAll;
      btnBookmark.onclick=()=>{ state.bookmarks[key]=!state.bookmarks[key]; saveLS(LS_BOOK,state.bookmarks); btnBookmark.textContent=state.bookmarks[key]?'üîñ ƒê√£ ƒë√°nh d·∫•u':'üîñ ƒê√°nh d·∫•u'; }
      clearMarks();
    }

    function prevQ(){ if(state.cur>0){ state.cur--; renderQuestion(); updateProgress(); } }
    function nextQ(){ if(state.cur<state.pool.length-1){ state.cur++; renderQuestion(); updateProgress(); } }

    function updateProgress(){
      const cur=state.cur+1, total=state.pool.length||0;
      progressText.textContent = `${cur>total?total:cur} / ${total}`;
      progressBar.style.width = total? `${(Math.min(cur,total)/total)*100}%` : '0%';
    }
    function updateStatsUI(){
      const done = Object.keys(state.checked).filter(k=>state.checked[k]).length;
      statCorrect.textContent = state.correct;
      statWrong.textContent = state.wrong;
      statDone.textContent = done;
    }

    function clearMarks(){ optList.querySelectorAll('label').forEach(el=>el.classList.remove('is-correct','is-wrong','animate-shake','animate-pop')); }
    function markThis(fromChange=false){
      const q=state.pool[state.cur]; const pick=state.answers[state.cur];
      clearMarks();
      const labels=optList.querySelectorAll('label');
      if(labels[q.answer]) labels[q.answer].classList.add('is-correct','animate-pop');
      if(pick!=null && pick!==q.answer && labels[pick]) labels[pick].classList.add('is-wrong','animate-shake');
      if(fromChange && !state.checked[state.cur]){
        state.checked[state.cur]=true;
        if(pick===q.answer){ state.correct++; fireConfetti(); } else { state.wrong++; addWrong(q._id); vibrate(20); }
        updateStatsUI();
      }
      if(state.mode!=='exam' && q.explain) explainBox.classList.remove('hidden');
    }
    function checkThis(){ if(state.mode==='practice'){ markThis(true); } }
    function revealThis(){
      const q=state.pool[state.cur]; clearMarks();
      const labels=optList.querySelectorAll('label');
      if(labels[q.answer]) labels[q.answer].classList.add('is-correct','animate-pop');
      if(q.explain) explainBox.classList.remove('hidden');
    }

    function addWrong(qid){
      // l∆∞u unique theo (subjectIdx, qid)
      const key=`${state.subjectIdx}:${qid}`;
      const has=state.wrongBank.some(x=>`${x.s}:${x.q}`===key);
      if(!has){
        state.wrongBank.unshift({s:state.subjectIdx,q:qid});
        state.wrongBank=state.wrongBank.slice(0,500);
        saveLS(LS_WRONG,state.wrongBank);
      }
    }

    // ====== Submit (Exam) ======
    function submitAll(){
      if(state.mode!=='exam') return;
      const total=state.pool.length; let correct=0; const wrongL=[];
      for(let i=0;i<total;i++){
        const q=state.pool[i];
        if(state.answers[i]===q.answer) correct++;
        else wrongL.push({s:state.subjectIdx,q:q._id});
      }
      state.wrongBank = [...wrongL, ...state.wrongBank].slice(0,500);
      saveLS(LS_WRONG,state.wrongBank);
      state.stats.total += total; state.stats.correct += correct; saveLS(LS_STATS,state.stats);
      clearTimer();

      const pct = Math.round(correct*100/Math.max(1,total));
      scoreText.textContent=`ƒê√∫ng ${correct}/${total} c√¢u (${pct}%).`;
      timeText.textContent = state.seconds>0 ? `Th·ªùi gian: ${Math.floor(state.seconds/60)}m ${state.seconds%60}s` : '';
      donut.style.setProperty('--p', `${pct*3.6}deg`);
      resultCard.classList.remove('hidden'); card.classList.add('hidden'); flashWrap.classList.add('hidden');
      window.scrollTo({top:0,behavior:'smooth'});

      btnReviewWrong.onclick=enterReviewWrong;
      btnRestart.onclick=start;
    }

    // ====== √în c√¢u sai ======
    function enterReviewWrong(){
      filterSelect.value='wrong';
      modeSelect.value='practice';
      state.filter='wrong'; state.mode='practice';
      start();
    }

    // ====== Flashcards ======
    function enterFlash(){
      // chu·∫©n b·ªã danh s√°ch
      const pool = makePool();
      state.fc.list = pool.map(q=>({
        front: q.text,
        back: renderFlashBack(q),
        qid: q._id
      }));
      state.fc.i=0;
      flashWrap.classList.remove('hidden'); card.classList.add('hidden'); resultCard.classList.add('hidden');
      renderFlash();
      // handlers
      fcFlip.onclick=()=> flashCard.classList.toggle('is-flipped');
      fcPrev.onclick=()=>{ if(state.fc.i>0){ state.fc.i--; renderFlash(); } };
      fcNext.onclick=()=>{ if(state.fc.i<state.fc.list.length-1){ state.fc.i++; renderFlash(); } };
      fcAgain.onclick=()=>{ // ƒë·∫©y th·∫ª sai xu·ªëng cu·ªëi (SRS ƒë∆°n gi·∫£n)
        const item = state.fc.list[state.fc.i];
        state.fc.list.push(item);
        state.fc.i++;
        renderFlash();
        vibrate(20);
      };
      fcGood.onclick=()=>{ // b·ªè qua th·∫ª hi·ªán t·∫°i
        state.fc.list.splice(state.fc.i,1);
        if(state.fc.i>=state.fc.list.length) state.fc.i=Math.max(0,state.fc.list.length-1);
        if(state.fc.list.length) renderFlash(); else { fcMeta.textContent='üî• B·∫°n ƒë√£ thu·ªôc h·∫øt b·ªô th·∫ª!'; }
        fireConfetti();
      };
      flashCard.onclick=()=> flashCard.classList.toggle('is-flipped');
    }
    function renderFlashBack(q){
      const opts = q.options.map((o,i)=>`<div class="mt-1"><b>${choiceLetters[i]}.</b> ${o}${i===q.answer?' <span class="text-green-600 dark:text-green-400">‚úì</span>':''}</div>`).join('');
      const exp = q.explain ? `<div class="mt-2 text-[13px] opacity-90">${q.explain}</div>` : '';
      return `<div class="text-sm"><div class="font-semibold mb-1">ƒê√°p √°n ƒë√∫ng: <span class="text-green-600 dark:text-green-400">${choiceLetters[q.answer]}</span></div>${opts}${exp}</div>`;
    }
    function renderFlash(){
      if(!state.fc.list.length){ flashWrap.classList.add('hidden'); return; }
      const it=state.fc.list[state.fc.i];
      fcFront.textContent = it.front;
      fcBack.innerHTML = it.back;
      flashCard.classList.remove('is-flipped');
      fcMeta.textContent = `Th·∫ª ${state.fc.i+1}/${state.fc.list.length}`;
    }

    // ====== Grid ======
    function buildGrid(){
      qGrid.innerHTML='';
      for(let i=0;i<state.pool.length;i++){
        const b=document.createElement('button');
        const active = (i===state.cur);
        b.className='text-sm rounded-lg border px-2 py-1 '+(active?'bg-brand text-white border-brand':'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700');
        b.textContent=(i+1);
        b.onclick=()=>{ state.cur=i; renderQuestion(); updateProgress(); };
        qGrid.appendChild(b);
      }
    }

    // ====== Timer ======
    function startTimer(){
      state.seconds=0; timerLbl.textContent='00:00';
      state.timer=setInterval(()=>{
        state.seconds++;
        const m=String(Math.floor(state.seconds/60)).padStart(2,'0');
        const s=String(state.seconds%60).padStart(2,'0');
        timerLbl.textContent=`${m}:${s}`;
      },1000);
    }
    function clearTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

    // ====== Swipe ======
    function attachSwipe(){
      let startX=0,startY=0,dx=0,dy=0;
      const area=$('main');
      area.addEventListener('touchstart',e=>{ const t=e.touches[0]; startX=t.clientX; startY=t.clientY; },{passive:true});
      area.addEventListener('touchmove',e=>{ const t=e.touches[0]; dx=t.clientX-startX; dy=t.clientY-startY; },{passive:true});
      area.addEventListener('touchend',()=>{ if(Math.abs(dx)>60 && Math.abs(dy)<40){ if(dx<0) nextQ(); else prevQ(); } dx=dy=0; },{passive:true});
    }

    // ====== Export / Import ti·∫øn tr√¨nh ======
    function exportState(){
      const payload={
        bookmarks: state.bookmarks,
        wrongBank: state.wrongBank,
        stats: state.stats
      };
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='quiz-ultra-progress.json'; a.click();
      URL.revokeObjectURL(a.href);
    }
    async function importState(e){
      const f=e.target.files?.[0]; if(!f) return;
      try{
        const txt=await f.text(); const data=JSON.parse(txt);
        if(data.bookmarks) state.bookmarks=data.bookmarks;
        if(data.wrongBank) state.wrongBank=data.wrongBank;
        if(data.stats) state.stats=data.stats;
        saveLS(LS_BOOK,state.bookmarks); saveLS(LS_WRONG,state.wrongBank); saveLS(LS_STATS,state.stats);
        alert('Nh·∫≠p ti·∫øn tr√¨nh th√†nh c√¥ng!');
      }catch{ alert('File kh√¥ng h·ª£p l·ªá.'); }
      e.target.value='';
    }

    // ====== Confetti & Vibrate ======
    function fireConfetti(){ if(typeof confetti==='function') confetti({ particleCount: 38, spread: 55, origin: { y: .8 } }); }
    function vibrate(ms){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch{} }

    // ====== L∆∞u/Ph·ª•c h·ªìi phi√™n (t√πy ch·ªçn) ======
    function saveSessionSnapshot(){
      saveLS(LS_STATE,{
        subjectIdx: state.subjectIdx,
        mode: state.mode,
        order: state.order,
        filter: state.filter,
        search: state.search
      });
    }

  })();
  </script>
</body>
</html>
