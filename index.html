<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Quiz Pro ‚Äì √în thi ƒë·ªânh cao</title>
  <meta name="theme-color" content="#0f172a" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:['class','[data-theme="dark"]'],theme:{extend:{colors:{brand:{50:'#eef2ff',100:'#e0e7ff',600:'#4f46e5',700:'#4338ca'}},boxShadow:{smooth:'0 6px 24px rgba(0,0,0,.08),0 2px 8px rgba(0,0,0,.06)'}}}}</script>
  <style>
    .safe-top{padding-top:env(safe-area-inset-top)}.safe-bottom{padding-bottom:env(safe-area-inset-bottom)}
    .card{border-radius:1rem;background:#fff;box-shadow:0 6px 24px rgba(0,0,0,.08),0 2px 8px rgba(0,0,0,.06);padding:1rem}
    .chip{display:inline-flex;align-items:center;gap:.375rem;border-radius:999px;padding:.25rem .625rem;font-size:.75rem;line-height:1rem;border:1px solid #e5e7eb;background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.9rem;padding:.5rem 1rem;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:.15s}
    .btn:active{transform:scale(.98)} .btn-prim{background:#4f46e5;color:#fff} .btn-soft{background:#fff;border:1px solid #e5e7eb}
    .hy{hyphens:auto;word-break:break-word;overflow-wrap:anywhere}
    .vh-safe{height:100svh}
  </style>

  <!-- Lu√¥n load data.js TR∆Ø·ªöC app (defer gi·ªØ th·ª© t·ª±) -->
  <script src="data.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="safe-top sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="mx-auto max-w-5xl px-3 sm:px-4">
      <div class="flex items-center gap-3 py-2">
        <div class="flex items-center gap-2">
          <div class="h-9 w-9 rounded-xl bg-brand-600 text-white grid place-items-center font-bold">Q</div>
          <div class="leading-tight">
            <div class="font-bold">Quiz Pro</div>
            <div class="text-xs text-gray-500">√în t·∫≠p ‚Ä¢ Luy·ªán thi ‚Ä¢ Flashcards</div>
          </div>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <button id="btnTheme" class="btn btn-soft" title="Ch·∫ø ƒë·ªô s√°ng/t·ªëi">üåô</button>
          <button id="btnShare" class="btn btn-soft" title="Chia s·∫ª c·∫•u h√¨nh">üîó</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="root" class="mx-auto max-w-5xl px-3 sm:px-4 pt-3 pb-24 safe-bottom"></main>

  <!-- Bottom nav -->
  <nav class="safe-bottom fixed inset-x-0 bottom-0 z-50 border-t bg-white/90 backdrop-blur">
    <div class="mx-auto max-w-5xl grid grid-cols-5 text-xs">
      <button data-view="home" class="py-2.5 flex flex-col items-center gap-1">üè†<span>Trang</span></button>
      <button data-view="practice" class="py-2.5 flex flex-col items-center gap-1">üìù<span>Luy·ªán</span></button>
      <button data-view="exam" class="py-2.5 flex flex-col items-center gap-1">‚è±Ô∏è<span>Thi</span></button>
      <button data-view="flash" class="py-2.5 flex flex-col items-center gap-1">üÉè<span>Th·∫ª</span></button>
      <button data-view="reports" class="py-2.5 flex flex-col items-center gap-1">üìä<span>B√°o c√°o</span></button>
    </div>
  </nav>

  <!-- APP -->
  <script defer>
  (function(){
    /* ========= Helpers ========= */
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const escapeHTML = s => (s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const strip = s => (s??'').replace(/\r/g,'').trim();
    const normalize = s => strip(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w \-\(\)\[\]\.:,/%]/g,'').replace(/\s+/g,' ').trim();
    const onDOM = fn => (document.readyState==='loading')?document.addEventListener('DOMContentLoaded',fn,{once:true}):fn();
    const save = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
    const load = (k,f=null)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}};

    // Seeded RNG
    function xmur3(str){for(var i=0,h=1779033703^str.length;i<str.length;i++)h=Math.imul(h^str.charCodeAt(i),3432918353),h=h<<13|h>>>19;return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return(h^h>>>16)>>>0}}
    function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
    const shuffleSeed = (arr, seedStr) => { const s=xmur3(seedStr||'seed')(), r=mulberry32(s), a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(r()*(i+1)); [a[i],a[j]]=[a[j],a[i]]} return a };

    // Theme
    const theme = {
      init(){ const st=load('qp_theme','light'); this.apply(st); $('#btnTheme').onclick=()=>{ const next=(document.documentElement.classList.contains('dark')?'light':'dark'); this.apply(next); save('qp_theme',next);} },
      apply(mode){ if(mode==='dark'){document.documentElement.classList.add('dark');document.documentElement.dataset.theme='dark'} else {document.documentElement.classList.remove('dark');document.documentElement.dataset.theme='light'}; $('#btnTheme').textContent=document.documentElement.classList.contains('dark')?'üåû':'üåô';}
    };

    /* ========= State ========= */
    const App = {
      subjects: [], subjectIdx: 0,
      cfg: { mode:'practice', count:20, randomQ:true, randomA:true, seed:'', durationMin:30, search:'' },
      run: { deck:[], idx:0, answers:{}, startAt:0, endAt:0, timer:null },
      srs: load('qp_srs',{}), stats: load('qp_stats',{}), wrongPool: load('qp_wrongPool',[]),
      saveAll(){ save('qp_srs',this.srs); save('qp_stats',this.stats); save('qp_wrongPool',this.wrongPool); },
      get curSub(){ return this.subjects[this.subjectIdx] || {subject:'',items:[],total:0} },
      setSubByName(n){ const i=this.subjects.findIndex(s=>s.subject===n); if(i>=0) this.subjectIdx=i; }
    };

    /* ========= Data loader (robust) ========= */
    async function ensureData(){
      // ƒë·ª£i quizData t·ª´ data.js (t·ªëi ƒëa 3s)
      const t0=Date.now();
      while(Date.now()-t0<3000){
        if(window.quizData && typeof window.quizData.getAll==='function') break;
        await new Promise(r=>setTimeout(r,50));
      }
      if(window.quizData && typeof window.quizData.getAll==='function'){
        try{
          const raw = window.quizData.getAll();
          App.subjects = raw.map(s=>({subject:strip(s.subject||'M√¥n kh√¥ng t√™n'), items:parseSubject(s.text||''), total:0}))
                            .map(s=>{s.total=s.items.length; return s});
          if(App.subjects.length===0) throw new Error('Kh√¥ng c√≥ m√¥n n√†o.');
          return;
        }catch(e){ console.error(e) }
      }
      // fallback: hi·ªÉn th·ªã UI n·∫°p file
      renderDataMissing();
    }

    /* ========= Parser (ch·ªãu l·ªói m·∫°nh) ========= */
    function parseSubject(txt){
      const raw = ('\n'+(txt||'')+'\n').replace(/\r/g,'');
      const re = /C√¢u\s+(\d+)\s*:\s*([\s\S]*?)\n\s*ƒê√°p\s*√°n\s*ƒë√∫ng\s*:\s*([\s\S]*?)\n\s*T·∫•t\s*c·∫£\s*ƒë√°p\s*√°n\s*:\s*([\s\S]*?)(?=\n[-‚Äì‚Äî]{3,}|$)/gim;
      const blocks = [];
      let m;
      while((m=re.exec(raw))!==null){
        const no=Number(m[1])||blocks.length+1, q=strip(m[2]), right=strip(m[3]);
        const options=parseOptions(m[4]||'');
        const correctKey = guessCorrect(options, right);
        const id = 'q_'+hash(q+'::'+options.map(o=>o.text).join('|'));
        blocks.push({id,no,question:q,options,correctKey,rightText:right});
      }
      return blocks;
    }
    function parseOptions(s){
      const lines = (s||'').split('\n').map(l=>l.trim()).filter(Boolean);
      const out=[];
      for(const l of lines){
        // H·ªó tr·ª£: "A. ‚úì N·ªôi dung" | "B) N·ªôi dung" | "C . N·ªôi dung"
        const mm = l.match(/^([A-Zƒê])[\.\)]\s*(.*)$/i);
        if(!mm) continue;
        const key=mm[1].toUpperCase(); let text=mm[2].replace(/[‚úì‚úî]/g,'').trim();
        out.push({key, text, marked:/[‚úì‚úî]/.test(l)});
      }
      return out;
    }
    function guessCorrect(options, right){
      if(!options.length) return null;
      const marked=options.find(o=>o.marked); if(marked) return marked.key;
      const nr=normalize(right);
      if(!nr) return null;
      // match ch·∫∑t
      let best=null,score=-1;
      for(const o of options){
        const no=normalize(o.text);
        let s=0;
        if(no===nr) s=5;
        else if(no.includes(nr)||nr.includes(no)) s=3;
        else s = jaccard(no,nr);
        if(s>score){score=s;best=o;}
      }
      return best?.key||null;
    }
    function jaccard(a,b){ const A=new Set(a.split(' ')), B=new Set(b.split(' '));
      const inter=[...A].filter(x=>B.has(x)).length; const uni=new Set([...A,...B]).size; return inter/Math.max(1,uni); }
    function hash(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619)} return (h>>>0).toString(16) }

    /* ========= Rendering ========= */
    const Root = ()=> $('#root');

    function render(){
      const root = Root(); if(!root){return}
      const view = Router.cur;
      if(!App.subjects.length){ renderDataMissing(); return; }

      if(view==='home') root.innerHTML = ViewHome();
      else if(view==='practice') root.innerHTML = ViewPractice();
      else if(view==='exam') root.innerHTML = ViewExam();
      else if(view==='flash') root.innerHTML = ViewFlash();
      else if(view==='reports') root.innerHTML = ViewReports();
      else root.innerHTML = ViewHome();

      bindCommon();
      if(view==='home') bindHome();
      if(view==='practice') bindPractice();
      if(view==='exam') bindExam();
      if(view==='flash') bindFlash();
      if(view==='reports') bindReports();
      highlightNav(view);
    }

    function renderDataMissing(){
      const root=Root(); if(!root) return;
      root.innerHTML = `
        <section class="card">
          <h3 class="font-bold text-rose-600">Ch∆∞a ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu g·ªëc</h3>
          <p class="text-sm text-gray-600 mt-1">ƒê·∫∑t <b>data.js</b> c√πng th∆∞ m·ª•c v√† m·ªü l·∫°i trang.<br/>Ho·∫∑c n·∫°p th·ªß c√¥ng t·ªáp <b>.txt/.js</b> b·∫°n ƒëang c√≥.</p>
          <div class="mt-3 flex items-center gap-2">
            <input id="fileData" type="file" accept=".txt,.js" class="hidden"/>
            <button id="btnPick" class="btn btn-soft">üìÑ T·∫£i file d·ªØ li·ªáu</button>
          </div>
          <details class="mt-3 text-sm text-gray-600">
            <summary class="cursor-pointer">M·∫πo: th·ª© t·ª± script</summary>
            <div>index n√†y ƒë√£ ƒë·∫∑t <code>&lt;script src="data.js" defer&gt;</code> tr∆∞·ªõc app. N·∫øu b·∫°n ƒë·ªïi t√™n file d·ªØ li·ªáu th√¨ nh·ªõ s·ª≠a l·∫°i.</div>
          </details>
        </section>`;
      $('#btnPick').onclick=()=>{
        const ip=$('#fileData'); ip.click();
        ip.onchange=()=> {
          const f=ip.files?.[0]; if(!f) return;
          const rd = new FileReader();
          rd.onload = ()=>{
            try{
              const txt = String(rd.result||'');
              // n·∫øu l√† .js c√≥ window.quizData -> eval sandbox ƒë∆°n gi·∫£n
              if(f.name.endsWith('.js') && /window\.quizData/.test(txt)){
                const mod = {}; (new Function('window', txt))(window);
                const raw = window.quizData?.getAll ? window.quizData.getAll() : [];
                App.subjects = raw.map(s=>({subject:strip(s.subject||'M√¥n'),items:parseSubject(s.text||''),total:0})).map(s=>{s.total=s.items.length;return s});
              }else{
                // coi nh∆∞ l√† m·ªôt m√¥n ƒë∆°n
                App.subjects=[{subject:'M√¥n t·∫£i l√™n', items:parseSubject(txt), total:0}];
                App.subjects[0].total=App.subjects[0].items.length;
              }
              Router.go('home');
            }catch(e){ alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file n√†y.'); }
          };
          rd.readAsText(f);
        };
      };
    }

    /* ========= Views ========= */
    const Router = {
      cur:'home',
      go(v){ this.cur=v; render(); },
      init(){ $$('.grid [data-view]').forEach(b=> b.onclick=()=> this.go(b.dataset.view)); $('#btnShare').onclick=shareLink; }
    };

    const FilterBar = ({showCount=true, showTimer=false}={})=>{
      const subjOpts = App.subjects.map((s,i)=>`<option value="${i}" ${i===App.subjectIdx?'selected':''}>${escapeHTML(s.subject)} (${s.total})</option>`).join('');
      const counts = [10,20,50,100,'all'].map(n=>`<option value="${n}" ${String(App.cfg.count)===String(n)?'selected':''}>${n==='all'?'T·∫•t c·∫£':n}</option>`).join('');
      return `
      <div class="card space-y-3">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label class="text-sm font-semibold">M√¥n</label>
          <select id="selSubject" class="rounded-xl ring-1 ring-gray-200 px-3 py-2 bg-white">${subjOpts}</select>
        </div>
        ${showCount?`
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label class="text-sm font-semibold">S·ªë c√¢u</label>
          <select id="selCount" class="rounded-xl ring-1 ring-gray-200 px-3 py-2 bg-white">${counts}</select>
        </div>`:''}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label class="text-sm font-semibold">Seed ƒë·ªÅ</label>
          <input id="inpSeed" class="rounded-xl ring-1 ring-gray-200 px-3 py-2" placeholder="vd: K61-ON" value="${escapeHTML(App.cfg.seed||'')}"/>
        </div>
        ${showTimer?`
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label class="text-sm font-semibold">Th·ªùi l∆∞·ª£ng thi (ph√∫t)</label>
          <input id="inpDur" type="number" min="5" max="180" class="rounded-xl ring-1 ring-gray-200 px-3 py-2" value="${App.cfg.durationMin}">
        </div>`:''}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label class="text-sm font-semibold">T√πy ch·ªçn</label>
          <div class="flex flex-wrap gap-2">
            <label class="chip"><input id="chkRQ" type="checkbox" class="mr-1" ${App.cfg.randomQ?'checked':''}/>Tr·ªôn c√¢u</label>
            <label class="chip"><input id="chkRA" type="checkbox" class="mr-1" ${App.cfg.randomA?'checked':''}/>Tr·ªôn ƒë√°p √°n</label>
          </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label class="text-sm font-semibold">T√¨m ki·∫øm</label>
          <input id="inpSearch" class="rounded-xl ring-1 ring-gray-200 px-3 py-2" placeholder="CSS, PHP, SPI..." value="${escapeHTML(App.cfg.search||'')}"/>
        </div>
      </div>`;
    };

    function ViewHome(){
      const s=App.curSub;
      return `
      <section class="space-y-4">
        ${FilterBar({showTimer:true})}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="card">
            <h3 class="font-bold mb-2">B·∫Øt ƒë·∫ßu nhanh</h3>
            <div class="grid grid-cols-2 gap-2">
              <button id="startPractice" class="btn btn-prim">Luy·ªán ngay</button>
              <button id="startExam" class="btn btn-soft">Thi ngay</button>
            </div>
            <p class="mt-2 text-sm text-gray-500">M√¥n: <b>${escapeHTML(s.subject)}</b> ‚Ä¢ ${s.total} c√¢u</p>
          </div>
          <div class="card">
            <h3 class="font-bold mb-2">√în c√¢u sai</h3>
            <p class="text-sm text-gray-600 mb-2">ƒêang c√≥ ${App.wrongPool.length} c√¢u sai ƒë∆∞·ª£c l∆∞u.</p>
            <div class="grid grid-cols-2 gap-2">
              <button id="startWrong" class="btn btn-soft">Luy·ªán c√¢u sai</button>
              <button id="startFlashWrong" class="btn btn-soft">Th·∫ª ‚Äì sai g·∫ßn ƒë√¢y</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h3 class="font-bold mb-2">Ph√≠m t·∫Øt</h3>
          <div class="text-sm text-gray-600">A/B/C/D ch·ªçn ƒë√°p √°n ‚Ä¢ ‚Üê/‚Üí chuy·ªÉn c√¢u ‚Ä¢ Enter n·ªôp b√†i.</div>
        </div>
      </section>`;
    }

    function ViewPractice(){
      buildDeck('practice');
      return QAView('Luy·ªán t·∫≠p', true, false);
    }
    function ViewExam(){
      buildDeck('exam');
      return QAView('Thi', false, true);
    }
    function QAView(title, showReveal, showSubmit){
      const deck = App.run.deck, i=App.run.idx, q=deck[i];
      return `
      <section class="space-y-3">
        ${FilterBar({showCount:true, showTimer:showSubmit})}
        <div class="card">
          <div class="flex items-center justify-between gap-2">
            <div class="text-sm text-gray-600">${title} ‚Ä¢ ${deck.length} c√¢u</div>
            <div class="flex items-center gap-2">
              ${showSubmit?`<span class="chip">‚è±Ô∏è <span id="examTimer">${fmtLeft()}</span></span>`:''}
              <div class="h-3 w-40 rounded-full bg-gray-100 overflow-hidden"><div id="progress" class="h-3 bg-brand-600" style="width:0%"></div></div>
            </div>
          </div>

          ${renderQuestion(q, i, deck.length, showReveal)}

          <div class="mt-3 flex flex-wrap gap-2 items-center">
            <button id="btnPrev" class="btn btn-soft">‚Üê Tr∆∞·ªõc</button>
            <button id="btnNext" class="btn btn-soft">Sau ‚Üí</button>
            ${showReveal?`<button id="btnReveal" class="btn btn-soft">üëÄ Hi·ªán ƒë√°p √°n</button>`:''}
            ${showSubmit?`<button id="btnSubmit" class="btn btn-prim ml-auto">N·ªôp b√†i</button>`:''}
          </div>

          ${renderGridIndex(deck)}
        </div>
      </section>`;
    }
    function renderGridIndex(deck){
      return `
      <div class="mt-4 grid grid-cols-10 sm:grid-cols-12 gap-1" id="gridIdx">
        ${deck.map((_,k)=>`<button data-goto="${k}" class="rounded-lg text-xs py-1 border ${k===App.run.idx?'bg-brand-600 text-white border-brand-600':'bg-white'}">${k+1}</button>`).join('')}
      </div>`;
    }
    function renderQuestion(item, idx, total, showReveal){
      if(!item) return `<div class="mt-3 text-sm text-rose-600">Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi.</div>`;
      const opts = App.cfg.randomA ? shuffleSeed(item.options, App.cfg.seed+item.id) : item.options.slice();
      const chosen = App.run.answers[item.id]||null;
      return `
      <div class="mt-3">
        <div class="text-xs text-gray-500 mb-1">C√¢u ${idx+1}/${total}</div>
        <div class="font-semibold hy whitespace-pre-wrap">${escapeHTML(item.question)}</div>
        <div class="mt-3 grid gap-2" id="optWrap">
          ${opts.map(o=>renderOption(item,o,chosen,showReveal)).join('')}
        </div>
        <div id="revealBox" class="mt-3 ${showReveal?'hidden':''}">
          ${answerBlock(item)}
        </div>
      </div>
      `;
    }
    function renderOption(item,o,chosen,showReveal){
      const isChosen = chosen===o.key;
      let cls='ring-1 ring-gray-200 bg-white hover:bg-gray-50';
      if(showReveal && isChosen){
        if(item.correctKey && o.key===item.correctKey) cls='ring-emerald-200 bg-emerald-50';
        else cls='ring-rose-200 bg-rose-50';
      }
      return `
        <label class="rounded-xl p-3 flex gap-3 items-start cursor-pointer ${cls}">
          <input type="radio" name="ans_${item.id}" value="${o.key}" class="mt-1" ${isChosen?'checked':''}/>
          <div><div class="font-semibold">${o.key}.</div><div class="hy whitespace-pre-wrap">${escapeHTML(o.text)}</div></div>
        </label>`;
    }
    function answerBlock(item){
      if(item.correctKey){
        const opt=item.options.find(x=>x.key===item.correctKey);
        return `<div class="text-emerald-700 font-semibold">ƒê√°p √°n ƒë√∫ng: ${opt.key}. ${escapeHTML(opt.text)}</div>`;
      }
      if(item.rightText) return `<div class="text-emerald-700 font-semibold">ƒê√°p √°n ƒë√∫ng: ${escapeHTML(item.rightText)}</div>`;
      return `<div class="text-amber-700">Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ƒë√°p √°n g·ªëc.</div>`;
    }

    function ViewFlash(){
      const pool = buildFlash();
      if(!pool.length) return `<section class="card">Ch∆∞a c√≥ th·∫ª ƒë·ªÉ h·ªçc. H√£y luy·ªán/thi tr∆∞·ªõc nh√©.</section>`;
      const it = pool[App.run.idx];
      return `
      <section class="space-y-3">
        ${FilterBar({showCount:true})}
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm text-gray-600">Flashcards ‚Ä¢ ${pool.length} th·∫ª</div>
            <span class="chip" id="fcInfo">Box ${getSRS(it.id).box}</span>
          </div>
          <div id="fcCard" class="rounded-2xl border p-4 bg-brand-50 cursor-pointer select-none">
            <div class="text-xs text-gray-500 mb-1">Ch·∫°m ƒë·ªÉ l·∫≠t</div>
            <div id="fcFront" class="font-semibold hy whitespace-pre-wrap">${escapeHTML(it.question)}</div>
            <div id="fcBack" class="hidden mt-3">${answerBlock(it)}</div>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2">
            <button class="btn btn-soft" data-rate="hard">Kh√≥</button>
            <button class="btn btn-soft" data-rate="good">V·ª´a</button>
            <button class="btn btn-prim" data-rate="easy">D·ªÖ</button>
          </div>
        </div>
      </section>`;
    }

    function ViewReports(){
      const s=App.curSub; const r=statsOf(s.items);
      return `
      <section class="space-y-3">
        <div class="card">
          <h3 class="font-bold mb-2">B√°o c√°o ‚Äì ${escapeHTML(s.subject)}</h3>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
            <div class="card"><div class="text-gray-500">T·ªïng c√¢u</div><div class="text-2xl font-bold">${s.total}</div></div>
            <div class="card"><div class="text-gray-500">ƒê√£ l√†m</div><div class="text-2xl font-bold">${r.done}</div></div>
            <div class="card"><div class="text-gray-500">ƒê√∫ng</div><div class="text-2xl font-bold text-emerald-600">${r.correct}</div></div>
            <div class="card"><div class="text-gray-500">Sai</div><div class="text-2xl font-bold text-rose-600">${r.wrong}</div></div>
          </div>
          <div class="mt-3">
            <div class="h-3 w-full rounded-full bg-gray-100 overflow-hidden"><div class="h-full bg-emerald-500" style="width:${r.correctPct}%"></div></div>
            <div class="mt-1 text-xs text-gray-600">T·ªâ l·ªá ƒë√∫ng: ${r.correctPct.toFixed(1)}%</div>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="btnExport" class="btn btn-soft">Xu·∫•t ti·∫øn ƒë·ªô</button>
            <input id="fileImport" type="file" accept="application/json" class="hidden"/>
            <button id="btnImport" class="btn btn-soft">Nh·∫≠p ti·∫øn ƒë·ªô</button>
            <button id="btnClearWrong" class="btn btn-soft text-rose-600">Xo√° b·ªô c√¢u sai</button>
          </div>
        </div>
      </section>`;
    }

    /* ========= Build decks ========= */
    function filtered(items){
      const q = normalize(App.cfg.search||''); if(!q) return items;
      return items.filter(it=> normalize(it.question+' '+it.options.map(o=>o.text).join(' ')).includes(q));
    }
    function pick(items){
      const n = App.cfg.count==='all' ? items.length : Math.min(items.length, Number(App.cfg.count)||10);
      return items.slice(0,n);
    }
    function buildDeck(mode){
      const subj=App.curSub;
      let arr = filtered(subj.items);
      if(App._wrongOnly){ const set=new Set(App.wrongPool); arr=arr.filter(x=>set.has(x.id)); if(!arr.length) arr=filtered(subj.items) }
      if(App.cfg.randomQ) arr = shuffleSeed(arr, App.cfg.seed||'seed');
      arr = pick(arr);
      App.run = { deck:arr, idx:0, answers:{}, startAt:Date.now(), endAt:0, timer:null };
      return arr;
    }
    function buildFlash(){
      const subj=App.curSub;
      let pool = filtered(subj.items);
      const wrong=new Set(App.wrongPool);
      pool = shuffleSeed(pool, App.cfg.seed||'flash').sort((a,b)=>{
        const aw=wrong.has(a.id)?1:0, bw=wrong.has(b.id)?1:0; if(aw!==bw) return bw-aw;
        return getSRS(a.id).due - getSRS(b.id).due;
      });
      if(App.cfg.count!=='all') pool=pool.slice(0, Number(App.cfg.count)||20);
      App.run={deck:pool, idx:0, answers:{}, startAt:Date.now(), endAt:0, timer:null};
      return pool;
    }

    /* ========= SRS ========= */
    function getSRS(id){ if(!App.srs[id]) App.srs[id]={box:1,due:0}; return App.srs[id]; }
    function srsRate(id, lvl){
      const s=getSRS(id); const now=Date.now();
      const step={1:1,2:2,3:4,4:7,5:14};
      if(lvl==='hard') s.box=Math.max(1,s.box-1);
      if(lvl==='good') s.box=Math.min(5,s.box+0);
      if(lvl==='easy') s.box=Math.min(5,s.box+1);
      s.due = now + (step[s.box]||1)*24*3600*1000;
      App.saveAll();
    }

    /* ========= Bindings ========= */
    function bindCommon(){
      const selSub=$('#selSubject'); if(selSub) selSub.onchange=(e)=>{App.subjectIdx=Number(e.target.value)||0; render();}
      const selCount=$('#selCount'); if(selCount) selCount.onchange=(e)=>App.cfg.count=e.target.value;
      const inpSeed=$('#inpSeed'); if(inpSeed) inpSeed.onchange=(e)=>App.cfg.seed=strip(e.target.value);
      const dur=$('#inpDur'); if(dur) dur.onchange=(e)=>App.cfg.durationMin=Math.max(5, Math.min(180, Number(e.target.value)||30));
      const chkRQ=$('#chkRQ'); if(chkRQ) chkRQ.onchange=(e)=>App.cfg.randomQ=e.target.checked;
      const chkRA=$('#chkRA'); if(chkRA) chkRA.onchange=(e)=>App.cfg.randomA=e.target.checked;
      const inpSearch=$('#inpSearch'); if(inpSearch) inpSearch.oninput=(e)=>App.cfg.search=e.target.value;
    }

    function bindHome(){
      $('#startPractice')?.addEventListener('click',()=>{App._wrongOnly=false; Router.go('practice')});
      $('#startExam')?.addEventListener('click',()=>Router.go('exam'));
      $('#startWrong')?.addEventListener('click',()=>{App._wrongOnly=true; Router.go('practice')});
      $('#startFlashWrong')?.addEventListener('click',()=>{App.cfg.mode='flash'; Router.go('flash')});
    }

    function bindQA(){
      const deck=App.run.deck; if(!deck.length) return;
      const cur=()=>deck[App.run.idx];
      // radios
      $$(`input[name="ans_${cur().id}"]`).forEach(r=> r.onchange=(e)=>{ App.run.answers[cur().id]=e.target.value; updateProgress(); updateOptionsVisual(); });
      // nav
      $('#btnPrev')?.addEventListener('click',()=>{ if(App.run.idx>0){App.run.idx--; rerenderQA()} });
      $('#btnNext')?.addEventListener('click',()=>{ if(App.run.idx<deck.length-1){App.run.idx++; rerenderQA()} });
      // reveal
      $('#btnReveal')?.addEventListener('click',()=>{ $('#revealBox')?.classList.toggle('hidden'); updateOptionsVisual(true);});
      // grid goto
      $$('#gridIdx [data-goto]').forEach(b=> b.onclick=()=>{ App.run.idx=Number(b.dataset.goto); rerenderQA(); });
      // hotkeys
      document.onkeydown=(e)=>{
        if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
        const k=e.key.toLowerCase();
        if(k==='arrowleft') $('#btnPrev')?.click();
        if(k==='arrowright') $('#btnNext')?.click();
        if(k==='a'||k==='b'||k==='c'||k==='d'){
          const radios=$$(`input[name="ans_${cur().id}"]`); const r=radios.find(x=>x.value.toLowerCase()===k);
          if(r){ r.checked=true; r.dispatchEvent(new Event('change',{bubbles:true})) }
        }
        if(k==='enter' && $('#btnSubmit')) $('#btnSubmit').click();
      }
      // progress
      updateProgress();
    }
    function bindPractice(){ bindQA(); }
    function bindExam(){
      bindQA();
      // timer
      clearInterval(App.run.timer);
      App.run.endAt=Date.now()+App.cfg.durationMin*60*1000;
      App.run.timer=setInterval(()=>{
        const t=$('#examTimer'); if(!t) return;
        const ms=App.run.endAt-Date.now();
        if(ms<=0){clearInterval(App.run.timer); t.textContent='0:00'; submitExam(); return;}
        t.textContent = msToMMSS(ms);
      },500);
      $('#btnSubmit')?.addEventListener('click', submitExam);
    }
    function bindFlash(){
      const pool=App.run.deck; if(!pool.length) return;
      const cur=()=>pool[App.run.idx];
      const card=$('#fcCard'), front=$('#fcFront'), back=$('#fcBack'), info=$('#fcInfo');
      card.onclick=()=> back.classList.toggle('hidden');
      $$('#root [data-rate]').forEach(b=> b.onclick=()=>{
        srsRate(cur().id, b.dataset.rate);
        App.run.idx=(App.run.idx+1)%pool.length;
        const it=cur(); front.textContent=it.question; back.innerHTML=answerBlock(it); info.textContent='Box '+getSRS(it.id).box;
        back.classList.add('hidden');
      });
    }
    function bindReports(){
      $('#btnExport')?.addEventListener('click',()=>{
        const blob=new Blob([JSON.stringify({srs:App.srs,stats:App.stats,wrongPool:App.wrongPool,v:1,at:Date.now()},null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='quiz-progress.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
      });
      $('#btnImport')?.addEventListener('click',()=>$('#fileImport').click());
      $('#fileImport')?.addEventListener('change',(e)=>{
        const f=e.target.files?.[0]; if(!f) return; const rd=new FileReader();
        rd.onload=()=>{try{const o=JSON.parse(rd.result||'{}'); if(o.srs)App.srs=o.srs; if(o.stats)App.stats=o.stats; if(Array.isArray(o.wrongPool))App.wrongPool=o.wrongPool; App.saveAll(); alert('ƒê√£ nh·∫≠p ti·∫øn ƒë·ªô!')}catch{alert('File kh√¥ng h·ª£p l·ªá')}}; rd.readAsText(f);
      });
      $('#btnClearWrong')?.addEventListener('click',()=>{ if(confirm('Xo√° danh s√°ch c√¢u sai?')){App.wrongPool=[]; App.saveAll(); alert('ƒê√£ xo√°.')} });
    }

    function updateOptionsVisual(forceShow=false){
      const deck=App.run.deck; const it=deck[App.run.idx]; if(!it) return;
      const show = forceShow || !$('#btnReveal'); // exam: lu√¥n t√¥ khi submit; practice: ch·ªâ khi reveal b·∫≠t
      if(!show) return;
      const chosen=App.run.answers[it.id];
      $$('#optWrap label').forEach(l=>{
        const val = l.querySelector('input')?.value;
        l.className='rounded-xl p-3 flex gap-3 items-start cursor-pointer ring-1';
        l.classList.add('ring-gray-200','bg-white');
        if(chosen===val && it.correctKey && val!==it.correctKey){ l.classList.remove('ring-gray-200'); l.classList.add('ring-rose-200'); l.style.background='#fff1f2'; }
        if(it.correctKey && val===it.correctKey){ l.classList.remove('ring-gray-200'); l.classList.add('ring-emerald-200'); l.style.background='#ecfdf5'; }
      });
    }

    function rerenderQA(){ const root=Root(); if(!root) return; root.innerHTML = (Router.cur==='exam'?ViewExam():ViewPractice()); (Router.cur==='exam')?bindExam():bindPractice(); }
    function updateProgress(){
      const cur=App.run.idx+1, total=App.run.deck.length;
      const pct=Math.round(((cur-1)+(App.run.answers[App.run.deck[App.run.idx].id]?0.5:0))/Math.max(1,total)*100);
      const bar=$('#progress'); if(bar) bar.style.width=pct+'%';
      // c·∫≠p nh·∫≠t tr·∫°ng th√°i l∆∞·ªõi
      $$('#gridIdx [data-goto]').forEach((b,k)=>{
        const id=App.run.deck[k].id; const chosen=App.run.answers[id];
        b.className='rounded-lg text-xs py-1 border';
        if(k===App.run.idx) b.classList.add('bg-brand-600','text-white','border-brand-600');
        else if(chosen) b.classList.add('bg-gray-100');
        else b.classList.add('bg-white');
      });
    }

    function submitExam(){
      const deck=App.run.deck; let correct=0, wrong=0; const wrongIds=[];
      for(const it of deck){
        const pick=App.run.answers[it.id]; const ok=!!it.correctKey && pick===it.correctKey;
        if(ok) correct++; else {wrong++; if(!App.wrongPool.includes(it.id)) App.wrongPool.push(it.id);}
        pushStat(ok);
      }
      App.saveAll();
      const score=Math.round(correct/deck.length*100);
      Root().innerHTML = `
        <section class="card">
          <h3 class="font-bold mb-1">K·∫øt qu·∫£: ${correct}/${deck.length} ‚Ä¢ ${score}%</h3>
          <div class="h-3 w-full rounded-full bg-gray-100 overflow-hidden"><div class="h-full ${score>=50?'bg-emerald-500':'bg-rose-500'}" style="width:${score}%"></div></div>
          <div class="mt-3 grid gap-2">
            ${deck.map((it,i)=>reviewRow(it,i,App.run.answers[it.id])).join('')}
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button class="btn btn-prim" id="revWrong">√în l·∫°i c√¢u sai</button>
            <button class="btn btn-soft" id="again">L√†m l·∫°i</button>
            <button class="btn btn-soft" id="toHome">Trang ch·ªß</button>
          </div>
        </section>`;
      $('#revWrong').onclick=()=>{App._wrongOnly=true; Router.go('practice')};
      $('#again').onclick=()=>Router.go('exam');
      $('#toHome').onclick=()=>Router.go('home');
    }
    function reviewRow(it,i,pick){
      const ok=!!it.correctKey && pick===it.correctKey;
      const ans=it.options.find(o=>o.key===pick);
      const corr=it.options.find(o=>o.key===it.correctKey);
      return `
      <div class="rounded-xl p-3 ${ok?'bg-emerald-50 ring-emerald-100':'bg-rose-50 ring-rose-100'} ring-1">
        <div class="text-xs text-gray-500 mb-1">C√¢u ${i+1}</div>
        <div class="font-semibold hy whitespace-pre-wrap">${escapeHTML(it.question)}</div>
        <div class="mt-2 text-sm">
          <div class="${ok?'text-emerald-700':'text-rose-700'}">B·∫°n ch·ªçn: ${ans?`${ans.key}. ${escapeHTML(ans.text)}`:'(ch∆∞a ch·ªçn)'}</div>
          <div class="text-emerald-700">ƒê√°p √°n ƒë√∫ng: ${corr?`${corr.key}. ${escapeHTML(corr.text)}`:escapeHTML(it.rightText||'Ch∆∞a x√°c ƒë·ªãnh')}</div>
        </div>
      </div>`;
    }

    function pushStat(ok){
      const k=App.curSub.subject; if(!App.stats[k]) App.stats[k]={played:0,correct:0,wrong:0,lastAt:0};
      const s=App.stats[k]; s.played++; if(ok)s.correct++; else s.wrong++; s.lastAt=Date.now();
    }
    function statsOf(items){
      const k=App.curSub.subject; const s=App.stats[k]||{played:0,correct:0,wrong:0};
      const done=s.correct+s.wrong; const pct=done?(s.correct/done*100):0; return {done,correct:s.correct,wrong:s.wrong,correctPct:pct};
    }

    function msToMMSS(ms){ const s=Math.max(0,Math.ceil(ms/1000)); const m=Math.floor(s/60), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}` }
    function fmtLeft(){ return App.run.endAt?msToMMSS(App.run.endAt-Date.now()):App.cfg.durationMin+':00' }

    async function shareLink(){
      const url=new URL(location.href);
      url.searchParams.set('subj', App.curSub.subject);
      url.searchParams.set('count', App.cfg.count);
      url.searchParams.set('seed', App.cfg.seed||'');
      url.searchParams.set('search', App.cfg.search||'');
      try{ await navigator.clipboard.writeText(url.toString()); alert('ƒê√£ sao ch√©p li√™n k·∫øt!') }catch{ prompt('Sao ch√©p li√™n k·∫øt:', url.toString()); }
    }

    function highlightNav(v){ $$('.grid [data-view]').forEach(b=> b.classList.toggle('text-brand-700', b.dataset.view===v)); }

    /* ========= Init ========= */
    onDOM(async ()=>{
      theme.init();
      Router.init();

      // URL params
      const q=new URLSearchParams(location.search);
      const subj=q.get('subj'); if(subj) App.setSubByName(subj);
      const count=q.get('count'); if(count) App.cfg.count=count;
      const seed=q.get('seed'); if(seed) App.cfg.seed=seed;
      const search=q.get('search'); if(search) App.cfg.search=search;

      await ensureData();
      if(App.subjects.length){ Router.go('home'); }

      // PWA mini SW
      if('serviceWorker' in navigator){
        const sw=`
          self.addEventListener('install',e=>{e.waitUntil(caches.open('qp-v1').then(c=>c.addAll(['./','./index.html','./data.js'])).then(()=>self.skipWaiting()))});
          self.addEventListener('activate',e=>e.waitUntil(self.clients.claim()));
          self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const copy=res.clone(); caches.open('qp-v1').then(c=>c.put(e.request,copy));return res}).catch(()=>caches.match('./index.html'))))});
        `;
        const blob=new Blob([sw],{type:'text/javascript'}); const u=URL.createObjectURL(blob);
        navigator.serviceWorker.register(u).catch(()=>{}); setTimeout(()=>URL.revokeObjectURL(u),4000);
      }
    });
  })();
  </script>
</body>
</html>
