<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Pro — 2 files (Mobile-first)</title>
  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Pako để ungzip data.js -->
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <!-- Ngân hàng câu hỏi (GZIP Base64) -->
  <script src="data.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    .sticky-top { position: sticky; top: 0; z-index: 50; }
    .shadow-card { box-shadow: 0 10px 25px rgba(0,0,0,.08), 0 4px 8px rgba(0,0,0,.06); }
    .option input[type="radio"] { display:none; }
    .option label { display:block; padding:.85rem 1rem; border-radius:.9rem; border:1px solid rgba(0,0,0,.12); cursor:pointer; }
    .option input[type="radio"]:checked + label { border-color: rgb(59 130 246); background: rgba(59,130,246,.10); }
    .option.locked label { opacity:.75; }
    .nav-btn-answered { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .nav-btn-default  { background:#f8fafc; color:#334155; border:1px solid #e2e8f0; }
    .nav-btn-hard     { background:#fef9c3; color:#854d0e; border:1px solid #fde68a; }
    .nav-btn-correct  { background:#dcfce7; color:#166534; border:1px solid #86efac; }
    .nav-btn-wrong    { background:#ffe4e6; color:#9f1239; border:1px solid #fecdd3; }
    .pulse-ring { position: relative; }
    .pulse-ring::after { content:""; position:absolute; inset:-6px; border-radius:1rem; border:2px dashed rgba(59,130,246,.5); animation:pulse 1.2s ease-out 2; }
    @keyframes pulse { 0%{opacity:.8; transform:scale(.98);} 70%{opacity:.1; transform:scale(1.06);} 100%{opacity:0; transform:scale(1.12);} }
    .sticky-nav { position: sticky; top: 56px; z-index: 40; } /* navigator sticky bên dưới header */
  </style>
</head>
<body class="bg-slate-50">
  <!-- HEADER -->
  <header class="sticky-top bg-white/95 backdrop-blur border-b">
    <div class="max-w-3xl mx-auto px-3 py-2 flex items-center gap-2">
      <button id="btnBackToSetup" class="hidden sm:inline-flex px-2 py-1 rounded-lg bg-slate-100 text-xs">Thiết lập</button>
      <div class="flex-1">
        <h1 class="text-base font-bold tracking-tight">Quiz Pro — 2 files</h1>
        <p class="text-[11px] text-slate-600">Setup ➜ Làm bài ➜ Nộp & xem kết quả • Mobile-first</p>
      </div>
      <div id="examHeader" class="hidden items-center gap-3">
        <div class="text-center">
          <div class="text-[11px] text-slate-500">Đồng hồ</div>
          <div id="timer" class="font-extrabold text-sm tabular-nums">00:00</div>
        </div>
        <button id="btnSubmit" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm font-semibold">Nộp bài</button>
        <button id="btnRestart" class="px-3 py-1.5 rounded-lg bg-slate-100 text-sm">Làm lại</button>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnEditor" class="px-3 py-1.5 rounded-lg bg-amber-100 text-amber-900 text-sm font-semibold">Soát/Đổi đáp</button>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-3 py-3">
    <!-- ========== SETUP ========== -->
    <section id="setupSection" class="bg-white rounded-2xl p-4 shadow-card">
      <h2 class="font-bold text-lg">Thiết lập bài tập</h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
        <div>
          <label class="text-xs text-slate-500">Môn</label>
          <select id="setupSubject" class="w-full mt-1 border rounded-lg px-2 py-2 text-sm"></select>
          <div class="text-xs text-slate-500 mt-1">Ngân hàng: <span id="bankCount" class="font-semibold">0</span> câu</div>
        </div>
        <div>
          <label class="text-xs text-slate-500">Số câu</label>
          <input id="setupLimit" type="number" min="1" value="20" class="w-full mt-1 border rounded-lg px-2 py-2 text-sm" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Thời lượng (phút)</label>
          <input id="setupMinutes" type="number" min="1" value="15" class="w-full mt-1 border rounded-lg px-2 py-2 text-sm" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Chế độ</label>
          <select id="setupMode" class="w-full mt-1 border rounded-lg px-2 py-2 text-sm">
            <option value="exam">Kiểm tra (ẩn đáp án đến khi nộp)</option>
            <option value="practice">Luyện tập (báo đúng/sai ngay)</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <label class="flex items-center gap-2 text-sm">
            <input id="setupShuffleQ" type="checkbox" class="h-4 w-4" checked />
            <span>Trộn câu</span>
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input id="setupShuffleA" type="checkbox" class="h-4 w-4" checked />
            <span>Trộn đáp án</span>
          </label>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <label class="flex items-center gap-2 text-sm">
            <input id="setupPreferHard" type="checkbox" class="h-4 w-4" />
            <span>Ưu tiên câu ★ khi tạo đề</span>
          </label>
          <label class="flex items-center gap-2 text-sm">
            <input id="setupResume" type="checkbox" class="h-4 w-4" />
            <span>Tiếp tục lần trước</span>
          </label>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnStart" class="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold">Bắt đầu làm bài</button>
        <button id="btnClearHard" class="px-4 py-2 rounded-lg bg-slate-100 text-sm">Xoá danh sách câu ★</button>
        <button id="btnExportOverrides" class="px-4 py-2 rounded-lg bg-slate-100 text-sm">Xuất file Đổi đáp</button>
        <label for="importOverrides" class="px-4 py-2 rounded-lg bg-slate-100 text-sm cursor-pointer">Nhập file Đổi đáp</label>
        <input id="importOverrides" type="file" accept="application/json" class="hidden" />
        <span class="text-xs text-slate-500 ml-auto">Cài đặt tự lưu lần sau.</span>
      </div>
    </section>

    <!-- ========== EXAM ========== -->
    <section id="examSection" class="hidden">
      <!-- Sticky controls + Navigator -->
      <section class="sticky-nav bg-white/95 backdrop-blur border rounded-xl p-3 shadow-card">
        <div class="flex flex-wrap items-center gap-2">
          <span id="progress" class="px-2 py-1 rounded-lg text-xs text-slate-700 bg-slate-100">0/0</span>
          <span id="title" class="text-xs text-slate-500"></span>
          <label class="ml-2 flex items-center gap-2 text-xs">
            <input id="preferHardLive" type="checkbox" class="h-4 w-4">
            <span>Ưu tiên ★ trong danh sách</span>
          </label>
          <div class="ml-auto flex gap-2">
            <select id="filterView" class="border rounded-lg px-2 py-1 text-xs">
              <option value="all">Tất cả</option>
              <option value="unanswered">Chưa làm</option>
              <option value="answered">Đã làm</option>
              <option value="hard">Câu ★</option>
            </select>
            <input id="searchBox" class="border rounded-lg px-2 py-1 text-xs" placeholder="Tìm câu hỏi..." />
            <button id="btnPrev" class="px-3 py-2 rounded-lg bg-slate-100 text-sm">← Trước</button>
            <button id="btnNext" class="px-3 py-2 rounded-lg bg-slate-100 text-sm">Sau →</button>
          </div>
        </div>
        <div id="navigator" class="mt-3 grid grid-cols-8 gap-2 text-xs"></div>
      </section>

      <!-- Questions -->
      <section class="mt-3 bg-white rounded-2xl p-3 sm:p-4 shadow-card">
        <div id="questionContainer" class="space-y-4"></div>
      </section>
    </section>

    <!-- ========== EDITOR (Đổi đáp) ========== -->
    <section id="editorSection" class="hidden bg-white rounded-2xl p-4 shadow-card">
      <div class="flex items-center gap-2">
        <h2 class="font-bold text-lg">Soát/Đổi đáp (toàn ngân hàng)</h2>
        <span id="editorCounter" class="text-xs text-slate-500"></span>
        <div class="ml-auto flex gap-2">
          <select id="editorSubject" class="border rounded-lg px-2 py-1 text-xs"></select>
          <input id="editorSearch" class="border rounded-lg px-2 py-1 text-xs" placeholder="Tìm câu..." />
          <button id="btnCloseEditor" class="px-3 py-1.5 rounded-lg bg-slate-100 text-sm">Đóng</button>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-1">Chọn đáp án đúng cho từng câu. Thay đổi được lưu cục bộ và áp dụng cho các lần sau.</p>
      <div id="editorList" class="mt-3 divide-y"></div>
    </section>
  </main>

  <!-- ================== APP SCRIPT ================== -->
  <script>
    // ---------- STATE ----------
    const BANK = [];                                  // tất cả câu hỏi
    const HARD_BANK_KEY = 'quizHardBank';
    const SETUP_KEY     = 'quizSetupPro';
    const OVERRIDE_KEY  = 'quizAnswerOverrides';

    const state = {
      phase: 'setup',                                 // setup | exam | editor
      items: [],
      answers: new Map(),
      hard: new Set(),
      currentIndex: 0,
      submitted: false,
      timeLeft: 0,
      timerId: null,
      setup: { subject:'all', limit:20, minutes:15, shuffleQ:true, shuffleA:true, mode:'exam', resume:false, preferHard:false },
      overrides: {},                                  // id -> correctIndex
      filter: 'all',
      search: '',
      preferHardLive: false                           // ưu tiên ★ trong navigator (không reload)
    };

    // ---------- SHORTCUTS ----------
    const $ = id => document.getElementById(id);
    const els = {
      // setup
      btnBackToSetup: $('btnBackToSetup'),
      setupSection: $('setupSection'), setupSubject: $('setupSubject'),
      setupLimit: $('setupLimit'), setupMinutes: $('setupMinutes'),
      setupShuffleQ: $('setupShuffleQ'), setupShuffleA: $('setupShuffleA'),
      setupMode: $('setupMode'), setupResume: $('setupResume'),
      setupPreferHard: $('setupPreferHard'),
      btnStart: $('btnStart'), bankCount: $('bankCount'), btnClearHard: $('btnClearHard'),
      btnExportOverrides: $('btnExportOverrides'), importOverrides: $('importOverrides'),
      // exam
      examSection: $('examSection'), examHeader: $('examHeader'),
      questionContainer: $('questionContainer'), navigator: $('navigator'),
      progress: $('progress'), title: $('title'), timer: $('timer'),
      btnPrev: $('btnPrev'), btnNext: $('btnNext'),
      btnSubmit: $('btnSubmit'), btnRestart: $('btnRestart'),
      filterView: $('filterView'), searchBox: $('searchBox'), preferHardLive: $('preferHardLive'),
      // editor
      editorSection: $('editorSection'), btnEditor: $('btnEditor'), btnCloseEditor: $('btnCloseEditor'),
      editorSubject: $('editorSubject'), editorList: $('editorList'),
      editorCounter: $('editorCounter'), editorSearch: $('editorSearch'),
    };

    // ---------- UTILS ----------
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const load = (k, def) => { try{ const v = JSON.parse(localStorage.getItem(k)||''); return (v===null || v===undefined)?def:v; }catch{ return def; } };
    function shuffle(a){ for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function fmt(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return m+':'+s; }
    function normalizeVN(s){ return s.normalize('NFD').replace(/\p{M}+/gu,'').toLowerCase().replace(/[“”"'\`’]/g,'').replace(/\s+/g,' ').trim(); }

    // ---------- PARSER (từ TXT) ----------
    function parseTxt(inputText, subject){
      let text = inputText.replace(/\r\n|\r/g, '\n');
      const parts = text.split(/(?=^\s*Câu\s+\d+\s*:)/m).filter(b => /^\s*Câu\s+\d+\s*:/m.test(b));
      const items = [];
      for (const raw of parts){
        const mQ = raw.match(/^\s*Câu\s+(\d+)\s*:\s*([\s\S]*)$/i);
        if(!mQ) continue;
        const qnum = parseInt(mQ[1],10);
        const afterQ = mQ[2];

        const dividerRe = /^\s*Tất\s*cả\s*(?:các\s*)?đáp\s*án\s*:?.*$/mi;
        const mDiv = dividerRe.exec(afterQ);
        const before = mDiv ? afterQ.slice(0, mDiv.index) : afterQ;
        const optionsPart = mDiv ? afterQ.slice(mDiv.index) : "";

        const mAns = before.match(/Đáp\s*án\s*đúng\s*:\s*(.+)/i);
        const explicitCorrect = mAns ? mAns[1].trim() : null;
        const questionText = mAns ? before.slice(0, mAns.index).trim() : before.trim();

        const options = []; let correctIndex = null;
        const rxOpt = /^\s*([A-Z])\.\s*(.+?)\s*$/gmi;
        let m;
        while ((m = rxOpt.exec(optionsPart))){
          let txt = m[2].trim();
          const tick = /[✓✔]/.test(txt);
          txt = txt.replace(/[✓✔]/g,'').replace(/\s*\.\s*$/,'').trim();
          if (txt) options.push(txt);
          if (tick) correctIndex = options.length - 1;
        }
        if (!options.length) continue;

        if (correctIndex === null && explicitCorrect){
          const target = normalizeVN(explicitCorrect);
          for (let i=0;i<options.length;i++){
            const o = normalizeVN(options[i]);
            if (o.startsWith(target) || target.startsWith(o) || o === target){ correctIndex = i; break; }
          }
          if (correctIndex === null){
            const set = s => new Set(s.split(' ').filter(Boolean));
            const interRatio = (a,b) => { const sa = set(normalizeVN(a)), sb = set(normalizeVN(b)); const inter=[...sa].filter(x=>sb.has(x)).length; const union=new Set([...sa,...sb]).size||1; return inter/union; };
            let best=-1, bestI=null;
            for (let i=0;i<options.length;i++){ const r=interRatio(options[i], explicitCorrect); if(r>best){ best=r; bestI=i; } }
            if (bestI!==null && best>=0.35) correctIndex=bestI;
          }
        }
        if (correctIndex === null) continue;

        items.push({ id: subject+'-'+qnum, subject, qnum, question: questionText, options, correctIndex });
      }
      return items.sort((a,b)=>a.qnum-b.qnum);
    }

    // ---------- BOOT ----------
    (function boot(){
      // Lấy text từ data.js
      const textQu = decodeBankFromGzB64(GZ_B64_QU);
      const textPh = decodeBankFromGzB64(GZ_B64_PH);

      // Parse ngân hàng
      BANK.push(...parseTxt(textQu, "Quản trị dự án CNTT"));
      BANK.push(...parseTxt(textPh, "Phát triển ứng dụng Web (Mở nguồn)"));

      // Load hard + overrides
      state.hard = new Set(Object.keys(load(HARD_BANK_KEY, {})));
      state.overrides = load(OVERRIDE_KEY, {});

      buildSetupUI();
      buildEditorUI();
      updateBankCount();
      Swal.fire({icon:'success', title:'Đã nạp '+BANK.length+' câu hỏi', timer:900, showConfirmButton:false});
    })();

    // ---------- SETUP ----------
    function buildSetupUI(){
      const subs = Array.from(new Set(BANK.map(x=>x.subject)));
      els.setupSubject.innerHTML = '<option value="all">Tất cả</option>' + subs.map(s=>'<option>'+s+'</option>').join('');

      const s = load(SETUP_KEY, null);
      if (s) Object.assign(state.setup, s);
      els.setupSubject.value     = state.setup.subject;
      els.setupLimit.value       = state.setup.limit;
      els.setupMinutes.value     = state.setup.minutes;
      els.setupShuffleQ.checked  = state.setup.shuffleQ;
      els.setupShuffleA.checked  = state.setup.shuffleA;
      els.setupMode.value        = state.setup.mode;
      els.setupResume.checked    = state.setup.resume;
      els.setupPreferHard.checked= state.setup.preferHard;

      els.setupSubject.onchange = ()=>{ updateBankCount(); clampLimitToBank(); saveSetup(); };
      [els.setupLimit, els.setupMinutes].forEach(i=> i.oninput = saveSetup);
      [els.setupShuffleQ, els.setupShuffleA, els.setupResume, els.setupPreferHard].forEach(i=> i.onchange = saveSetup);
      els.setupMode.onchange = saveSetup;

      els.btnStart.onclick = startExamFromSetup;
      els.btnClearHard.onclick = ()=>{
        Swal.fire({icon:'warning', title:'Xoá danh sách câu ★ đã lưu?', showCancelButton:true, confirmButtonText:'Xoá', cancelButtonText:'Huỷ'})
          .then(({isConfirmed})=>{ if(isConfirmed){ state.hard = new Set(); save(HARD_BANK_KEY, {}); updateNavigator(); }});
      };
      els.btnExportOverrides.onclick = exportOverrides;
      els.importOverrides.onchange = importOverridesFile;

      els.btnBackToSetup.onclick = returnToSetup;
      els.btnEditor.onclick = openEditor;

      updateBankCount();
    }
    function saveSetup(){
      state.setup = {
        subject: els.setupSubject.value || 'all',
        limit: parseInt(els.setupLimit.value||'1',10) || 1,
        minutes: parseInt(els.setupMinutes.value||'1',10) || 1,
        shuffleQ: !!els.setupShuffleQ.checked,
        shuffleA: !!els.setupShuffleA.checked,
        mode: els.setupMode.value || 'exam',
        resume: !!els.setupResume.checked,
        preferHard: !!els.setupPreferHard.checked,
      };
      save(SETUP_KEY, state.setup);
    }
    function updateBankCount(){
      const subj = els.setupSubject.value || 'all';
      const pool = subj === 'all' ? BANK : BANK.filter(x=>x.subject === subj);
      els.bankCount.textContent = pool.length;
      clampLimitToBank();
    }
    function clampLimitToBank(){
      const max = parseInt(els.bankCount.textContent||'0',10) || 0;
      els.setupLimit.value = Math.max(1, Math.min(parseInt(els.setupLimit.value||'1',10)||1, Math.max(1,max)));
    }

    // ---------- START EXAM ----------
    function startExamFromSetup(){
      saveSetup();
      let pool = (state.setup.subject==='all') ? BANK.slice() : BANK.filter(x=>x.subject===state.setup.subject);
      pool = pool.map(it => (state.overrides[it.id]!==undefined ? {...it, correctIndex: state.overrides[it.id]} : it));
      if (state.setup.preferHard){
        const hard = pool.filter(x=>state.hard.has(x.id));
        const rest = pool.filter(x=>!state.hard.has(x.id));
        pool = hard.concat(rest);
      }
      if (state.setup.shuffleQ) shuffle(pool);
      const limit = Math.max(1, Math.min(state.setup.limit, pool.length));
      const selected = pool.slice(0, limit);

      state.items = selected.map(it=>{
        const order = it.options.map((_,i)=>i);
        if (state.setup.shuffleA) shuffle(order);
        const options = order.map(i=>it.options[i]);
        const correctIndex = order.indexOf(it.correctIndex);
        return {...it, options, correctIndex};
      });

      state.answers = new Map();
      state.currentIndex = 0;
      state.submitted = false;
      state.timeLeft = state.setup.minutes * 60;
      if (state.timerId) clearInterval(state.timerId);
      tick(); state.timerId = setInterval(tick, 1000);

      els.setupSection.classList.add('hidden');
      els.editorSection.classList.add('hidden');
      els.examSection.classList.remove('hidden');
      els.examHeader.classList.remove('hidden');
      state.phase = 'exam';

      attachExamHandlersOnce();
      renderAll();
      Swal.fire({icon:'success', title:'Bắt đầu làm bài', timer:900, showConfirmButton:false});
    }
    function returnToSetup(){
      if (state.timerId) clearInterval(state.timerId);
      state.timerId = null;
      state.phase = 'setup';
      els.examSection.classList.add('hidden');
      els.examHeader.classList.add('hidden');
      els.setupSection.classList.remove('hidden');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // ---------- EXAM RENDER ----------
    function attachExamHandlersOnce(){
      if (attachExamHandlersOnce.done) return; attachExamHandlersOnce.done = true;

      els.btnPrev.onclick = ()=> jumpTo(state.currentIndex-1);
      els.btnNext.onclick = ()=> jumpTo(state.currentIndex+1);
      els.btnSubmit.onclick = manualSubmit;
      els.btnRestart.onclick = ()=> Swal.fire({icon:'question', title:'Thoát về thiết lập?', showCancelButton:true, confirmButtonText:'Đồng ý', cancelButtonText:'Huỷ'}).then(({isConfirmed})=>{ if (isConfirmed) returnToSetup(); });
      els.filterView.onchange = ()=>{ state.filter = els.filterView.value; updateNavigator(); };
      els.searchBox.oninput  = ()=>{ state.search = els.searchBox.value; updateNavigator(); };
      els.preferHardLive.onchange = ()=>{ state.preferHardLive = els.preferHardLive.checked; updateNavigator(); }; // ưu tiên ★ không reload

      // Editor
      els.btnEditor.onclick = openEditor;
      els.btnCloseEditor.onclick = closeEditor;
      els.editorSubject.onchange = renderEditorList;
      els.editorSearch.oninput = renderEditorList;
    }

    function renderAll(){
      els.title.textContent = (state.setup.subject==='all'?'Tất cả môn':state.setup.subject) + ' • ' + state.items.length + ' câu • ' + (state.setup.mode==='exam'?'Kiểm tra':'Luyện tập');
      updateNavigator();
      els.questionContainer.innerHTML = '';
      const frag = document.createDocumentFragment();
      state.items.forEach((item, displayIdx)=>{
        const card = document.createElement('div');
        card.id = 'q-' + displayIdx;
        card.className = 'border rounded-xl p-3';

        const head = document.createElement('div');
        head.className = 'flex items-start justify-between gap-2';
        const left = document.createElement('div');
        left.className = 'font-semibold text-slate-800';
        left.textContent = 'Câu ' + (displayIdx+1);
        const right = document.createElement('div');
        right.className = 'flex items-center gap-3';
        const star = document.createElement('button');
        star.className = 'text-lg ' + (state.hard.has(item.id) ? 'text-yellow-500' : 'text-slate-300');
        star.title = 'Đánh dấu câu khó'; star.setAttribute('aria-label','Đánh dấu câu khó'); star.textContent = '★';
        const meta = document.createElement('div'); meta.className='text-[11px] text-slate-500'; meta.textContent = '#'+item.qnum;
        right.appendChild(star); right.appendChild(meta);
        head.appendChild(left); head.appendChild(right);
        card.appendChild(head);

        const qt = document.createElement('div'); qt.className='mt-1 text-slate-800 text-sm'; qt.textContent = item.question; card.appendChild(qt);

        const opts = document.createElement('div'); opts.className='mt-2 space-y-2';
        item.options.forEach((txt, optIdx)=>{
          const id = item.id + '-' + displayIdx + '-opt-' + optIdx;
          const wrap = document.createElement('div'); wrap.className='option';
          const input = document.createElement('input'); input.type='radio'; input.id=id; input.name='q-'+displayIdx; input.value=String(optIdx);
          if (state.answers.get(item.id)===optIdx) input.checked = true;
          if (state.submitted) input.disabled = true;
          const label = document.createElement('label'); label.setAttribute('for', id); label.className='hover:bg-slate-50 text-sm'; label.textContent = txt;

          input.addEventListener('change', ()=>{
            state.answers.set(item.id, optIdx);
            updateProgress(); updateNavigator();
            if (state.setup.mode==='practice'){
              const res = document.getElementById('res-'+displayIdx);
              const ok = optIdx===item.correctIndex;
              res.classList.remove('hidden');
              res.textContent = ok ? 'Chính xác ✓' : 'Sai. Đáp án đúng: ' + item.options[item.correctIndex];
              res.classList.toggle('text-emerald-700', ok);
              res.classList.toggle('text-rose-700', !ok);
            }
          });

          if (state.submitted) wrap.classList.add('locked');
          wrap.appendChild(input); wrap.appendChild(label); opts.appendChild(wrap);
        });
        card.appendChild(opts);

        const res = document.createElement('div'); res.id='res-'+displayIdx; res.className='mt-2 hidden text-sm'; card.appendChild(res);

        star.addEventListener('click', (e)=>{
          e.preventDefault();
          if (state.hard.has(item.id)) state.hard.delete(item.id); else state.hard.add(item.id);
          const obj={}; state.hard.forEach(id=>obj[id]=true); save(HARD_BANK_KEY, obj);
          updateNavigator(); // sắp xếp navigator theo ưu tiên ★ ngay, không reload
          star.className = 'text-lg ' + (state.hard.has(item.id) ? 'text-yellow-500' : 'text-slate-300');
        });

        frag.appendChild(card);
      });
      els.questionContainer.appendChild(frag);
      updateProgress();
      jumpTo(0, false);
    }

    function filteredIndices(){
      const list = [...state.items.keys()];
      const q = normalizeVN(state.search||'');
      let res = list.filter(i=>{
        const it = state.items[i];
        if (state.filter==='answered' && !state.answers.has(it.id)) return false;
        if (state.filter==='unanswered' && state.answers.has(it.id)) return false;
        if (state.filter==='hard' && !state.hard.has(it.id)) return false;
        if (q){
          const hay = normalizeVN(it.question + ' ' + it.options.join(' '));
          if (!hay.includes(q)) return false;
        }
        return true;
      });
      if (state.preferHardLive){ // ưu tiên ★ chỉ đổi thứ tự navigator
        const a = res.filter(i=>state.hard.has(state.items[i].id));
        const b = res.filter(i=>!state.hard.has(state.items[i].id));
        res = a.concat(b);
      }
      return res;
    }

    function updateNavigator(){
      els.navigator.innerHTML = '';
      const idxs = filteredIndices();
      idxs.forEach((displayIdx)=>{
        const it = state.items[displayIdx];
        const answered = state.answers.has(it.id);
        const hard = state.hard.has(it.id);
        let cls = 'nav-btn-default';
        if (hard) cls='nav-btn-hard';
        if (answered) cls='nav-btn-answered';
        if (state.submitted) cls = (state.answers.get(it.id)===it.correctIndex) ? 'nav-btn-correct':'nav-btn-wrong';
        const b = document.createElement('button');
        b.className = 'rounded-lg py-1 text-center border text-xs '+cls;
        b.textContent = String(displayIdx+1);
        b.onclick = ()=> jumpTo(displayIdx);
        els.navigator.appendChild(b);
      });
    }

    function updateProgress(){
      const total = state.items.length;
      const answered = state.items.reduce((n,it)=> n + (state.answers.has(it.id)?1:0), 0);
      els.progress.textContent = answered + '/' + total;
    }

    function jumpTo(idx, smooth=true){
      idx = Math.max(0, Math.min(idx, state.items.length-1));
      state.currentIndex = idx;
      const el = document.getElementById('q-'+idx);
      if (!el) return;
      el.classList.add('pulse-ring');
      el.scrollIntoView({behavior: smooth?'smooth':'auto', block:'start'});
      setTimeout(()=> el.classList.remove('pulse-ring'), 800);
    }

    // ---------- TIMER & SUBMIT ----------
    function tick(){
      els.timer.textContent = fmt(state.timeLeft);
      if (state.timeLeft <= 0){ if (state.timerId) clearInterval(state.timerId); autoSubmitOnTimeout(); return; }
      state.timeLeft -= 1;
    }
    function getUnansweredIndices(){ const miss=[]; state.items.forEach((it,i)=>{ if(!state.answers.has(it.id)) miss.push(i); }); return miss; }
    function manualSubmit(){
      const miss = getUnansweredIndices();
      if (miss.length){
        const preview = miss.slice(0,30).map(i=>i+1).join(', ') + (miss.length>30?'...':'');
        Swal.fire({icon:'warning', title:'Còn '+miss.length+' câu chưa làm', html:'Bạn cần trả lời hết trước khi nộp.<br/><small>Câu: '+preview+'</small>', confirmButtonText:'Đến câu chưa làm'})
          .then(()=> jumpTo(miss[0]));
        return;
      }
      gradeAndShow();
    }
    function autoSubmitOnTimeout(){ gradeAndShow(true); }
    function gradeAndShow(fromTimeout=false){
      state.submitted = true;
      if (state.timerId){ clearInterval(state.timerId); state.timerId=null; }

      let correct=0;
      state.items.forEach((it,i)=>{
        const chosen = state.answers.get(it.id);
        const ok = chosen===it.correctIndex;
        if (ok) correct++;
        const card = document.getElementById('q-'+i);
        const res  = document.getElementById('res-'+i);
        if (card){
          card.classList.add(ok ? 'bg-emerald-50' : 'bg-rose-50');
          card.querySelectorAll('input[type="radio"]').forEach(x=>x.disabled=true);
          card.querySelectorAll('.option').forEach(d=>d.classList.add('locked'));
        }
        if (res){
          res.classList.remove('hidden');
          res.textContent = ok ? 'Chính xác ✓' : 'Sai. Đáp án đúng: ' + it.options[it.correctIndex];
          res.classList.toggle('text-emerald-700', ok);
          res.classList.toggle('text-rose-700', !ok);
        }
      });
      updateNavigator();

      const total = state.items.length;
      const score = Math.round(correct/total*100);
      Swal.fire({
        icon: score>=50 ? 'success' : 'error',
        title: (fromTimeout?'Hết giờ — Điểm ':'Nộp bài — Điểm ')+score+'/100',
        html: '<div class="space-y-1 text-left">'
              + '<div><b>Đúng:</b> '+correct+'/'+total+'</div>'
              + '<div><b>Tỷ lệ đúng:</b> '+score+'%</div>'
              + '<div class="text-slate-500 text-xs">Lựa chọn đã bị khoá để tránh bấm nhầm khi xem đáp án.</div>'
              + '</div>',
        confirmButtonText:'Đóng'
      });
    }

    // ---------- EDITOR (Đổi đáp) ----------
    function buildEditorUI(){
      const subs = Array.from(new Set(BANK.map(x=>x.subject)));
      els.editorSubject.innerHTML = '<option value="all">Tất cả</option>' + subs.map(s=>'<option>'+s+'</option>').join('');
    }
    function openEditor(){
      els.setupSection.classList.add('hidden');
      els.examSection.classList.add('hidden');
      els.editorSection.classList.remove('hidden');
      renderEditorList();
    }
    function closeEditor(){
      els.editorSection.classList.add('hidden');
      els.setupSection.classList.remove('hidden');
    }
    els.btnCloseEditor.onclick = closeEditor;
    els.editorSubject.onchange = renderEditorList;
    els.editorSearch.oninput = renderEditorList;

    function renderEditorList(){
      const subj = els.editorSubject.value || 'all';
      const q = normalizeVN(els.editorSearch.value||'');
      let arr = BANK.slice();
      if (subj!=='all') arr = arr.filter(x=>x.subject===subj);
      if (q) arr = arr.filter(x => normalizeVN(x.question+' '+x.options.join(' ')).includes(q));
      els.editorCounter.textContent = '• '+arr.length+' câu';
      els.editorList.innerHTML='';
      const frag = document.createDocumentFragment();
      arr.forEach(it=>{
        const row = document.createElement('div'); row.className='py-3';
        const title = document.createElement('div'); title.className='text-sm font-semibold text-slate-800 flex items-center justify-between';
        title.textContent = '#'+it.qnum+' — '+it.question;
        const small = document.createElement('span'); small.className='ml-2 text-[11px] text-slate-500'; small.textContent = it.subject; title.appendChild(small);
        row.appendChild(title);

        const opts = document.createElement('div'); opts.className='mt-2 grid grid-cols-1 gap-1';
        const currentCI = (state.overrides[it.id]!==undefined) ? state.overrides[it.id] : it.correctIndex;
        it.options.forEach((txt, idx)=>{
          const id = 'ed-'+it.id+'-'+idx;
          const label = document.createElement('label'); label.className='flex items-center gap-2 text-sm cursor-pointer';
          const radio = document.createElement('input'); radio.type='radio'; radio.name='ed-'+it.id; radio.id=id; radio.value=String(idx); radio.checked = idx===currentCI;
          const span = document.createElement('span'); span.textContent = txt;
          label.appendChild(radio); label.appendChild(span);
          radio.addEventListener('change', ()=>{
            state.overrides[it.id] = idx;
            save(OVERRIDE_KEY, state.overrides);
            Swal.fire({icon:'success', title:'Đã đổi đáp câu #'+it.qnum, timer:800, showConfirmButton:false});
          });
          opts.appendChild(label);
        });
        row.appendChild(opts);
        frag.appendChild(row);
      });
      els.editorList.appendChild(frag);
    }
    function exportOverrides(){
      const data = JSON.stringify(state.overrides, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='quiz_answer_overrides.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    }
    function importOverridesFile(e){
      const f = e.target.files?.[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const obj = JSON.parse(r.result);
          if (typeof obj !== 'object') throw 0;
          state.overrides = obj; save(OVERRIDE_KEY, state.overrides);
          Swal.fire({icon:'success', title:'Đã nhập file đổi đáp', timer:900, showConfirmButton:false});
        }catch{ Swal.fire({icon:'error', title:'File không hợp lệ'}); }
      };
      r.readAsText(f, 'utf-8');
    }

    // ---------- INIT after data.js loaded ----------
    (function initAfterData(){
      try{
        const _ = decodeBankFromGzB64(GZ_B64_QU);
      }catch(e){
        console.error(e);
        Swal.fire({icon:'error', title:'Không đọc được ngân hàng câu hỏi (data.js). Kiểm tra đường dẫn.'});
      }
    })();
  </script>
</body>
</html>
