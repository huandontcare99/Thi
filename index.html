<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>√în luy·ªán tr·∫Øc nghi·ªám ‚Äì mobile first</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',
              500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81'
            }
          }
        }
      }
    }
  </script>

  <!-- Small fixes for mobile/tablet -->
  <style>
    *{-webkit-tap-highlight-color:rgba(0,0,0,0)}
    html,body{height:100%}
    button:active{transform:translateY(.5px)}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}
    .fade-in{animation:fade .25s ease}
    @keyframes fade{from{opacity:.0;transform:translateY(2px)}to{opacity:1;transform:none}}
  </style>
</head>
<body class="bg-slate-50 text-slate-900 selection:bg-brand-200 selection:text-slate-900">

  <!-- HEADER (nh·∫π, kh√¥ng che m√†n) -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-3 py-2">
      <div class="flex items-center justify-between gap-3">
        <h1 class="text-base sm:text-lg font-semibold tracking-tight">√în luy·ªán tr·∫Øc nghi·ªám</h1>
        <nav class="flex items-center gap-2">
          <button id="navHome" class="text-xs sm:text-sm px-3 py-1 rounded-lg border border-slate-300 hover:bg-slate-100">Trang ch·ªß</button>
          <button id="navFlash" class="text-xs sm:text-sm px-3 py-1 rounded-lg border border-slate-300 hover:bg-slate-100">Flashcards</button>
        </nav>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-4xl mx-auto p-3 pb-24 space-y-4">

    <!-- Alert -->
    <div id="alert" class="hidden mb-2 p-3 rounded-lg border text-sm"></div>

    <!-- VIEW: SETUP -->
    <section id="view-setup" class="fade-in space-y-4">
      <div class="rounded-2xl bg-white shadow-sm border border-slate-200 p-4">
        <h2 class="text-base font-semibold mb-3">Thi·∫øt l·∫≠p</h2>

        <!-- Form ch·ªçn nhanh ‚Äì mobile first, kh√¥ng ƒë√® nhau -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="block">
            <span class="block text-sm mb-1">M√¥n</span>
            <select id="selSubject" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-400">
              <option value="">ƒêang n·∫°p d·ªØ li·ªáu‚Ä¶</option>
            </select>
          </label>

          <label class="block">
            <span class="block text-sm mb-1">Ch·∫ø ƒë·ªô</span>
            <select id="selMode" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-400">
              <option value="practice">Luy·ªán t·∫≠p</option>
              <option value="exam">Thi (ƒë·∫øm gi·ªù)</option>
            </select>
          </label>

          <label class="block">
            <span class="block text-sm mb-1">S·ªë c√¢u</span>
            <select id="selCount" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-400">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="all">T·∫•t c·∫£</option>
            </select>
          </label>

          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2">
              <input id="chkShuffleQ" type="checkbox" class="w-5 h-5 rounded border-slate-300 text-brand-600 focus:ring-brand-400" checked>
              <span class="text-sm">X√°o c√¢u</span>
            </label>
            <label class="flex items-center gap-2">
              <input id="chkShuffleA" type="checkbox" class="w-5 h-5 rounded border-slate-300 text-brand-600 focus:ring-brand-400" checked>
              <span class="text-sm">X√°o ƒë√°p √°n</span>
            </label>
          </div>
        </div>

        <div class="mt-4 flex items-center gap-2">
          <button id="btnStart" class="flex-1 px-4 py-3 rounded-xl bg-brand-600 text-white font-medium active:scale-[.985] hover:bg-brand-700">B·∫Øt ƒë·∫ßu</button>
          <button id="btnQuick" class="px-4 py-3 rounded-xl border border-slate-300 font-medium hover:bg-slate-100 active:scale-[.985]">Test nhanh 10 c√¢u</button>
        </div>
      </div>

      <div class="rounded-2xl bg-white shadow-sm border border-slate-200 p-4 text-sm text-slate-600">
        M·∫πo: ‚ÄúLuy·ªán t·∫≠p‚Äù xem ƒë√°p √°n ƒë√∫ng ngay khi n·ªôp; ‚ÄúThi‚Äù s·∫Ω c√≥ ƒë·∫øm gi·ªù & ch·∫•m sau c√πng.
      </div>
    </section>

    <!-- VIEW: QUIZ -->
    <section id="view-quiz" class="hidden fade-in space-y-3">
      <!-- Thanh ti·∫øn tr√¨nh + th·ªùi gian -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="flex items-center justify-between text-sm mb-2">
          <div id="quizMeta" class="font-medium">--</div>
          <div id="timer" class="tabular-nums text-slate-600">--:--</div>
        </div>
        <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
          <div id="progressBar" class="h-2 bg-brand-500 w-0"></div>
        </div>
      </div>

      <!-- Card c√¢u h·ªèi -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div id="qTitle" class="text-base font-semibold mb-2">‚Äî</div>
        <div id="qText" class="text-[15px] leading-relaxed mb-3">‚Äî</div>

        <div id="qOptions" class="space-y-2"></div>

        <div class="mt-4 flex items-center gap-2">
          <button id="btnPrev" class="flex-1 px-3 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.985]">‚Üê Tr∆∞·ªõc</button>
          <button id="btnShuffleOne" class="px-3 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.985]">üîÄ ƒë√°p √°n</button>
          <button id="btnNext" class="flex-1 px-3 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.985]">Sau ‚Üí</button>
        </div>

        <div class="mt-3">
          <button id="btnSubmit" class="w-full px-4 py-3 rounded-xl bg-brand-600 text-white font-medium hover:bg-brand-700 active:scale-[.985]">N·ªôp b√†i</button>
        </div>
      </div>
    </section>

    <!-- VIEW: RESULT -->
    <section id="view-result" class="hidden fade-in space-y-4">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <h2 class="text-base font-semibold mb-2">K·∫øt qu·∫£</h2>
        <div id="scoreLine" class="text-[15px] mb-2">‚Äî</div>
        <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
          <div id="scoreBar" class="h-2 bg-brand-500 w-0"></div>
        </div>
        <div class="mt-3 flex items-center gap-2">
          <button id="btnReviewWrong" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-100 active:scale-[.985]">√în c√¢u sai</button>
          <button id="btnRestart" class="flex-1 px-4 py-2.5 rounded-xl bg-brand-600 text-white hover:bg-brand-700 active:scale-[.985]">L√†m l·∫°i</button>
        </div>
      </div>

      <div id="wrongList" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 hidden">
        <h3 class="text-base font-semibold mb-3">C√¢u sai</h3>
        <div id="wrongItems" class="space-y-4"></div>
      </div>
    </section>

    <!-- VIEW: FLASHCARDS -->
    <section id="view-flash" class="hidden fade-in space-y-3">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
        <div class="flex flex-col sm:flex-row sm:items-end gap-2 sm:gap-3">
          <div class="flex-1">
            <label class="block text-sm mb-1">Ngu·ªìn th·∫ª</label>
            <select id="flashSource" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white focus:outline-none focus:ring-2 focus:ring-brand-400">
              <option value="all">T·∫•t c·∫£ c√¢u c·ªßa m√¥n hi·ªán t·∫°i</option>
              <option value="wrong">Ch·ªâ c√°c c√¢u sai g·∫ßn nh·∫•t</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button id="flashShuffle" class="px-3 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-100">üîÄ X√°o</button>
            <button id="flashPrev" class="px-3 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-100">‚Üê</button>
            <button id="flashNext" class="px-3 py-2.5 rounded-xl border border-slate-300 hover:bg-slate-100">‚Üí</button>
          </div>
        </div>
      </div>

      <div id="flashCard" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 text-center">
        <div id="flashMeta" class="text-sm text-slate-600 mb-2">‚Äî</div>
        <div id="flashQ" class="text-base font-semibold mb-3">‚Äî</div>
        <button id="flashReveal" class="mx-auto px-4 py-2.5 rounded-xl bg-brand-600 text-white hover:bg-brand-700">Hi·ªán ƒë√°p √°n</button>
        <div id="flashA" class="hidden mt-3 text-[15px] leading-relaxed"></div>
      </div>
    </section>

  </main>

  <!-- MUST load data.js BEFORE app script -->
  <script src="data.js"></script>

  <!-- APP -->
  <script>
  (() => {
    // ===== Shortcuts =====
    const $ = (s)=>document.querySelector(s);
    const byId = (id)=>document.getElementById(id);
    const alertBox = byId('alert');

    const showAlert=(msg,type='info')=>{
      const base='mb-2 p-3 rounded-lg border text-sm';
      const style= type==='error' ? 'bg-red-50 border-red-200 text-red-700'
                  : type==='success' ? 'bg-emerald-50 border-emerald-200 text-emerald-700'
                  : 'bg-slate-50 border-slate-200 text-slate-700';
      alertBox.className= base+' '+style;
      alertBox.textContent = msg;
      alertBox.classList.remove('hidden');
      clearTimeout(showAlert._t); showAlert._t=setTimeout(()=>alertBox.classList.add('hidden'),3000);
    };

    const shuffle=(arr)=>{const a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a;};
    const escapeHTML=(s)=>String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const deAccent=(s)=> s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const norm=(s)=> deAccent(String(s||'')).replace(/\s+/g,' ').replace(/[^\p{L}\p{N}]+/gu,'').toLowerCase().trim();

    // ===== State =====
    const S = {
      subjects: [],
      raw: new Map(),        // subject -> raw text
      questions: [],         // current working set
      current: 0,
      answers: new Map(),    // qIndex -> k (index in shuffled order)
      ansOrder: new Map(),   // qIndex -> [permutation]
      mode: 'practice',
      timerId: null,
      timerSec: 0,
      lastWrongKey: '',      // for flashcards
    };

    // ===== Views =====
    const V = {
      setup: byId('view-setup'),
      quiz: byId('view-quiz'),
      result: byId('view-result'),
      flash: byId('view-flash'),
    };
    function showView(name){
      V.setup.classList.toggle('hidden', name!=='setup');
      V.quiz.classList.toggle('hidden', name!=='quiz');
      V.result.classList.toggle('hidden', name!=='result');
      V.flash.classList.toggle('hidden', name!=='flash');
    }

    // ===== Parse =====
    function parseQuestions(raw){
      if(!raw||typeof raw!=='string') return [];
      raw = raw.replace(/\r\n/g,'\n');

      const blocks = raw.match(/C√¢u\s+\d+:[\s\S]*?(?=\n[-=]{5,}\n|$)/g) || [];
      const items = [];

      for(const block of blocks){
        const m = block.match(/C√¢u\s+\d+:\s*([\s\S]*?)\nƒê√°p √°n ƒë√∫ng:\s*([\s\S]*?)(?:\n|$)/);
        if(!m) continue;
        const qText = m[1].trim();
        const correctText = m[2].trim();

        const optionsArea = (block.match(/T·∫•t c·∫£ ƒë√°p √°n:\s*([\s\S]*)$/) || [,''])[1];
        const optMatches = [...optionsArea.matchAll(/^\s*([A-D])\.\s*(?:[‚úì\u2713]\s*)?(.+?)\s*$/gm)];
        const options = optMatches.map(mm => mm[2].trim());
        if(options.length<2) continue;

        // correct by ‚úì mark
        let correctIndex = -1;
        const marked = [...optionsArea.matchAll(/^\s*([A-D])\.\s*[‚úì\u2713]/gm)][0];
        if(marked){ correctIndex = 'ABCD'.indexOf(marked[1]); }

        // fallback by comparing text
        if(correctIndex<0){
          const target = norm(correctText);
          correctIndex = options.findIndex(o=>{
            const no = norm(o);
            return no===target || no.includes(target) || target.includes(no);
          });
        }
        if(correctIndex<0) correctIndex = 0;

        items.push({ text:qText, options, correctIndex, correctText });
      }
      return items;
    }

    // ===== Progress & Timer =====
    const quizMeta = byId('quizMeta');
    const progressBar = byId('progressBar');
    const timerEl = byId('timer');

    function renderProgress(){
      const total = S.questions.length;
      const answered = S.answers.size;
      const pct = Math.round((answered/Math.max(total,1))*100);
      progressBar.style.width = pct+'%';
      quizMeta.textContent = `C√¢u ${S.current+1}/${total}`;
    }

    function startTimer(minutes = Math.max(10, Math.ceil(S.questions.length/2)) ){
      stopTimer();
      S.timerSec = minutes*60;
      renderTimer();
      S.timerId = setInterval(()=>{
        S.timerSec--;
        renderTimer();
        if(S.timerSec<=0){ stopTimer(); submitQuiz(); }
      },1000);
    }
    function stopTimer(){ if(S.timerId) clearInterval(S.timerId); S.timerId=null; }
    function renderTimer(){
      const s = Math.max(0, S.timerSec);
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      timerEl.textContent = S.mode==='exam' ? `${mm}:${ss}` : '--:--';
    }

    // ===== Quiz Render =====
    const qTitle = byId('qTitle');
    const qText = byId('qText');
    const qOptions = byId('qOptions');

    function ensureAnsOrder(idx, allowShuffle){
      if(!S.ansOrder.has(idx)){
        const n = S.questions[idx].options.length;
        const base = Array.from({length:n},(_,i)=>i);
        S.ansOrder.set(idx, allowShuffle ? shuffle(base) : base);
      }
      return S.ansOrder.get(idx);
    }

    function renderQuestion(){
      const i = S.current, total=S.questions.length;
      const q = S.questions[i]; if(!q) return;

      qTitle.textContent='Ch·ªçn ƒë√°p √°n ƒë√∫ng:';
      qText.textContent=q.text;

      const order = ensureAnsOrder(i, byId('chkShuffleA').checked);
      const chosen = S.answers.get(i);

      qOptions.innerHTML='';
      order.forEach((optIdx,k)=>{
        const id = `q${i}_o${k}`;
        const checked = chosen===k;
        const label = document.createElement('label');
        label.className = [
          'block rounded-xl border p-3 transition',
          checked ? 'border-brand-400 ring-2 ring-brand-300 bg-brand-50' : 'border-slate-300 hover:bg-slate-50'
        ].join(' ');
        label.innerHTML = `
          <div class="flex items-start gap-3">
            <input type="radio" name="q${i}" id="${id}" class="mt-1 w-5 h-5 text-brand-600 border-slate-300 focus:ring-brand-400"
                   ${checked?'checked':''} data-k="${k}">
            <div class="text-[15px] leading-relaxed">${escapeHTML(q.options[optIdx])}</div>
          </div>
        `;
        qOptions.appendChild(label);
      });

      renderProgress();
    }

    // ===== Start / Submit / Result =====
    function startQuiz(quick=false){
      const subj = byId('selSubject').value;
      if(!subj || !S.raw.has(subj)) { showAlert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu g·ªëc. H√£y gi·ªØ nguy√™n data.js v√† ch·ªçn m√¥n.', 'error'); return; }
      S.mode = byId('selMode').value;

      let qs = parseQuestions(S.raw.get(subj));
      if(!qs.length){ showAlert('Kh√¥ng tr√≠ch xu·∫•t ƒë∆∞·ª£c c√¢u h·ªèi t·ª´ d·ªØ li·ªáu.', 'error'); return; }

      // s·ªë c√¢u
      let need = byId('selCount').value==='all' ? qs.length : Number(byId('selCount').value||10);
      need = Math.min(need, qs.length);

      if(byId('chkShuffleQ').checked || quick) qs = shuffle(qs);
      S.questions = qs.slice(0, need);

      S.current=0; S.answers.clear(); S.ansOrder.clear();

      showView('quiz');
      renderQuestion();

      if(S.mode==='exam') startTimer(); else { stopTimer(); renderTimer(); }
      showAlert('B·∫Øt ƒë·∫ßu l√†m b√†i. Ch√∫c b·∫°n l√†m t·ªët!','success');
    }

    function submitQuiz(){
      stopTimer();
      const total = S.questions.length;
      let correct=0; const wrong=[];
      for(let i=0;i<total;i++){
        const q = S.questions[i];
        const order = ensureAnsOrder(i,false);
        const chosenK = S.answers.get(i);
        const chosenReal = typeof chosenK==='number' ? order[chosenK] : -1;
        if(chosenReal===q.correctIndex) correct++;
        else wrong.push({i,q,chosenK,order});
      }

      // k·∫øt qu·∫£
      const pct = Math.round((correct/Math.max(total,1))*100);
      byId('scoreLine').textContent = `ƒê√∫ng ${correct}/${total} c√¢u (${pct}%).`;
      byId('scoreBar').style.width = pct+'%';

      // l∆∞u wrong v√†o localStorage cho flashcards
      try{
        const subj = byId('selSubject').value;
        const key = 'wrong_'+norm(subj);
        S.lastWrongKey = key;
        const pack = wrong.map(({q})=>({t:q.text, a:q.options[q.correctIndex]}));
        localStorage.setItem(key, JSON.stringify(pack));
      }catch(e){}

      // render danh s√°ch sai
      const box = byId('wrongList');
      const wrap = byId('wrongItems'); wrap.innerHTML='';
      if(wrong.length){
        box.classList.remove('hidden');
        wrong.forEach(({i,q,chosenK,order})=>{
          const chosenReal = typeof chosenK==='number' ? order[chosenK] : -1;
          const chosenText = chosenReal>=0 ? q.options[chosenReal] : '(ch∆∞a ch·ªçn)';
          const correctText = q.options[q.correctIndex];

          const div = document.createElement('div');
          div.className='border border-slate-200 rounded-xl p-3';
          div.innerHTML = `
            <div class="text-sm font-medium mb-1">C√¢u ${i+1}</div>
            <div class="text-[15px] mb-2">${escapeHTML(q.text)}</div>
            <div class="text-sm"><span class="font-medium text-red-600">B·∫°n ch·ªçn:</span> ${escapeHTML(chosenText)}</div>
            <div class="text-sm"><span class="font-medium text-emerald-700">ƒê√°p √°n ƒë√∫ng:</span> ${escapeHTML(correctText)}</div>
          `;
          wrap.appendChild(div);
        });
      }else{
        box.classList.add('hidden');
      }

      showView('result');
      showAlert('ƒê√£ ch·∫•m b√†i. K√©o xu·ªëng ƒë·ªÉ xem c√°c c√¢u sai (n·∫øu c√≥).','success');
    }

    // ===== Flashcards =====
    let FC = { list:[], idx:0 };
    function loadFlashcards(){
      const subj = byId('selSubject').value;
      if(!subj || !S.raw.has(subj)){ showAlert('Ch∆∞a ch·ªçn m√¥n cho flashcards.','error'); return; }

      const src = byId('flashSource').value;
      let list=[];
      if(src==='wrong'){
        try{
          const key = S.lastWrongKey || 'wrong_'+norm(subj);
          list = JSON.parse(localStorage.getItem(key)||'[]');
        }catch(e){ list=[]; }
      }
      if(!list.length){
        // l·∫•y t·∫•t c·∫£ c√¢u c·ªßa m√¥n
        const all = parseQuestions(S.raw.get(subj));
        list = all.map(q=>({t:q.text, a:q.options[q.correctIndex]}));
      }
      FC.list = list; FC.idx=0;
      renderFlash();
    }
    function renderFlash(){
      const n = FC.list.length;
      if(!n){ byId('flashMeta').textContent='Kh√¥ng c√≥ th·∫ª.'; byId('flashQ').textContent='‚Äî'; byId('flashA').classList.add('hidden'); byId('flashA').textContent=''; return; }
      const cur = FC.list[FC.idx];
      byId('flashMeta').textContent = `Th·∫ª ${FC.idx+1}/${n}`;
      byId('flashQ').textContent = cur.t;
      byId('flashA').textContent = cur.a;
      byId('flashA').classList.add('hidden');
    }

    // ===== Bindings =====
    function bind(){
      // quiz options (delegation)
      byId('qOptions').addEventListener('change', (e)=>{
        const input = e.target.closest('input[type=radio]');
        if(!input) return;
        const k = Number(input.dataset.k);
        S.answers.set(S.current, k);
        renderQuestion();
      });

      byId('btnPrev').addEventListener('click', ()=>{ S.current=Math.max(0,S.current-1); renderQuestion(); });
      byId('btnNext').addEventListener('click', ()=>{ S.current=Math.min(S.questions.length-1,S.current+1); renderQuestion(); });
      byId('btnShuffleOne').addEventListener('click', ()=>{ S.ansOrder.delete(S.current); renderQuestion(); });
      byId('btnSubmit').addEventListener('click', submitQuiz);

      byId('btnStart').addEventListener('click', ()=>startQuiz(false));
      byId('btnQuick').addEventListener('click', ()=>{ byId('selCount').value='10'; startQuiz(true); });

      byId('btnRestart').addEventListener('click', ()=>{ showView('setup'); window.scrollTo({top:0,behavior:'smooth'}); });
      byId('btnReviewWrong').addEventListener('click', ()=> byId('wrongList').classList.toggle('hidden'));

      // nav
      byId('navHome').addEventListener('click', ()=>{ stopTimer(); showView('setup'); });
      byId('navFlash').addEventListener('click', ()=>{ stopTimer(); showView('flash'); loadFlashcards(); });

      // flashcards
      byId('flashSource').addEventListener('change', loadFlashcards);
      byId('flashShuffle').addEventListener('click', ()=>{ FC.list = shuffle(FC.list); FC.idx=0; renderFlash(); });
      byId('flashPrev').addEventListener('click', ()=>{ if(!FC.list.length) return; FC.idx=(FC.idx-1+FC.list.length)%FC.list.length; renderFlash(); });
      byId('flashNext').addEventListener('click', ()=>{ if(!FC.list.length) return; FC.idx=(FC.idx+1)%FC.list.length; renderFlash(); });
      byId('flashReveal').addEventListener('click', ()=> byId('flashA').classList.toggle('hidden'));
    }

    // ===== Init =====
    function init(){
      bind();
      if(!window.quizData || typeof window.quizData.getAll!=='function'){
        showAlert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu g·ªëc (window.quizData). H√£y gi·ªØ nguy√™n data.js v√† load tr∆∞·ªõc app.', 'error');
        byId('btnStart').disabled = true; byId('btnQuick').disabled = true;
        return;
      }
      const all = window.quizData.getAll();
      if(!Array.isArray(all)||!all.length){ showAlert('Danh s√°ch m√¥n r·ªóng trong data.js','error'); return; }
      S.subjects = all.map(x=>x.subject);
      S.raw.clear();
      for(const it of all) S.raw.set(it.subject, it.text);

      const sel = byId('selSubject'); sel.innerHTML='';
      S.subjects.forEach(s=>{
        const op=document.createElement('option'); op.value=s; op.textContent=s; sel.appendChild(op);
      });

      byId('btnStart').disabled = false; byId('btnQuick').disabled = false;
      showView('setup');
      showAlert('D·ªØ li·ªáu ƒë√£ n·∫°p xong. Ch·ªçn m√¥n ƒë·ªÉ b·∫Øt ƒë·∫ßu.','success');
    }

    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); }
    else { init(); }
  })();
  </script>
</body>
</html>
