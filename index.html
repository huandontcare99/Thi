<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Quiz Pro ‚Äì √în luy·ªán & Thi th·ª≠</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          borderRadius: { 'xl2': '1rem' },
          boxShadow: { 'soft': '0 10px 25px -10px rgba(0,0,0,.15)' },
          colors: { brand: { DEFAULT:'#2563eb' } }
        }
      }
    }
  </script>

  <style>
    :root{ color-scheme: light; }
    /* Radio ƒë·∫πp & v√πng ch·∫°m l·ªõn */
    .opt input[type="radio"]{ display:none; }
    .opt input[type="radio"]+label{
      display:block; border:1px solid rgb(226 232 240); border-radius:14px;
      padding:12px 14px; background:#fff;
    }
    .opt input[type="radio"]:checked+label{
      border-color: rgb(59 130 246);
      outline: 3px solid rgba(59,130,246,.14);
    }
    .is-correct{ border-color: rgb(34 197 94)!important; background:#f0fdf4!important; }
    .is-wrong{ border-color: rgb(239 68 68)!important; background:#fef2f2!important; }
    /* Fix iOS auto-zoom */
    @media (max-width:380px){ select,input,button{ font-size:16px; } }
  </style>

  <!-- (T√πy ch·ªçn) T·ª± load data.js n·∫øu c√≥ c√πng th∆∞ m·ª•c -->
  <script src="data.js" defer></script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
  <!-- Header si√™u g·ªçn, kh√¥ng che m√†n h√¨nh -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/85 border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-3 py-2">
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-xl2 bg-brand text-white flex items-center justify-center font-bold shadow-soft">Q</div>
        <div class="min-w-0">
          <h1 class="text-base font-semibold leading-tight">Quiz Pro</h1>
          <p class="text-xs text-slate-500 leading-tight">√în luy·ªán & Thi th·ª≠ (Mobile-first)</p>
        </div>
        <button id="btnToolbar" class="ml-auto px-3 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">
          B·∫£ng ƒëi·ªÅu khi·ªÉn
        </button>
      </div>

      <!-- Toolbar: x·∫øp d·ªçc tr√™n mobile, 2-3 c·ªôt khi r·ªông h∆°n -->
      <div id="toolbar" class="mt-2 grid grid-cols-1 gap-2 md:grid-cols-2 lg:grid-cols-3">
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">M√¥n</label>
          <select id="subjectSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option>ƒêang n·∫°p d·ªØ li·ªáu‚Ä¶</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">Ch·∫ø ƒë·ªô</label>
          <select id="modeSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option value="study">H·ªçc (hi·ªán ƒë√°p √°n)</option>
            <option value="practice">Luy·ªán t·∫≠p (ch·∫•m ngay)</option>
            <option value="exam">Thi th·ª≠ (ch·∫•m cu·ªëi, c√≥ gi·ªù)</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">S·ªë c√¢u</label>
          <select id="countSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="30">30</option>
            <option value="all">T·∫•t c·∫£</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">S·∫Øp x·∫øp</label>
          <select id="orderSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option value="sequence">Theo th·ª© t·ª±</option>
            <option value="shuffle">Ng·∫´u nhi√™n</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">B·ªô l·ªçc</label>
          <select id="filterSelect" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2">
            <option value="all" selected>T·∫•t c·∫£</option>
            <option value="bookmarked">ƒê√£ ƒë√°nh d·∫•u</option>
            <option value="wrong">Sai g·∫ßn ƒë√¢y</option>
          </select>
        </div>
        <div class="flex gap-2">
          <label class="text-sm text-slate-600 pt-2 min-w-[70px]">T√¨m</label>
          <input id="searchInput" placeholder="T·ª´ kh√≥a c√¢u h·ªèi‚Ä¶" class="flex-1 rounded-xl2 border border-slate-200 bg-white px-3 py-2" />
        </div>

        <div class="md:col-span-2 lg:col-span-3 flex gap-2 mt-1">
          <button id="btnStart" class="flex-1 bg-brand hover:bg-blue-700 text-white rounded-xl2 px-4 py-3 font-semibold shadow-soft">
            B·∫Øt ƒë·∫ßu
          </button>
          <button id="btnReset" class="px-4 py-3 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">
            X√≥a k·∫øt qu·∫£
          </button>
          <button id="btnLoadFile" class="px-4 py-3 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">
            üìÅ N·∫°p d·ªØ li·ªáu
          </button>
          <input id="fileInput" type="file" accept=".js,.txt,.json" class="hidden" />
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-3 pb-24">
    <!-- Progress -->
    <div class="mt-3">
      <div class="h-2 w-full bg-slate-200 rounded-full overflow-hidden">
        <div id="progressBar" class="h-2 bg-brand transition-[width] duration-300" style="width:0%"></div>
      </div>
      <div class="mt-1 text-xs text-slate-500" id="progressText">0 / 0</div>
    </div>

    <!-- Khu c√¢u h·ªèi -->
    <section id="quizArea" class="mt-3 space-y-3">
      <div id="emptyMsg" class="bg-amber-50 border border-amber-200 text-amber-800 rounded-xl2 p-3 text-sm">
        Ch∆∞a c√≥ b√†i. ƒê·∫∑t <b>index.html</b> c·∫°nh file <b>data.js</b> ho·∫∑c <b>data.txt</b>, r·ªìi nh·∫•n <b>B·∫Øt ƒë·∫ßu</b>.
        N·∫øu v·∫´n ch∆∞a ƒë·ªçc ƒë∆∞·ª£c, b·∫•m <b>üìÅ N·∫°p d·ªØ li·ªáu</b> ƒë·ªÉ ch·ªçn file th·ªß c√¥ng.
      </div>

      <article id="card" class="hidden rounded-2xl bg-white border border-slate-200 shadow-soft p-4">
        <div class="flex items-start gap-2">
          <div class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600" id="badgeSubject">M√¥n</div>
          <div class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600" id="badgeMode">Ch·∫ø ƒë·ªô</div>
          <div class="ml-auto text-xs text-slate-500" id="timerBox" hidden>‚è± <span id="timer">00:00</span></div>
        </div>

        <h2 id="qTitle" class="mt-2 text-base font-semibold"></h2>
        <div id="optList" class="mt-2 space-y-2"></div>

        <div id="explainBox" class="mt-3 hidden">
          <div class="text-sm font-semibold mb-1">Gi·∫£i th√≠ch</div>
          <div id="explain" class="text-sm text-slate-700"></div>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
          <button id="btnPrev" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">‚Üê Tr∆∞·ªõc</button>
          <button id="btnNext" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Ti·∫øp ‚Üí</button>
          <button id="btnCheck" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Ch·∫•m c√¢u n√†y</button>
          <button id="btnReveal" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Hi·ªán ƒë√°p √°n</button>
          <button id="btnBookmark" class="ml-auto px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">üîñ ƒê√°nh d·∫•u</button>
          <button id="btnSubmit" class="px-4 py-2 rounded-xl2 bg-brand text-white hover:bg-blue-700">N·ªôp b√†i</button>
        </div>
      </article>

      <article id="resultCard" class="hidden rounded-2xl bg-white border border-slate-200 shadow-soft p-4">
        <h3 class="text-lg font-bold mb-1">K·∫øt qu·∫£</h3>
        <p id="scoreText" class="text-sm text-slate-700"></p>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btnReviewWrong" class="px-4 py-2 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">Luy·ªán l·∫°i c√¢u sai</button>
          <button id="btnRestart" class="px-4 py-2 rounded-xl2 bg-brand text-white hover:bg-blue-700">L√†m l·∫°i</button>
        </div>
      </article>
    </section>

    <!-- Danh s√°ch c√¢u (bottom sheet) -->
    <div id="sheet" class="fixed inset-x-0 bottom-0 z-30 hidden">
      <div class="mx-auto max-w-4xl rounded-t-2xl bg-white shadow-2xl border border-slate-200">
        <div class="p-3 flex items-center gap-2 border-b border-slate-200">
          <div class="font-semibold">Danh s√°ch c√¢u</div>
          <button id="sheetClose" class="ml-auto px-3 py-1 rounded-xl2 border border-slate-200 bg-white hover:bg-slate-50">ƒê√≥ng</button>
        </div>
        <div id="qGrid" class="p-3 grid grid-cols-10 gap-1 max-h-[40vh] overflow-auto"></div>
      </div>
    </div>
  </main>

  <!-- FAB m·ªü danh s√°ch c√¢u ‚Äì kh√¥ng che n·ªôi dung -->
  <button id="fab" class="fixed bottom-4 right-4 z-20 rounded-full bg-brand text-white w-12 h-12 shadow-soft hover:bg-blue-700" title="Danh s√°ch c√¢u">#</button>

  <!-- App -->
  <script>
  (function(){
    "use strict";

    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const byId = id => document.getElementById(id);

    const normalize = (s) => (s ?? "")
      .toString()
      .replace(/\s+/g,' ')
      .trim()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[‚Äú‚Äù"']/g,'')
      .toLowerCase();

    const choiceLetters = ['A','B','C','D','E','F'];
    const LS_BOOK = 'quizpro_bookmarks';
    const LS_WRONG = 'quizpro_wrong';
    const loadLS = (k, def) => { try{return JSON.parse(localStorage.getItem(k)) ?? def;}catch{return def;} };
    const saveLS = (k,v) => localStorage.setItem(k, JSON.stringify(v));

    // ===== Robust legacy RAW parser =====
    function parseLegacyText(raw){
      if(!raw) return [];
      // C·∫Øt theo "C√¢u n:" ho·∫∑c v·∫°ch k·∫ª
      const blocks=[]; const re=/(^|\n)C√¢u\s*\d+\s*:[\s\S]*?(?=(?:\n[-=]{3,}\s*\n)|(?:\n\s*C√¢u\s*\d+\s*:)|\s*$)/gi;
      let m; while((m=re.exec(raw))){ blocks.push(m[0]); }

      const qs=[];
      for(const b of blocks){
        const qm=/C√¢u\s*\d+\s*:\s*([\s\S]*?)\n\s*ƒê√°p √°n ƒë√∫ng:\s*([^\n]+)\s*\n/i.exec(b);
        if(!qm) continue;
        const qText=qm[1].trim();
        const correctText=qm[2].trim();

        let optPart=/T·∫•t c·∫£ ƒë√°p √°n:\s*([\s\S]*)/i.exec(b)?.[1] ?? '';
        const lines=optPart.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

        const opts=[];
        for(const ln of lines){
          const m2=/^([A-Zƒê])\.\s*(.*)$/.exec(ln); // k·ªÉ c·∫£ ch·ªØ ƒê
          if(!m2) continue;
          const letter=m2[1].toUpperCase();
          let text=m2[2].trim();
          const hasCheck=/‚úì/.test(text);
          text=text.replace(/^‚úì\s*/,'').replace(/\s*‚úì\s*$/,'').trim();
          opts.push({letter,text,hasCheck});
        }
        if(!opts.length) continue;

        // T√¨m ƒë√°p √°n
        let answerIndex=opts.findIndex(o=>o.hasCheck);
        if(answerIndex<0){
          const normCorrect=normalize(correctText);
          answerIndex=opts.findIndex(o=>normalize(o.text)===normCorrect);
          if(answerIndex<0){
            answerIndex=opts.findIndex(o=>normalize(o.text).includes(normCorrect)||normCorrect.includes(normalize(o.text)));
          }
        }
        if(answerIndex<0) answerIndex=0;

        qs.push({ text:qText, options:opts.map(o=>o.text), answer:answerIndex, explain:'' });
      }
      return qs;
    }

    // L·∫•y t√™n m√¥n t·ª´ header n·ªôi dung RAW
    function inferSubjectName(raw, fallback){
      const m=/M√îN\s*[:Ôºö]\s*([^\n]+)\n/i.exec(raw||'');
      return (m?m[1].trim():fallback||'M√¥n');
    }

    // Parse data.js TEXT (kh√¥ng eval): b·∫Øt c√°c RAW_* v√† SUBJECT_*
    function parseDataJsText(jsText){
      const subjects=[];
      if(!jsText) return subjects;

      // Map SUBJECT_* constants
      const subjMap={};
      const subjRe=/const\s+SUBJECT_([A-Za-z0-9_]+)\s*=\s*"([^"]*)"/g;
      let sm; while((sm=subjRe.exec(jsText))){
        subjMap[sm[1]] = sm[2];
      }

      // RAW blocks
      const rawRe=/const\s+(RAW_([A-Za-z0-9_]+))\s*=\s*String\.raw`([\s\S]*?)`;/g;
      let rm; while((rm=rawRe.exec(jsText))){
        const key = rm[2];               // v√≠ d·ª• PH, QU
        const raw = rm[3];               // n·ªôi dung RAW
        const name = subjMap[key] || inferSubjectName(raw, key);
        subjects.push({ name, questions: parseLegacyText(raw) });
      }

      // N·∫øu kh√¥ng c√≥ RAW_* m√† c√≥ window.quizData.getAll() ‚Üí c·ªë g·∫Øng ƒë·ªçc text gi·ªØa backtick (2 m√¥n)
      if(subjects.length===0){
        const allRaw=[...jsText.matchAll(/String\.raw`([\s\S]*?)`/g)].map(x=>x[1]);
        for(const raw of allRaw){
          const name=inferSubjectName(raw, 'M√¥n');
          const qs=parseLegacyText(raw);
          if(qs.length) subjects.push({ name, questions: qs });
        }
      }
      return subjects;
    }

    // Parse JSON text
    function parseJsonText(txt){
      try{
        const data=JSON.parse(txt);
        if(Array.isArray(data?.subjects)){
          return data.subjects.map(s=>({
            name: s.name || 'M√¥n',
            questions: s.questions?.map(q=>({ text:q.text, options:q.options, answer:q.answer, explain:q.explain||'' }))||[]
          }));
        }
      }catch{}
      return [];
    }

    // Load subjects t·ª´ c√°c ngu·ªìn: window, r·ªìi fetch data.txt n·∫øu c√≥
    async function loadSubjectsAuto(){
      // 1) window.quizDataJSON
      if(window.quizDataJSON?.subjects?.length){
        return window.quizDataJSON.subjects.map(s=>({
          name:s.name, questions:s.questions.map(q=>({text:q.text,options:q.options,answer:q.answer,explain:q.explain||''}))
        }));
      }
      // 2) window.quizData.getAll() (data.js truy·ªÅn th·ªëng)
      if(window.quizData?.getAll){
        try{
          const arr=window.quizData.getAll();
          return arr.map(it=>({ name: it.subject, questions: parseLegacyText(String(it.text||'')) }));
        }catch(e){ console.warn('L·ªói quizData.getAll()', e); }
      }
      // 3) Bi·∫øn RAW_* global
      const rawKeys = Object.keys(window).filter(k=>/^RAW_/.test(k));
      if(rawKeys.length){
        const subjects=[];
        for(const k of rawKeys){
          const raw=String(window[k]||'');
          const suffix=k.replace(/^RAW_/,'');
          const subjName=(window['SUBJECT_'+suffix]||inferSubjectName(raw,suffix));
          subjects.push({ name:subjName, questions:parseLegacyText(raw) });
        }
        if(subjects.length) return subjects;
      }
      // 4) fetch data.txt (n·∫øu ƒë·∫∑t c·∫°nh index)
      try{
        const res = await fetch('data.txt', {cache:'no-store'});
        if(res.ok){
          const txt = await res.text();
          // Th·ª≠ RAW tr∆∞·ªõc, n·∫øu kh√¥ng th√¨ JSON
          const rawQs = parseLegacyText(txt);
          if(rawQs.length){
            return [{ name: inferSubjectName(txt,'M√¥n'), questions: rawQs }];
          }
          const jsonSubs = parseJsonText(txt);
          if(jsonSubs.length) return jsonSubs;
        }
      }catch{}
      return []; // ƒë·ªÉ d√πng n√∫t "N·∫°p d·ªØ li·ªáu"
    }

    // ====== State ======
    const state={
      subjects:[],
      subjectIdx:0,
      mode:'study',
      order:'sequence',
      filter:'all',
      search:'',
      pool:[],
      cur:0,
      answers:{},
      checked:{},
      bookmarks: loadLS(LS_BOOK,{}),
      wrongBank: loadLS(LS_WRONG,[]),
      timer:null,
      seconds:0
    };

    // ====== Refs ======
    const subjectSelect = byId('subjectSelect');
    const modeSelect = byId('modeSelect');
    const countSelect = byId('countSelect');
    const orderSelect = byId('orderSelect');
    const filterSelect = byId('filterSelect');
    const searchInput = byId('searchInput');
    const btnStart = byId('btnStart');
    const btnReset = byId('btnReset');
    const btnToolbar = byId('btnToolbar');
    const btnLoadFile = byId('btnLoadFile');
    const fileInput = byId('fileInput');
    const toolbar = byId('toolbar');

    const emptyMsg = byId('emptyMsg');
    const card = byId('card');
    const badgeSubject = byId('badgeSubject');
    const badgeMode = byId('badgeMode');
    const timerBox = byId('timerBox'); const timerLbl = byId('timer');

    const qTitle = byId('qTitle');
    const optList = byId('optList');
    const explainBox = byId('explainBox'); const explain = byId('explain');

    const btnPrev = byId('btnPrev');
    const btnNext = byId('btnNext');
    const btnCheck = byId('btnCheck');
    const btnReveal = byId('btnReveal');
    const btnBookmark = byId('btnBookmark');
    const btnSubmit = byId('btnSubmit');

    const progressBar = byId('progressBar');
    const progressText = byId('progressText');

    const resultCard = byId('resultCard');
    const scoreText = byId('scoreText');
    const btnReviewWrong = byId('btnReviewWrong');
    const btnRestart = byId('btnRestart');

    const sheet = byId('sheet'); const sheetClose = byId('sheetClose'); const qGrid = byId('qGrid');
    const fab = byId('fab');

    // ====== Init ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      // S·ª± ki·ªán UI
      btnStart.onclick = start;
      btnReset.onclick = resetAll;
      btnToolbar.onclick = ()=> toolbar.classList.toggle('hidden');
      btnLoadFile.onclick = ()=> fileInput.click();
      fileInput.onchange = handleFileInput;

      subjectSelect.onchange = ()=> state.subjectIdx = subjectSelect.selectedIndex;
      modeSelect.onchange = ()=> state.mode = modeSelect.value;
      orderSelect.onchange = ()=> state.order = orderSelect.value;
      filterSelect.onchange = ()=> state.filter = filterSelect.value;
      searchInput.oninput = ()=> state.search = searchInput.value;

      btnPrev.onclick = prevQ; btnNext.onclick = nextQ;
      btnCheck.onclick = checkThis; btnReveal.onclick = revealThis;
      btnBookmark.onclick = toggleBookmark; btnSubmit.onclick = submitAll;

      fab.onclick = ()=> sheet.classList.toggle('hidden');
      sheetClose.onclick = ()=> sheet.classList.add('hidden');

      // N·∫°p subjects t·ª± ƒë·ªông
      state.subjects = await loadSubjectsAuto();
      renderSubjectOptions();
    });

    function renderSubjectOptions(){
      subjectSelect.innerHTML='';
      if(!state.subjects.length){
        subjectSelect.innerHTML='<option>Ch∆∞a ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu</option>';
        emptyMsg.classList.remove('hidden');
        card.classList.add('hidden');
        return;
      }
      state.subjects.forEach((s,i)=>{
        const opt=document.createElement('option');
        opt.value=i; opt.textContent=s.name || ('M√¥n '+(i+1));
        subjectSelect.appendChild(opt);
      });
      state.subjectIdx=0;
      emptyMsg.classList.remove('hidden');
    }

    async function handleFileInput(e){
      const file = e.target.files?.[0];
      if(!file) return;
      const txt = await file.text();

      // Th·ª≠ JSON ‚Üí data.js ‚Üí RAW th·∫≥ng
      let subs = parseJsonText(txt);
      if(!subs.length) subs = parseDataJsText(txt);
      if(!subs.length){
        const rawQs = parseLegacyText(txt);
        if(rawQs.length) subs=[{ name: inferSubjectName(txt,'M√¥n'), questions: rawQs }];
      }

      if(!subs.length){
        alert('Kh√¥ng tr√≠ch xu·∫•t ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ file n√†y. Vui l√≤ng ch·ªçn ƒë√∫ng file data.');
        return;
      }
      state.subjects = subs;
      renderSubjectOptions();
      alert('N·∫°p d·ªØ li·ªáu th√†nh c√¥ng!');
    }

    // ====== Pooling ======
    function makePool(){
      const subj = state.subjects[state.subjectIdx];
      if(!subj) return [];
      let arr = subj.questions.map((q,idx)=>({...q,_id:idx}));

      if(state.search.trim()){
        const key=normalize(state.search);
        arr=arr.filter(q => normalize(q.text).includes(key) || q.options.some(o=>normalize(o).includes(key)));
      }
      if(state.filter==='bookmarked'){
        arr=arr.filter(q => !!state.bookmarks[`${state.subjectIdx}:${q._id}`]);
      }else if(state.filter==='wrong'){
        const set=new Set(state.wrongBank.map(x=>`${x.s}:${x.q}`));
        arr=arr.filter(q=>set.has(`${state.subjectIdx}:${q._id}`));
      }
      const need = (countSelect.value==='all') ? arr.length : Math.min(+countSelect.value||20, arr.length);
      if(state.order==='shuffle') arr.sort(()=>Math.random()-.5);
      return arr.slice(0, need);
    }

    // ====== Start ======
    function start(){
      clearTimer();
      state.answers={}; state.checked={};
      resultCard.classList.add('hidden');

      state.pool = makePool();
      state.cur = 0;

      if(!state.pool.length){
        emptyMsg.classList.remove('hidden'); card.classList.add('hidden');
        updateProgress(); return;
      }

      if(state.mode==='exam'){ startTimer(); }
      badgeSubject.textContent = state.subjects[state.subjectIdx]?.name || 'M√¥n';
      badgeMode.textContent = (state.mode==='study'?'H·ªçc':state.mode==='practice'?'Luy·ªán t·∫≠p':'Thi th·ª≠');

      sheet.classList.add('hidden');
      renderQuestion();
      updateProgress();
      buildGrid();
    }

    // ====== Render ======
    function renderQuestion(){
      const q = state.pool[state.cur];
      if(!q){ emptyMsg.classList.remove('hidden'); card.classList.add('hidden'); return; }
      emptyMsg.classList.add('hidden'); card.classList.remove('hidden');

      qTitle.textContent = `C√¢u ${state.cur+1}: ${q.text}`;
      optList.innerHTML=''; explainBox.classList.add('hidden'); explain.textContent=q.explain||'';

      q.options.forEach((o,i)=>{
        const id=`opt-${state.cur}-${i}`;
        const wrap=document.createElement('div'); wrap.className='opt';
        const input=document.createElement('input'); input.type='radio'; input.name=`q-${state.cur}`; input.id=id; input.value=i;
        input.checked = (state.answers[state.cur]===i);
        input.onchange = ()=>{
          state.answers[state.cur]=i;
          if(state.mode==='practice') markOptions();
        };
        const lab=document.createElement('label'); lab.setAttribute('for',id);
        lab.innerHTML=`<div class="flex gap-2"><div class="text-slate-500">${choiceLetters[i]||''}.</div><div class="flex-1">${o}</div></div>`;
        wrap.appendChild(input); wrap.appendChild(lab); optList.appendChild(wrap);
      });

      btnCheck.classList.toggle('hidden', state.mode!=='practice');
      btnReveal.classList.toggle('hidden', state.mode!=='study');
      btnSubmit.classList.toggle('hidden', state.mode!=='exam');

      const key=`${state.subjectIdx}:${q._id}`;
      btnBookmark.textContent = state.bookmarks[key] ? 'üîñ ƒê√£ ƒë√°nh d·∫•u' : 'üîñ ƒê√°nh d·∫•u';
      timerBox.hidden = (state.mode!=='exam');
      clearMarks();
    }

    function clearMarks(){ $$('#optList label').forEach(el=>el.classList.remove('is-correct','is-wrong')); }
    function markOptions(){
      const q=state.pool[state.cur]; const pick=state.answers[state.cur];
      clearMarks();
      const labels=$$('#optList label');
      if(labels[q.answer]) labels[q.answer].classList.add('is-correct');
      if(pick!=null && pick!==q.answer && labels[pick]) labels[pick].classList.add('is-wrong');
      state.checked[state.cur]=true;
    }
    function revealThis(){
      const q=state.pool[state.cur]; const labels=$$('#optList label');
      clearMarks(); if(labels[q.answer]) labels[q.answer].classList.add('is-correct');
      if(q.explain) explainBox.classList.remove('hidden');
    }

    function toggleBookmark(){
      const q=state.pool[state.cur]; const key=`${state.subjectIdx}:${q._id}`;
      state.bookmarks[key]=!state.bookmarks[key]; saveLS(LS_BOOK,state.bookmarks);
      btnBookmark.textContent = state.bookmarks[key] ? 'üîñ ƒê√£ ƒë√°nh d·∫•u' : 'üîñ ƒê√°nh d·∫•u';
    }

    function prevQ(){ if(state.cur>0){ state.cur--; renderQuestion(); updateProgress(); } }
    function nextQ(){ if(state.cur<state.pool.length-1){ state.cur++; renderQuestion(); updateProgress(); } }

    function updateProgress(){
      const cur=state.cur+1, total=state.pool.length||0;
      progressText.textContent = `${cur>total?total:cur} / ${total}`;
      progressBar.style.width = total? `${(Math.min(cur,total)/total)*100}%` : '0%';
    }

    // ====== Submit (Exam) ======
    function submitAll(){
      if(state.mode!=='exam') return;
      const total=state.pool.length; let correct=0, wrongList=[];
      for(let i=0;i<total;i++){
        const q=state.pool[i];
        if(state.answers[i]===q.answer) correct++; else wrongList.push({s:state.subjectIdx,q:q._id});
      }
      state.wrongBank=(wrongList.concat(state.wrongBank)).slice(0,200);
      saveLS(LS_WRONG,state.wrongBank);

      clearTimer();
      scoreText.textContent=`ƒê√∫ng ${correct}/${total} c√¢u (${Math.round(correct*100/Math.max(1,total))}%).`;
      resultCard.classList.remove('hidden');

      btnReviewWrong.onclick=()=>{
        state.mode='practice'; modeSelect.value='practice';
        state.filter='wrong'; filterSelect.value='wrong';
        start();
      };
      btnRestart.onclick=start;
    }

    // ====== Grid & FAB ======
    function buildGrid(){
      qGrid.innerHTML='';
      for(let i=0;i<state.pool.length;i++){
        const b=document.createElement('button');
        b.className='text-sm rounded-lg border border-slate-200 px-2 py-1 '+(i===state.cur?'bg-brand text-white border-brand':'bg-white hover:bg-slate-50');
        b.textContent=(i+1);
        b.onclick=()=>{ state.cur=i; renderQuestion(); updateProgress(); };
        qGrid.appendChild(b);
      }
    }

    // ====== Timer ======
    function startTimer(){
      state.seconds=0; timerLbl.textContent='00:00';
      state.timer=setInterval(()=>{
        state.seconds++;
        const m=String(Math.floor(state.seconds/60)).padStart(2,'0');
        const s=String(state.seconds%60).padStart(2,'0');
        timerLbl.textContent=`${m}:${s}`;
      },1000);
    }
    function clearTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

    function resetAll(){
      localStorage.removeItem(LS_BOOK);
      localStorage.removeItem(LS_WRONG);
      state.bookmarks={}; state.wrongBank=[];
      alert('ƒê√£ x√≥a ƒë√°nh d·∫•u & l·ªãch s·ª≠ sai g·∫ßn ƒë√¢y.');
    }
  })();
  </script>
</body>
</html>
