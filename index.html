<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ngân hàng trắc nghiệm — Pro Quiz</title>
  <!-- Tailwind qua CDN để có UI sạch & responsive -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    /* Hiển thị trạng thái câu trên thanh điều hướng */
    .qchip { @apply w-9 h-9 rounded-full flex items-center justify-center text-sm font-medium cursor-pointer transition; }
    .qchip-unanswered { @apply bg-gray-200/80 hover:bg-gray-300 text-gray-700; }
    .qchip-answered { @apply bg-blue-200/70 hover:bg-blue-300 text-blue-900; }
    .qchip-correct { @apply bg-emerald-200/80 hover:bg-emerald-300 text-emerald-900; }
    .qchip-wrong { @apply bg-rose-200/80 hover:bg-rose-300 text-rose-900; }
    .qchip-current { outline: 2px solid rgba(59,130,246,.7); }
    .card { @apply bg-white dark:bg-zinc-900/60 rounded-2xl shadow p-5; }
    .opt { @apply border rounded-xl p-3 transition cursor-pointer; }
    .opt:hover { @apply bg-gray-50 dark:bg-zinc-800; }
    .opt-selected { @apply ring-2 ring-blue-400 bg-blue-50 dark:bg-blue-950/30; }
    .opt-correct { @apply border-emerald-400 bg-emerald-50 dark:bg-emerald-900/30; }
    .opt-wrong { @apply border-rose-400 bg-rose-50 dark:bg-rose-900/30; }
    .badge { @apply inline-flex items-center px-2 py-1 text-xs font-semibold rounded-md; }
    .badge-info { @apply bg-blue-100 text-blue-800; }
    .badge-warn { @apply bg-amber-100 text-amber-800; }
    .badge-ok { @apply bg-emerald-100 text-emerald-800; }
    .badge-bad { @apply bg-rose-100 text-rose-800; }
    .hidden-when-print { }
    @media print {
      .hidden-when-print { display: none !important; }
      .card { box-shadow: none !important; }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-zinc-950 text-gray-900 dark:text-gray-100">
  <!-- DATA.JS — phải đặt trước app script -->
  <script src="data.js"></script>

  <div class="max-w-6xl mx-auto px-4 py-6 md:py-8">
    <header class="mb-6 md:mb-8 flex items-start md:items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Ngân hàng trắc nghiệm — Pro Quiz</h1>
        <p class="text-sm md:text-base text-gray-600 dark:text-gray-400">Giao diện mới: chọn môn, tạo đề, làm bài, nộp & xem kết quả ngay — không tự nhảy đề.</p>
      </div>
      <div class="hidden-when-print flex items-center gap-2">
        <button id="btn-export" class="px-3 py-2 rounded-xl bg-gray-900 text-white dark:bg-white dark:text-black text-sm font-semibold disabled:opacity-50" disabled>Xuất kết quả (.json)</button>
        <button id="btn-print"  class="px-3 py-2 rounded-xl bg-white text-gray-900 dark:bg-zinc-800 dark:text-white border text-sm font-semibold">In / Lưu PDF</button>
      </div>
    </header>

    <!-- SETUP PANEL -->
    <section id="setup" class="card hidden-when-print">
      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">Chọn môn</label>
            <select id="sel-subject" class="w-full border rounded-xl p-3 bg-white dark:bg-zinc-900"></select>
            <p id="subject-stats" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></p>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-2">Số câu trong đề</label>
              <select id="sel-count" class="w-full border rounded-xl p-3 bg-white dark:bg-zinc-900">
                <option value="10">10 câu</option>
                <option value="20" selected>20 câu</option>
                <option value="50">50 câu</option>
                <option value="all">Tất cả</option>
              </select>
              <p class="mt-2 text-xs text-gray-500">Có thể đổi “Tất cả” để luyện full.</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Hẹn giờ (phút) <span class="text-gray-400">(tuỳ chọn)</span></label>
              <input id="inp-minutes" type="number" class="w-full border rounded-xl p-3 bg-white dark:bg-zinc-900" placeholder="vd: 30" min="1" />
              <p class="mt-2 text-xs text-gray-500">Để trống nếu không cần đếm ngược.</p>
            </div>
          </div>

          <div class="flex flex-wrap gap-3">
            <label class="inline-flex items-center gap-2">
              <input id="chk-shuffle-q" type="checkbox" class="scale-110" checked />
              <span>Trộn thứ tự câu hỏi</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input id="chk-shuffle-a" type="checkbox" class="scale-110" checked />
              <span>Trộn thứ tự đáp án</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input id="chk-continue" type="checkbox" class="scale-110" />
              <span>Nếu có bản nháp trước, cho phép tiếp tục</span>
            </label>
          </div>
        </div>

        <aside class="space-y-3">
          <div class="p-3 rounded-xl bg-blue-50 dark:bg-blue-950/30 text-blue-900 dark:text-blue-100">
            <div class="badge badge-info mb-2">Mẹo</div>
            <ul class="list-disc pl-5 text-sm leading-6">
              <li>Có thể thêm môn mới chỉ bằng cách thêm vào <code>data.js</code> (giữ nguyên format đang dùng).</li>
              <li>Không tự chuyển đề khi nộp — bạn chủ động bấm “Làm lại đề này” hoặc “Đổi môn”.</li>
              <li>Kết quả được lưu tạm để tiếp tục làm ở lần sau.</li>
            </ul>
          </div>
          <button id="btn-start" class="w-full py-3 rounded-xl bg-emerald-600 text-white font-semibold">Bắt đầu</button>
          <button id="btn-restore" class="w-full py-3 rounded-xl bg-white dark:bg-zinc-800 border font-semibold hidden">Tiếp tục lần trước</button>
        </aside>
      </div>
    </section>

    <!-- QUIZ PANEL -->
    <section id="quiz" class="mt-6 hidden">
      <div class="hidden-when-print card mb-4 flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <span id="badge-subject" class="badge badge-info"></span>
          <span id="badge-count" class="badge bg-gray-100 text-gray-800"></span>
          <span id="badge-timer" class="badge bg-purple-100 text-purple-800 hidden"></span>
          <span id="badge-status" class="badge bg-gray-100 text-gray-800">Đang làm</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-save" class="px-3 py-2 rounded-xl bg-white dark:bg-zinc-800 border text-sm font-semibold">Lưu tạm</button>
          <button id="btn-submit" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold">Nộp bài</button>
        </div>
      </div>

      <div class="hidden-when-print card mb-4">
        <div id="nav-questions" class="flex flex-wrap gap-2"></div>
      </div>

      <div id="question-list" class="space-y-4"></div>
    </section>

    <!-- RESULT PANEL -->
    <section id="result" class="mt-6 hidden">
      <div class="card mb-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="space-y-1">
            <div class="text-lg font-semibold">Kết quả</div>
            <div id="result-summary" class="text-sm text-gray-600 dark:text-gray-400"></div>
          </div>
          <div class="flex items-center gap-2 hidden-when-print">
            <button id="btn-show-correct" class="px-3 py-2 rounded-xl bg-white dark:bg-zinc-800 border text-sm font-semibold">Hiện đáp án đúng</button>
            <button id="btn-retry" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm font-semibold">Làm lại đề này</button>
            <button id="btn-new" class="px-3 py-2 rounded-xl bg-gray-900 text-white dark:bg-white dark:text-black text-sm font-semibold">Tạo đề khác</button>
            <button id="btn-change" class="px-3 py-2 rounded-xl bg-white dark:bg-zinc-800 border text-sm font-semibold">Đổi môn</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div id="review-list" class="space-y-4"></div>
      </div>
    </section>
  </div>

  <script>
  ;(() => {
    // ====== Utils ======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const rndInt = (n) => Math.floor(Math.random() * n);
    const shuffle = (arr) => {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    };
    const htmlEscape = (s) => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    const normVN = (s) => String(s||"").normalize("NFD").replace(/\p{M}+/gu,"").replace(/[“”"'`’]/g,"").replace(/\s+/g," ").trim().toLowerCase();

    // ====== Parse RAW fallback (giữ nguyên data.js, chỉ parse khi cần) ======
    function parseSubjectFromRaw(subjectName, raw, subjectId) {
      const text = String(raw||"");
      const items = [];
      const reBlock = /(?:^|\n)\s*Câu\s+(\d+)\s*:\s*([\s\S]*?)(?=\n-{2,}|(?:\n\s*Câu\s+\d+\s*:)|\s*$)/gi;
      let m;
      while ((m = reBlock.exec(text))) {
        const qnum = parseInt(m[1], 10);
        const block = m[2];

        const firstLine = (block.split("\n")[0] || "").trim();
        const question = firstLine || ("Câu " + qnum);

        const mCorrect = block.match(/Đáp\s*án\s*đúng\s*:\s*(.+)/i);
        const correctStr = (mCorrect ? mCorrect[1] : "").trim();

        const afterAll = block.split(/Tất\s*cả\s*đáp\s*án\s*:/i)[1] || block;
        const lines = afterAll.split("\n");
        const map = {};
        for (const lineRaw of lines) {
          const line = lineRaw.replace(/\s+$/,'');
          const mm = line.match(/^\s*([ABCD])\.\s*(.+)$/i);
          if (!mm) continue;
          const letter = mm[1].toUpperCase();
          let txt = mm[2].trim();
          const tick = /[✓✔]/.test(txt);
          txt = txt.replace(/[✓✔]/g, "").replace(/\s*\.\s*$/, "").trim();
          map[letter] = { txt, tick };
        }
        const order = ["A","B","C","D"];
        const options = order.map(k => map[k]?.txt || "").filter(Boolean);

        let correctIndex = null;
        // Ưu tiên dấu tick
        const tickIdx = order.findIndex(k => map[k] && map[k].tick);
        if (tickIdx >= 0 && map[order[tickIdx]]) {
          const targetTxt = map[order[tickIdx]].txt;
          correctIndex = options.findIndex(t => normVN(t) === normVN(targetTxt));
        }
        // Khớp theo "Đáp án đúng:"
        if (correctIndex == null && correctStr) {
          const target = normVN(correctStr);
          for (let i=0;i<options.length;i++) {
            const o = normVN(options[i]);
            if (o === target || o.startsWith(target) || target.startsWith(o)) {
              correctIndex = i; break;
            }
          }
          // Fuzzy nhẹ
          if (correctIndex == null) {
            const set = s => new Set(normVN(s).split(" ").filter(Boolean));
            const inter = (a,b) => {
              const sa=set(a), sb=set(b);
              const n=[...sa].filter(x=>sb.has(x)).length;
              const u=new Set([...sa,...sb]).size||1;
              return n/u;
            };
            let best=-1, idx=null;
            for (let i=0;i<options.length;i++){
              const r=inter(options[i], correctStr);
              if (r>best){ best=r; idx=i; }
            }
            if (idx!=null && best>=0.35) correctIndex = idx;
          }
        }
        if (!options.length || correctIndex==null || correctIndex<0) continue;

        items.push({
          id: `${subjectId}-${qnum}`,
          qnum,
          text: question,
          options,
          answer: correctIndex
        });
      }
      items.sort((a,b)=>a.qnum-b.qnum);
      return { id: subjectId, name: subjectName, questions: items };
    }

    function loadSubjects() {
      // Ưu tiên CÁCH 1 nếu có
      if (window.quizDataJSON && Array.isArray(window.quizDataJSON.subjects)) {
        const ok = window.quizDataJSON.subjects.every(s => Array.isArray(s.questions));
        if (ok) return window.quizDataJSON.subjects.map(s => ({ id: s.id || normVN(s.name), name: s.name, questions: s.questions }));
      }
      // CÁCH 2: từ RAW
      if (window.quizData && typeof window.quizData.getAll === "function") {
        const raws = window.quizData.getAll(); // [{subject, text}]
        const out = [];
        for (const [i, it] of raws.entries()) {
          const id = (it.subject ? normVN(it.subject).replace(/\W+/g,'-') : `s${i+1}`);
          out.push(parseSubjectFromRaw(it.subject || `Môn ${i+1}`, it.text || "", id));
        }
        return out;
      }
      return [];
    }

    // ====== App State ======
    const LS_KEY = "proquiz_v1_saved";
    const state = {
      step: "setup", // setup | running | submitted
      subjects: [],
      subjectId: null,
      subjectName: null,
      allQuestions: [],
      quizQuestions: [],
      userAnswers: {}, // {qid: index}
      startedAt: null,
      finishedAt: null,
      timer: { totalSec: 0, remainSec: 0, tickH: null, enabled: false },
      settings: { shuffleQ: true, shuffleA: true },
      showCorrect: false
    };

    // ====== DOM refs ======
    const elSetup = $("#setup");
    const elQuiz = $("#quiz");
    const elResult = $("#result");

    const selSubject = $("#sel-subject");
    const selCount = $("#sel-count");
    const inpMinutes = $("#inp-minutes");
    const chkShuffleQ = $("#chk-shuffle-q");
    const chkShuffleA = $("#chk-shuffle-a");
    const chkContinue = $("#chk-continue");
    const btnStart = $("#btn-start");
    const btnRestore = $("#btn-restore");

    const btnSave = $("#btn-save");
    const btnSubmit = $("#btn-submit");
    const badgeSubject = $("#badge-subject");
    const badgeCount = $("#badge-count");
    const badgeTimer = $("#badge-timer");
    const badgeStatus = $("#badge-status");
    const navQuestions = $("#nav-questions");
    const questionList = $("#question-list");

    const btnShowCorrect = $("#btn-show-correct");
    const btnRetry = $("#btn-retry");
    const btnNew = $("#btn-new");
    const btnChange = $("#btn-change");
    const resultSummary = $("#result-summary");
    const reviewList = $("#review-list");

    const btnExport = $("#btn-export");
    const btnPrint = $("#btn-print");
    const subjectStats = $("#subject-stats");

    // ====== Renderers ======
    function renderSetup() {
      elSetup.classList.remove("hidden");
      elQuiz.classList.add("hidden");
      elResult.classList.add("hidden");

      // Dropdown môn
      selSubject.innerHTML = "";
      state.subjects.forEach((s, i) => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.name} — ${s.questions.length} câu`;
        selSubject.appendChild(opt);
      });
      // Chọn môn trước (nếu có bản nháp còn lưu)
      const draft = loadDraft();
      if (draft && draft.subjectId && chkContinue.checked) {
        selSubject.value = draft.subjectId;
        btnRestore.classList.remove("hidden");
      } else {
        btnRestore.classList.add("hidden");
      }

      // Stats
      const s0 = state.subjects.find(s => s.id === selSubject.value) || state.subjects[0];
      subjectStats.textContent = s0 ? `Hiện có ${s0.questions.length} câu cho môn “${s0.name}”.` : "";

      // Sự kiện đổi môn → cập nhật stats
      selSubject.onchange = () => {
        const sel = state.subjects.find(s => s.id === selSubject.value);
        subjectStats.textContent = sel ? `Hiện có ${sel.questions.length} câu cho môn “${sel.name}”.` : "";
        // Nếu có draft và trùng môn, hiện nút tiếp tục
        const d = loadDraft();
        if (d && d.subjectId === selSubject.value && chkContinue.checked) {
          btnRestore.classList.remove("hidden");
        } else {
          btnRestore.classList.add("hidden");
        }
      };
    }

    function renderQuiz() {
      elSetup.classList.add("hidden");
      elResult.classList.add("hidden");
      elQuiz.classList.remove("hidden");

      badgeSubject.textContent = state.subjectName || "Môn";
      badgeCount.textContent = `${state.quizQuestions.length} câu`;
      badgeStatus.textContent = "Đang làm";
      badgeStatus.className = "badge bg-gray-100 text-gray-800";

      // Timer
      if (state.timer.enabled) {
        badgeTimer.classList.remove("hidden");
        updateTimerBadge();
      } else {
        badgeTimer.classList.add("hidden");
        badgeTimer.textContent = "";
      }

      // Thanh nav chips
      navQuestions.innerHTML = "";
      state.quizQuestions.forEach((q, idx) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "qchip qchip-unanswered";
        chip.dataset.qid = q.id;
        chip.textContent = String(idx+1);
        chip.onclick = () => {
          const elQ = document.getElementById(`q-${q.id}`);
          if (elQ) elQ.scrollIntoView({ behavior: "smooth", block: "start" });
          highlightCurrentChip(q.id);
        };
        navQuestions.appendChild(chip);
      });

      // Danh sách câu hỏi
      questionList.innerHTML = "";
      state.quizQuestions.forEach((q, idx) => {
        const card = document.createElement("div");
        card.className = "card";
        card.id = `q-${q.id}`;

        const header = document.createElement("div");
        header.className = "mb-3 flex items-start gap-3";
        const order = document.createElement("div");
        order.className = "px-3 py-1 rounded-lg bg-gray-200 text-gray-800 font-semibold";
        order.textContent = `Câu ${idx+1}`;
        const title = document.createElement("div");
        title.className = "text-base md:text-lg font-medium";
        title.textContent = q.text; // an toàn (textContent)
        header.append(order, title);

        const opts = document.createElement("div");
        opts.className = "space-y-2";
        q.options.forEach((optText, oi) => {
          const optId = `opt-${q.id}-${oi}`;
          const wrap = document.createElement("label");
          wrap.className = "opt flex items-start gap-3";
          const input = document.createElement("input");
          input.type = "radio";
          input.name = `ans-${q.id}`;
          input.value = String(oi);
          input.className = "mt-1.5";
          input.checked = state.userAnswers[q.id] === oi;

          input.onchange = () => {
            state.userAnswers[q.id] = oi;
            updateChipStatus(q.id);
            saveDraft(); // autosave
            // làm nổi bật chọn
            $$(".opt", card).forEach(el => el.classList.remove("opt-selected"));
            wrap.classList.add("opt-selected");
          };

          const span = document.createElement("span");
          span.className = "leading-relaxed";
          span.textContent = optText;

          wrap.append(input, span);
          opts.appendChild(wrap);

          // Nếu có chọn sẵn từ draft
          if (state.userAnswers[q.id] === oi) {
            wrap.classList.add("opt-selected");
          }
        });

        card.append(header, opts);
        questionList.appendChild(card);
      });

      // Đánh dấu chip ban đầu
      state.quizQuestions.forEach(q => updateChipStatus(q.id));
      highlightCurrentChip(state.quizQuestions[0]?.id);

      // Enable export khi đang làm (xuất nháp)
      btnExport.disabled = false;
    }

    function renderResult() {
      elQuiz.classList.add("hidden");
      elResult.classList.remove("hidden");
      badgeStatus.textContent = "Đã nộp";
      badgeStatus.className = "badge badge-ok";

      // Tính điểm
      const total = state.quizQuestions.length;
      let correct = 0, wrong = 0, blank = 0;
      state.quizQuestions.forEach(q => {
        const a = state.userAnswers[q.id];
        if (a == null) blank++;
        else if (a === q.answer) correct++;
        else wrong++;
      });
      const score = Math.round((correct/total)*100);

      const durationSec = (state.finishedAt && state.startedAt) ? Math.max(1, Math.round((state.finishedAt - state.startedAt)/1000)) : null;
      const h = (dur) => {
        const mm = Math.floor(dur/60), ss = dur%60;
        return `${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
      };

      resultSummary.innerHTML = `
        <span class="mr-2">Điểm: <b>${score}</b>/100</span>
        <span class="badge ${correct>0?'badge-ok':''} mr-1">Đúng: ${correct}</span>
        <span class="badge ${wrong>0?'badge-bad':''} mr-1">Sai: ${wrong}</span>
        <span class="badge ${blank>0?'badge-warn':''}">Chưa làm: ${blank}</span>
        ${durationSec ? `<span class="ml-2 text-gray-500">Thời gian: ${h(durationSec)}</span>` : ""}
      `;

      // Danh sách review
      reviewList.innerHTML = "";
      state.quizQuestions.forEach((q, idx) => {
        const card = document.createElement("div");
        card.className = "border rounded-2xl p-4";
        const your = state.userAnswers[q.id];

        const head = document.createElement("div");
        head.className = "mb-2 flex items-center gap-2";
        const tag = document.createElement("span");
        tag.className = "px-2 py-1 rounded-lg text-xs font-semibold";
        if (your == null) tag.className += " bg-amber-100 text-amber-800", tag.textContent = "Chưa trả lời";
        else if (your === q.answer) tag.className += " bg-emerald-100 text-emerald-800", tag.textContent = "Đúng";
        else tag.className += " bg-rose-100 text-rose-800", tag.textContent = "Sai";

        const tt = document.createElement("div");
        tt.className = "font-medium";
        tt.textContent = `Câu ${idx+1}. ${q.text}`;

        head.append(tag, tt);

        const opts = document.createElement("div");
        opts.className = "mt-2 grid gap-2";
        q.options.forEach((t, i) => {
          const row = document.createElement("div");
          row.className = "border rounded-xl p-2";
          row.textContent = t;

          if (state.showCorrect) {
            if (i === q.answer) row.classList.add("opt-correct");
            if (your != null && i === your && your !== q.answer) row.classList.add("opt-wrong");
          } else {
            if (your != null && i === your) row.classList.add(your === q.answer ? "opt-correct":"opt-wrong");
          }
          opts.appendChild(row);
        });

        card.append(head, opts);
        reviewList.appendChild(card);
      });

      // Bật export để xuất kết quả
      btnExport.disabled = false;
    }

    function highlightCurrentChip(qid) {
      $$(".qchip", navQuestions).forEach(el => el.classList.remove("qchip-current"));
      const el = $$(`.qchip`, navQuestions).find(x => x.dataset.qid === qid);
      if (el) el.classList.add("qchip-current");
    }

    function updateChipStatus(qid) {
      const chip = $$(`.qchip`, navQuestions).find(x => x.dataset.qid === qid);
      if (!chip) return;
      // khi đang làm (chưa chấm) chỉ hiển thị đã chọn hay chưa
      const picked = state.userAnswers[qid];
      chip.classList.remove("qchip-unanswered","qchip-answered","qchip-correct","qchip-wrong");
      chip.classList.add(picked == null ? "qchip-unanswered" : "qchip-answered");
    }

    function updateTimerBadge() {
      const s = Math.max(0, state.timer.remainSec|0);
      const mm = String(Math.floor(s/60)).padStart(2,"0");
      const ss = String(s%60).padStart(2,"0");
      badgeTimer.textContent = `⏳ ${mm}:${ss}`;
      if (s <= 10) {
        badgeTimer.classList.add("animate-pulse");
      } else {
        badgeTimer.classList.remove("animate-pulse");
      }
    }

    // ====== Flow ======
    function startQuiz({ subjectId, countMode, minutes, shuffleQ, shuffleA, fromDraft=false }) {
      const subj = state.subjects.find(s => s.id === subjectId);
      if (!subj) { alert("Không tìm thấy môn học."); return; }

      state.step = "running";
      state.subjectId = subj.id;
      state.subjectName = subj.name;
      state.allQuestions = subj.questions.slice();
      state.settings.shuffleQ = !!shuffleQ;
      state.settings.shuffleA = !!shuffleA;
      state.userAnswers = fromDraft ? (loadDraft()?.answers || {}) : {};
      state.showCorrect = false;

      // chọn số câu
      let pool = state.allQuestions.slice();
      if (shuffleQ) pool = shuffle(pool);
      let pickN = 20;
      if (countMode === "all") pickN = pool.length;
      else pickN = Math.min(parseInt(countMode || "20", 10), pool.length);
      state.quizQuestions = pool.slice(0, pickN).map(q => {
        // clone q và trộn đáp án (nếu cần)
        const clone = { ...q, options: q.options.slice(), answer: q.answer };
        if (shuffleA) {
          const idx = clone.options.map((_, i) => i);
          const perm = shuffle(idx);
          const newOpts = perm.map(i => clone.options[i]);
          const newAns = perm.findIndex(i => i === clone.answer);
          clone.options = newOpts;
          clone.answer = newAns;
        }
        return clone;
      });

      // Timer
      const totalSec = minutes ? Math.max(1, parseInt(minutes, 10)) * 60 : 0;
      state.timer.enabled = totalSec > 0;
      state.timer.totalSec = totalSec;
      state.timer.remainSec = totalSec;
      if (state.timer.tickH) clearInterval(state.timer.tickH);
      if (state.timer.enabled) {
        state.timer.tickH = setInterval(() => {
          state.timer.remainSec--;
          updateTimerBadge();
          if (state.timer.remainSec <= 0) {
            clearInterval(state.timer.tickH);
            autoSubmit("Hết giờ — hệ thống đã tự nộp bài.");
          }
        }, 1000);
      }

      state.startedAt = fromDraft && loadDraft()?.startedAt ? new Date(loadDraft().startedAt) : new Date();
      state.finishedAt = null;

      saveDraft(); // snapshot lúc bắt đầu
      renderQuiz();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function submitQuiz() {
      // Kiểm tra câu chưa làm
      const blanks = state.quizQuestions.filter(q => state.userAnswers[q.id] == null).length;
      if (blanks > 0) {
        const ok = confirm(`Bạn còn ${blanks} câu chưa trả lời. Vẫn nộp bài?`);
        if (!ok) return;
      }
      state.finishedAt = new Date();
      state.step = "submitted";
      if (state.timer.tickH) clearInterval(state.timer.tickH);

      // Xoá draft để không nhầm lẫn lần sau
      clearDraft();

      renderResult();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function autoSubmit(msg) {
      state.finishedAt = new Date();
      state.step = "submitted";
      clearDraft();
      alert(msg);
      renderResult();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function retrySameQuiz() {
      // giữ nguyên bộ câu hiện tại, chỉ reset lời giải
      state.step = "running";
      state.userAnswers = {};
      state.showCorrect = false;
      state.startedAt = new Date();
      state.finishedAt = null;
      // reset timer nếu có
      if (state.timer.enabled) {
        state.timer.remainSec = state.timer.totalSec;
        if (state.timer.tickH) clearInterval(state.timer.tickH);
        state.timer.tickH = setInterval(() => {
          state.timer.remainSec--;
          updateTimerBadge();
          if (state.timer.remainSec <= 0) {
            clearInterval(state.timer.tickH);
            autoSubmit("Hết giờ — hệ thống đã tự nộp bài.");
          }
        }, 1000);
      }

      renderQuiz();
      saveDraft();
    }

    function newQuizSameSubject() {
      state.showCorrect = false;
      startQuiz({
        subjectId: state.subjectId,
        countMode: selCount.value,
        minutes: inpMinutes.value,
        shuffleQ: chkShuffleQ.checked,
        shuffleA: chkShuffleA.checked,
        fromDraft: false
      });
    }

    // ====== Draft (localStorage) ======
    function saveDraft() {
      const data = {
        step: state.step,
        subjectId: state.subjectId,
        subjectName: state.subjectName,
        questionIds: state.quizQuestions.map(q => q.id),
        answers: state.userAnswers,
        startedAt: state.startedAt ? state.startedAt.toISOString() : null,
        timer: { enabled: state.timer.enabled, totalSec: state.timer.totalSec, remainSec: state.timer.remainSec },
        settings: state.settings
      };
      try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch {}
    }
    function loadDraft() {
      try {
        const s = localStorage.getItem(LS_KEY);
        if (!s) return null;
        return JSON.parse(s);
      } catch { return null; }
    }
    function clearDraft() {
      try { localStorage.removeItem(LS_KEY); } catch {}
    }
    function restoreDraft() {
      const d = loadDraft();
      if (!d) return false;
      // Khớp môn
      const subj = state.subjects.find(s => s.id === d.subjectId);
      if (!subj) return false;

      // Map lại câu hỏi theo IDs đã lưu
      const mapById = new Map(subj.questions.map(q => [q.id, q]));
      const restored = [];
      for (const qid of d.questionIds || []) {
        const q0 = mapById.get(qid);
        if (!q0) continue;
        // Khôi phục đúng thứ tự & đáp án (không re-shuffle)
        restored.push({ ...q0 });
      }
      if (!restored.length) return false;

      state.step = "running";
      state.subjectId = subj.id;
      state.subjectName = subj.name;
      state.allQuestions = subj.questions.slice();
      state.quizQuestions = restored;
      state.userAnswers = d.answers || {};
      state.startedAt = d.startedAt ? new Date(d.startedAt) : new Date();
      state.finishedAt = null;
      state.settings = d.settings || state.settings;
      state.showCorrect = false;

      // Timer
      state.timer.enabled = d.timer?.enabled || false;
      state.timer.totalSec = d.timer?.totalSec || 0;
      state.timer.remainSec = d.timer?.remainSec || 0;
      if (state.timer.tickH) clearInterval(state.timer.tickH);
      if (state.timer.enabled && state.timer.remainSec > 0) {
        state.timer.tickH = setInterval(() => {
          state.timer.remainSec--;
          updateTimerBadge();
          if (state.timer.remainSec <= 0) {
            clearInterval(state.timer.tickH);
            autoSubmit("Hết giờ — hệ thống đã tự nộp bài.");
          }
        }, 1000);
      }

      renderQuiz();
      return true;
    }

    // ====== Export / Print ======
    function exportResultJSON() {
      const payload = {
        metadata: {
          app: "Pro Quiz",
          version: 1,
          exportedAt: new Date().toISOString()
        },
        subject: { id: state.subjectId, name: state.subjectName },
        startedAt: state.startedAt,
        finishedAt: state.finishedAt,
        settings: state.settings,
        timer: { enabled: state.timer.enabled, totalSec: state.timer.totalSec },
        questions: state.quizQuestions.map((q, idx) => ({
          order: idx + 1,
          id: q.id,
          text: q.text,
          options: q.options,
          correctIndex: q.answer,
          userIndex: state.userAnswers[q.id] ?? null
        }))
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
      a.download = `ket-qua-${state.subjectId}-${stamp}.json`;
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    // ====== Event bindings ======
    btnStart.onclick = () => {
      startQuiz({
        subjectId: selSubject.value,
        countMode: selCount.value,
        minutes: inpMinutes.value,
        shuffleQ: chkShuffleQ.checked,
        shuffleA: chkShuffleA.checked,
        fromDraft: false
      });
    };
    btnRestore.onclick = () => { restoreDraft(); };

    btnSave.onclick = () => {
      saveDraft();
      badgeStatus.textContent = "Đã lưu tạm";
      badgeStatus.className = "badge bg-blue-100 text-blue-800";
      setTimeout(() => {
        badgeStatus.textContent = "Đang làm";
        badgeStatus.className = "badge bg-gray-100 text-gray-800";
      }, 1200);
    };

    btnSubmit.onclick = () => submitQuiz();
    btnRetry.onclick = () => retrySameQuiz();
    btnNew.onclick = () => newQuizSameSubject();
    btnChange.onclick = () => {
      state.step = "setup";
      if (state.timer.tickH) clearInterval(state.timer.tickH);
      renderSetup();
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
    btnShowCorrect.onclick = () => {
      state.showCorrect = !state.showCorrect;
      btnShowCorrect.textContent = state.showCorrect ? "Ẩn đáp án đúng" : "Hiện đáp án đúng";
      renderResult();
    };

    btnExport.onclick = () => exportResultJSON();
    btnPrint.onclick = () => window.print();

    // ====== Boot ======
    function boot() {
      state.subjects = loadSubjects();
      if (!state.subjects.length) {
        alert("Không tải được dữ liệu câu hỏi. Hãy kiểm tra data.js.");
        return;
      }
      renderSetup();

      // Nếu có draft sẵn và người dùng tick “cho phép tiếp tục”
      const draft = loadDraft();
      if (draft && chkContinue.checked) {
        btnRestore.classList.remove("hidden");
      }
    }
    boot();

    // Bảo đảm không bao giờ “tự nhảy đề” sau khi nộp:
    // Chúng ta KHÔNG gọi startQuiz() trong submitQuiz(), chỉ renderResult().
  })();
  </script>
</body>
</html>
