<!--
üì¶ Quiz Pro UI ‚Äî gi·ªØ nguy√™n data.js
- ƒê·∫∑t c√°c file n√†y c√πng th∆∞ m·ª•c v·ªõi data.js c·ªßa b·∫°n.
- KH√îNG s·ª≠a data.js. Ch·ªâ th√™m c√°c file b√™n d∆∞·ªõi.
- M·ªü index.html ƒë·ªÉ ch·∫°y. C√≥ PWA (offline), seed, l·ªãch s·ª≠, QA, practice/exam, progress bar, ph√≠m t·∫Øt.

C·∫•u tr√∫c:
  index.html
  styles.css
  parser.js
  store.js
  app.js
  manifest.json
  service-worker.js
  data.js   (gi·ªØ nguy√™n nh∆∞ b·∫°n cung c·∫•p)

-->

<!-- ======================== index.html ======================== -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Pro ‚Äî Luy·ªán/Thi tr·∫Øc nghi·ªám</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <span class="logo">üéØ</span>
      <div class="titles">
        <h1>Quiz Pro</h1>
        <p class="subtitle">Luy·ªán/Thi tr·∫Øc nghi·ªám ‚Äî m∆∞·ª£t, ch√≠nh x√°c, offline</p>
      </div>
    </div>
    <nav class="top-actions">
      <button id="btnTabQuiz" class="tab-btn active">L√†m b√†i</button>
      <button id="btnTabHistory" class="tab-btn">L·ªãch s·ª≠</button>
      <button id="btnTabQA" class="tab-btn">Ng√¢n h√†ng</button>
      <button id="btnInstall" class="ghost">C√†i ·ª©ng d·ª•ng</button>
      <a id="btnHelp" class="ghost" href="#help">Tr·ª£ gi√∫p</a>
    </nav>
  </header>

  <main id="main">
    <!-- ========== TAB: QUIZ / SETUP ========== -->
    <section id="tab-quiz" class="tab active">
      <div id="setup" class="card">
        <div class="grid grid-2">
          <div>
            <label for="selSubject">M√¥n h·ªçc</label>
            <select id="selSubject"></select>
            <small id="subjectInfo" class="muted"></small>
          </div>
          <div>
            <label for="numQuestions">S·ªë c√¢u</label>
            <input id="numQuestions" type="number" min="1" step="1" placeholder="vd. 20" />
            <small class="muted">ƒê·ªÉ tr·ªëng = d√πng t·∫•t c·∫£ c√¢u h·ª£p l·ªá</small>
          </div>
          <div>
            <label for="selMode">Ch·∫ø ƒë·ªô</label>
            <select id="selMode">
              <option value="practice">Luy·ªán t·∫≠p (hi·ªán ƒë√∫ng/sai ngay)</option>
              <option value="exam">Thi (·∫©n ƒë√°p √°n t·ªõi khi n·ªôp)</option>
            </select>
          </div>
          <div class="flex-row">
            <label class="switch">
              <input id="chkShuffleOptions" type="checkbox" checked />
              <span class="slider"></span>
            </label>
            <span>ƒê·∫£o th·ª© t·ª± ƒë√°p √°n</span>
          </div>
          <div class="flex-row">
            <label class="switch">
              <input id="chkTimer" type="checkbox" />
              <span class="slider"></span>
            </label>
            <span>B·∫≠t h·∫πn gi·ªù</span>
          </div>
          <div id="timerBox" class="hidden">
            <label for="timerMinutes">Th·ªùi gian (ph√∫t)</label>
            <input id="timerMinutes" type="number" min="1" step="1" value="30" />
          </div>
        </div>
        <div class="setup-actions">
          <button id="btnStart" class="primary">B·∫Øt ƒë·∫ßu</button>
          <button id="btnSeedLink" class="ghost" title="Sao ch√©p link c√πng ƒë·ªÅ (seed)">Sao ch√©p link ƒë·ªÅ</button>
          <span id="copyToast" class="toast hidden">ƒê√£ sao ch√©p!</span>
        </div>
        <details class="help">
          <summary>Ph√≠m t·∫Øt & m·∫πo</summary>
          <ul>
            <li><b>1/2/3/4</b> ch·ªçn ƒë√°p √°n A/B/C/D</li>
            <li><b>‚Üê/‚Üí</b> chuy·ªÉn c√¢u tr∆∞·ªõc/sau</li>
            <li><b>Enter</b> n·ªôp b√†i (khi ƒë√£ tr·∫£ l·ªùi ƒë·ªß)</li>
            <li><b>R</b> l√†m l·∫°i ƒë·ªÅ v·ªõi c√πng seed</li>
          </ul>
        </details>
      </div>

      <div id="exam" class="hidden">
        <div class="exam-top">
          <div class="pill" id="pillSubject">‚Äî</div>
          <div class="pill" id="pillMode">‚Äî</div>
          <div class="pill" id="pillSeed">seed: ‚Äî</div>
          <div id="timer" class="timer hidden">00:00</div>
        </div>

        <div class="progress">
          <div id="progressBar" class="progress-bar" style="width:0%"></div>
          <div id="progressText" class="progress-text">0/0</div>
        </div>

        <div class="exam-body">
          <aside class="question-nav" id="questionNav"></aside>
          <article class="question-area">
            <div id="qNumber" class="q-number">C√¢u 1</div>
            <div id="qText" class="q-text"></div>
            <form id="options" class="options"></form>
            <div id="feedback" class="feedback"></div>
            <div class="q-actions">
              <button id="btnPrev" class="ghost">‚Üê Tr∆∞·ªõc</button>
              <button id="btnNext" class="ghost">Sau ‚Üí</button>
              <div class="spacer"></div>
              <button id="btnSubmit" class="primary">N·ªôp b√†i</button>
            </div>
          </article>
        </div>
      </div>

      <div id="result" class="hidden card">
        <div class="result-head">
          <h2>K·∫øt qu·∫£</h2>
          <div class="result-stats">
            <div><span class="muted">M√¥n:</span> <b id="resSubject">‚Äî</b></div>
            <div><span class="muted">Ch·∫ø ƒë·ªô:</span> <b id="resMode">‚Äî</b></div>
            <div><span class="muted">Seed:</span> <b id="resSeed">‚Äî</b></div>
            <div><span class="muted">ƒêi·ªÉm:</span> <b id="resScore">‚Äî</b></div>
            <div><span class="muted">Th·ªùi gian:</span> <b id="resTime">‚Äî</b></div>
          </div>
        </div>
        <div class="result-actions">
          <button id="btnReplay" class="secondary">L√†m l·∫°i ƒë·ªÅ n√†y</button>
          <button id="btnNew" class="primary">ƒê·ªÅ m·ªõi</button>
          <button id="btnReviewWrong" class="ghost">Xem c√¢u sai</button>
          <button id="btnExportCSV" class="ghost">Xu·∫•t CSV</button>
        </div>
        <div id="review" class="review hidden"></div>
      </div>
    </section>

    <!-- ========== TAB: HISTORY ========== -->
    <section id="tab-history" class="tab">
      <div class="card">
        <h2>L·ªãch s·ª≠ l√†m b√†i</h2>
        <div id="historyList" class="history-list"></div>
        <div class="history-actions">
          <button id="btnClearHistory" class="danger">Xo√° to√†n b·ªô l·ªãch s·ª≠</button>
        </div>
      </div>
    </section>

    <!-- ========== TAB: QA ========== -->
    <section id="tab-qa" class="tab">
      <div class="card">
        <h2>Ng√¢n h√†ng c√¢u h·ªèi (QA)</h2>
        <div id="qaSummary" class="qa-summary"></div>
        <details>
          <summary>Chi ti·∫øt l·ªói parse</summary>
          <div id="qaDetails" class="qa-details"></div>
        </details>
      </div>
    </section>
  </main>

  <!-- ====== Templates (for cloning) ====== -->
  <template id="tplNavBtn">
    <button class="nav-btn">1</button>
  </template>
  <template id="tplOption">
    <label class="option">
      <input type="radio" name="opt" />
      <span class="opt-text"></span>
    </label>
  </template>

  <footer class="app-footer">
    <span>¬© Quiz Pro ‚Äî ch·∫°y thu·∫ßn tr√¨nh duy·ªát, PWA offline</span>
    <a href="#about">v·ªÅ s·∫£n ph·∫©m</a>
  </footer>

  <!-- data.js (nguy√™n b·∫£n) ph·∫£i load tr∆∞·ªõc parser/app -->
  <script src="./data.js"></script>
  <script src="./parser.js"></script>
  <script src="./store.js"></script>
  <script src="./app.js"></script>
</body>
</html>


/* ======================== styles.css ======================== */
:root{
  --bg:#0b1020;
  --card:#12192e;
  --muted:#9aa3b2;
  --text:#e5e7eb;
  --acc:#6ee7ff;
  --acc2:#a78bfa;
  --ok:#22c55e;
  --warn:#f59e0b;
  --err:#ef4444;
  --border:#223054;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0e1430 40%,#0b1020);color:var(--text)}

.app-header{position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);background:rgba(11,16,32,.7)}
.brand{display:flex;gap:12px;align-items:center}
.brand .logo{font-size:24px}
.titles h1{font-size:18px;margin:0}
.titles .subtitle{margin:0;color:var(--muted);font-size:12px}
.top-actions{display:flex;gap:8px;align-items:center}
.tab-btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0e1430;color:var(--text);cursor:pointer}
.tab-btn.active{border-color:var(--acc);box-shadow:0 0 0 2px rgba(110,231,255,.15)}
.ghost{padding:8px 12px;border-radius:10px;background:transparent;border:1px dashed var(--border);color:var(--muted);cursor:pointer}
.primary{padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--acc),var(--acc2));color:#0b1020;font-weight:700;cursor:pointer}
.secondary{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#162038;color:var(--text);cursor:pointer}
.danger{padding:10px 14px;border-radius:12px;border:1px solid #6b2734;background:#2f141a;color:#ffb4c2;cursor:pointer}

main{max-width:1100px;margin:24px auto;padding:0 16px}
.tab{display:none}
.tab.active{display:block}

.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 40px rgba(0,0,0,.25)}
.grid{display:grid;gap:16px}
.grid-2{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
label{display:block;margin-bottom:6px;color:var(--muted)}
input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1630;color:var(--text)}
.small{font-size:12px}
.muted{color:var(--muted)}
.hidden{display:none}
.flex-row{display:flex;align-items:center;gap:10px}
.setup-actions{margin-top:12px;display:flex;gap:10px;align-items:center}
.toast{font-size:12px;color:#0b1020;background:#a7f3d0;padding:6px 8px;border-radius:8px}

.switch{position:relative;display:inline-block;width:44px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#334155;border-radius:999px;transition:.2s}
.slider:before{content:"";position:absolute;height:18px;width:18px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s}
.switch input:checked + .slider{background:linear-gradient(90deg,var(--acc),var(--acc2))}
.switch input:checked + .slider:before{transform:translateX(20px)}

.help summary{cursor:pointer;margin-top:8px}

.exam-top{display:flex;gap:8px;align-items:center;margin:12px 0}
.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1630;color:var(--muted)}
.timer{margin-left:auto;padding:6px 10px;border-radius:10px;background:#1c243f;border:1px solid var(--border);font-variant-numeric:tabular-nums}

.progress{position:relative;height:14px;background:#0d1330;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.progress-bar{height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2));transition:width .25s ease}
.progress-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;color:#0b1020;font-weight:700;mix-blend-mode:overlay}

.exam-body{display:grid;grid-template-columns:220px 1fr;gap:16px;margin-top:16px}
.question-nav{background:#0f1630;border:1px solid var(--border);border-radius:14px;padding:10px;max-height:65vh;overflow:auto}
.nav-btn{display:inline-flex;align-items:center;justify-content:center;width:44px;height:36px;margin:4px;border-radius:10px;border:1px solid var(--border);background:#0c122a;color:var(--muted);cursor:pointer}
.nav-btn.active{background:#18224a;color:#fff;border-color:var(--acc)}
.nav-btn.answered{color:#c7f9cc;border-color:#2a7f50;background:#113123}

.q-number{font-size:14px;color:var(--muted);margin-bottom:6px}
.q-text{font-size:18px;line-height:1.45;margin-bottom:10px;white-space:pre-wrap}
.options{display:grid;gap:10px}
.option{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--border);border-radius:12px;background:#101632;cursor:pointer}
.option input{margin-top:3px}
.option.correct{border-color:#1f6d3c;background:#0f2a1d}
.option.wrong{border-color:#7a1f2a;background:#2a0f12}
.feedback{min-height:18px;margin-top:8px;color:#a7f3d0}
.q-actions{display:flex;gap:8px;align-items:center;margin-top:12px}
.spacer{flex:1}

.result-head{display:flex;align-items:center;justify-content:space-between}
.result-stats{display:flex;gap:16px;flex-wrap:wrap}
.result-actions{display:flex;gap:10px;margin:12px 0}
.review .rev-item{border-top:1px dashed var(--border);padding:10px 0}
.rev-q{white-space:pre-wrap}
.rev-meta{font-size:12px;color:var(--muted)}

.history-list .hist{border-top:1px dashed var(--border);padding:10px 0;display:grid;grid-template-columns:1fr auto;gap:8px}
.hist .actions{display:flex;gap:8px}

.qa-summary{display:grid;gap:8px}
.qa-card{border:1px solid var(--border);border-radius:12px;padding:10px;background:#101632}
.qa-details .err{border-top:1px dashed var(--border);padding:8px 0;color:#fecaca}

.app-footer{margin:24px auto 48px;max-width:1100px;padding:0 16px;display:flex;justify-content:space-between;color:var(--muted)}

@media (max-width: 860px){
  .exam-body{grid-template-columns:1fr}
  .question-nav{order:2}
}




/* ======================== store.js ======================== */
(function(){
  const KEY = 'quizpro.v1';

  function load(){
    try { return JSON.parse(localStorage.getItem(KEY)||'{}'); } catch { return {}; }
  }
  function save(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }

  function up(path, value){
    const s = load();
    const segs = path.split('.');
    let cur = s;
    for(let i=0;i<segs.length-1;i++){ cur = cur[segs[i]] = cur[segs[i]] || {}; }
    cur[segs[segs.length-1]] = value;
    save(s);
  }

  function pushHistory(item){
    const s = load();
    s.history = s.history || [];
    s.history.unshift(item);
    s.history = s.history.slice(0,200); // gi·ªØ 200 b·∫£n ghi g·∫ßn nh·∫•t
    save(s);
  }

  function clearHistory(){
    const s = load();
    s.history = [];
    save(s);
  }

  function getHistory(){ return (load().history)||[]; }

  // l∆∞u ‚Äúc√¢u sai‚Äù ƒë·ªÉ √¥n t·∫≠p
  function rememberWrong(subject, question){
    const s = load();
    s.wrong = s.wrong || {};
    const arr = s.wrong[subject] = s.wrong[subject] || [];
    // tr√°nh tr√πng n·ªôi dung qu√° d√†i -> hash ƒë∆°n gi·∫£n
    const id = hash(question.q + '|' + question.options.join('|'));
    if(!arr.find(x=>x.id===id)) arr.push({id, question});
    save(s);
  }
  function getWrong(subject){ return ((load().wrong||{})[subject])||[]; }

  // hash nh·∫π
  function hash(str){
    let h = 2166136261>>>0;
    for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
    return (h>>>0).toString(36);
  }

  window.quizStore = { load, up, pushHistory, clearHistory, getHistory, rememberWrong, getWrong };
})();


/* ======================== app.js ======================== */
(function(){
  // ====== Utils ======
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const escapeHTML = (s)=> s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));

  // RNG c√≥ seed
  function mulberry32(a){ return function(){ let t = a += 0x6D2B79F5; t = Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; } }
  function seedFrom(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h = Math.imul(h ^ str.charCodeAt(i), 3432918353); h = (h<<13)|(h>>>19);} return h>>>0; }
  function shuffle(arr, rnd){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()* (i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  // ====== State ======
  let BANK = [];// [{subject, items}]
  let QA = null;

  let attempt = null; // tr·∫°ng th√°i ƒë·ªÅ hi·ªán t·∫°i
  // attempt shape
  // { subject, mode, seed, idxs:[], questions:[], answers:[], startedAt, timerSec, timeUsedSec, done }

  // ====== Init ======
  window.addEventListener('DOMContentLoaded', () => {
    try{
      const parsed = window.quizParser.parseAll();
      BANK = parsed.data; QA = parsed.qa;
    }catch(e){
      alert('L·ªói parse data.js ‚Äî vui l√≤ng ki·ªÉm tra l·∫°i file.');
      console.error(e);
      return;
    }

    buildSubjectSelect();
    renderQASummary();
    hookTabs();
    hookSetup();
    hookExam();
    hookHistory();
    registerPWA();

    // ƒë·ªçc seed t·ª´ URL
    applyURLSeed();
  });

  // ====== Tabs ======
  function hookTabs(){
    const btnQuiz = $('#btnTabQuiz');
    const btnHistory = $('#btnTabHistory');
    const btnQA = $('#btnTabQA');

    btnQuiz.addEventListener('click',()=>setTab('quiz'));
    btnHistory.addEventListener('click',()=>{ setTab('history'); renderHistory(); });
    btnQA.addEventListener('click',()=>setTab('qa'));
  }
  function setTab(name){
    $$('.tab').forEach(x=>x.classList.remove('active'));
    $('#tab-'+name).classList.add('active');
    $$('.tab-btn').forEach(x=>x.classList.remove('active'));
    $('#btnTab'+name[0].toUpperCase()+name.slice(1)).classList.add('active');
  }

  // ====== Setup view ======
  function buildSubjectSelect(){
    const sel = $('#selSubject');
    sel.innerHTML = '';
    BANK.forEach((s, i)=>{
      const valid = s.items.length;
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `${s.subject} ‚Äî ${valid} c√¢u`;
      sel.appendChild(opt);
    });
    sel.addEventListener('change', ()=> updateSubjectInfo());
    updateSubjectInfo();
  }
  function updateSubjectInfo(){
    const s = BANK[$('#selSubject').value|0];
    const qa = QA.subjects.find(x=>x.subject===s.subject) || {totalBlocks:0,valid:0,invalid:0};
    $('#subjectInfo').textContent = `ƒê√£ parse: ${qa.valid}/${qa.totalBlocks} c√¢u h·ª£p l·ªá` + (qa.invalid?` ‚Äî b·ªè qua ${qa.invalid} c√¢u l·ªói`:'');
  }

  function hookSetup(){
    $('#chkTimer').addEventListener('change', (e)=>{
      $('#timerBox').classList.toggle('hidden', !e.target.checked);
    });

    $('#btnSeedLink').addEventListener('click', ()=>{
      if(!attempt){
        const subjectIx = $('#selSubject').value|0;
        const mode = $('#selMode').value;
        const n = ($('#numQuestions').value||'').trim();
        const seed = genSeed();
        const url = makeSeedURL({subjectIx, mode, n, seed});
        copyText(url);
        toastCopy();
      } else {
        const url = makeSeedURL({subjectIx: attempt.subjectIx, mode: attempt.mode, n: attempt.questions.length, seed: attempt.seed});
        copyText(url); toastCopy();
      }
    });

    $('#btnStart').addEventListener('click', startExamFromUI);
  }

  function makeSeedURL({subjectIx, mode, n, seed}){
    const url = new URL(location.href);
    url.searchParams.set('subject', subjectIx);
    url.searchParams.set('mode', mode);
    if(n) url.searchParams.set('n', n);
    url.searchParams.set('seed', seed);
    return url.toString();
  }

  function applyURLSeed(){
    const url = new URL(location.href);
    const subjectIx = url.searchParams.get('subject');
    const mode = url.searchParams.get('mode');
    const n = url.searchParams.get('n');
    const seed = url.searchParams.get('seed');
    if(subjectIx!==null && seed){
      $('#selSubject').value = subjectIx;
      if(mode) $('#selMode').value = mode;
      if(n) $('#numQuestions').value = n;
      startExam({ subjectIx: subjectIx|0, mode: $('#selMode').value, n: (n?parseInt(n,10):undefined), seed });
      setTab('quiz');
      $('#setup').scrollIntoView({behavior:'smooth'});
    }
  }

  function startExamFromUI(){
    const subjectIx = $('#selSubject').value|0;
    const mode = $('#selMode').value;
    const n = parseInt($('#numQuestions').value,10) || undefined;
    const seed = genSeed();
    startExam({subjectIx, mode, n, seed});
  }

  function genSeed(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,6)); }

  function startExam({subjectIx, mode, n, seed}){
    const subj = BANK[subjectIx];
    const total = subj.items.length;
    const count = Math.min(n||total, total);
    const rnd = mulberry32(seedFrom(seed+'|pick'));
    const idxs = shuffle([...Array(total).keys()], rnd).slice(0, count);

    const shuffleOpts = $('#chkShuffleOptions').checked;
    const items = idxs.map(i=>subj.items[i]).map(q=>{
      if(!shuffleOpts) return {...q};
      const rnd2 = mulberry32(seedFrom(seed+'|opt|'+q.q));
      const ord = shuffle(q.options.map((_,i)=>i), rnd2);
      const options = ord.map(i=>q.options[i]);
      const correctIndex = ord.indexOf(q.correctIndex);
      return { q: q.q, options, correctIndex };
    });

    const timerSec = $('#chkTimer').checked ? (parseInt($('#timerMinutes').value,10)||30)*60 : null;

    attempt = {
      subjectIx, subject: subj.subject, mode, seed,
      idxs, questions: items,
      answers: new Array(count).fill(null),
      cur: 0,
      startedAt: Date.now(),
      timerSec, timeUsedSec: 0, done:false,
    };

    // UI
    $('#setup').classList.add('hidden');
    $('#result').classList.add('hidden');
    $('#exam').classList.remove('hidden');

    $('#pillSubject').textContent = subj.subject;
    $('#pillMode').textContent = mode==='exam' ? 'Ch·∫ø ƒë·ªô: Thi' : 'Ch·∫ø ƒë·ªô: Luy·ªán';
    $('#pillSeed').textContent = 'seed: '+seed;

    // Progress
    updateProgress();

    // Question nav
    buildQuestionNav();

    // render current
    renderQuestion();

    // Timer
    if(attempt.timerSec){ $('#timer').classList.remove('hidden'); startTimer(); }
    else $('#timer').classList.add('hidden');

    // keyboard
    bindHotkeys();
  }

  function buildQuestionNav(){
    const nav = $('#questionNav');
    nav.innerHTML = '';
    const tpl = $('#tplNavBtn');
    attempt.questions.forEach((_,i)=>{
      const btn = tpl.content.firstElementChild.cloneNode(true);
      btn.textContent = i+1;
      btn.addEventListener('click', ()=> goto(i));
      nav.appendChild(btn);
    });
    updateNavState();
  }

  function goto(i){ attempt.cur = i; renderQuestion(); }

  function updateNavState(){
    const nav = $('#questionNav');
    const btns = $$('.nav-btn', nav);
    btns.forEach((b,i)=>{
      b.classList.toggle('active', i===attempt.cur);
      b.classList.toggle('answered', attempt.answers[i]!==null);
    });
  }

  function updateProgress(){
    const total = attempt.questions.length;
    const answered = attempt.answers.filter(x=>x!==null).length;
    const pct = Math.round(answered*100/total);
    $('#progressBar').style.width = pct+'%';
    $('#progressText').textContent = `${answered}/${total}`;
  }

  function renderQuestion(){
    const i = attempt.cur;
    const q = attempt.questions[i];

    $('#qNumber').textContent = `C√¢u ${i+1}`;
    $('#qText').textContent = q.q; // textContent ƒë·ªÉ tr√°nh HTML injection

    const form = $('#options');
    form.innerHTML = '';
    const tpl = $('#tplOption');

    q.options.forEach((text,ix)=>{
      const row = tpl.content.firstElementChild.cloneNode(true);
      const input = $('input', row);
      const span = $('.opt-text', row);
      span.textContent = ['A. ','B. ','C. ','D. '][ix] + text;
      input.name = 'opt'; input.value = ix;
      input.checked = attempt.answers[i]===ix;
      input.addEventListener('change', ()=>{
        attempt.answers[i]=ix; updateNavState(); updateProgress();
        if(attempt.mode==='practice') showFeedback(ix===q.correctIndex);
        else $('#feedback').textContent = '';
      });
      if(attempt.done){
        if(ix===q.correctIndex) row.classList.add('correct');
        if(attempt.answers[i]===ix && ix!==q.correctIndex) row.classList.add('wrong');
      }
      form.appendChild(row);
    });

    // feedback (practice)
    if(attempt.mode==='practice' && attempt.answers[i]!==null){
      showFeedback(attempt.answers[i]===q.correctIndex);
    } else $('#feedback').textContent='';

    updateNavState();
  }

  function showFeedback(ok){
    $('#feedback').textContent = ok ? '‚úî Ch√≠nh x√°c!' : '‚úò Ch∆∞a ƒë√∫ng ‚Äî th·ª≠ l·∫°i nh√©!';
  }

  function hookExam(){
    $('#btnPrev').addEventListener('click', (e)=>{ e.preventDefault(); if(attempt.cur>0){attempt.cur--; renderQuestion();}});
    $('#btnNext').addEventListener('click', (e)=>{ e.preventDefault(); if(attempt.cur<attempt.questions.length-1){attempt.cur++; renderQuestion();}});
    $('#btnSubmit').addEventListener('click', (e)=>{ e.preventDefault(); submitExam(); });
  }

  function bindHotkeys(){
    window.onkeydown = (ev)=>{
      if(!attempt || $('#exam').classList.contains('hidden')) return;
      if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
      if(ev.key==='ArrowLeft'){ if(attempt.cur>0){attempt.cur--; renderQuestion();} }
      if(ev.key==='ArrowRight'){ if(attempt.cur<attempt.questions.length-1){attempt.cur++; renderQuestion();} }
      if(['1','2','3','4'].includes(ev.key)){
        const pick = parseInt(ev.key,10)-1;
        const input = $$('input[name="opt"]')[pick];
        if(input){ input.checked = true; input.dispatchEvent(new Event('change',{bubbles:true})); }
      }
      if(ev.key.toLowerCase()==='r' && attempt.done){ replaySameSeed(); }
      if(ev.key==='Enter' && !attempt.done){ submitExam(); }
    };
  }

  function submitExam(){
    if(!attempt) return;
    const total = attempt.questions.length;
    const answered = attempt.answers.filter(x=>x!==null).length;
    if(answered<total){
      if(!confirm(`B·∫°n m·ªõi tr·∫£ l·ªùi ${answered}/${total} c√¢u. V·∫´n n·ªôp b√†i?`)) return;
    }
    attempt.done = true;
    attempt.timeUsedSec = Math.floor((Date.now() - attempt.startedAt)/1000);

    // ch·∫•m ƒëi·ªÉm & l∆∞u l·ªãch s·ª≠
    const detail = attempt.questions.map((q,i)=>({
      q: q.q, options: q.options, correctIndex: q.correctIndex, picked: attempt.answers[i]
    }));
    const correct = detail.filter(d=>d.picked===d.correctIndex).length;
    const score = Math.round(correct*100/total);

    // l∆∞u c√¢u sai cho √¥n t·∫≠p
    detail.forEach(d=>{ if(d.picked!==d.correctIndex) quizStore.rememberWrong(attempt.subject, {q:d.q, options:d.options, correctIndex:d.correctIndex}); });

    quizStore.pushHistory({
      ts: Date.now(), subject: attempt.subject, subjectIx: attempt.subjectIx,
      mode: attempt.mode, seed: attempt.seed, n: total,
      correct, score, timeUsedSec: attempt.timeUsedSec
    });

    // hi·ªán k·∫øt qu·∫£
    showResult({correct, score, total, detail});

    // kho√° UI c√¢u h·ªèi: hi·ªÉn th·ªã ƒë√∫ng/sai
    renderQuestion();
  }

  function showResult({correct, score, total, detail}){
    $('#exam').classList.add('hidden');
    const mins = Math.floor(attempt.timeUsedSec/60).toString().padStart(2,'0');
    const secs = (attempt.timeUsedSec%60).toString().padStart(2,'0');

    $('#resSubject').textContent = attempt.subject;
    $('#resMode').textContent = attempt.mode==='exam'?'Thi':'Luy·ªán';
    $('#resSeed').textContent = attempt.seed;
    $('#resScore').textContent = `${correct}/${total} ‚Äî ${score}%`;
    $('#resTime').textContent = `${mins}:${secs}`;

    $('#result').classList.remove('hidden');

    // actions
    $('#btnReplay').onclick = replaySameSeed;
    $('#btnNew').onclick = ()=>{ location.href = location.origin + location.pathname; };
    $('#btnReviewWrong').onclick = ()=> renderReview(detail, 'wrong');
    $('#btnExportCSV').onclick = ()=> exportCSV(detail);
  }

  function replaySameSeed(){
    if(!attempt) return;
    startExam({subjectIx: attempt.subjectIx, mode: attempt.mode, n: attempt.questions.length, seed: attempt.seed});
  }

  function renderReview(detail, filter){
    const box = $('#review');
    box.innerHTML='';
    const pool = filter==='wrong' ? detail.filter(d=>d.picked!==d.correctIndex) : detail;
    pool.forEach((d,i)=>{
      const div = document.createElement('div');
      div.className = 'rev-item';
      div.innerHTML = `
        <div class="rev-q"><b>C√¢u ${i+1}.</b> ${escapeHTML(d.q)}</div>
        <ol>
          ${d.options.map((o,ix)=>{
            const mark = ix===d.correctIndex? ' (ƒë√∫ng)' : (ix===d.picked?' (b·∫°n ch·ªçn)':'');
            return `<li>${escapeHTML(o)}<span class="rev-meta">${mark}</span></li>`;
          }).join('')}
        </ol>
      `;
      box.appendChild(div);
    });
    box.classList.remove('hidden');
  }

  function exportCSV(detail){
    const rows = [ ['index','question','A','B','C','D','correctIndex','picked'] ];
    detail.forEach((d,i)=>{
      rows.push([i+1, d.q, d.options[0]||'', d.options[1]||'', d.options[2]||'', d.options[3]||'', d.correctIndex, d.picked]);
    });
    const csv = rows.map(r=>r.map(x=>`"${(x||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `quiz-result-${attempt.subjectIx}-${attempt.seed}.csv`;
    a.click();
  }

  // ====== Timer ======
  let timerHandle = null;
  function startTimer(){
    clearInterval(timerHandle);
    let remain = attempt.timerSec;
    const tick = ()=>{
      if(attempt.done){ clearInterval(timerHandle); return; }
      remain--; if(remain<0){ clearInterval(timerHandle); submitExam(); return; }
      const m = Math.floor(remain/60).toString().padStart(2,'0');
      const s = (remain%60).toString().padStart(2,'0');
      $('#timer').textContent = `${m}:${s}`;
    };
    // set ngay l·∫≠p t·ª©c
    const m0 = Math.floor(remain/60).toString().padStart(2,'0');
    const s0 = (remain%60).toString().padStart(2,'0');
    $('#timer').textContent = `${m0}:${s0}`;
    timerHandle = setInterval(tick, 1000);
  }

  // ====== History ======
  function hookHistory(){
    $('#btnClearHistory').addEventListener('click',()=>{
      if(confirm('Xo√° to√†n b·ªô l·ªãch s·ª≠?')){ quizStore.clearHistory(); renderHistory(); }
    });
  }

  function renderHistory(){
    const host = $('#historyList');
    const his = quizStore.getHistory();
    host.innerHTML = his.length? '' : '<div class="muted">Ch∆∞a c√≥ b·∫£n ghi.</div>';
    his.forEach((h,ix)=>{
      const dt = new Date(h.ts);
      const mins = Math.floor(h.timeUsedSec/60).toString().padStart(2,'0');
      const secs = (h.timeUsedSec%60).toString().padStart(2,'0');
      const div = document.createElement('div');
      div.className = 'hist';
      div.innerHTML = `
        <div>
          <b>${h.subject}</b> ‚Ä¢ ${h.mode==='exam'?'Thi':'Luy·ªán'} ‚Ä¢ ${h.correct}/${h.n} (${h.score}%) ‚Ä¢ ${mins}:${secs}
          <div class="muted">${dt.toLocaleString()} ‚Ä¢ seed ${h.seed}</div>
        </div>
        <div class="actions">
          <button class="secondary" data-act="replay">L√†m l·∫°i</button>
          <button class="ghost" data-act="share">Link ƒë·ªÅ</button>
        </div>
      `;
      $('.actions [data-act="replay"]', div).onclick = ()=>{
        startExam({subjectIx: h.subjectIx, mode: h.mode, n: h.n, seed: h.seed}); setTab('quiz');
      };
      $('.actions [data-act="share"]', div).onclick = ()=>{
        const url = makeSeedURL({subjectIx: h.subjectIx, mode: h.mode, n: h.n, seed: h.seed});
        copyText(url); toastCopy();
      };
      host.appendChild(div);
    });
  }

  // ====== QA ======
  function renderQASummary(){
    const host = $('#qaSummary');
    host.innerHTML='';
    QA.subjects.forEach(s=>{
      const card = document.createElement('div');
      card.className = 'qa-card';
      card.innerHTML = `<b>${s.subject}</b><br/>T·ªïng block: ${s.totalBlocks} ‚Ä¢ H·ª£p l·ªá: ${s.valid} ‚Ä¢ B·ªè qua: ${s.invalid}`;
      host.appendChild(card);
    });

    const det = $('#qaDetails');
    det.innerHTML = '';
    QA.subjects.forEach(s=>{
      if(!s.errors.length) return;
      const h3 = document.createElement('h3'); h3.textContent = s.subject; det.appendChild(h3);
      s.errors.forEach(e=>{
        const d = document.createElement('div'); d.className='err';
        d.textContent = `C√¢u #${e.i}: ${e.type} ‚Äî ${e.msg}`;
        det.appendChild(d);
      });
    });
  }

  // ====== Helpers ======
  function copyText(t){ navigator.clipboard?.writeText(t).catch(()=>{}); }
  function toastCopy(){ const el = $('#copyToast'); el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'), 1100); }

  // ====== PWA ======
  function registerPWA(){
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    }
    let deferredPrompt=null; const btn = $('#btnInstall');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; btn.classList.remove('hidden'); });
    btn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const {outcome}=await deferredPrompt.userChoice; if(outcome==='accepted'){ btn.textContent='ƒê√£ c√†i'; btn.disabled=true; } });
  }
})();



